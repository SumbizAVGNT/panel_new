{# app/templates/news_list.html #}
{% extends "base.html" %}
{% block title %}News — MoonRein{% endblock %}

{% block content %}
<div class="container-xxl pt-2">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h1 class="h5 m-0">News</h1>
    {% if can_edit %}
      <a class="btn btn-primary btn-sm" href="{{ url_for('news.new_post') }}">New Post</a>
    {% endif %}
  </div>

  {% if items and items|length %}
    <div class="d-grid gap-2">
      {% for p in items %}
        {% set tgts = targets_by_post.get(p.id, []) %}
        <div
          class="card glass news-item"
          tabindex="0"
          role="button"
          data-id="{{ p.id }}"
          data-title="{{ p.title|e }}"
          data-created="{{ p.created_at }}"
          data-author="{{ p.author or '—' }}"
          data-content="{{ p.content|e }}"
          data-embed='{{ p.embed_json if p.embed_json is string else (p.embed_json|tojson if p.embed_json else "") }}'
          data-attach="{{ p.attachment_url or '' }}"
        >
          <div class="card-body py-3">
            <div class="text-secondary small">{{ p.created_at }} · by <span class="text-light">{{ p.author or '—' }}</span></div>

            <div class="d-flex align-items-center gap-2 mt-1">
              <div class="fw-semibold fs-6 text-truncate">{{ p.title }}</div>
              <span class="badge rounded-pill bg-{{ 'success' if p.status=='sent' else ('warning' if p.status=='pending' else 'danger') }}">{{ p.status }}</span>
            </div>

            {% if tgts %}
              <div class="mt-2 d-flex flex-wrap gap-2">
                {% for t in tgts %}
                  {% set icon = 'bi-discord' if t.platform=='discord' else ('bi-telegram' if t.platform=='telegram' else ('bi-vk' if t.platform=='vk' else 'bi-send')) %}
                  <div class="d-inline-flex align-items-center gap-2 border rounded-pill px-2 py-1 target-chip">
                    <i class="bi {{ icon }}"></i>
                    <span class="small text-light">{{ t.bot_name }}</span>
                    <span class="text-secondary small">{{ t.external_target_name or t.external_target_id }}</span>
                    <span class="badge bg-{{ 'success' if t.send_status=='sent' else ('warning' if t.send_status=='pending' else 'danger') }} ms-1">{{ t.send_status }}</span>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-secondary">No posts yet.</div>
  {% endif %}
</div>

{# -------- Modal preview -------- #}
<div class="modal fade" id="newsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content glass border border-secondary-subtle">
      <div class="modal-header">
        <div class="d-flex flex-column">
          <h5 class="modal-title" id="nm_title">Title</h5>
          <div class="small text-secondary" id="nm_meta"></div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div id="nm_content" class="mb-3 text-break"></div>

        <div id="nm_embed" class="discord-embed d-none">
          <div id="nm_embed_color" class="embed-color"></div>
          <div class="embed-body">
            <div id="nm_embed_title" class="embed-title"></div>
            <div id="nm_embed_desc" class="embed-desc"></div>
            <img id="nm_embed_img" class="embed-img d-none" alt="">
          </div>
        </div>

        <img id="nm_attach" class="img-fluid rounded d-none mt-2" alt="">
      </div>
    </div>
  </div>
</div>

<style>
.news-item{ cursor:pointer; }
.news-item:focus{ outline:2px solid var(--bs-primary); }
.target-chip{pointer-events:none} /* чтобы чипы не "крали" клик */

.discord-embed{
  position:relative;display:grid;grid-template-columns:4px 1fr;gap:0;
  border:1px solid #263142;background:#0b1422;border-radius:8px
}
.embed-color{background:#5865F2;border-radius:8px 0 0 8px}
.embed-body{padding:10px 12px}
.embed-title{font-weight:700;margin-bottom:4px}
.embed-desc{white-space:pre-wrap;color:#cbd5e1}
.embed-img{max-height:360px;object-fit:contain;border-radius:6px;margin-top:8px}
</style>

<script>
(function(){
  function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

  onReady(function(){
    const modalEl = document.getElementById('newsModal');
    const bsModal = modalEl && window.bootstrap ? new bootstrap.Modal(modalEl) : null;

    const q = sel => document.querySelector(sel);
    const setText = (el, t)=>{ if(el) el.textContent = t||''; };
    const setHtml = (el, h)=>{ if(el) el.innerHTML = h||''; };
    const show = (el, v)=>{ if(el) el.classList.toggle('d-none', !v); };
    const br = s => (s||'').replace(/\n/g,'<br>');

    async function ensureFull(card){
      // если нет контента и embed — подтянуть по API
      if(card.dataset.content || card.dataset.embed || card.dataset.attach) return;
      const id = card.dataset.id;
      if(!id) return;
      try{
        const res = await fetch(`{{ url_for('news.api_post', post_id=0) }}`.replace('/0','/'+id), {cache:'no-store'});
        const data = await res.json();
        if(data.ok && data.post){
          const p = data.post;
          card.dataset.content = p.content || '';
          card.dataset.attach  = p.attachment_url || '';
          card.dataset.embed   = p.embed_json ? JSON.stringify(p.embed_json) : '';
        }
      }catch(e){ console.warn('fetch post failed', e); }
    }

    async function openCard(card){
      await ensureFull(card);

      const title   = card.dataset.title || '';
      const created = card.dataset.created || '';
      const author  = card.dataset.author || '—';
      const content = card.dataset.content || '';
      const attach  = card.dataset.attach || '';
      let embed = null;
      if(card.dataset.embed){
        try{ embed = JSON.parse(card.dataset.embed); }catch(_){}
      }

      setText(document.getElementById('nm_title'), title);
      setText(document.getElementById('nm_meta'), `${created} · by ${author}`);
      setHtml(document.getElementById('nm_content'), br(content));

      if (embed && (embed.title || embed.description || (embed.image && embed.image.url))) {
        const strip = document.getElementById('nm_embed_color');
        const t = document.getElementById('nm_embed_title');
        const d = document.getElementById('nm_embed_desc');
        const img = document.getElementById('nm_embed_img');

        // color: int -> hex
        let color = '#5865F2';
        if (typeof embed.color === 'number') {
          color = '#' + embed.color.toString(16).padStart(6,'0');
        } else if (typeof embed.color === 'string' && embed.color.startsWith('#')) {
          color = embed.color;
        }
        if(strip) strip.style.background = color;

        setText(t, embed.title || '');
        setHtml(d, br(embed.description || ''));

        if (embed.image && embed.image.url) {
          img.src = embed.image.url;
          img.alt = 'embed image';
          show(img, true);
        } else {
          img.removeAttribute('src');
          show(img, false);
        }
        show(document.getElementById('nm_embed'), true);
      } else {
        show(document.getElementById('nm_embed'), false);
      }

      const att = document.getElementById('nm_attach');
      if (attach) { att.src = attach; show(att, true); }
      else { att.removeAttribute('src'); show(att, false); }

      if (bsModal) bsModal.show();
    }

    // Делегирование клика/Enter/Space
    document.addEventListener('click', function(e){
      const card = e.target.closest('.news-item');
      if(!card) return;
      e.preventDefault();
      openCard(card);
    });

    document.addEventListener('keydown', function(e){
      if(e.key!=='Enter' && e.key!==' ') return;
      const card = e.target.closest('.news-item');
      if(!card) return;
      e.preventDefault();
      openCard(card);
    });
  });
})();
</script>
{% endblock %}
