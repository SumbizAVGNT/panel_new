{% extends "layout/base.html" %}
{% block title %}Game Servers{% endblock %}
{% block content %}
<style>
.grid-realms{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
.tile{
  border-radius:14px;border:1px solid rgba(148,163,184,.18);
  background:rgba(13,17,23,.55);backdrop-filter:blur(8px);
  padding:14px;display:flex;flex-direction:column;gap:8px;transition:.15s
}
.tile:hover{box-shadow:0 12px 28px rgba(0,0,0,.25),0 0 0 1px rgba(148,163,184,.25)}
.tile .cap{font-size:.78rem;color:#94a3b8;letter-spacing:.04em;text-transform:uppercase}
.badge-cap{padding:.35rem .6rem;border-radius:999px}
.tile .row2{display:flex;align-items:center;justify-content:space-between}
.tile .subs{display:flex;flex-wrap:wrap;gap:6px}
.pill{font-size:.78rem;border:1px solid rgba(148,163,184,.25);border-radius:999px;padding:.1rem .5rem;color:#cbd5e1}
.tile .arrow{opacity:.7;transition:.15s}
.tile:hover .arrow{opacity:1;transform:translateX(2px)}
</style>

<div class="container-xxl py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="m-0">Game Servers</h2>
    <button id="refresh" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-arrow-repeat me-1"></i>Обновить
    </button>
  </div>

  <div id="list" class="grid-realms">
    <div class="tile">
      <div class="cap">Loading</div>
      <div class="h5 m-0">Fetching realms…</div>
    </div>
  </div>
</div>

<script>
/*
  Статическая группировка (кластер → дочерние реалмы).
  Сейчас «anarxy-1» агрегирует «lobby». Позже можно хранить это в БД.
*/
const STATIC_CLUSTERS = {
  "anarxy-1": ["lobby"]
};
// куда вести по клику на кластер (по умолчанию — первый дочерний)
const CLUSTER_DEFAULT_TARGET = {
  "anarxy-1": "lobby"
};

function badgeHtml(isOnline, text){
  return `<span class="badge badge-cap ${isOnline?'bg-success':'bg-secondary'}">${text || (isOnline?'online':'offline')}</span>`;
}

function tileHtml({cap, title, href, onlineCount=0, subtext="", subs=[]}){
  const isOnline = (onlineCount|0) > 0;
  const subsHtml = subs.length ? `<div class="subs">${subs.map(s=>`<span class="pill">${s}</span>`).join("")}</div>` : "";
  return `
    <a class="tile text-decoration-none text-reset" href="${href}">
      <div class="cap">${cap}</div>
      <div class="row2">
        <div class="h5 m-0">${title}</div>
        ${badgeHtml(isOnline)}
      </div>
      ${subsHtml || (subtext ? `<div class="small text-secondary">${subtext}</div>` : "")}
      <div class="small text-secondary d-flex align-items-center gap-1">
        ${onlineCount|0} plugin(s) connected
        <i class="bi bi-arrow-right-short arrow ms-auto"></i>
      </div>
    </a>
  `;
}

async function loadList(){
  const box = document.getElementById('list');
  box.innerHTML = '';

  let payload = {};
  try{
    const r = await fetch('/admin/gameservers/api/list',{cache:'no-store'});
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'bridge unavailable');
    payload = j.data || {};
  }catch(e){
    // даже если bridge недоступен — покажем статический кластер как offline
    payload = payload || {};
  }

  // --- Сначала рисуем статические кластеры ---
  for(const clusterName of Object.keys(STATIC_CLUSTERS)){
    const children = STATIC_CLUSTERS[clusterName] || [];
    // агрегируем статус: сумма подключенных плагинов у дочерних реалмов
    const agg = children.reduce((acc, r)=>acc + (payload[r]||0), 0);
    const target = CLUSTER_DEFAULT_TARGET[clusterName] || children[0] || null;
    const href = target ? `/admin/gameservers/${encodeURIComponent(target)}` : '#';
    const subs = children; // покажем список дочерних под названием кластера
    box.insertAdjacentHTML('beforeend', tileHtml({
      cap: 'Cluster',
      title: clusterName,
      href,
      onlineCount: agg,
      subtext: target ? `opens: ${target}` : '',
      subs
    }));
  }

  // --- Затем обычные реалмы, исключая те, что попали в кластеры ---
  const clusteredChildren = new Set(Object.values(STATIC_CLUSTERS).flat());
  const realms = Object.keys(payload).filter(k => !clusteredChildren.has(k)).sort((a,b)=>a.localeCompare(b));
  if (realms.length === 0 && Object.keys(STATIC_CLUSTERS).length === 0){
    box.insertAdjacentHTML('beforeend', `<div class="text-secondary">Нет доступных реалмов</div>`);
  }
  for(const k of realms){
    const count = payload[k] || 0;
    box.insertAdjacentHTML('beforeend', tileHtml({
      cap: 'Realm',
      title: k,
      href: `/admin/gameservers/${encodeURIComponent(k)}`,
      onlineCount: count,
      subtext: ''
    }));
  }
}

document.getElementById('refresh').addEventListener('click', loadList);
loadList();
</script>
{% endblock %}
