{% extends "layout/base.html" %}
{% block title %}Game Servers{% endblock %}
{% block content %}
<style>
.tabs{display:flex;gap:6px;margin-bottom:14px}
.tabs .tab-btn{
  border-radius:10px;border:1px solid rgba(148,163,184,.22);
  background:rgba(13,17,23,.55);color:#e5e7eb;padding:.45rem .8rem;
  font-weight:600;letter-spacing:.015em
}
.tabs .tab-btn.active{background:#0f172a;border-color:rgba(148,163,184,.35)}
.tab-pane{display:none}
.tab-pane.active{display:block}

/* grid */
.grid-realms{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
.tile{
  position:relative;border-radius:14px;border:1px solid rgba(148,163,184,.18);
  background:rgba(13,17,23,.55);backdrop-filter:blur(8px);
  padding:14px;display:flex;flex-direction:column;gap:8px;transition:.15s
}
.tile:hover{box-shadow:0 10px 26px rgba(0,0,0,.24),0 0 0 1px rgba(148,163,184,.22)}
.tile .cap{font-size:.78rem;color:#94a3b8;letter-spacing:.04em;text-transform:uppercase}
.tile .row2{display:flex;align-items:center;justify-content:space-between}
.badge-cap{padding:.35rem .6rem;border-radius:999px}
.meta{display:flex;flex-wrap:wrap;gap:8px}
.meta .pill{
  font-size:.78rem;border:1px solid rgba(148,163,184,.25);border-radius:999px;
  padding:.15rem .55rem;color:#cbd5e1
}
.small-dim{color:#94a3b8}
.tile .footer{display:flex;align-items:center;gap:8px;margin-top:6px}
.tile .footer .go{margin-left:auto;opacity:.75;transition:.15s}
.tile:hover .footer .go{opacity:1;transform:translateX(2px)}
.skel{position:relative;overflow:hidden;background:rgba(148,163,184,.12);border-radius:6px}
.skel:after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);transform:translateX(-100%);animation:shimmer 1.1s infinite}
@keyframes shimmer{100%{transform:translateX(100%)}}

/* promo */
.promo{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.cardx{border-radius:14px;border:1px solid rgba(148,163,184,.18);background:rgba(13,17,23,.55);padding:14px}
.cardx h6{margin:0 0 8px 0}
</style>

<div class="container-xxl py-4">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="m-0">Game Center</h2>
    <div class="d-flex align-items-center gap-2">
      <button id="refresh" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-repeat me-1"></i>Обновить</button>
      <!-- простая ссылка на /admin без current_app -->
      <a class="btn btn-sm btn-outline-light" href="/admin"><i class="bi bi-house"></i></a>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="servers"><i class="bi bi-hdd-network me-1"></i>Servers</button>
    <button class="tab-btn" data-tab="accounts"><i class="bi bi-people me-1"></i>Accounts</button>
    <button class="tab-btn" data-tab="promo"><i class="bi bi-megaphone me-1"></i>Promo</button>
  </div>

  <!-- Servers -->
  <div id="tab-servers" class="tab-pane active">
    <div id="realms" class="grid-realms">
      <div class="tile">
        <div class="cap">Loading</div>
        <div class="h5 m-0">Fetching realms…</div>
        <div class="skel" style="height:18px;width:60%"></div>
      </div>
    </div>
  </div>

  <!-- Accounts -->
  <div id="tab-accounts" class="tab-pane">
    <div class="cardx mb-2 small-dim">
      Раздел «Accounts» встроен сюда для удобства. Откройте на полный экран при необходимости.
    </div>
    <iframe src="{{ url_for('admin.accounts.index') }}" style="width:100%;height:70vh;border:1px solid rgba(148,163,184,.18);border-radius:12px;background:#0b1220"></iframe>
  </div>

  <!-- Promo -->
  <div id="tab-promo" class="tab-pane">
    <div class="promo">
      <div class="cardx">
        <h6><i class="bi bi-currency-dollar me-1 text-success"></i>Создать промо-код</h6>
        <div class="small small-dim mb-2">Быстрая раздача бонусов/коинов по коду.</div>
        <div class="row g-2">
          <div class="col-sm-4"><input id="pr-code" class="form-control form-control-sm" placeholder="Код (AUTO если пусто)"></div>
          <div class="col-sm-3"><input id="pr-amount" type="number" class="form-control form-control-sm" placeholder="Сумма"></div>
          <div class="col-sm-3">
            <select id="pr-realm" class="form-select form-select-sm">
              <option value="">all realms</option>
            </select>
          </div>
          <div class="col-sm-2 d-grid"><button id="pr-create" class="btn btn-sm btn-outline-info">Create</button></div>
        </div>
        <div id="pr-msg" class="small small-dim mt-2"></div>
      </div>

      <div class="cardx">
        <h6><i class="bi bi-graph-up-arrow me-1 text-info"></i>Последние кампании</h6>
        <div class="small small-dim">Заготовка под список активных промо-кампаний (подключите ваш API).</div>
        <ul id="promo-list" class="mt-2 mb-0 small">
          <li class="small-dim">Нет данных</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------- Tabs ---------------- */
document.querySelectorAll('.tab-btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const k = b.dataset.tab;
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    const pane = document.getElementById('tab-'+k);
    if(pane) pane.classList.add('active');
  });
});

/* ---------------- Servers list ---------------- */
function badge(isOnline, text){
  return `<span class="badge badge-cap ${isOnline?'bg-success':'bg-secondary'}">${text || (isOnline?'online':'offline')}</span>`;
}
function tileSkeleton(){
  return `
  <div class="tile">
    <div class="cap">Realm</div>
    <div class="row2"><div class="h5 m-0 skel" style="height:22px;width:120px"></div>${badge(false,'—')}</div>
    <div class="meta">
      <span class="pill skel" style="width:70px;height:22px"></span>
      <span class="pill skel" style="width:80px;height:22px"></span>
      <span class="pill skel" style="width:90px;height:22px"></span>
    </div>
    <div class="footer small-dim">
      <span class="skel" style="height:16px;width:120px"></span>
      <i class="bi bi-arrow-right-short go"></i>
    </div>
  </div>`;
}
function realmTileHtml(name, plugins){
  const href = `/admin/gameservers/${encodeURIComponent(name)}`;
  return `
  <a class="tile text-decoration-none text-reset" href="${href}" data-realm="${name}">
    <div class="cap">Realm</div>
    <div class="row2">
      <div class="h5 m-0">${name}</div>
      ${badge((plugins|0)>0)}
    </div>
    <div class="meta" id="m-${name}">
      <span class="pill">plugins: ${(plugins|0)}</span>
      <span class="pill" data-k="online">online: —</span>
      <span class="pill" data-k="tps">TPS1m: —</span>
      <span class="pill" data-k="mspt">MSPT: —</span>
    </div>
    <div class="footer small-dim">
      <span data-k="uptime">uptime: —</span>
      <span class="small-dim" data-k="updated">· обновлено: —</span>
      <i class="bi bi-arrow-right-short go"></i>
    </div>
  </a>`;
}

async function loadRealms(){
  const box = document.getElementById('realms');
  box.innerHTML = tileSkeleton();

  let data = {};
  try{
    const r = await fetch('/admin/gameservers/api/list',{cache:'no-store'});
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'bridge error');
    data = j.data || {};
  }catch(e){
    box.innerHTML = `<div class="tile"><div class="cap">Error</div><div class="small small-dim">${e.message||e}</div></div>`;
    return;
  }

  const realms = Object.keys(data).sort((a,b)=>a.localeCompare(b));
  if (realms.length===0){
    box.innerHTML = `<div class="tile"><div class="cap">Info</div><div>Нет доступных реалмов</div></div>`;
    return;
  }

  // отрисуем карточки
  box.innerHTML = '';
  realms.forEach(name=>{
    box.insertAdjacentHTML('beforeend', realmTileHtml(name, data[name]||0));
  });

  // селект на вкладке Promo
  const sel = document.getElementById('pr-realm');
  if (sel){
    sel.innerHTML = `<option value="">all realms</option>` + realms.map(r=>`<option>${r}</option>`).join('');
  }

  // ленивые метрики
  for(const name of realms){
    try{
      const r = await fetch(`/admin/gameservers/api/stats/latest?realm=${encodeURIComponent(name)}`, {cache:'no-store'});
      const j = await r.json();
      if(!j.ok || !j.data) continue;
      const p = normalize(j.data);
      fillTile(name, p);
    }catch(e){}
  }
}

function normalize(d){
  d = d || {};
  const tps = d.tps || {};
  const players = d.players || {};
  const jvm = d.jvm || {};
  return {
    tps1: tps["1m"] ?? d.tps_1m ?? null,
    mspt: (tps.mspt ?? d.mspt ?? null),
    online: players.online ?? d.players_online ?? null,
    uptime_ms: jvm.uptime_ms ?? d.uptime_ms ?? null,
    ts: d.ts || Math.floor(Date.now()/1000)
  };
}
function fillTile(name, p){
  const root = document.querySelector(`.tile[data-realm="${CSS.escape(name)}"]`);
  if(!root) return;
  const meta = root.querySelector(`#m-${CSS.escape(name)}`);
  const q = k => meta.querySelector(`[data-k="${k}"]`);
  if(q('online')) q('online').textContent = `online: ${p.online ?? '—'}`;
  if(q('tps'))    q('tps').textContent    = `TPS1m: ${p.tps1!=null? p.tps1.toFixed(2) : '—'}`;
  if(q('mspt'))   q('mspt').textContent   = `MSPT: ${p.mspt!=null? p.mspt.toFixed(2) : '—'}`;
  const up = root.querySelector('[data-k="uptime"]');
  if(up) up.textContent = `uptime: ${humanMs(p.uptime_ms)}`;
  const upd = root.querySelector('[data-k="updated"]');
  if(upd){
    const ago = Math.max(0, Math.floor(Date.now()/1000 - (p.ts||Math.floor(Date.now()/1000))));
    upd.textContent = `· обновлено: ${ago}s ago`;
  }
}
function humanMs(ms){
  if(!ms || ms<0) return '—';
  let s = Math.floor(ms/1000);
  const d=Math.floor(s/86400); s%=86400; const h=Math.floor(s/3600); s%=3600; const m=Math.floor(s/60); s%=60;
  const a=[]; if(d) a.push(d+'d'); if(h) a.push(h+'h'); if(m) a.push(m+'m'); if(s) a.push(s+'s'); return a.join(' ')||'0s';
}

document.getElementById('refresh').addEventListener('click', loadRealms);
loadRealms();

/* ---------------- Promo mock actions ---------------- */
document.getElementById('pr-create').addEventListener('click', ()=>{
  const code = (document.getElementById('pr-code').value.trim() || ('PR' + Math.random().toString(36).slice(2,8).toUpperCase()));
  const amount = parseFloat(document.getElementById('pr-amount').value || '0');
  const realm = document.getElementById('pr-realm').value || 'all';
  const msg = document.getElementById('pr-msg');
  if(!(amount>0)){ msg.textContent='Введите сумму > 0'; msg.classList.add('text-danger'); return; }
  msg.classList.remove('text-danger'); msg.textContent = `Создан промо-код ${code} на ${amount} для ${realm}. (Демо; подключите ваш API)`;
});
</script>
{% endblock %}
