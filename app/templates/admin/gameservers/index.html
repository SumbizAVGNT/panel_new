{% extends "layout/base.html" %}
<div class="row2"><div class="h5 m-0 skel" style="height:22px;width:120px"></div>${badge(false,'—')}</div>
<div class="meta">
<span class="pill skel" style="width:70px;height:22px"></span>
<span class="pill skel" style="width:80px;height:22px"></span>
<span class="pill skel" style="width:90px;height:22px"></span>
</div>
<div class="footer small-dim">
<span class="skel" style="height:16px;width:120px"></span>
<i class="bi bi-arrow-right-short go"></i>
</div>
</div>`;
}
function realmTileHtml(name, plugins){
const href = `/admin/gameservers/${encodeURIComponent(name)}`;
return `<a class="tile text-decoration-none text-reset" href="${href}" data-realm="${name}">
<div class="cap">Realm</div>
<div class="row2"><div class="h5 m-0">${name}</div>${badge((plugins|0)>0)}</div>
<div class="meta" id="m-${name}">
<span class="pill">plugins: ${(plugins|0)}</span>
<span class="pill" data-k="online">online: —</span>
<span class="pill" data-k="tps">TPS1m: —</span>
<span class="pill" data-k="mspt">MSPT: —</span>
</div>
<div class="footer small-dim">
<span data-k="uptime">uptime: —</span>
<span class="small-dim" data-k="updated">· обновлено: —</span>
<i class="bi bi-arrow-right-short go"></i>
</div>
</a>`;
}
async function loadRealms(){
const box = document.getElementById('realms');
box.innerHTML = tileSkeleton();
let data = {};
try{
const r = await fetch('/admin/gameservers/api/list',{cache:'no-store'});
const j = await r.json(); if(!j.ok) throw new Error(j.error||'bridge error');
data = j.data || {};
}catch(e){
box.innerHTML = `<div class="tile"><div class="cap">Error</div><div class="small small-dim">${e.message||e}</div></div>`;
return;
}
const realms = Object.keys(data).sort((a,b)=>a.localeCompare(b));
if(!realms.length){ box.innerHTML = `<div class="tile"><div class="cap">Info</div><div>Нет доступных реалмов</div></div>`; return; }
box.innerHTML = '';
realms.forEach(name=> box.insertAdjacentHTML('beforeend', realmTileHtml(name, data[name]||0)));
for(const name of realms){
try{
const r = await fetch(`/admin/gameservers/api/stats/latest?realm=${encodeURIComponent(name)}`, {cache:'no-store'});
const j = await r.json(); if(!j.ok || !j.data) continue; fillTile(name, normalize(j.data));
}catch(_){}}
}
function normalize(d){
d=d||{}; const t=d.tps||{}, p=d.players||{}, j=d.jvm||{};
return { tps1: t["1m"] ?? d.tps_1m ?? null, mspt: t.mspt ?? d.mspt ?? null,
online: p.online ?? d.players_online ?? null, uptime_ms: j.uptime_ms ?? d.uptime_ms ?? null,
ts: d.ts || Math.floor(Date.now()/1000) };
}
function fillTile(name, p){
const root = document.querySelector(`.tile[data-realm="${CSS.escape(name)}"]`); if(!root) return;
const meta = root.querySelector(`#m-${CSS.escape(name)}`), q=k=>meta.querySelector(`[data-k="${k}"]`);
if(q('online')) q('online').textContent = `online: ${p.online ?? '—'}`;
if(q('tps')) q('tps').textContent = `TPS1m: ${p.tps1!=null? p.tps1.toFixed(2) : '—'}`;
if(q('mspt')) q('mspt').textContent = `MSPT: ${p.mspt!=null? p.mspt.toFixed(2) : '—'}`;
const up = root.querySelector('[data-k="uptime"]'); if(up) up.textContent = `uptime: ${humanMs(p.uptime_ms)}`;
const upd = root.querySelector('[data-k="updated"]');
if(upd){ const ago = Math.max(0, Math.floor(Date.now()/1000 - (p.ts||Math.floor(Date.now()/1000)))); upd.textContent = `· обновлено: ${ago}s ago`; }
}
function humanMs(ms){
if(!ms || ms<0) return '—'; let s=Math.floor(ms/1000);
const d=Math.floor(s/86400); s%=86400; const h=Math.floor(s/3600); s%=3600; const m=Math.floor(s/60); s%=60;
const a=[]; if(d) a.push(d+'d'); if(h) a.push(h+'h'); if(m) a.push(m+'m'); if(s) a.push(s+'s'); return a.join(' ')||'0s';
}
document.getElementById('refresh').addEventListener('click', loadRealms);
loadRealms();
</script>


{# Accounts JS #}
{% include "admin/gameservers/accounts/accounts_script.html" %}


{# Promocode JS #}
{% include "admin/gameservers/promocode/promocode_script.html" %}


{# Kits JS #}
{% include "admin/gameservers/promocode/kits_script.html" %}
{% endblock %}