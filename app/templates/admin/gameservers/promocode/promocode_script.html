<script>
(async function PromoModule(){
  const $ = (id)=>document.getElementById(id);
  const listEl = $('pc-list'), kitSel = $('pc-kit'), msg = $('pc-msg');

  async function loadKitsToSelect(){
    try{
      const r = await fetch('/admin/promocode/api/kits/list',{cache:'no-store'});
      const j = await r.json(); if(!j.ok) throw new Error(j.error||'kits');
      kitSel.innerHTML = `<option value="">— без кита —</option>` + (j.data||[]).map(k=>`<option value="${k.id}">${k.name}</option>`).join('');
    }catch(e){ /* ignore */ }
  }

  async function loadPromos(){
    listEl.innerHTML = `<li class="small-dim">Загрузка…</li>`;
    try{
      const r = await fetch('/admin/promocode/api/promo/list',{cache:'no-store'});
      const j = await r.json(); if(!j.ok) throw new Error(j.error||'list');
      const rows = j.data||[];
      if(!rows.length){ listEl.innerHTML = `<li class="small-dim">Нет данных</li>`; return; }
      listEl.innerHTML = rows.map(x=>`
        <li>
          <div class="d-flex align-items-center justify-content-between">
            <div><span class="code">${x.code}</span> · ${x.amount!=null? x.amount+' '+(x.currency_key||'') : ''} ${x.kit_name? ' · kit: '+x.kit_name : ''}</div>
            <div class="small-dim">${x.uses_left}/${x.uses_total}${x.expires_at? ' · до '+x.expires_at : ''}</div>
          </div>
        </li>`).join('');
    }catch(e){
      listEl.innerHTML = `<li class="text-danger">${e.message||e}</li>`;
    }
  }

  $('pc-create').addEventListener('click', async ()=>{
    const body = {
      code: ($('pc-code').value||'').trim(),
      amount: parseFloat($('pc-amount').value||'0'),
      uses: parseInt($('pc-uses').value||'1',10)||1,
      currency_key: $('pc-currency').value||'rubs',
      realm: ($('pc-realm').value||'').trim()||null,
      kit_id: $('pc-kit').value || null,
      expires_at: $('pc-exp').value || null,
    };
    try{
      const r = await fetch('/admin/promocode/api/promo/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const j = await r.json(); if(!j.ok) throw new Error(j.error||'create failed');
      msg.textContent = `Создан промокод: ${j.data.code}`;
      await loadPromos();
    }catch(e){ msg.textContent = 'Ошибка: '+(e.message||e); }
  });

  await loadKitsToSelect();
  await loadPromos();
})();
</script>
