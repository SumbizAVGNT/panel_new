<script>
(function(){
  'use strict';

  // ---------- helpers ----------
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const on = (el, ev, fn)=> el && el.addEventListener(ev, fn);
  const esc = (s)=> String(s??'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
  const fmt = {
    money:(a,k)=> (a!=null && a!=='') ? `${(+a).toFixed(2)} ${k||''}`.trim() : '—',
    date:(s)=> s ? String(s).replace('T',' ').slice(0,19) : '—'
  };

  // toast (создаст контейнер при первом вызове)
  function toast(msg){
    let zone = $('#pc-toasts');
    if(!zone){
      zone = document.createElement('div');
      zone.id = 'pc-toasts';
      zone.className = 'pc-toasts';
      document.body.appendChild(zone);
    }
    const el = document.createElement('div');
    el.className = 'pc-toast';
    el.textContent = msg;
    zone.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(), 250); }, 2200);
  }
  const copy = (t)=> navigator.clipboard?.writeText(t).then(()=>toast('Скопировано')).catch(()=>{});

  // neon hover (для .btn-neon)
  function setNeonPointer(btn, e){
    const r = btn.getBoundingClientRect();
    btn.style.setProperty('--x', (e.clientX - r.left)+'px');
    btn.style.setProperty('--y', (e.clientY - r.top)+'px');
  }

  // skeletons
  function skeletonRows(target, n=6){
    if(!target) return;
    target.innerHTML = Array.from({length:n}).map(()=>`
      <tr class="skel-row">
        <td><div class="skel skel-pill" style="width:120px"></div></td>
        <td><div class="skel skel-pill" style="width:70px"></div></td>
        <td><div class="skel skel-pill" style="width:100px"></div></td>
        <td><div class="skel skel-pill" style="width:90px"></div></td>
        <td><div class="skel skel-pill" style="width:80px"></div></td>
        <td><div class="skel skel-pill" style="width:120px"></div></td>
        <td><div class="skel skel-pill" style="width:90px"></div></td>
        <td class="text-end"><div class="skel skel-pill" style="width:60px;float:right"></div></td>
        <td class="text-end"><div class="skel skel-pill" style="width:140px;float:right"></div></td>
      </tr>
    `).join('');
  }

  // ---------- API ----------
  const API_BASES = ['/admin/promocode/api','/admin/gameservers/promocode/api'];
  const chooseBase = async ()=>{
    for (const base of API_BASES){
      try{ const r = await fetch(base + '/promo/list', {cache:'no-store'}); if (r.ok) return base; }catch(_){}
    }
    return API_BASES[0];
  };
  const json = async (url, opts={})=>{
    const r = await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}}, opts));
    let j=null; try{ j=await r.json(); }catch(_){}
    if(!j || !j.ok) throw new Error(j?.error || ('HTTP '+r.status));
    return j.data;
  };

  // ---------- state ----------
  let API = '';
  let rows = [];
  let kits = [];
  let sortBy = 'id', sortDir = 'desc';
  let modalBS = null;                  // modal (без бэкдропа)
  let bodyDelegBound = false;          // чтоб не вешать копирование много раз
  let groupsLoadedFor = null;          // ленивые вкладки
  let redsLoadedFor   = null;
  let lpGroupsLoaded  = false;
  const els = {};

  // ---------- Modal wrapper (BS или fallback без затемнения) ----------
  const Modal = {
    init(){
      if (window.bootstrap) modalBS = bootstrap.Modal.getOrCreateInstance(els.m, {backdrop:false, keyboard:true, focus:true});
      $$('[data-bs-dismiss="modal"]', els.m).forEach(btn=> btn.addEventListener('click', ()=>Modal.hide()));
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && Modal.isShown() && !modalBS) Modal.hide(); });
    },
    isShown(){ return modalBS ? !!els.m.classList.contains('show') : els.m.style.display==='block'; },
    show(){
      if (modalBS) { modalBS.show(); return; }
      els.m.classList.add('show');
      els.m.style.display='block';
      els.m.removeAttribute('aria-hidden');
      document.body.classList.add('modal-open');
      // без создания backdrop — нет затемнения
    },
    hide(){
      if (modalBS) { modalBS.hide(); return; }
      els.m.classList.remove('show');
      els.m.style.display='none';
      els.m.setAttribute('aria-hidden','true');
      document.body.classList.remove('modal-open');
    }
  };

  // ---------- grab ----------
  function grab(){
    els.body      = $('#pc-list');
    els.count     = $('#pc-count');
    els.search    = $('#pc-search');
    els.btnRef    = $('#pc-refresh');
    els.btnCreate = $('#pc-create');
    els.tbl       = $('#pc-table');

    // фильтры (если есть)
    els.fStatus   = $('#pc-filter-status');
    els.fRealm    = $('#pc-filter-realm');
    els.fKit      = $('#pc-filter-kit');

    // modal
    els.m        = $('#pcEditModal');
    els.mId      = $('#pc-f-id');
    els.mTitle   = $('#pc-f-title');
    els.mCode    = $('#pc-f-code');
    els.mGen     = $('#pc-f-gen');
    els.mEnabled = $('#pc-f-enabled');
    els.mRealm   = $('#pc-f-realm');
    els.mExp     = $('#pc-f-exp');
    els.mAmount  = $('#pc-f-amount');
    els.mCurr    = $('#pc-f-currency');
    els.mTotal   = $('#pc-f-total');
    els.mPer     = $('#pc-f-per');
    els.mCd      = $('#pc-f-cd');
    els.mKit     = $('#pc-f-kit');
    els.mLeft    = $('#pc-f-left');
    els.mSave    = $('#pc-f-save');
    els.mDel     = $('#pc-f-delete');

    // quick actions
    els.aGen     = $('#pc-a-gen');
    els.aCopy    = $('#pc-a-copy');

    // tabs (AURORA)
    els.tabNav   = $('#pc-mTabs');
    els.tabOver  = $('#pc-tab-overview');
    els.tabGroups= $('#pc-tab-groups');
    els.tabReds  = $('#pc-tab-reds');

    // groups / reds
    els.gBody  = $('#pc-groups-body');
    els.gAdd   = $('#pc-g-add');
    els.gSave  = $('#pc-g-save');

    els.rQuery = $('#pc-r-player');
    els.rBtn   = $('#pc-r-search');
    els.rCount = $('#pc-r-count');
    els.rBody  = $('#pc-reds-body');

    // datalist для LP-групп (автосоздание если не дан в разметке)
    els.lpList = $('#pc-lp-groups');
    if(!els.lpList){
      els.lpList = document.createElement('datalist');
      els.lpList.id = 'pc-lp-groups';
      document.body.appendChild(els.lpList);
    }
  }

  // ---------- kits ----------
  async function loadKits(){
    try{
      kits = await json(API+'/kits/list');
      if (els.mKit){
        els.mKit.innerHTML = `<option value="">— без кита —</option>` + (kits||[]).map(k=>`<option value="${k.id}">${esc(k.name)}</option>`).join('');
      }
      if (els.fKit){
        els.fKit.innerHTML = `<option value="">Kit: любой</option>` + (kits||[]).map(k=>`<option value="${k.id}">${esc(k.name)}</option>`).join('');
      }
    }catch(_){/* ignore */}
  }
  async function loadKitsIntoSelect(){ await loadKits(); } // совместимость

  function fillRealmFilter(){
    if(!els.fRealm) return;
    const uniq = Array.from(new Set(rows.map(r=>r.realm||''))).sort((a,b)=>String(a).localeCompare(String(b)));
    els.fRealm.innerHTML = `<option value="">Realm: все</option>` + uniq.map(v=>`<option value="${esc(v)}">${v || 'all'}</option>`).join('');
  }

  // ---------- LP GROUPS (автодополнение) ----------
  async function loadLpGroupsOnce(){
    if (lpGroupsLoaded) return;
    const urls = [
      API+'/lp/groups',
      '/admin/accounts/api/lp/groups',
      '/admin/gameservers/accounts/api/lp/groups'
    ];
    for (const u of urls){
      try{
        const r = await fetch(u, {cache:'no-store'});
        if(!r.ok) continue;
        const j = await r.json();
        const arr = (j && (j.data||j.groups||j)) || [];
        if(!Array.isArray(arr) || !arr.length) continue;
        els.lpList.innerHTML = arr.map(g=>`<option value="${esc(g.name||g)}">`).join('');
        lpGroupsLoaded = true;
        break;
      }catch(_){/* next */}
    }
  }

  // ---------- table ----------
  function filterRows(){
    const q = (els.search?.value||'').trim().toLowerCase();
    const st = els.fStatus?.value ?? '';
    const rl = els.fRealm?.value ?? '';
    const kit = els.fKit?.value ?? '';

    return rows.filter(x=>{
      if (q && !String(x.code).toLowerCase().includes(q)) return false;
      if (st!=='' && String(+!!x.enabled)!==st) return false;
      if (rl!=='' && String(x.realm||'')!==rl) return false;
      if (kit!=='' && String(x.kit_id||'')!==kit) return false;
      return true;
    });
  }

  function render(){
    let list = filterRows();

    list.sort((a,b)=>{
      const A=a[sortBy], B=b[sortBy];
      if (['id','amount','uses_left','uses_total'].includes(sortBy)) return (Number(A)||0)-(Number(B)||0);
      return String(A??'').localeCompare(String(B??''));
    });
    if (sortDir==='desc') list.reverse();

    if (els.count) els.count.textContent = list.length ? `${list.length} шт.` : '';

    if (!list.length){
      els.body.innerHTML = `<tr><td colspan="9" class="text-secondary small">Нет данных</td></tr>`;
      return;
    }

    const now = Date.now();
    const q = (els.search?.value||'').trim().toLowerCase();

    els.body.innerHTML = list.map(x=>{
      const used = (x.uses_total!=null && x.uses_left!=null) ? (x.uses_total - x.uses_left) : '—';
      const st = (+x.enabled ? `<span class="badge badge-active">active</span>` : `<span class="badge badge-off">off</span>`);
      const lim = (x.uses_total!=null) ? `${x.uses_left}/${x.uses_total}` : '∞';
      const expTs = x.expires_at ? Date.parse(String(x.expires_at).replace(' ','T')) : null;
      const expStr = fmt.date(x.expires_at);
      const expHtml = expTs && expTs < now ? `<span class="text-expired" title="истёк">${expStr}</span>` : expStr;

      // подсветка совпадения в коде + чип
      const code = String(x.code);
      const i = q ? code.toLowerCase().indexOf(q) : -1;
      const codeHtml = (i>=0)
        ? esc(code.slice(0,i)) + '<mark>' + esc(code.slice(i,i+q.length)) + '</mark>' + esc(code.slice(i+q.length))
        : esc(code);

      return `
      <tr data-id="${x.id}">
        <td>
          <span class="pc-code" title="Скопировать код"><i class="bi bi-qr-code"></i><span class="code">${codeHtml}</span></span>
        </td>
        <td>${st}</td>
        <td>${fmt.money(x.amount, x.currency_key)}</td>
        <td>${x.realm ? esc(x.realm) : '<span class="text-dim">all</span>'}</td>
        <td>${lim}</td>
        <td>${expHtml}</td>
        <td>${x.kit_name? `<span class="badge badge-soft">${esc(x.kit_name)}</span>`: ''}</td>
        <td class="text-end">${used}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-light act-edit">Изм.</button>
            <button class="btn btn-outline-secondary act-copy" title="Скопировать код"><i class="bi bi-clipboard"></i></button>
            <button class="btn btn-outline-danger act-del">Удалить</button>
          </div>
        </td>
      </tr>`;
    }).join('');

    // actions
    $$('.pc-code', els.body).forEach(el=>el.addEventListener('click', (e)=>{
      const tr = e.target.closest('tr'); const r = rows.find(x=>x.id==tr.dataset.id);
      if(r){ navigator.clipboard?.writeText(r.code).then(()=>{ el.classList.add('copied'); toast('Код скопирован'); setTimeout(()=>el.classList.remove('copied'), 700); }); }
    }));
    $$('.act-edit', els.body).forEach(btn=>btn.addEventListener('click', onRowEdit));
    $$('.act-copy', els.body).forEach(btn=>btn.addEventListener('click', (e)=>{
      const tr = e.target.closest('tr'); const r = rows.find(x=>x.id==tr.dataset.id);
      if(r) copy(r.code);
    }));
    $$('.act-del', els.body).forEach(btn=>btn.addEventListener('click', onRowDelete));

    // делегат для клика по первой ячейке (копирование), навешиваем один раз
    if(!bodyDelegBound){
      bodyDelegBound = true;
      els.body.addEventListener('click', (e)=>{
        const td = e.target.closest('td'); const tr = e.target.closest('tr');
        if(!td || !tr) return;
        if(td.cellIndex===0){
          const r = rows.find(x=>x.id==tr.dataset.id);
          if(r) copy(r.code);
        }
      });
    }
  }

  async function loadList(){
    skeletonRows(els.body);
    try{
      rows = await json(API+'/promo/list');
      fillRealmFilter();
      render();
    }catch(e){
      els.body.innerHTML = `<tr><td colspan="9" class="text-danger">${esc(e.message||String(e))}</td></tr>`;
    }
  }

  // ---------- modal: fill & open ----------
  function fillModal(row){
    if(!els.m) return;
    els.mId.value      = row?.id ?? '';
    els.mTitle && (els.mTitle.textContent = row ? `#${row.id}` : '(новый)');
    els.mCode && (els.mCode.value    = row?.code ?? '');
    els.mEnabled && (els.mEnabled.value = (row?.enabled ?? 1) ? '1':'0');
    els.mRealm && (els.mRealm.value   = row?.realm ?? '');
    els.mExp && (els.mExp.value     = row?.expires_at ?? '');
    els.mAmount && (els.mAmount.value  = row?.amount ?? '');
    els.mCurr && (els.mCurr.value    = row?.currency_key ?? 'rubs');
    els.mTotal && (els.mTotal.value   = row?.uses_total ?? '');
    els.mPer && (els.mPer.value     = row?.per_player_uses ?? '');
    els.mCd && (els.mCd.value      = row?.cooldown_seconds ?? '');
    els.mLeft && (els.mLeft.value    = row?.uses_left ?? '');
    els.mKit && (els.mKit.value     = row?.kit_id ?? '');

    // По умолчанию «Общее», лениво грузим остальные вкладки
    switchTab('overview');
    groupsLoadedFor = null;
    redsLoadedFor = null;
  }

  function onRowEdit(e){
    const tr = e.target.closest('tr');
    const id = Number(tr.dataset.id);
    const row = rows.find(x=>x.id===id);

    // Показать модалку мгновенно
    Modal.show();
    fillModal(row);

    // Подгружаем второстепенные вещи в фоне
    loadKits().then(()=>{ if(row && els.mKit) els.mKit.value = row.kit_id ?? ''; });
    loadLpGroupsOnce();
  }

  async function onRowDelete(e){
    const tr = e.target.closest('tr');
    const id = Number(tr.dataset.id);
    const row = rows.find(x=>x.id===id);
    if (!confirm(`Удалить промокод ${row?.code || ('#'+id)}?`)) return;
    try{
      await json(API+'/promo/delete', {method:'POST', body:JSON.stringify({id})});
      await loadList();
      toast('Удалено');
    }catch(err){ alert('Ошибка: '+(err.message||err)); }
  }

  // ---------- save ----------
  function buildBodyFromModal(){
    const id = els.mId?.value ? Number(els.mId.value) : null;
    return {
      id,
      code: (els.mCode?.value||'').trim().toUpperCase(),
      enabled: Number(els.mEnabled?.value||1),
      realm: (els.mRealm?.value||'').trim() || null,
      expires_at: (els.mExp?.value||'').trim() || null,
      amount: (els.mAmount && els.mAmount.value!==''? Number(els.mAmount.value): null),
      currency_key: (els.mCurr?.value||'').trim() || null,
      uses_total: (els.mTotal && els.mTotal.value!==''? Number(els.mTotal.value): null),
      per_player_uses: (els.mPer && els.mPer.value!==''? Number(els.mPer.value): null),
      cooldown_seconds: (els.mCd && els.mCd.value!==''? Number(els.mCd.value): null),
      kit_id: (els.mKit && els.mKit.value ? Number(els.mKit.value) : null)
    };
  }
  async function saveCurrent(){
    const body = buildBodyFromModal();
    try{
      if(!body.id){
        const created = await json(API+'/promo/create', {method:'POST', body: JSON.stringify({
          code: body.code || undefined,
          amount: body.amount || 0,
          currency_key: body.currency_key || 'rubs',
          realm: body.realm,
          kit_id: body.kit_id,
          uses: body.uses_total || 1,
          expires_at: body.expires_at
        })});
        await loadList();
        const row = rows.find(x=>x.id===created.id) || rows.find(x=>x.code===created.code);
        if(row) fillModal(row);
      }else{
        await json(API+'/promo/update', {method:'POST', body: JSON.stringify(body)});
        await loadList();
        const row = rows.find(x=>x.id===body.id);
        if(row) fillModal(row);
      }
      toast('Сохранено');
    }catch(err){
      alert('Ошибка: '+(err.message||err));
    }
  }

  // ---------- groups ----------
  function rowGroupTpl(i,g){
    return `<tr>
      <td class="text-secondary">${i+1}</td>
      <td><input class="form-control form-control-sm g-name" list="pc-lp-groups" value="${esc(g.group_name||'')}"></td>
      <td style="width:150px"><input type="number" class="form-control form-control-sm g-temp" value="${g.temp_seconds??''}"></td>
      <td><input class="form-control form-control-sm g-srv" value="${esc(g.context_server||'')}"></td>
      <td><input class="form-control form-control-sm g-wld" value="${esc(g.context_world||'')}"></td>
      <td style="width:110px"><input type="number" class="form-control form-control-sm g-pr" value="${g.priority??(i+1)}"></td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger g-del">&times;</button></td>
    </tr>`;
  }
  function readGroupsFromUI(){
    const out=[];
    $$('#pc-groups-body tr').forEach((tr,i)=>{
      const g={
        group_name: ($('.g-name',tr).value||'').trim(),
        temp_seconds: $('.g-temp',tr).value ? Number($('.g-temp',tr).value) : null,
        context_server: ($('.g-srv',tr).value||'').trim()||'global',
        context_world: ($('.g-wld',tr).value||'').trim()||'global',
        priority: $('.g-pr',tr).value ? Number($('.g-pr',tr).value) : (i+1)
      };
      if(g.group_name) out.push(g);
    });
    return out;
  }
  function bindGroupRowEvents(){
    $$('.g-del', els.gBody).forEach(btn=>btn.addEventListener('click', (e)=>{
      e.preventDefault();
      e.target.closest('tr').remove();
    }));
  }
  async function loadGroups(codeId){
    if(!els.gBody) return;
    els.gBody.innerHTML = '';
    if(!codeId){ els.gBody.innerHTML='<tr><td colspan="7" class="text-secondary small">Сохраните промокод, чтобы добавить группы</td></tr>'; return; }
    try{
      await loadLpGroupsOnce();
      const data = await json(API+'/promo/groups/list?code_id='+codeId);
      els.gBody.innerHTML = (data||[]).map((g,i)=>rowGroupTpl(i,g)).join('') || '<tr><td colspan="7" class="text-secondary small">Нет групп</td></tr>';
      bindGroupRowEvents();
      groupsLoadedFor = codeId;
    }catch(_){
      els.gBody.innerHTML = '<tr><td colspan="7" class="text-secondary small">Не удалось загрузить группы</td></tr>';
    }
  }
  function addGroupRow(){
    const i = $$('#pc-groups-body tr').length;
    els.gBody.insertAdjacentHTML('beforeend', rowGroupTpl(i, {}));
    bindGroupRowEvents();
  }
  async function saveGroups(){
    const id = Number(els.mId?.value||0);
    if(!id) return alert('Сначала сохраните промокод');
    try{
      const groups = readGroupsFromUI();
      await json(API+'/promo/groups/save', {method:'POST', body: JSON.stringify({code_id:id, groups})});
      toast('Группы сохранены');
      await loadGroups(id);
    }catch(err){ alert('Ошибка: '+(err.message||err)); }
  }

  // ---------- redemptions ----------
  async function loadReds(codeId){
    if(!els.rBody) return;
    els.rBody.innerHTML = '';
    if(els.rCount) els.rCount.textContent = '';
    if(!codeId) return;
    try{
      const q = (els.rQuery?.value||'').trim();
      const data = await json(API+`/promo/redemptions?code_id=${codeId}` + (q?`&q=${encodeURIComponent(q)}`:''));
      els.rBody.innerHTML = (data||[]).map(r=>`
        <tr>
          <td>${fmt.date(r.created_at)}</td>
          <td>${esc(r.username||'—')}</td>
          <td class="text-secondary small">${esc(r.uuid)}</td>
          <td>${r.granted_amount!=null? (+r.granted_amount).toFixed(2) : '—'}</td>
          <td>${rows.find(x=>x.id===r.code_id)?.currency_key || ''}</td>
          <td class="text-secondary">${esc(r.ip||'')}</td>
        </tr>
      `).join('') || `<tr><td colspan="6" class="text-secondary small">Пусто</td></tr>`;
      if(els.rCount) els.rCount.textContent = (data||[]).length ? `${data.length} активаций` : '';
      redsLoadedFor = codeId;
    }catch(_){
      els.rBody.innerHTML = `<tr><td colspan="6" class="text-secondary small">Ошибка загрузки</td></tr>`;
    }
  }

  // ---------- tabs (AURORA) ----------
  function switchTab(key){
    if(!els.tabNav) return;
    $$('.pc-tabs .nav-link').forEach(a=>a.classList.toggle('active', a.dataset.tab===key));
    if(els.tabOver)   els.tabOver.classList.toggle('d-none', key!=='overview');
    if(els.tabGroups) els.tabGroups.classList.toggle('d-none', key!=='groups');
    if(els.tabReds)   els.tabReds.classList.toggle('d-none', key!=='reds');

    const id = Number(els.mId?.value||0);
    if (key==='groups' && id && groupsLoadedFor!==id) loadGroups(id);
    if (key==='reds'   && id && redsLoadedFor!==id)   loadReds(id);
  }

  // ---------- events ----------
  function bind(){
    // сортировка
    $$('th[data-sort]', els.tbl).forEach(th=>{
      th.addEventListener('click', ()=>{
        const k = th.getAttribute('data-sort');
        if (sortBy===k) sortDir = (sortDir==='asc'?'desc':'asc'); else { sortBy=k; sortDir='asc'; }
        $$('th[data-sort]', els.tbl).forEach(x=>x.classList.remove('desc'));
        if (sortDir==='desc') th.classList.add('desc');
        render();
      });
    });

    // фильтры / поиск
    on(els.search, 'input', render);
    on(els.fStatus, 'change', render);
    on(els.fRealm, 'change', render);
    on(els.fKit, 'change', render);

    // toolbar
    on(els.btnRef, 'click', loadList);
    $$('.btn-neon').forEach(b=> on(b,'pointermove', (e)=>setNeonPointer(b,e)));
    on(els.btnCreate, 'click', ()=>{
      Modal.show();           // мгновенно
      fillModal(null);
      loadKits();
      loadLpGroupsOnce();
    });

    // modal actions
    on(els.mSave, 'click', saveCurrent);
    on(els.mDel, 'click', async ()=>{
      const id = els.mId?.value ? Number(els.mId.value) : null;
      if(!id){ alert('Промокод ещё не сохранён'); return; }
      if(!confirm('Удалить промокод?')) return;
      try{
        await json(API+'/promo/delete',{method:'POST', body:JSON.stringify({id})});
        Modal.hide();
        await loadList();
        toast('Удалено');
      }catch(err){ alert('Ошибка: '+(err.message||err)); }
    });

    // codegen
    function genCode(){
      const alph='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let out=''; const len=10+Math.floor(Math.random()*3);
      for(let i=0;i<len;i++) out+=alph[Math.floor(Math.random()*alph.length)];
      if(els.mCode) els.mCode.value = out;
    }
    on(els.mGen, 'click', (e)=>{ e.preventDefault(); genCode(); toast('Сгенерирован новый код'); });
    on(els.aGen, 'click', ()=>{ genCode(); toast('Сгенерирован новый код'); });
    on(els.aCopy,'click', ()=>{ const code=(els.mCode?.value||'').trim(); if(code){ navigator.clipboard?.writeText(code); toast('Код скопирован'); } });

    // groups
    on(els.gAdd, 'click', addGroupRow);
    on(els.gSave, 'click', saveGroups);

    // reds
    on(els.rBtn, 'click', ()=>loadReds(Number(els.mId?.value||0)));
    on(els.rQuery, 'keydown', (e)=>{ if(e.key==='Enter') loadReds(Number(els.mId?.value||0)); });

    // tabs
    $$('.pc-tabs .nav-link').forEach(a=>a.addEventListener('click', ()=>switchTab(a.dataset.tab)));
  }

  // ---------- init ----------
  (async function init(){
    grab();
    Modal.init();
    API = await chooseBase();
    bind();
    await loadKits();
    await loadList();
  })();

})();
</script>
