<script>
(function(){
  'use strict';

  // ---------- helpers ----------
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const API_BASES = ['/admin/promocode/api','/admin/gameservers/promocode/api']; // fallback
  const pickBase = async (path='')=>{
    for (const base of API_BASES){
      try{ const r=await fetch(base+'/ping',{cache:'no-store'}); if(r.ok||r.status===404) return base; }catch(_){}
    }
    return API_BASES[0];
  };
  const json = async (url, opts={})=>{
    const r = await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}}, opts));
    const j = await r.json().catch(()=>({ok:false,error:'bad json'}));
    if(!j.ok) throw new Error(j.error||('HTTP '+r.status));
    return j.data;
  };
  const fmt = {
    money:(a,k)=> a!=null && a!=='' ? `${(+a).toFixed(2)} ${k||''}`.trim() : '—',
    date:(s)=> s ? String(s).replace('T',' ').slice(0,19) : '—'
  };
  const badge = (t,cls='badge-soft')=>`<span class="badge ${cls}">${t}</span>`;
  const copy = (t)=>navigator.clipboard?.writeText(t).catch(()=>{});

  // ---------- state ----------
  let API='';            // выбранный base
  let list=[];           // строки таблицы
  let sortBy='id', sortDir='desc';
  let modal, els={};     // ссылки на элементы

  // ---------- grab ----------
  function grab(){
    els.body     = $('#pc-list');
    els.count    = $('#pc-count');
    els.search   = $('#pc-search');
    els.btnRef   = $('#pc-refresh');
    els.btnCreate= $('#pc-create');
    els.tbl      = $('#pc-table');

    // modal
    els.m         = $('#pcEditModal');
    els.mId       = $('#pc-f-id');
    els.mTitle    = $('#pc-f-title');
    els.mCode     = $('#pc-f-code');
    els.mEnabled  = $('#pc-f-enabled');
    els.mRealm    = $('#pc-f-realm');
    els.mExp      = $('#pc-f-exp');
    els.mAmount   = $('#pc-f-amount');
    els.mCurr     = $('#pc-f-currency');
    els.mTotal    = $('#pc-f-total');
    els.mPer      = $('#pc-f-per');
    els.mCd       = $('#pc-f-cd');
    els.mKit      = $('#pc-f-kit');
    els.mLeft     = $('#pc-f-left');
    els.mSave     = $('#pc-f-save');
    els.mDel      = $('#pc-f-delete');
    els.gBody     = $('#pc-groups-body');
    els.gAdd      = $('#pc-g-add');
    els.gSave     = $('#pc-g-save');
    els.rQuery    = $('#pc-r-player');
    els.rBtn      = $('#pc-r-search');
    els.rCount    = $('#pc-r-count');
    els.rBody     = $('#pc-reds-body');

    // bootstrap modal
    if (window.bootstrap) modal = bootstrap.Modal.getOrCreateInstance(els.m);
  }

  // ---------- kits ----------
  async function loadKitsIntoSelect(){
    els.mKit.innerHTML = `<option value="">— без кита —</option>`;
    try{
      const kits = await json(API+'/kits/list');
      els.mKit.innerHTML += (kits||[]).map(k=>`<option value="${k.id}">${k.name}</option>`).join('');
    }catch(_){}
  }

  // ---------- table ----------
  function render(){
    const q = (els.search.value||'').trim().toLowerCase();
    let rows = list.filter(x => !q || String(x.code).toLowerCase().includes(q));

    rows.sort((a,b)=>{
      const A = a[sortBy], B = b[sortBy];
      if (sortBy==='amount' || sortBy==='uses_left' || sortBy==='uses_total' || sortBy==='id') {
        return (Number(A)||0) - (Number(B)||0);
      }
      return String(A??'').localeCompare(String(B??''));
    });
    if (sortDir==='desc') rows.reverse();

    els.count.textContent = rows.length ? `${rows.length} шт.` : '';

    if (!rows.length) {
      els.body.innerHTML = `<tr><td colspan="9" class="text-secondary small">Нет данных</td></tr>`;
      return;
    }

    els.body.innerHTML = rows.map(x=>{
      const used = (x.uses_total!=null && x.uses_left!=null) ? (x.uses_total - x.uses_left) : '—';
      const st = +x.enabled ? badge('active') : badge('off','bg-secondary');
      const lim = (x.uses_total!=null) ? `${x.uses_left}/${x.uses_total}` : '∞';
      return `
      <tr data-id="${x.id}">
        <td class="fw-semibold">${x.code}</td>
        <td>${st}</td>
        <td>${fmt.money(x.amount, x.currency_key)}</td>
        <td>${x.realm || '<span class="text-dim">all</span>'}</td>
        <td>${lim}</td>
        <td>${fmt.date(x.expires_at)}</td>
        <td>${x.kit_name? badge(x.kit_name): ''}</td>
        <td class="text-end">${used}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-light act-edit">Изм.</button>
            <button class="btn btn-outline-secondary act-copy" title="Скопировать код"><i class="bi bi-clipboard"></i></button>
            <button class="btn btn-outline-danger act-del">Удалить</button>
          </div>
        </td>
      </tr>`;
    }).join('');

    // actions
    $$('.act-edit', els.body).forEach(btn=>btn.addEventListener('click', onRowEdit));
    $$('.act-copy', els.body).forEach(btn=>btn.addEventListener('click', (e)=>{
      const tr = e.target.closest('tr'); const r = list.find(x=>x.id==tr.dataset.id); if(r) copy(r.code);
    }));
    $$('.act-del', els.body).forEach(btn=>btn.addEventListener('click', onRowDelete));
  }

  async function loadList(){
    els.body.innerHTML = `<tr><td colspan="9" class="text-secondary small">Загрузка…</td></tr>`;
    try{
      list = await json(API+'/promo/list');
    }catch(e){
      els.body.innerHTML = `<tr><td colspan="9" class="text-danger">${e.message||e}</td></tr>`;
      return;
    }
    render();
  }

  // ---------- modal: fill & open ----------
  function fillModal(row){
    els.mId.value      = row?.id ?? '';
    els.mTitle.textContent = row ? `#${row.id}` : '(новый)';
    els.mCode.value    = row?.code ?? '';
    els.mEnabled.value = (row?.enabled ?? 1) ? '1':'0';
    els.mRealm.value   = row?.realm ?? '';
    els.mExp.value     = row?.expires_at ?? '';
    els.mAmount.value  = row?.amount ?? '';
    els.mCurr.value    = row?.currency_key ?? 'rubs';
    els.mTotal.value   = row?.uses_total ?? '';
    els.mPer.value     = row?.per_player_uses ?? '';
    els.mCd.value      = row?.cooldown_seconds ?? '';
    els.mLeft.value    = row?.uses_left ?? '';
    els.mKit.value     = row?.kit_id ?? '';

    // группы + редемпшены
    loadGroups(row?.id);
    loadReds(row?.id);
  }

  async function onRowEdit(e){
    const tr = e.target.closest('tr');
    const id = Number(tr.dataset.id);
    const row = list.find(x=>x.id===id);
    fillModal(row);
    modal.show();
  }

  async function onRowDelete(e){
    const tr = e.target.closest('tr');
    const id = Number(tr.dataset.id);
    const row = list.find(x=>x.id===id);
    if (!confirm(`Удалить промокод ${row?.code || ('#'+id)}?`)) return;
    try{
      await json(API+'/promo/delete',{method:'POST',body:JSON.stringify({id})});
      await loadList();
    }catch(err){ alert('Ошибка: '+(err.message||err)); }
  }

  // ---------- modal actions ----------
  async function saveCurrent(){
    const id = els.mId.value ? Number(els.mId.value) : null;
    const body = {
      id,
      code: (els.mCode.value||'').trim().toUpperCase(),
      enabled: Number(els.mEnabled.value||1),
      realm: (els.mRealm.value||'').trim() || null,
      expires_at: (els.mExp.value||'').trim() || null,
      amount: (els.mAmount.value!==''? Number(els.mAmount.value): null),
      currency_key: (els.mCurr.value||'').trim() || null,
      uses_total: (els.mTotal.value!==''? Number(els.mTotal.value): null),
      per_player_uses: (els.mPer.value!==''? Number(els.mPer.value): null),
      cooldown_seconds: (els.mCd.value!==''? Number(els.mCd.value): null),
      kit_id: (els.mKit.value||'')||null
    };

    try{
      if(!id){
        // create
        const resp = await json(API+'/promo/create',{method:'POST',body:JSON.stringify({
          code: body.code || undefined,
          amount: body.amount || 0,
          currency_key: body.currency_key || 'rubs',
          realm: body.realm,
          kit_id: body.kit_id,
          uses: body.uses_total || 1,
          expires_at: body.expires_at
        })});
        // открываем его же для редактирования
        await loadList();
        const row = list.find(x=>x.id===resp.id) || list.find(x=>x.code===resp.code);
        fillModal(row);
      }else{
        // update
        await json(API+'/promo/update',{method:'POST',body:JSON.stringify(body)});
        await loadList();
        const row = list.find(x=>x.id===id);
        fillModal(row);
      }
      alert('Сохранено');
    }catch(err){
      alert('Ошибка: '+(err.message||err));
    }
  }

  // ---------- groups (LuckPerms) ----------
  function rowGroupTpl(i,g){
    return `<tr>
      <td class="text-secondary">${i+1}</td>
      <td><input class="form-control form-control-sm g-name" value="${g.group_name||''}"></td>
      <td style="width:150px"><input type="number" class="form-control form-control-sm g-temp" value="${g.temp_seconds??''}"></td>
      <td><input class="form-control form-control-sm g-srv" value="${g.context_server||''}"></td>
      <td><input class="form-control form-control-sm g-wld" value="${g.context_world||''}"></td>
      <td style="width:110px"><input type="number" class="form-control form-control-sm g-pr" value="${g.priority??(i+1)}"></td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger g-del">&times;</button></td>
    </tr>`;
  }
  function readGroupsFromUI(){
    const rows=[];
    $$('#pc-groups-body tr').forEach((tr,i)=>{
      const g={
        group_name: $('.g-name',tr).value.trim(),
        temp_seconds: $('.g-temp',tr).value ? Number($('.g-temp',tr).value) : null,
        context_server: $('.g-srv',tr).value.trim()||null,
        context_world: $('.g-wld',tr).value.trim()||null,
        priority: $('.g-pr',tr).value ? Number($('.g-pr',tr).value) : (i+1)
      };
      if(g.group_name) rows.push(g);
    });
    return rows;
  }
  async function loadGroups(codeId){
    els.gBody.innerHTML = '';
    if(!codeId) return;
    try{
      const rows = await json(API+'/promo/groups/list?code_id='+codeId);
      els.gBody.innerHTML = rows.map((g,i)=>rowGroupTpl(i,g)).join('') || '<tr><td colspan="7" class="text-secondary small">Нет групп</td></tr>';
      bindGroupRowEvents();
    }catch(_){
      els.gBody.innerHTML = '<tr><td colspan="7" class="text-secondary small">Нет групп</td></tr>';
    }
  }
  function bindGroupRowEvents(){
    $$('.g-del', els.gBody).forEach(btn=>btn.addEventListener('click', (e)=>{
      e.preventDefault();
      e.target.closest('tr').remove();
    }));
  }
  function addGroupRow(){
    const i = $$('#pc-groups-body tr').length;
    els.gBody.insertAdjacentHTML('beforeend', rowGroupTpl(i, {}));
    bindGroupRowEvents();
  }
  async function saveGroups(){
    const id = Number(els.mId.value||0);
    if(!id) return alert('Сначала сохраните промокод');
    try{
      const groups = readGroupsFromUI();
      await json(API+'/promo/groups/save',{method:'POST',body:JSON.stringify({code_id:id, groups})});
      alert('Группы сохранены');
      await loadGroups(id);
    }catch(err){ alert('Ошибка: '+(err.message||err)); }
  }

  // ---------- redemptions ----------
  async function loadReds(codeId){
    els.rBody.innerHTML = '';
    els.rCount.textContent = '';
    if(!codeId) return;
    try{
      const q = (els.rQuery.value||'').trim();
      const rows = await json(API+`/promo/redemptions?code_id=${codeId}` + (q?`&q=${encodeURIComponent(q)}`:''));
      els.rBody.innerHTML = rows.map(r=>`
        <tr>
          <td>${fmt.date(r.created_at)}</td>
          <td>${r.username||'—'}</td>
          <td class="text-secondary small">${r.uuid}</td>
          <td>${r.granted_amount!=null? (+r.granted_amount).toFixed(2) : '—'}</td>
          <td>${list.find(x=>x.id===r.code_id)?.currency_key || ''}</td>
          <td class="text-secondary">${r.ip||''}</td>
        </tr>
      `).join('') || `<tr><td colspan="6" class="text-secondary small">Пусто</td></tr>`;
      els.rCount.textContent = rows.length ? `${rows.length} активаций` : '';
    }catch(_){
      els.rBody.innerHTML = `<tr><td colspan="6" class="text-secondary small">Ошибка загрузки</td></tr>`;
    }
  }

  // ---------- events ----------
  function bind(){
    // сортировка
    $$('th[data-sort]', els.tbl).forEach(th=>{
      th.addEventListener('click', ()=>{
        const k = th.getAttribute('data-sort');
        if (sortBy===k) sortDir = (sortDir==='asc'?'desc':'asc'); else { sortBy=k; sortDir='asc'; }
        $$('th[data-sort]', els.tbl).forEach(x=>x.classList.remove('desc'));
        if (sortDir==='desc') th.classList.add('desc');
        render();
      });
    });

    els.search.addEventListener('input', render);
    els.btnRef.addEventListener('click', loadList);

    els.btnCreate.addEventListener('click', async ()=>{
      await loadKitsIntoSelect();
      fillModal(null);
      modal && modal.show();
    });

    els.mSave.addEventListener('click', saveCurrent);
    els.mDel.addEventListener('click', async ()=>{
      const id = els.mId.value ? Number(els.mId.value) : null;
      if(!id){ alert('Промокод ещё не сохранён'); return; }
      if(!confirm('Удалить промокод?')) return;
      try{
        await json(API+'/promo/delete',{method:'POST', body:JSON.stringify({id})});
        modal && modal.hide();
        await loadList();
      }catch(err){ alert('Ошибка: '+(err.message||err)); }
    });

    els.gAdd.addEventListener('click', addGroupRow);
    els.gSave.addEventListener('click', saveGroups);

    els.rBtn.addEventListener('click', ()=>loadReds(Number(els.mId.value||0)));
  }

  // ---------- init ----------
  (async function init(){
    grab();
    API = await pickBase();
    bind();
    await loadKitsIntoSelect();
    await loadList();
  })();

})();
</script>
