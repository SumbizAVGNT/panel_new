<script>
(function(){
  'use strict';

  // ---------- helpers ----------
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const API_BASES = ['/admin/promocode/api','/admin/gameservers/promocode/api']; // fallback
  const pickBase = async (path='')=>{
    for (const base of API_BASES){
      try{ const r=await fetch(base+'/ping',{cache:'no-store'}); if(r.ok||r.status===404) return base; }catch(_){}
    }
    return API_BASES[0];
  };
  const json = async (url, opts={})=>{
    const r = await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}}, opts));
    const j = await r.json().catch(()=>({ok:false,error:'bad json'}));
    if(!j.ok) throw new Error(j.error||('HTTP '+r.status));
    return j.data;
  };
  const fmt = {
    money:(a,k)=> a!=null && a!=='' ? `${(+a).toFixed(2)} ${k||''}`.trim() : '—',
    date:(s)=> s ? String(s).replace('T',' ').slice(0,19) : '—'
  };
  const badge = (t,cls='badge-soft')=>`<span class="badge ${cls}">${t}</span>`;
  const copy = (t)=>navigator.clipboard?.writeText(t).catch(()=>{});

  // ---------- state ----------
  let API='';            // выбранный base
  let list=[];           // строки таблицы
  let sortBy='id', sortDir='desc';
  let modal, els={};     // ссылки на элементы

  // ---------- grab ----------
  function grab(){
    els.body     = $('#pc-list');
    els.count    = $('#pc-count');
    els.search   = $('#pc-search');
    els.btnRef   = $('#pc-refresh');
    els.btnCreate= $('#pc-create');
    els.tbl      = $('#pc-table');

    // modal
    els.m         = $('#pcEditModal');
    els.mId       = $('#pc-f-id');
    els.mTitle    = $('#pc-f-title');
    els.mCode     = $('#pc-f-code');
    els.mEnabled  = $('#pc-f-enabled');
    els.mRealm    = $('#pc-f-realm');
    els.mExp      = $('#pc-f-exp');
    els.mAmount   = $('#pc-f-amount');
    els.mCurr     = $('#pc-f-currency');
    els.mTotal    = $('#pc-f-total');
    els.mPer      = $('#pc-f-per');
    els.mCd       = $('#pc-f-cd');
    els.mKit      = $('#pc-f-kit');
    els.mLeft     = $('#pc-f-left');
    els.mSave     = $('#pc-f-save');
    els.mDel      = $('#pc-f-delete');
    els.gBody     = $('#pc-groups-body');
    els.gAdd      = $('#pc-g-add');
    els.gSave     = $('#pc-g-save');
    els.rQuery    = $('#pc-r-player');
    els.rBtn      = $('#pc-r-search');
    els.rCount    = $('#pc-r-count');
    els.rBody     = $('#pc-reds-body');

    // bootstrap modal
    if (window.bootstrap) modal = bootstrap.Modal.getOrCreateInstance(els.m);
  }

  // ---------- kits ----------
  async function loadKitsIntoSelect(){
    els.mKit.innerHTML = `<option value="">— без кита —</option>`;
    try{
      const kits = await json(API+'/kits/list');
      els.mKit.innerHTML += (kits||[]).map(k=>`<option value="${k.id}">${k.name}</option>`).join('');
    }catch(_){}
  }

  // ---------- table ----------
  function render(){
    // ... (rest of the render function)
  }

  async function loadList(){
    // ... (rest of the loadList function)
  }

  // ---------- modal: fill & open ----------
  function fillModal(row){
    // ... (rest of the fillModal function)
  }

  async function onRowEdit(e){
    // ... (rest of the onRowEdit function)
  }

  async function onRowDelete(e){
    // ... (rest of the onRowDelete function)
  }

  // ---------- modal actions ----------
  async function saveCurrent(){
    // ... (rest of the saveCurrent function)
  }

  // ---------- groups (LuckPerms) ----------
  function rowGroupTpl(i,g){
    // ... (rest of the rowGroupTpl function)
  }

  function readGroupsFromUI(){
    // ... (rest of the readGroupsFromUI function)
  }

  async function loadGroups(codeId){
    // ... (rest of the loadGroups function)
  }

  function bindGroupRowEvents(){
    // ... (rest of the bindGroupRowEvents function)
  }

  function addGroupRow(){
    // ... (rest of the addGroupRow function)
  }

  async function saveGroups(){
    // ... (rest of the saveGroups function)
  }

  // ---------- redemptions ----------
  async function loadReds(codeId){
    // ... (rest of the loadReds function)
  }

  // ---------- events ----------
  function bind(){
    // сортировка
    $$('th[data-sort]', els.tbl).forEach(th=>{
      th.addEventListener('click', ()=>{
        const k = th.getAttribute('data-sort');
        if (sortBy===k) sortDir = (sortDir==='asc'?'desc':'asc'); else { sortBy=k; sortDir='asc'; }
        $$('th[data-sort]', els.tbl).forEach(x=>x.classList.remove('desc'));
        if (sortDir==='desc') th.classList.add('desc');
        render();
      });
    });

    els.search.addEventListener('input', render);
    els.btnRef.addEventListener('click', loadList);

    els.btnCreate.addEventListener('click', async ()=>{
      await loadKitsIntoSelect();
      fillModal(null);
      modal && modal.show();
    });

    els.mSave.addEventListener('click', saveCurrent);
    els.mDel.addEventListener('click', async ()=>{
      const id = els.mId.value ? Number(els.mId.value) : null;
      if(!id){ alert('Промокод ещё не сохранён'); return; }
      if(!confirm('Удалить промокод?')) return;
      try{
        await json(API+'/promo/delete',{method:'POST', body:JSON.stringify({id})});
        modal && modal.hide();
        await loadList();
      }catch(err){ alert('Ошибка: '+(err.message||err)); }
    });

    els.gAdd.addEventListener('click', addGroupRow);
    els.gSave.addEventListener('click', saveGroups);

    els.rBtn.addEventListener('click', ()=>loadReds(Number(els.mId.value||0)));
  }

  // ---------- init ----------
  (async function init(){
    grab();
    API = await pickBase();
    bind();
    await loadKitsIntoSelect();
    await loadList();
  })();

})();
</script>