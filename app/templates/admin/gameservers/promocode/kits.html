{% raw %}
<section id="kits-root" class="vstack gap-3" data-mcver="1.20.6">
  <style>
    /* ===== Kits (scoped) ===== */
    #kits-root .glass{background:rgba(13,17,23,.55);border:1px solid rgba(148,163,184,.18);backdrop-filter:blur(8px);border-radius:16px}
    #kits-root .head-bar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    #kits-root .pill{border:1px solid rgba(148,163,184,.25);border-radius:999px;padding:.2rem .6rem;color:#cbd5e1;background:rgba(2,6,23,.35);font-size:.78rem}
    #kits-root .hint{color:#94a3b8;font-size:.86rem}
    #kits-root .sec-title{font-weight:700;color:#e5e7eb}
    #kits-root .dim{color:#94a3b8;font-size:.86rem}

    /* Builder grid */
    #kits-root .builder{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:1100px){#kits-root .builder{grid-template-columns:1fr}}
    #kits-root .slot-grid{display:grid;grid-template-columns:repeat(9,1fr);gap:10px}
    #kits-root .slot{position:relative;background:rgba(2,6,23,.5);border:1px dashed rgba(148,163,184,.3);border-radius:12px;min-height:62px;display:grid;place-items:center;color:#cbd5e1;cursor:pointer;transition:.15s; user-select:none}
    #kits-root .slot:hover{border-color:rgba(148,163,184,.5);transform:translateY(-1px)}
    #kits-root .slot.active{outline:2px solid #60a5fa;outline-offset:2px}
    #kits-root .slot .qty{position:absolute;right:6px;bottom:4px;background:rgba(15,23,42,.8);border:1px solid rgba(148,163,184,.35);border-radius:8px;padding:2px 6px;font-size:.72rem}
    #kits-root .slot .name{max-width:90%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.8rem}
    #kits-root .slot .icon{width:30px;height:30px;image-rendering:pixelated;border-radius:6px;border:1px solid rgba(148,163,184,.25);background:rgba(15,23,42,.6);display:block}
    #kits-root .slot.drag-over{background:rgba(96,165,250,.08);border-style:solid}

    /* Items catalog */
    #kits-root .items-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:10px}
    @media (max-width:1400px){#kits-root .items-grid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:1100px){#kits-root .items-grid{grid-template-columns:repeat(5,1fr)}}
    @media (max-width:900px){#kits-root .items-grid{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:680px){#kits-root .items-grid{grid-template-columns:repeat(3,1fr)}}
    #kits-root .item{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid rgba(148,163,184,.2);border-radius:12px;background:rgba(13,17,23,.55);cursor:grab}
    #kits-root .item:active{cursor:grabbing}
    #kits-root .item .icon{width:28px;height:28px;image-rendering:pixelated;border-radius:6px;border:1px solid rgba(148,163,184,.25);background:rgba(15,23,42,.6)}
    #kits-root .item .n{font-size:.86rem;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Saved kits list */
    #kits-root .right-col{display:grid;grid-template-rows:auto 1fr;gap:12px}
    #kits-root .kit-row{display:flex;align-items:center;gap:10px;padding:8px;border:1px solid rgba(148,163,184,.18);border-radius:12px;background:rgba(13,17,23,.45);cursor:pointer}
    #kits-root .kit-row:hover{border-color:rgba(148,163,184,.35)}
    #kits-root .kit-row.sel{border-color:#60a5fa;box-shadow:0 0 0 2px rgba(96,165,250,.25) inset}
    #kits-root .kit-row .ttl{font-weight:700;color:#e5e7eb}
    #kits-root .kit-row .sub{font-size:.78rem;color:#94a3b8}

    /* skeleton */
    #kits-root .skeleton{position:relative;overflow:hidden;background:rgba(148,163,184,.12);border-radius:10px;min-height:40px}
    #kits-root .skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);transform:translateX(-100%);animation:sk 1.05s infinite}
    @keyframes sk{to{transform:translateX(100%)}}

    /* Autocomplete + chips */
    #kits-root .dd{position:relative;z-index:50}
    #kits-root .dd-list{position:absolute;left:0;right:0;top:calc(100% + 6px);background:#0b1220;border:1px solid rgba(148,163,184,.25);border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.45);max-height:260px;overflow:auto;z-index:5000;pointer-events:auto}
    #kits-root .dd-item{padding:.45rem .6rem;display:flex;justify-content:space-between;gap:.6rem;cursor:pointer}
    #kits-root .dd-item small{color:#94a3b8}
    #kits-root .dd-item:hover,#kits-root .dd-item.act{background:rgba(96,165,250,.12)}
    #kits-root .chips{position:relative;z-index:51}
    #kits-root .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .5rem;border-radius:999px;border:1px solid rgba(148,163,184,.28);background:rgba(15,23,42,.6);margin:.25rem .25rem 0 0}
    #kits-root .chip .lvl{font-weight:700; cursor:pointer}
    #kits-root .chip .x{border:0;background:transparent;color:#e5e7eb;line-height:1;padding:0 .1rem;cursor:pointer}
    #kits-root #ench-input{border:1px solid rgba(148,163,184,.28);background:rgba(15,23,42,.55);color:#e5e7eb;border-radius:10px;padding:.48rem .6rem;width:100%}

    /* Pager */
    #kits-root .pager{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}
    #kits-root .pager .pages{display:flex;align-items:center;gap:6px}
    #kits-root .pager .info{color:#94a3b8;font-size:.86rem}
  </style>

  <!-- Header -->
  <div class="glass p-3 head-bar">
    <div class="d-flex align-items-center gap-2">
      <span class="sec-title">Kits</span>
      <span class="pill"><span id="kit-stats">0 items</span></span>
      <span class="dim" id="kit-hint">создайте или выберите кит слева</span>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button id="kit-new" class="btn btn-sm btn-outline-info"><i class="bi bi-plus-lg me-1"></i>Новый</button>
      <button id="kit-dup" class="btn btn-sm btn-outline-secondary" disabled><i class="bi bi-files me-1"></i>Дублировать</button>
      <button id="kit-save" class="btn btn-sm btn-success" disabled><i class="bi bi-check2-circle me-1"></i>Сохранить</button>
      <button id="kit-del" class="btn btn-sm btn-outline-danger" disabled><i class="bi bi-trash me-1"></i>Удалить</button>
    </div>
  </div>

  <!-- Builder -->
  <div class="builder">
    <!-- left: builder + catalog -->
    <div class="vstack gap-3">
      <div class="glass p-3">
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label mb-1">Название кита</label>
            <input id="kit-name" class="form-control" placeholder="starter, vip, tools">
          </div>
          <div class="col-md-6">
            <label class="form-label mb-1">Описание (опц.)</label>
            <input id="kit-desc" class="form-control" placeholder="короткое описание">
          </div>
        </div>

        <div class="d-flex align-items-center justify-content-between mt-3 mb-1">
          <div class="sec-title">Слоты</div>
          <div class="d-flex align-items-center gap-2">
            <button id="slot-clear" class="btn btn-sm btn-outline-light" disabled><i class="bi bi-x-circle"></i> Очистить слот</button>
          </div>
        </div>
        <div id="slot-grid" class="slot-grid"></div>

        <div id="slot-editor" class="mt-3" hidden>
          <div class="d-flex align-items-center justify-content-between">
            <div class="sec-title">Редактор слота <span id="slot-no" class="pill">—</span></div>
            <div class="hint">клик по слоту — выбрать; Alt+клик или ПКМ — очистить; перетянуть предмет — положить/переместить</div>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-md-4">
              <label class="form-label mb-1">Количество</label>
              <div class="input-group">
                <button class="btn btn-outline-light" data-qty="-1">−</button>
                <input id="slot-qty" type="number" min="1" max="64" value="1" class="form-control">
                <button class="btn btn-outline-light" data-qty="+1">+</button>
              </div>
            </div>
            <div class="col-md-8">
              <label class="form-label mb-1">Отображаемое имя (опц.)</label>
              <div class="input-group">
                <input id="slot-dname" class="form-control" placeholder="Напр. &aStarter &fSword">
                <button id="dname-clear" class="btn btn-outline-secondary" title="Очистить имя"><i class="bi bi-eraser"></i></button>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label mb-1">Enchant / Attr</label>
              <div class="dd">
                <input id="ench-input" placeholder="Начните печатать: sharp..., prot..., attack_damage..." autocomplete="off">
                <div id="ench-dd" class="dd-list d-none"></div>
              </div>
              <div id="slot-enchants" class="chips mt-2"></div>
              <div class="d-flex justify-content-between mt-1">
                <div class="form-text text-secondary">Enter — добавить; клик по уровню на чипе — +1 (Shift — −1); Backspace — удалить последний чип.</div>
                <button id="ench-clear" class="btn btn-sm btn-outline-secondary"><i class="bi bi-x-octagon me-1"></i>Очистить</button>
              </div>
              <input id="slot-extra" type="hidden" value="">
            </div>
          </div>
        </div>
      </div>

      <!-- Catalog -->
      <div class="glass p-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="sec-title">Каталог предметов</div>
          <div class="d-flex align-items-center gap-2">
            <select id="ver-select" class="form-select form-select-sm" style="min-width:220px">
              <option value="vanilla" selected>Vanilla</option>
              <option value="custom">Custom (если есть)</option>
              <option value="all">Все</option>
            </select>
            <div class="input-group input-group-sm" style="min-width:320px">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input id="item-search" class="form-control" placeholder="Поиск (id / name)">
              <button id="item-refresh" class="btn btn-outline-secondary" title="Обновить"><i class="bi bi-arrow-repeat"></i></button>
            </div>
          </div>
        </div>

        <div id="items-wrap" class="items-grid"></div>
        <div id="items-empty" class="text-secondary small mt-2" hidden>Ничего не найдено.</div>

        <!-- Pager -->
        <div id="items-pager" class="pager" hidden>
          <div class="pages">
            <button id="pg-first" class="btn btn-sm btn-outline-secondary" title="В начало">«</button>
            <button id="pg-prev"  class="btn btn-sm btn-outline-secondary" title="Назад">‹</button>
            <span class="info"><span id="pg-page">1</span>/<span id="pg-pages">1</span></span>
            <button id="pg-next"  class="btn btn-sm btn-outline-secondary" title="Вперёд">›</button>
            <button id="pg-last"  class="btn btn-sm btn-outline-secondary" title="В конец">»</button>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="dim">на странице</span>
            <select id="pg-size" class="form-select form-select-sm">
              <option value="48">48</option>
              <option value="96" selected>96</option>
              <option value="144">144</option>
              <option value="240">240</option>
            </select>
            <span class="info"><span id="pg-range">0–0</span> из <span id="pg-total">0</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- right: saved kits list -->
    <div class="right-col">
      <div class="glass p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div class="sec-title">Сохранённые киты</div>
          <div class="d-flex align-items-center gap-2">
            <div class="dim" id="kits-count">—</div>
            <button id="kits-refresh" class="btn btn-sm btn-outline-secondary" title="Обновить список">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
        </div>
        <div id="kits-list" class="vstack gap-2 mt-2">
          <div class="skeleton"></div>
          <div class="skeleton"></div>
          <div class="skeleton"></div>
        </div>
      </div>

      <div class="glass p-3">
        <div class="sec-title mb-1">Подсказки</div>
        <ul class="mb-0 text-secondary small">
          <li>Перетащите предмет из каталога на слот (1–27).</li>
          <li>Клик по слоту — редактирование, Alt+клик или ПКМ — очистить слот.</li>
          <li>Можно перетаскивать между слотами для перемещения/обмена.</li>
          <li>«Сохранить» станет активной, когда есть изменения.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- toast zone -->
  <div id="kits-toasts" class="position-fixed bottom-0 end-0 p-3" style="z-index:1080"></div>
</section>

<script>
window.kitsInit = function() {
  const root = document.getElementById('kits-root');
  if (!root) return;

  const $  = (q, d=root)=>d.querySelector(q);
  const $$ = (q, d=root)=>Array.from(d.querySelectorAll(q));
  const SLOT_COUNT = 27;
  const MC_VER = root.dataset.mcver || "1.20.6";

  let ENCHANTS = [
    "sharpness","smite","bane_of_arthropods","looting","unbreaking","mending","efficiency","fortune",
    "protection","projectile_protection","blast_protection","fire_protection","feather_falling",
    "power","punch","flame","infinity","thorns","respiration","aqua_affinity","soul_speed","swift_sneak",
    "depth_strider","frost_walker","silk_touch","knockback","fire_aspect","sweeping_edge","luck_of_the_sea","lure",
    "attack_damage","attack_speed","max_health","movement_speed","armor","armor_toughness"
  ];

  const iconUrl = (ns, id, hint) => {
    if (hint) return hint;
    ns = ns || 'minecraft';
    if (ns === 'minecraft') return `/static/mc/${MC_VER}/items/${id}.png`;
    return `/static/mc/itemsadder/${ns}.${id}.png`;
  };

  const toast = (msg, type="info")=>{
    const id = "t"+Date.now();
    const box = document.createElement('div');
    box.className = "toast align-items-center text-bg-"+(type==="error"?"danger":(type==="ok"?"success":"dark"))+" border-0 show";
    box.id = id;
    box.role = "alert";
    box.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
    $('#kits-toasts').appendChild(box);
    setTimeout(()=>box.remove(), 3500);
  };

  const API = {
    async kitsList(){ return (await fetch("/promocode/api/kits/list")).json(); },
    async kitsSave(payload){ return (await fetch("/promocode/api/kits/save",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})).json(); },
    async kitsDelete(id){ return (await fetch("/promocode/api/kits/delete",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({id})})).json(); },
    async itemsVanilla(){ return (await fetch("/promocode/api/items/vanilla")).json(); },
    async itemsCustom(){ return (await fetch("/promocode/api/items/custom")).json(); },
    async enchants(){ try{ const r = await fetch("/static/data/enchantments-1.20.6.json"); if(r.ok) return r.json(); }catch{} return null; },
  };

  const state = {
    list: [],
    selectedId: null,
    kit: null,
    items: [],
    dirty: false,
    _sel: null,

    // pagination
    page: 1,
    pageSize: 96,
    filtered: []
  };

  const markDirty = (v=true)=>{
    state.dirty = v;
    $('#kit-save').disabled = !state.dirty || !state.kit || !$('#kit-name').value.trim();
  };

  const updateStats = ()=>{
    const count = (state.kit?.slots||[]).filter(Boolean).length;
    $('#kit-stats').textContent = `${count} items`;
    $('#slot-clear').disabled = (state._sel==null);
    $('#kit-dup').disabled = !state.kit || state.kit.id==null;
    $('#kit-del').disabled = !state.kit || state.kit.id==null;
    $('#kit-save').disabled = !state.dirty || !state.kit || !$('#kit-name').value.trim();
  };

  const selectSlot = (idx)=>{
    state._sel = idx;
    $$('.slot').forEach(x=>x.classList.toggle('active', Number(x.dataset.idx)===idx));
    const it = state.kit?.slots?.[idx] || null;
    $('#slot-editor').hidden = !it;
    $('#slot-no').textContent = it ? ("#"+(idx+1)) : "—";
    $('#slot-qty').value = it?.amount || 1;
    $('#slot-dname').value = it?.display_name || "";
    const wrap = $('#slot-enchants'); wrap.innerHTML = "";
    (it?.enchants||[]).forEach((e,i)=>{
      const chip = document.createElement('span');
      chip.className = "chip";
      chip.innerHTML = `<span>${e.id}</span><span class="lvl" title="Клик: +1, Shift: −1">${e.lvl||1}</span><button class="x" title="Удалить">&times;</button>`;
      chip.querySelector('.x').onclick = (ev)=>{ ev.stopPropagation(); it.enchants.splice(i,1); selectSlot(idx); markDirty(true); };
      chip.querySelector('.lvl').onclick = (ev)=>{
        ev.stopPropagation();
        const up = !ev.shiftKey;
        const cur = Number(e.lvl||1);
        e.lvl = Math.max(1, Math.min(10, cur + (up?1:-1)));
        selectSlot(idx); markDirty(true);
      };
      chip.addEventListener('auxclick', (ev)=>{ if (ev.button===1){ it.enchants.splice(i,1); selectSlot(idx); markDirty(true); }});
      wrap.appendChild(chip);
    });
    updateStats();
  };

  const renderSlots = ()=>{
    const grid = $('#slot-grid');
    const prevSel = state._sel;
    grid.innerHTML = "";
    for (let i=0;i<27;i++){
      const it = state.kit?.slots?.[i] || null;
      const el = document.createElement('div');
      el.className = "slot";
      el.dataset.idx = i;

      if (it){
        const ico = iconUrl(it.namespace, it.item_id, it.icon);
        el.innerHTML = `<img class="icon" alt="${(it.namespace||'minecraft')}:${it.item_id}" src="${ico}" onerror="this.style.visibility='hidden'">
                        <div class="name">${(it.namespace||'minecraft')}:${it.item_id}</div>
                        <span class="qty">${it.amount||1}</span>`;
        el.setAttribute('draggable','true');
        el.addEventListener('dragstart', e=>{
          e.dataTransfer.setData('application/x-slot', JSON.stringify({from:i, move:true}));
          e.dataTransfer.setData('text/plain', JSON.stringify({from:i, move:true, type:'slot'}));
        });
      } else {
        el.innerHTML = `<span class="dim">#${i+1}</span>`;
      }

      el.addEventListener('dragover', e=>{ e.preventDefault(); el.classList.add('drag-over'); });
      el.addEventListener('dragleave', ()=> el.classList.remove('drag-over'));
      el.addEventListener('drop', e=>{
        e.preventDefault(); el.classList.remove('drag-over');
        const raw = e.dataTransfer.getData('application/x-slot') || e.dataTransfer.getData('text/plain');
        if (!raw) return;
        let data = {};
        try{ data = JSON.parse(raw); }catch(_){}
        if (data && typeof data.from === 'number'){
          const from = data.from, to = i;
          if (from===to) return;
          const a = state.kit.slots[from];
          const b = state.kit.slots[to];
          state.kit.slots[to] = a ? {...a, slot: to} : null;
          state.kit.slots[from] = b ? {...b, slot: from} : null;
          renderSlots();
          selectSlot(to);
          markDirty(true);
          return;
        }
        if (data && data.id){
          state.kit.slots[i] = { namespace: data.ns||'minecraft', item_id: data.id, amount: 1, display_name: "", enchants: [], slot: i, icon: data.icon };
          renderSlots(); selectSlot(i); markDirty(true);
        }
      });

      el.addEventListener('click', (ev)=>{
        if (ev.altKey){ if (state.kit.slots[i]){ state.kit.slots[i]=null; renderSlots(); selectSlot(i); markDirty(true);} return; }
        selectSlot(i);
      });
      el.addEventListener('contextmenu', (ev)=>{
        ev.preventDefault();
        if (state.kit.slots[i]){ state.kit.slots[i]=null; renderSlots(); selectSlot(i); markDirty(true); }
      });

      grid.appendChild(el);
    }
    if (prevSel!=null) selectSlot(prevSel);
    updateStats();
  };

  const escapeHtml = (s)=>String(s||"").replace(/[&<>"]/g, t=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[t]));

  const renderKitsList = ()=>{
    const box = $('#kits-list');
    if (!state.list.length){
      box.innerHTML = `<div class="dim">Пока пусто</div>`;
      $('#kits-count').textContent = '0';
      return;
    }
    box.innerHTML = state.list.map(k=>{
      const cnt = (k.items_count!=null ? k.items_count : (k.items||[]).length);
      return `<div class="kit-row ${k.id===state.selectedId?'sel':''}" data-id="${k.id}">
        <div><div class="ttl">${escapeHtml(k.name)}</div>
        <div class="sub">${cnt} items${k.description? ' · '+escapeHtml(k.description):''}</div></div></div>`;
    }).join('');
    $('#kits-count').textContent = String(state.list.length);
    $$('#kits-list .kit-row').forEach(row=>{
      row.addEventListener('click', ()=>{
        const id = parseInt(row.dataset.id,10);
        const k = state.list.find(x=>x.id===id);
        openKit(k);
      });
    });
  };

  const openKit = (k)=>{
    state.selectedId = k?.id ?? null;
    state.kit = { id: k?.id ?? null, name: k?.name ?? "", description: k?.description ?? "", slots: Array.from({length:27}, ()=> null) };
    (k?.items||[]).forEach(it=>{
      const pos = (typeof it.slot==='number' && it.slot>=0 && it.slot<27) ? it.slot : state.kit.slots.findIndex(x=>x==null);
      if (pos>=0) state.kit.slots[pos] = {
        namespace: it.namespace||'minecraft', item_id: it.item_id || it.id,
        amount: it.amount||1, display_name: it.display_name||"", enchants: it.enchants||it.enchantments||[], slot: pos
      };
    });

    $('#kit-name').value = state.kit.name;
    $('#kit-desc').value = state.kit.description;
    renderSlots();
    renderKitsList();
    markDirty(false);
    $('#kit-hint').textContent = k?.id ? `открыт кит #${k.id}` : 'новый кит';
  };

  const newKit = ()=>{ openKit({id:null,name:"",description:"",items:[]}); };
  const duplicateKit = ()=>{
    if (!state.kit || state.kit.id==null) return;
    const source = JSON.parse(JSON.stringify(state.kit));
    source.id = null; source.name = (source.name||"") + " (copy)";
    openKit({ id:null, name:source.name, description:source.description, items: source.slots.filter(Boolean).map(x=>({...x})) });
    markDirty(true);
  };
  const deleteKit = async ()=>{
    if (!state.kit || state.kit.id==null) return;
    if (!confirm("Удалить кит \""+state.kit.name+"\"?")) return;
    const res = await API.kitsDelete(state.kit.id);
    if (!res.ok){ toast(res.error||"Ошибка удаления", "error"); return; }
    toast("Кит удалён","ok"); await loadKits(); newKit();
  };
  const saveKit = async ()=>{
    if (!state.kit) return;
    const items = state.kit.slots.map((it,idx)=> it ? ({
      namespace: it.namespace||'minecraft', item_id: it.item_id,
      amount: Math.max(1, Math.min(64, parseInt(it.amount||1,10))),
      display_name: (it.display_name||'') || null, enchants: it.enchants||[], slot: idx
    }) : null).filter(Boolean);

    const payload = { id: state.kit.id ?? null, name: $('#kit-name').value.trim(), description: $('#kit-desc').value.trim(), items };
    if (!payload.name){ toast("Укажите название кита","error"); return; }

    const res = await API.kitsSave(payload);
    if (!res.ok){ toast(res.error||"Не удалось сохранить", "error"); return; }
    toast("Сохранено","ok"); await loadKits();
    const savedId = (res.data && (res.data.id || res.data.kit?.id)) || res.id || state.kit.id;
    const saved = state.list.find(x=> x.id===savedId) || state.list.find(x=> x.name===payload.name);
    if (saved) openKit(saved); markDirty(false);
  };

  const loadKits = async ()=>{
    try{
      const res = await API.kitsList();
      if (!res.ok){ toast(res.error||"Ошибка загрузки", "error"); return; }
      state.list = Array.isArray(res.data) ? res.data : [];
      renderKitsList();
    }catch(e){ toast("Ошибка сети при загрузке китов","error"); }
  };

  const loadCatalog = async ()=>{
    try{
      const [van, cust] = await Promise.allSettled([API.itemsVanilla(), API.itemsCustom()]);
      const vv = (van.status==="fulfilled" && van.value.ok) ? (van.value.data||[]) : [];
      const cc = (cust.status==="fulfilled" && cust.value.ok) ? (cust.value.data||[]) : [];
      state.items = [...vv, ...cc].map(x=>({ id:x.id, ns:x.ns||x.namespace||'minecraft', name:x.name||x.id, icon:x.icon || iconUrl(x.ns||x.namespace, x.id) }));
      state.page = 1;
      renderCatalog();
    }catch(e){ toast("Ошибка сети при загрузке каталога","error"); }
  };

  const renderPager = (total)=>{
    const pages = Math.max(1, Math.ceil(total / state.pageSize));
    const page  = Math.min(pages, Math.max(1, state.page));
    state.page = page;

    $('#pg-pages').textContent = String(pages);
    $('#pg-page').textContent  = String(page);
    $('#pg-total').textContent = String(total);

    const start = total ? ((page-1)*state.pageSize + 1) : 0;
    const end   = Math.min(total, page*state.pageSize);
    $('#pg-range').textContent = `${start}–${end}`;

    $('#pg-first').disabled = page<=1;
    $('#pg-prev').disabled  = page<=1;
    $('#pg-next').disabled  = page>=pages;
    $('#pg-last').disabled  = page>=pages;

    $('#pg-size').value = String(state.pageSize);
    $('#items-pager').hidden = total <= state.pageSize;
  };

  const renderCatalog = ()=>{
    const wrap = $('#items-wrap');
    const q = ($('#item-search').value||"").trim().toLowerCase();
    const scope = $('#ver-select').value;

    // фильтр
    const list = state.items.filter(x=>{
      const okScope = scope==="vanilla" ? (x.ns==='minecraft' || !x.ns) : scope==="custom" ? (x.ns && x.ns!=='minecraft') : true;
      if (!okScope) return false;
      if (!q) return true;
      return x.id.toLowerCase().includes(q) || (x.name||"").toLowerCase().includes(q) || (`${x.ns}:${x.id}`).toLowerCase().includes(q);
    });
    state.filtered = list;

    // пагинация
    const pages = Math.max(1, Math.ceil(list.length / state.pageSize));
    if (state.page > pages) state.page = pages;
    const start = (state.page - 1) * state.pageSize;
    const end   = start + state.pageSize;
    const pageItems = list.slice(start, end);

    // рендер
    $('#items-empty').hidden = pageItems.length>0;
    wrap.innerHTML = pageItems.map(it=>`
      <div class="item" draggable="true" data-ns="${it.ns}" data-id="${it.id}" data-icon="${it.icon}" title="${it.ns}:${it.id}">
        <img class="icon" alt="${it.ns}:${it.id}" src="${it.icon}" loading="lazy" onerror="this.style.visibility='hidden'">
        <div class="n">${it.ns}:${it.id}</div>
      </div>`).join('');

    $$('.item').forEach(el=>{
      el.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', JSON.stringify({ns:el.dataset.ns,id:el.dataset.id,icon:el.dataset.icon}));
      });
      el.addEventListener('dblclick', ()=>{
        let pos = (state._sel!=null) ? state._sel : state.kit.slots.findIndex(x=>!x);
        if (pos<0) pos=0;
        state.kit.slots[pos] = { namespace: el.dataset.ns||'minecraft', item_id: el.dataset.id, amount:1, display_name:"", enchants:[], slot:pos, icon: el.dataset.icon };
        renderSlots(); selectSlot(pos); markDirty(true);
      });
    });

    renderPager(list.length);
  };

  /* ---------- events ---------- */
  $('#kits-refresh').addEventListener('click', loadKits);
  $('#kit-new').addEventListener('click', newKit);
  $('#kit-dup').addEventListener('click', duplicateKit);
  $('#kit-del').addEventListener('click', deleteKit);
  $('#kit-save').addEventListener('click', saveKit);

  $('#item-refresh').addEventListener('click', ()=>{ state.page=1; loadCatalog(); });
  $('#ver-select').addEventListener('change', ()=>{ state.page=1; renderCatalog(); });
  $('#item-search').addEventListener('input', ()=>{ state.page=1; renderCatalog(); });

  // pager controls
  $('#pg-first').addEventListener('click', ()=>{ state.page=1; renderCatalog(); });
  $('#pg-prev').addEventListener('click',  ()=>{ state.page=Math.max(1,state.page-1); renderCatalog(); });
  $('#pg-next').addEventListener('click',  ()=>{ const pages=Math.max(1,Math.ceil(state.filtered.length/state.pageSize)); state.page=Math.min(pages,state.page+1); renderCatalog(); });
  $('#pg-last').addEventListener('click',  ()=>{ state.page=Math.max(1,Math.ceil(state.filtered.length/state.pageSize)); renderCatalog(); });
  $('#pg-size').addEventListener('change',  ()=>{ state.pageSize=parseInt($('#pg-size').value,10)||96; state.page=1; renderCatalog(); });

  $('#kit-name').addEventListener('input', ()=>markDirty(true));
  $('#kit-desc').addEventListener('input', ()=>markDirty(true));

  $('#slot-clear').addEventListener('click', ()=>{
    if (state._sel==null) return;
    state.kit.slots[state._sel] = null;
    renderSlots(); selectSlot(state._sel); markDirty(true);
  });

  $$('#slot-editor [data-qty]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if (state._sel==null) return;
      const it = state.kit.slots[state._sel]; if (!it) return;
      const delta = parseInt(btn.getAttribute('data-qty'),10);
      it.amount = Math.max(1, Math.min(64, parseInt(it.amount||1,10) + delta));
      $('#slot-qty').value = it.amount;
      renderSlots(); selectSlot(state._sel); markDirty(true);
    });
  });
  $('#slot-qty').addEventListener('input', ()=>{
    if (state._sel==null) return;
    const it = state.kit.slots[state._sel]; if (!it) return;
    it.amount = Math.max(1, Math.min(64, parseInt($('#slot-qty').value||"1",10)));
    renderSlots(); selectSlot(state._sel); markDirty(true);
  });
  $('#slot-dname').addEventListener('input', ()=>{
    if (state._sel==null) return;
    const it = state.kit.slots[state._sel]; if (!it) return;
    it.display_name = $('#slot-dname').value; markDirty(true);
  });
  $('#dname-clear').addEventListener('click', ()=>{
    if (state._sel==null) return;
    $('#slot-dname').value = ""; const it = state.kit.slots[state._sel]; if (!it) return;
    it.display_name = ""; markDirty(true);
  });

  const dd = $('#ench-dd'), input = $('#ench-input');
  const renderDd = ()=>{
    const q = (input.value||"").toLowerCase();
    const list = ENCHANTS.filter(x=>x.includes(q)).slice(0,30);
    if (!list.length){ dd.classList.add('d-none'); dd.innerHTML=""; return; }
    dd.classList.remove('d-none');
    dd.innerHTML = list.map((x,i)=>`<div class="dd-item ${i===0?'act':''}" data-id="${x}"><span>${x}</span><small>lvl 1..10</small></div>`).join('');
    $$('.dd-item', dd).forEach(el=>{ el.addEventListener('click', ()=> addEnchant(el.dataset.id, 1)); });
  };
  const addEnchant = (id, lvl=1)=>{
    if (state._sel==null) return;
    const it = state.kit.slots[state._sel]; if (!it) return;
    if (!it.enchants) it.enchants = [];
    const found = it.enchants.find(e=>e.id===id);
    if (found) found.lvl = lvl; else it.enchants.push({id, lvl});
    input.value = ""; dd.classList.add('d-none'); selectSlot(state._sel); markDirty(true);
  };
  input.addEventListener('input', renderDd);
  input.addEventListener('keydown', e=>{
    if (e.key==="Enter"){ e.preventDefault(); const first = $('.dd-item', dd); if (first) addEnchant(first.dataset.id, 1);
    } else if (e.key==="Backspace" && !input.value){ if (state._sel==null) return; const it = state.kit.slots[state._sel]; if (!it) return; it.enchants?.pop(); selectSlot(state._sel); markDirty(true);
    } else if (e.key==="Escape"){ dd.classList.add('d-none'); }
  });
  document.getElementById('ench-clear').addEventListener('click', ()=>{ if (state._sel==null) return; const it = state.kit.slots[state._sel]; if (!it) return; it.enchants = []; selectSlot(state._sel); markDirty(true); });

  (async function boot(){
    try{ const ench = await API.enchants(); if (ench && Array.isArray(ench)) ENCHANTS = ench; }catch{}
    await Promise.all([loadKits(), loadCatalog()]);
    if (state.list.length) openKit(state.list[0]); else newKit();
  })();
};

window.requestAnimationFrame(()=>window.kitsInit && window.kitsInit());
</script>
{% endraw %}
