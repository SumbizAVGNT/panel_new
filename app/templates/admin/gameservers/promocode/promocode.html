<!-- ===== Toolbar + Table + Modal (Promocodes) ===== -->

<div class="d-flex gap-2 flex-wrap align-items-center mb-2 pc-toolbar">
  <input id="pc-search" class="form-control form-control-sm" placeholder="Поиск по коду…">
  <button id="pc-refresh" class="btn btn-sm btn-outline-light">
    <i class="bi bi-arrow-repeat me-1"></i>Обновить
  </button>
  <button id="pc-create" class="btn btn-sm btn-primary">
    <i class="bi bi-plus-lg me-1"></i>Создать промокод
  </button>
  <span id="pc-count" class="text-secondary small ms-auto"></span>
</div>

<div class="table-responsive glass-card">
  <table id="pc-table" class="table table-dark table-striped table-sm align-middle mb-0">
    <thead class="text-secondary small">
    <tr>
      <th data-sort="code"        style="cursor:pointer">Код</th>
      <th data-sort="enabled"     style="cursor:pointer">Статус</th>
      <th data-sort="amount"      style="cursor:pointer">Награда</th>
      <th data-sort="realm"       style="cursor:pointer">Realm</th>
      <th data-sort="limits"      style="cursor:default">Лимиты</th>
      <th data-sort="expires_at"  style="cursor:pointer">Срок</th>
      <th data-sort="kit_name"    style="cursor:pointer">Kit</th>
      <th data-sort="uses_left"   style="cursor:pointer">Активаций</th>
      <th class="text-end">Действия</th>
    </tr>
    </thead>
    <tbody id="pc-list">
      <!-- rows заполняются скриптом -->
    </tbody>
  </table>
</div>

<!-- Modal: редактирование/создание промокода -->
<div class="modal fade" id="pcEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark border-secondary">
      <div class="modal-header">
        <h5 class="modal-title">
          Промокод <span id="pc-f-title" class="text-secondary"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>

      <div class="modal-body">

        <!-- Основные поля -->
        <input type="hidden" id="pc-f-id">
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label small">Код</label>
            <input id="pc-f-code" class="form-control form-control-sm" placeholder="например, SUMMER2025">
          </div>
          <div class="col-md-2">
            <label class="form-label small">Активен</label>
            <select id="pc-f-enabled" class="form-select form-select-sm">
              <option value="1">Да</option>
              <option value="0">Нет</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label small">Realm</label>
            <input id="pc-f-realm" class="form-control form-control-sm" placeholder="anarchy / пусто = любой">
          </div>
          <div class="col-md-3">
            <label class="form-label small">Истекает (YYYY-MM-DD HH:MM:SS)</label>
            <input id="pc-f-exp" class="form-control form-control-sm" placeholder="">
          </div>

          <div class="col-md-3">
            <label class="form-label small">Сумма</label>
            <input id="pc-f-amount" type="number" step="0.01" class="form-control form-control-sm" placeholder="0">
          </div>
          <div class="col-md-3">
            <label class="form-label small">Валюта</label>
            <input id="pc-f-currency" class="form-control form-control-sm" placeholder="rubs / coins / …" value="rubs">
          </div>
          <div class="col-md-2">
            <label class="form-label small">Всего использований</label>
            <input id="pc-f-total" type="number" min="0" class="form-control form-control-sm" placeholder="0 = безлимит">
          </div>
          <div class="col-md-2">
            <label class="form-label small">Per-player</label>
            <input id="pc-f-per" type="number" min="0" class="form-control form-control-sm" placeholder="null">
          </div>
          <div class="col-md-2">
            <label class="form-label small">Кулдаун (сек)</label>
            <input id="pc-f-cd" type="number" min="0" class="form-control form-control-sm">
          </div>
          <div class="col-md-2">
            <label class="form-label small">Kit</label>
            <select id="pc-f-kit" class="form-select form-select-sm">
              <option value="">— без кита —</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small">Осталось использ.</label>
            <input id="pc-f-left" type="number" class="form-control form-control-sm" disabled>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2 mt-2">
          <button class="btn btn-sm btn-success" id="pc-f-save">
            <i class="bi bi-check2 me-1"></i>Сохранить
          </button>
          <button class="btn btn-sm btn-outline-danger" id="pc-f-delete">
            <i class="bi bi-trash me-1"></i>Удалить
          </button>
          <span id="pc-f-hint" class="text-secondary small">Если оставить поле «Код» пустым — сгенерируется автоматически.</span>
        </div>

        <hr class="border-secondary my-3">

        <!-- LuckPerms группы -->
        <div class="d-flex align-items-center justify-content-between">
          <h6 class="m-0">LuckPerms группы</h6>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-light" id="pc-g-add">+ группа</button>
            <button class="btn btn-sm btn-primary" id="pc-g-save">Сохранить группы</button>
          </div>
        </div>

        <div class="table-responsive mt-2">
          <table class="table table-dark table-sm align-middle">
            <thead class="text-secondary small">
            <tr>
              <th style="width:50px">#</th>
              <th>group</th>
              <th>temp_seconds</th>
              <th>server</th>
              <th>world</th>
              <th style="width:110px">priority</th>
              <th style="width:64px"></th>
            </tr>
            </thead>
            <tbody id="pc-groups-body">
              <!-- строки групп генерируются скриптом -->
            </tbody>
          </table>
        </div>

        <hr class="border-secondary my-3">

        <!-- Активации игроков -->
        <div class="d-flex align-items-center gap-2">
          <h6 class="m-0">Активации игроков</h6>
          <input id="pc-r-player" class="form-control form-control-sm" placeholder="поиск по нику/uuid" style="max-width:260px">
          <button class="btn btn-sm btn-outline-light" id="pc-r-search"><i class="bi bi-search"></i></button>
          <span id="pc-r-count" class="text-secondary small ms-auto"></span>
        </div>

        <div class="table-responsive mt-2">
          <table class="table table-dark table-sm align-middle">
            <thead class="text-secondary small">
            <tr>
              <th>Время</th>
              <th>Игрок</th>
              <th>UUID</th>
              <th>Сумма</th>
              <th>Валюта</th>
              <th>IP</th>
            </tr>
            </thead>
            <tbody id="pc-reds-body">
              <!-- строки активаций генерируются скриптом -->
            </tbody>
          </table>
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Visual polish (glass) ===== -->
<style>
#pc-table{--bs-table-bg:rgba(15,23,42,.65);--bs-table-striped-bg:rgba(148,163,184,.05)}
#pc-table th,#pc-table td{vertical-align:middle}
.pc-toolbar .form-control{min-width:260px;background:rgba(2,6,23,.55);border-color:rgba(148,163,184,.25);color:#e5e7eb}
.pc-toolbar .btn{border-radius:.65rem}
.badge-soft{background:rgba(148,163,184,.12);border:1px solid rgba(148,163,184,.22);color:#e5e7eb}
.text-dim{color:#94a3b8!important}
.text-expired{color:#ef4444!important}
.glass-card{background:rgba(13,17,23,.55);border:1px solid rgba(148,163,184,.18);backdrop-filter:blur(6px);border-radius:14px}
.modal-content.bg-dark{background:rgba(13,17,23,.92)!important}
.table thead th[data-sort]{user-select:none}
.table thead th[data-sort]::after{content:"";display:inline-block;margin-left:.35rem;border:4px solid transparent;border-top-color:rgba(148,163,184,.55);transform:translateY(-2px)}
.table thead th[data-sort].desc::after{border-top-color:transparent;border-bottom-color:rgba(148,163,184,.75);transform:translateY(3px)}
</style>

<!-- ===== Logic ===== -->
<script>
(function(){
  'use strict';

  // -------- helpers
  const $ = (s, r=document)=>r.querySelector(s);
  const $$= (s, r=document)=>Array.from(r.querySelectorAll(s));
  const API_BASES = ['/admin/promocode/api','/admin/gameservers/promocode/api'];
  const chooseBase = async ()=>{
    for(const b of API_BASES){
      try{ const r=await fetch(b+'/promo/list',{method:'GET'}); if(r.ok) return b; }catch(_){}
    }
    return API_BASES[0];
  };
  const jget = async (url)=> (await (await fetch(url,{cache:'no-store'})).json());
  const jpost= async (url,body)=> (await (await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})})).json()));
  const fmtMoney=(a,k)=> a!=null&&a!==''? `${(+a).toFixed(2)} ${k||''}`.trim():'—';
  const fmtDate =(s)=> s? String(s).replace('T',' ').slice(0,19):'—';
  const badge   =(t,cls='badge-soft')=>`<span class="badge ${cls}">${t}</span>`;
  const copyTxt =(t)=>navigator.clipboard?.writeText(t).catch(()=>{});

  // -------- state
  let API='', rows=[], sortBy='id', sortDir='desc';
  let modal;
  const els = {
    list: $('#pc-list'), cnt: $('#pc-count'), search: $('#pc-search'),
    ref: $('#pc-refresh'), create: $('#pc-create'), table: $('#pc-table'),
    m: $('#pcEditModal'),
    mId: $('#pc-f-id'), mTitle: $('#pc-f-title'), mCode: $('#pc-f-code'),
    mEnabled: $('#pc-f-enabled'), mRealm: $('#pc-f-realm'), mExp: $('#pc-f-exp'),
    mAmount: $('#pc-f-amount'), mCurr: $('#pc-f-currency'),
    mTotal: $('#pc-f-total'), mPer: $('#pc-f-per'), mCd: $('#pc-f-cd'),
    mKit: $('#pc-f-kit'), mLeft: $('#pc-f-left'),
    mSave: $('#pc-f-save'), mDel: $('#pc-f-delete'),
    gBody: $('#pc-groups-body'), gAdd: $('#pc-g-add'), gSave: $('#pc-g-save'),
    rQ: $('#pc-r-player'), rBtn: $('#pc-r-search'), rCnt: $('#pc-r-count'), rBody: $('#pc-reds-body'),
  };

  if (window.bootstrap) modal = bootstrap.Modal.getOrCreateInstance(els.m);

  // -------- kits
  async function loadKitsSelect(){
    try{
      const j = await jget(API+'/kits/list'); if(!j.ok) return;
      els.mKit.innerHTML = `<option value="">— без кита —</option>` + (j.data||[]).map(k=>`<option value="${k.id}">${k.name}</option>`).join('');
    }catch(_){}
  }

  // -------- table
  function paint(){
    const q = (els.search.value||'').trim().toLowerCase();
    let list = rows.filter(x => !q || String(x.code).toLowerCase().includes(q));
    list.sort((a,b)=>{
      const A=a[sortBy], B=b[sortBy];
      if(['id','amount','uses_left','uses_total'].includes(sortBy)) return (Number(A)||0)-(Number(B)||0);
      return String(A??'').localeCompare(String(B??''));
    });
    if(sortDir==='desc') list.reverse();
    els.cnt.textContent = list.length ? `${list.length} шт.` : '';

    if(!list.length){
      els.list.innerHTML = `<tr><td colspan="9" class="text-secondary small">Нет данных</td></tr>`;
      return;
    }
    const now = Date.now();
    els.list.innerHTML = list.map(x=>{
      const used = (x.uses_total!=null && x.uses_left!=null) ? (x.uses_total - x.uses_left) : '—';
      const st = (+x.enabled ? badge('active') : badge('off','bg-secondary'));
      const lim = (x.uses_total!=null) ? `${x.uses_left}/${x.uses_total}` : '∞';
      const expTs = x.expires_at ? Date.parse(String(x.expires_at).replace(' ','T')) : null;
      const expStr = fmtDate(x.expires_at);
      const expHtml = expTs && expTs < now ? `<span class="text-expired" title="истёк">${expStr}</span>` : expStr;

      return `<tr data-id="${x.id}">
        <td class="fw-semibold">${x.code}</td>
        <td>${st}</td>
        <td>${fmtMoney(x.amount, x.currency_key)}</td>
        <td>${x.realm || '<span class="text-dim">all</span>'}</td>
        <td>${lim}</td>
        <td>${expHtml}</td>
        <td>${x.kit_name? badge(x.kit_name): ''}</td>
        <td class="text-end">${used}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-light act-edit">Изм.</button>
            <button class="btn btn-outline-secondary act-copy" title="Скопировать"><i class="bi bi-clipboard"></i></button>
            <button class="btn btn-outline-danger act-del">Удалить</button>
          </div>
        </td>
      </tr>`;
    }).join('');

    $$('.act-edit', els.list).forEach(b=>b.addEventListener('click', openEdit));
    $$('.act-copy', els.list).forEach(b=>b.addEventListener('click', e=>{
      const tr=e.target.closest('tr'); const r=rows.find(x=>x.id==tr.dataset.id); if(r) copyTxt(r.code);
    }));
    $$('.act-del', els.list).forEach(b=>b.addEventListener('click', delOne));
  }

  async function loadList(){
    els.list.innerHTML = `<tr><td colspan="9" class="text-secondary small">Загрузка…</td></tr>`;
    try{
      const j = await jget(API+'/promo/list');
      if(!j.ok) throw new Error(j.error||'list');
      rows = j.data||[];
      paint();
    }catch(e){
      els.list.innerHTML = `<tr><td colspan="9" class="text-danger">${e.message||e}</td></tr>`;
    }
  }

  // -------- modal fill + groups/reds
  function fillModal(row){
    els.mId.value = row?.id ?? '';
    els.mTitle.textContent = row ? `#${row.id}` : '(новый)';
    els.mCode.value = row?.code ?? '';
    els.mEnabled.value = (row?.enabled ?? 1) ? '1':'0';
    els.mRealm.value = row?.realm ?? '';
    els.mExp.value = row?.expires_at ?? '';
    els.mAmount.value = row?.amount ?? '';
    els.mCurr.value = row?.currency_key ?? 'rubs';
    els.mTotal.value = row?.uses_total ?? '';
    els.mPer.value = row?.per_player_uses ?? '';
    els.mCd.value = row?.cooldown_seconds ?? '';
    els.mLeft.value = row?.uses_left ?? '';
    els.mKit.value = row?.kit_id ?? '';
    // подтянем группы и активации
    loadGroups(row?.id);
    loadReds(row?.id);
  }

  async function openEdit(e){
    const tr=e.target.closest('tr');
    const id=Number(tr.dataset.id);
    const row = rows.find(x=>x.id===id);
    await loadKitsSelect();
    fillModal(row);
    modal ? modal.show() : els.m.classList.add('show'); // fallback если нет bootstrap.js
  }

  async function delOne(e){
    const tr=e.target.closest('tr');
    const id=Number(tr.dataset.id);
    const row = rows.find(x=>x.id===id);
    if(!confirm(`Удалить промокод ${row?.code || ('#'+id)}?`)) return;
    try{
      const j = await jpost(API+'/promo/delete',{id});
      if(!j.ok) throw new Error(j.error||'delete');
      await loadList();
    }catch(err){ alert('Ошибка: '+(err.message||err)); }
  }

  // -------- save (create/update)
  async function saveCurrent(){
    const id = els.mId.value ? Number(els.mId.value) : null;
    const body = {
      id,
      code: (els.mCode.value||'').trim().toUpperCase(),
      enabled: Number(els.mEnabled.value||1),
      realm: (els.mRealm.value||'').trim() || null,
      expires_at: (els.mExp.value||'').trim() || null,
      amount: (els.mAmount.value!==''? Number(els.mAmount.value): null),
      currency_key: (els.mCurr.value||'').trim() || null,
      uses_total: (els.mTotal.value!==''? Number(els.mTotal.value): null),
      per_player_uses: (els.mPer.value!==''? Number(els.mPer.value): null),
      cooldown_seconds: (els.mCd.value!==''? Number(els.mCd.value): null),
      kit_id: (els.mKit.value? Number(els.mKit.value) : null)
    };

    try{
      if(!id){
        // create (upsert)
        const j = await jpost(API+'/promo/create',{
          code: body.code || undefined,
          amount: body.amount || 0,
          currency_key: body.currency_key || 'rubs',
          realm: body.realm,
          kit_id: body.kit_id,
          uses: body.uses_total || 1,
          expires_at: body.expires_at
        });
        if(!j.ok) throw new Error(j.error||'create');
        // открыть именно созданный (учёт автогенерации кода)
        await loadList();
        const created = rows.find(x=>x.id===j.data?.id) || rows.find(x=>x.code===j.data?.code);
        if(created){ fillModal(created); }
      }else{
        // update
        const resp = await fetch(API+'/promo/update',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        if(resp.status===404){
          alert('Обновление недоступно: реализуйте /promo/update на бэке (без сброса uses_left).');
          return;
        }
        const j = await resp.json();
        if(!j.ok) throw new Error(j.error||'update');
        await loadList();
        const updated = rows.find(x=>x.id===id);
        if(updated){ fillModal(updated); }
      }
      alert('Сохранено');
    }catch(err){
      alert('Ошибка: '+(err.message||err));
    }
  }

  // -------- groups (LP)
  function groupRow(i,g){
    return `<tr>
      <td class="text-secondary">${i+1}</td>
      <td><input class="form-control form-control-sm g-name" value="${g.group_name||''}"></td>
      <td style="width:150px"><input type="number" class="form-control form-control-sm g-temp" value="${g.temp_seconds??''}"></td>
      <td><input class="form-control form-control-sm g-srv" value="${g.context_server||''}"></td>
      <td><input class="form-control form-control-sm g-wld" value="${g.context_world||''}"></td>
      <td style="width:110px"><input type="number" class="form-control form-control-sm g-pr" value="${g.priority??(i+1)}"></td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger g-del">&times;</button></td>
    </tr>`;
  }
  function groupsFromUI(){
    const out=[];
    $$('#pc-groups-body tr').forEach((tr,i)=>{
      const g={
        group_name: $('.g-name',tr).value.trim(),
        temp_seconds: $('.g-temp',tr).value ? Number($('.g-temp',tr).value) : null,
        context_server: $('.g-srv',tr).value.trim()||null,
        context_world: $('.g-wld',tr).value.trim()||null,
        priority: $('.g-pr',tr).value ? Number($('.g-pr',tr).value) : (i+1)
      };
      if(g.group_name) out.push(g);
    });
    return out;
  }
  function bindGroupRowEvents(){
    $$('.g-del', els.gBody).forEach(b=>b.addEventListener('click', e=>e.target.closest('tr').remove()));
  }
  async function loadGroups(codeId){
    els.gBody.innerHTML='';
    if(!codeId) return;
    try{
      const r = await fetch(API+'/promo/groups/list?code_id='+codeId);
      if(r.status===404){ els.gBody.innerHTML='<tr><td colspan="7" class="text-secondary small">Endpoint /promo/groups/* не реализован</td></tr>'; return; }
      const j = await r.json(); if(!j.ok) throw new Error(j.error||'groups');
      const rows = j.data||[];
      els.gBody.innerHTML = rows.map((g,i)=>groupRow(i,g)).join('') || '<tr><td colspan="7" class="text-secondary small">Нет групп</td></tr>';
      bindGroupRowEvents();
    }catch(_){
      els.gBody.innerHTML='<tr><td colspan="7" class="text-secondary small">Не удалось загрузить группы</td></tr>';
    }
  }
  function addGroupRow(){
    const i=$$('#pc-groups-body tr').length;
    els.gBody.insertAdjacentHTML('beforeend', groupRow(i,{}));
    bindGroupRowEvents();
  }
  async function saveGroups(){
    const id = Number(els.mId.value||0);
    if(!id) return alert('Сначала сохраните промокод');
    try{
      const resp = await fetch(API+'/promo/groups/save',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({code_id:id, groups: groupsFromUI()})
      });
      if(resp.status===404){ alert('Реализуйте /promo/groups/save на бэке'); return; }
      const j = await resp.json(); if(!j.ok) throw new Error(j.error||'save groups');
      alert('Группы сохранены');
      await loadGroups(id);
    }catch(err){ alert('Ошибка: '+(err.message||err)); }
  }

  // -------- redemptions
  async function loadReds(codeId){
    els.rBody.innerHTML='';
    els.rCnt.textContent='';
    if(!codeId) return;
    try{
      const q=(els.rQ.value||'').trim();
      const codeRow = rows.find(x=>x.id===codeId);
      const url = API+`/promo/redemptions?code=${encodeURIComponent(codeRow?.code||'')}` + (q?`&q=${encodeURIComponent(q)}`:'');
      const j = await jget(url); if(!j.ok) throw new Error(j.error||'reds');
      const data = j.data||[];
      els.rBody.innerHTML = data.map(r=>`
        <tr>
          <td>${fmtDate(r.created_at)}</td>
          <td>${r.username||'—'}</td>
          <td class="text-secondary small">${r.uuid}</td>
          <td>${r.granted_amount!=null? (+r.granted_amount).toFixed(2) : '—'}</td>
          <td>${rows.find(x=>x.id===r.code_id)?.currency_key || ''}</td>
          <td class="text-secondary">${r.ip||''}</td>
        </tr>
      `).join('') || `<tr><td colspan="6" class="text-secondary small">Пусто</td></tr>`;
      els.rCnt.textContent = data.length ? `${data.length} активаций` : '';
    }catch(_){
      els.rBody.innerHTML = `<tr><td colspan="6" class="text-secondary small">Ошибка загрузки</td></tr>`;
    }
  }

  // -------- events
  function bind(){
    // сорт
    $$('th[data-sort]', els.table).forEach(th=>{
      th.addEventListener('click', ()=>{
        const k = th.getAttribute('data-sort');
        if(sortBy===k) sortDir = (sortDir==='asc'?'desc':'asc'); else { sortBy=k; sortDir='asc'; }
        $$('th[data-sort]', els.table).forEach(x=>x.classList.remove('desc'));
        if(sortDir==='desc') th.classList.add('desc');
        paint();
      });
    });
    els.search.addEventListener('input', paint);
    els.ref.addEventListener('click', loadList);
    els.create.addEventListener('click', async ()=>{
      await loadKitsSelect();
      fillModal(null);
      modal ? modal.show() : els.m.classList.add('show');
    });
    els.mSave.addEventListener('click', saveCurrent);
    els.mDel.addEventListener('click', async ()=>{
      const id = els.mId.value ? Number(els.mId.value) : null;
      if(!id){ alert('Промокод ещё не сохранён'); return; }
      if(!confirm('Удалить промокод?')) return;
      const j = await jpost(API+'/promo/delete',{id});
      if(!j.ok){ alert(j.error||'Ошибка удаления'); return; }
      modal && modal.hide();
      await loadList();
    });
    els.gAdd.addEventListener('click', addGroupRow);
    els.gSave.addEventListener('click', saveGroups);
    els.rBtn.addEventListener('click', ()=>loadReds(Number(els.mId.value||0)));
    els.rQ.addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadReds(Number(els.mId.value||0)); });
    // быстрый копи по клику на код
    els.list.addEventListener('click', (e)=>{
      const cell = e.target.closest('td'); const tr = e.target.closest('tr');
      if(!cell || !tr) return;
      if(cell.cellIndex===0){ const r=rows.find(x=>x.id==tr.dataset.id); if(r) copyTxt(r.code); }
    });
  }

  // -------- init
  (async function init(){
    API = await chooseBase();
    bind();
    await loadKitsSelect();
    await loadList();
  })();

})();
</script>
