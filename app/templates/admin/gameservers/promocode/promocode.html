<!-- ===================== PROMOCODES – AURORA/GLASS UI ===================== -->
<!-- Toolbar + Table + Modal + Styles + Logic (one file) -->

<!-- ===== Toolbar + Table ===== -->
<div class="pc-wrap">
  <!-- Aurora background -->
  <div class="aurora-overlay"></div>

  <!-- Toolbar -->
  <div class="pc-toolbar glass-card">
    <div class="left">
      <div class="input-icon">
        <i class="bi bi-search"></i>
        <input id="pc-search" class="form-control form-control-sm" placeholder="Поиск по коду…">
      </div>

      <select id="pc-filter-status" class="form-select form-select-sm" title="Статус">
        <option value="">Статус: все</option>
        <option value="1">Только активные</option>
        <option value="0">Только выключенные</option>
      </select>

      <select id="pc-filter-realm" class="form-select form-select-sm" title="Realm">
        <option value="">Realm: все</option>
      </select>

      <select id="pc-filter-kit" class="form-select form-select-sm" title="Kit">
        <option value="">Kit: любой</option>
      </select>
    </div>

    <div class="right">
      <button id="pc-refresh" class="btn btn-sm btn-outline-light btn-ghost">
        <i class="bi bi-arrow-repeat me-1"></i>Обновить
      </button>
      <button id="pc-create" class="btn btn-sm btn-primary btn-neon">
        <i class="bi bi-plus-lg me-1"></i>Создать
      </button>
      <span id="pc-count" class="text-secondary small"></span>
    </div>
  </div>

  <!-- Table -->
  <div class="table-responsive glass-card">
    <table id="pc-table" class="table table-dark table-striped table-sm align-middle mb-0">
      <thead class="text-secondary small sticky-head">
      <tr>
        <th data-sort="code"        style="cursor:pointer">Код</th>
        <th data-sort="enabled"     style="cursor:pointer">Статус</th>
        <th data-sort="amount"      style="cursor:pointer">Награда</th>
        <th data-sort="realm"       style="cursor:pointer">Realm</th>
        <th data-sort="limits"      style="cursor:default">Лимиты</th>
        <th data-sort="expires_at"  style="cursor:pointer">Срок</th>
        <th data-sort="kit_name"    style="cursor:pointer">Kit</th>
        <th data-sort="uses_left"   class="text-end" style="cursor:pointer">Активаций</th>
        <th class="text-end">Действия</th>
      </tr>
      </thead>
      <tbody id="pc-list">
        <!-- скелетоны вставляются скриптом -->
      </tbody>
    </table>
  </div>
</div>

<!-- ===== Modal: редактирование/создание ===== -->
<div class="modal fade" id="pcEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content glass-modal">

      <!-- Aurora header -->
      <div class="modal-header mod-aurora">
        <div class="mod-aurora__title">
          <div class="mod-aurora__dot"></div>
          <div>
            <div class="mod-aurora__caption">Промокод</div>
            <div class="mod-aurora__sub">Редактор <span id="pc-f-title" class="text-secondary"></span></div>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="pc-f-id">

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label small text-dim">Код</label>
            <div class="input-group input-group-sm">
              <input id="pc-f-code" class="form-control" placeholder="например, SUMMER2025">
              <button id="pc-f-gen" class="btn btn-outline-secondary" title="Сгенерировать"><i class="bi bi-magic"></i></button>
            </div>
          </div>
          <div class="col-md-2">
            <label class="form-label small text-dim">Активен</label>
            <select id="pc-f-enabled" class="form-select form-select-sm">
              <option value="1">Да</option>
              <option value="0">Нет</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label small text-dim">Realm</label>
            <input id="pc-f-realm" class="form-control form-control-sm" placeholder="anarchy / пусто = любой">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-dim">Истекает (YYYY-MM-DD HH:MM:SS)</label>
            <input id="pc-f-exp" class="form-control form-control-sm">
          </div>

          <div class="col-md-3">
            <label class="form-label small text-dim">Сумма</label>
            <input id="pc-f-amount" type="number" step="0.01" class="form-control form-control-sm" placeholder="0">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-dim">Валюта</label>
            <input id="pc-f-currency" class="form-control form-control-sm" placeholder="rubs / coins / …" value="rubs">
          </div>
          <div class="col-md-2">
            <label class="form-label small text-dim">Всего использований</label>
            <input id="pc-f-total" type="number" min="0" class="form-control form-control-sm" placeholder="0 = безлимит">
          </div>
          <div class="col-md-2">
            <label class="form-label small text-dim">Per-player</label>
            <input id="pc-f-per" type="number" min="0" class="form-control form-control-sm" placeholder="null">
          </div>
          <div class="col-md-2">
            <label class="form-label small text-dim">Кулдаун (сек)</label>
            <input id="pc-f-cd" type="number" min="0" class="form-control form-control-sm">
          </div>
          <div class="col-md-2">
            <label class="form-label small text-dim">Kit</label>
            <select id="pc-f-kit" class="form-select form-select-sm">
              <option value="">— без кита —</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small text-dim">Осталось использ.</label>
            <input id="pc-f-left" type="number" class="form-control form-control-sm" disabled>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2 mt-3">
          <button class="btn btn-sm btn-success btn-neon" id="pc-f-save">
            <i class="bi bi-check2 me-1"></i>Сохранить
          </button>
          <button class="btn btn-sm btn-outline-danger" id="pc-f-delete">
            <i class="bi bi-trash me-1"></i>Удалить
          </button>
          <span id="pc-f-hint" class="text-secondary small">Оставьте «Код» пустым — сгенерируется автоматически.</span>
        </div>

        <hr class="border-secondary my-4">

        <!-- LuckPerms группы -->
        <div class="d-flex align-items-center justify-content-between">
          <h6 class="m-0">LuckPerms группы</h6>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-light" id="pc-g-add">+ группа</button>
            <button class="btn btn-sm btn-primary btn-ghost" id="pc-g-save">Сохранить группы</button>
          </div>
        </div>

        <div class="table-responsive mt-2 glass-subcard">
          <table class="table table-dark table-sm align-middle nice-table">
            <thead class="text-secondary small">
            <tr>
              <th style="width:50px">#</th>
              <th>group</th>
              <th>temp_seconds</th>
              <th>server</th>
              <th>world</th>
              <th style="width:110px">priority</th>
              <th style="width:64px"></th>
            </tr>
            </thead>
            <tbody id="pc-groups-body"></tbody>
          </table>
        </div>

        <hr class="border-secondary my-4">

        <!-- Активации игроков -->
        <div class="d-flex align-items-center gap-2">
          <h6 class="m-0">Активации игроков</h6>
          <input id="pc-r-player" class="form-control form-control-sm" placeholder="поиск по нику/uuid" style="max-width:260px">
          <button class="btn btn-sm btn-outline-light" id="pc-r-search"><i class="bi bi-search"></i></button>
          <span id="pc-r-count" class="text-secondary small ms-auto"></span>
        </div>

        <div class="table-responsive mt-2 glass-subcard">
          <table class="table table-dark table-sm align-middle nice-table">
            <thead class="text-secondary small">
            <tr>
              <th>Время</th>
              <th>Игрок</th>
              <th>UUID</th>
              <th>Сумма</th>
              <th>Валюта</th>
              <th>IP</th>
            </tr>
            </thead>
            <tbody id="pc-reds-body"></tbody>
          </table>
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Toast zone ===== -->
<div id="pc-toasts" class="pc-toasts"></div>

<!-- ===== Visual: AURORA + GLASS ===== -->
<style>
:root{
  --pc-bg: rgba(13,17,23,.55);
  --pc-br: rgba(148,163,184,.18);
  --pc-blur: 10px;
  --pc-glow: 0 0 0 1px rgba(96,165,250,.20), 0 12px 42px rgba(2,132,199,.22);
  --pc-green: #10b981;
  --pc-red: #ef4444;
  --pc-cyan: #22d3ee;
  --pc-blue: #60a5fa;
  --pc-violet:#a78bfa;
  --pc-dim: #94a3b8;
  --pc-text: #e5e7eb;
}

.pc-wrap{position:relative; display:grid; gap:14px}

/* Aurora background */
.aurora-overlay{
  position:absolute; inset:-40px;
  pointer-events:none; z-index:0;
  background:
    radial-gradient(500px 300px at 15% 0%, rgba(34,211,238,.12), transparent 50%),
    radial-gradient(700px 420px at 85% 10%, rgba(96,165,250,.10), transparent 55%),
    conic-gradient(from 180deg at 70% 10%, rgba(167,139,250,.12), rgba(34,211,238,.10), rgba(96,165,250,.10), transparent 60%);
  filter: blur(28px) saturate(120%);
  animation: auroraShift 16s ease-in-out infinite alternate;
}
@keyframes auroraShift{
  0%{ transform:translateY(-6px) scale(1.02); opacity:.75 }
  100%{ transform:translateY(6px) scale(1.03); opacity:.9 }
}

/* Glass cards */
.glass-card{
  position:relative; z-index:1;
  background:var(--pc-bg);
  border:1px solid var(--pc-br);
  backdrop-filter: blur(var(--pc-blur));
  border-radius:16px;
  padding:.75rem;
  box-shadow: var(--pc-glow);
}
.glass-subcard{
  background:rgba(2,6,23,.45);
  border:1px solid rgba(148,163,184,.15);
  border-radius:14px;
  padding:.5rem;
}

/* Modal glass */
.glass-modal{
  background:rgba(13,17,23,.92)!important;
  border:1px solid var(--pc-br);
  border-radius:16px;
  box-shadow: var(--pc-glow);
  overflow:hidden;
}
.mod-aurora{
  position:relative;
  border-bottom:1px solid rgba(148,163,184,.2);
}
.mod-aurora::before{
  content:""; position:absolute; inset:-30% -10% auto -10%; height:140%;
  background:
    radial-gradient(300px 160px at 10% 70%, rgba(34,211,238,.25), transparent 55%),
    radial-gradient(340px 200px at 90% 30%, rgba(96,165,250,.25), transparent 60%),
    conic-gradient(from 200deg at 50% 0%, rgba(167,139,250,.28), rgba(34,211,238,.18), transparent 70%);
  filter: blur(26px);
  opacity:.6; pointer-events:none;
}
.mod-aurora__title{display:flex; align-items:center; gap:.75rem}
.mod-aurora__dot{
  width:32px;height:32px;border-radius:10px;
  background: linear-gradient(145deg, var(--pc-cyan), var(--pc-blue));
  box-shadow: 0 6px 18px rgba(34,211,238,.35);
}
.mod-aurora__caption{font-weight:700; letter-spacing:.3px}
.mod-aurora__sub{font-size:.9rem; color:var(--pc-dim)}

.pc-toolbar{position:relative; display:flex;justify-content:space-between;align-items:center;gap:10px}
.pc-toolbar .left, .pc-toolbar .right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.pc-toolbar .form-control, .pc-toolbar .form-select{
  min-width:180px;background:rgba(2,6,23,.55)!important;
  border-color:rgba(148,163,184,.25);color:var(--pc-text)
}
.input-icon{position:relative}
.input-icon i{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--pc-dim)}
.input-icon input{padding-left:32px}

/* Neon button */
.btn-ghost{border-color:rgba(148,163,184,.28)!important}
.btn-neon{
  position:relative; overflow:hidden; border:0!important; color:#0b1220!important;
  background: linear-gradient(90deg, var(--pc-cyan), var(--pc-blue));
  box-shadow: 0 8px 24px rgba(34,211,238,.28);
}
.btn-neon::after{
  content:""; position:absolute; inset:0;
  background: radial-gradient(130px 130px at var(--x,50%) var(--y,50%), rgba(255,255,255,.25), transparent 60%);
  mix-blend-mode: screen; opacity:0; transition:opacity .18s;
}
.btn-neon:hover::after{opacity:1}

/* Table */
#pc-table{--bs-table-bg:rgba(15,23,42,.6);--bs-table-striped-bg:rgba(148,163,184,.06)}
#pc-table th,#pc-table td{vertical-align:middle}
#pc-table tbody tr{transition:.16s}
#pc-table tbody tr:hover{transform:translateY(-1px); box-shadow:0 8px 28px rgba(0,0,0,.28)}
.sticky-head{position:sticky;top:0;z-index:1;background:rgba(15,23,42,.85)!important}

/* Badges */
.badge-soft{background:rgba(148,163,184,.12);border:1px solid rgba(148,163,184,.22);color:var(--pc-text)}
.badge-active{background:rgba(16,185,129,.14);border-color:rgba(16,185,129,.45);color:#a7f3d0}
.badge-off{background:rgba(148,163,184,.12);border-color:rgba(148,163,184,.35);color:#e5e7eb}

/* Misc */
.text-dim{color:var(--pc-dim)!important}
.text-expired{color:var(--pc-red)!important}
.table thead th[data-sort]{user-select:none; position:relative}
.table thead th[data-sort]::after{
  content:"";display:inline-block;margin-left:.35rem;border:4px solid transparent;
  border-top-color:rgba(148,163,184,.55);transform:translateY(-2px)
}
.table thead th[data-sort].desc::after{border-top-color:transparent;border-bottom-color:rgba(148,163,184,.75);transform:translateY(3px)}

/* Code pill */
.pc-code{
  display:inline-flex; align-items:center; gap:.45rem;
  padding:.25rem .55rem; border-radius:.7rem;
  background:linear-gradient(180deg, rgba(148,163,184,.12), rgba(148,163,184,.05));
  border:1px solid rgba(148,163,184,.25); cursor:copy; transition:.15s;
}
.pc-code:hover{border-color:rgba(148,163,184,.5)}
.pc-code.copied{box-shadow:0 0 0 2px rgba(96,165,250,.28)}

/* Toasts */
.pc-toasts{position:fixed;right:14px;bottom:14px;display:grid;gap:8px;z-index:1080}
.pc-toast{
  background:rgba(2,6,23,.96); color:#e5e7eb; border:1px solid rgba(148,163,184,.22);
  border-radius:12px; padding:.5rem .65rem; box-shadow:0 14px 34px rgba(0,0,0,.35);
  animation: toast-in .18s ease-out;
}
@keyframes toast-in{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}

/* Skeletons */
.skel{position:relative; overflow:hidden; background:rgba(148,163,184,.08)}
.skel::after{
  content:""; position:absolute; inset:0; transform:translateX(-100%);
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.09), transparent);
  animation: sk 1.05s infinite;
}
@keyframes sk{to{transform:translateX(100%)}}
.skel-row td{padding:.65rem .5rem}
.skel-pill{height:20px;border-radius:10px}

.modal-content .form-control, .modal-content .form-select{
  background:rgba(2,6,23,.6)!important; border-color:rgba(148,163,184,.28)!important;
  color:var(--pc-text)!important;
}
.nice-table thead th{background:rgba(2,6,23,.5)}
</style>

<!-- ===== Logic ===== -->
<script>
(function(){
  'use strict';

  // ---------- helpers ----------
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const on = (el, ev, fn)=> el && el.addEventListener(ev, fn);
  const esc = (s)=> String(s??'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
  const hl  = (txt, q)=>{ if(!q) return esc(txt); const i=String(txt).toLowerCase().indexOf(q.toLowerCase()); if(i<0) return esc(txt);
    return esc(String(txt).slice(0,i)) + '<mark>'+esc(String(txt).slice(i,i+q.length))+'</mark>' + esc(String(txt).slice(i+q.length));
  };
  const toast = (msg)=>{ const z = $('#pc-toasts'); if(!z) return; const el=document.createElement('div'); el.className='pc-toast'; el.textContent=msg; z.appendChild(el); setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),250); }, 2200); };
  const setNeonPointer = (btn, e)=>{ const r=btn.getBoundingClientRect(); btn.style.setProperty('--x', (e.clientX - r.left)+'px'); btn.style.setProperty('--y', (e.clientY - r.top)+'px'); };

  const API_BASES = ['/admin/promocode/api','/admin/gameservers/promocode/api'];
  const chooseBase = async ()=>{ for (const b of API_BASES){ try{ const r=await fetch(b+'/promo/list',{cache:'no-store'}); if(r.ok) return b; }catch(_){}} return API_BASES[0]; };
  const json = async (url, opts={})=>{
    const r = await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}}, opts));
    let j=null; try{ j=await r.json(); }catch(_){}
    if(!j || !j.ok) throw new Error(j?.error || ('HTTP '+r.status));
    return j.data;
  };
  const fmtMoney=(a,k)=> (a!=null && a!=='') ? `${(+a).toFixed(2)} ${k||''}`.trim() : '—';
  const fmtDate =(s)=> s ? String(s).replace('T',' ').slice(0,19) : '—';

  // ---------- state + refs ----------
  let API='', rows=[], kits=[], sortBy='id', sortDir='desc';
  let modalBS=null, backdrop=null, bodyDelegBound=false;
  const els = {
    list: $('#pc-list'), cnt: $('#pc-count'), search: $('#pc-search'),
    ref: $('#pc-refresh'), create: $('#pc-create'), table: $('#pc-table'),
    filterStatus: $('#pc-filter-status'), filterRealm: $('#pc-filter-realm'), filterKit: $('#pc-filter-kit'),
    // modal
    m: $('#pcEditModal'),
    mId: $('#pc-f-id'), mTitle: $('#pc-f-title'), mCode: $('#pc-f-code'), mGen: $('#pc-f-gen'),
    mEnabled: $('#pc-f-enabled'), mRealm: $('#pc-f-realm'), mExp: $('#pc-f-exp'),
    mAmount: $('#pc-f-amount'), mCurr: $('#pc-f-currency'),
    mTotal: $('#pc-f-total'), mPer: $('#pc-f-per'), mCd: $('#pc-f-cd'),
    mKit: $('#pc-f-kit'), mLeft: $('#pc-f-left'),
    mSave: $('#pc-f-save'), mDel: $('#pc-f-delete'),
    // groups / reds
    gBody: $('#pc-groups-body'), gAdd: $('#pc-g-add'), gSave: $('#pc-g-save'),
    rQ: $('#pc-r-player'), rBtn: $('#pc-r-search'), rCnt: $('#pc-r-count'), rBody: $('#pc-reds-body'),
  };

  // ---------- Modal wrapper (Bootstrap or fallback) ----------
  const Modal = {
    init(){
      if (window.bootstrap) modalBS = bootstrap.Modal.getOrCreateInstance(els.m);
      $$('[data-bs-dismiss="modal"]', els.m).forEach(btn=>btn.addEventListener('click', ()=>Modal.hide()));
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && Modal.isShown() && !modalBS) Modal.hide(); });
    },
    isShown(){ return modalBS ? !!els.m.classList.contains('show') : els.m.style.display==='block'; },
    show(){
      if (modalBS){ modalBS.show(); return; }
      els.m.classList.add('show'); els.m.style.display='block'; els.m.removeAttribute('aria-hidden'); document.body.classList.add('modal-open');
      if(!backdrop){ backdrop=document.createElement('div'); backdrop.className='modal-backdrop fade show'; document.body.appendChild(backdrop); backdrop.addEventListener('click', ()=>Modal.hide()); }
    },
    hide(){
      if (modalBS){ modalBS.hide(); return; }
      els.m.classList.remove('show'); els.m.style.display='none'; els.m.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open');
      if(backdrop){ backdrop.remove(); backdrop=null; }
    }
  };

  // ---------- skeletons ----------
  function skeletonRows(n=6){
    els.list.innerHTML = Array.from({length:n}).map(()=>`
      <tr class="skel-row">
        <td><div class="skel skel-pill" style="width:120px"></div></td>
        <td><div class="skel skel-pill" style="width:70px"></div></td>
        <td><div class="skel skel-pill" style="width:100px"></div></td>
        <td><div class="skel skel-pill" style="width:90px"></div></td>
        <td><div class="skel skel-pill" style="width:80px"></div></td>
        <td><div class="skel skel-pill" style="width:120px"></div></td>
        <td><div class="skel skel-pill" style="width:90px"></div></td>
        <td class="text-end"><div class="skel skel-pill" style="width:60px;float:right"></div></td>
        <td class="text-end"><div class="skel skel-pill" style="width:140px;float:right"></div></td>
      </tr>
    `).join('');
  }

  // ---------- kits + filters ----------
  async function loadKits(){
    try{
      kits = await json(API+'/kits/list');
      els.mKit.innerHTML = `<option value="">— без кита —</option>` + (kits||[]).map(k=>`<option value="${k.id}">${esc(k.name)}</option>`).join('');
      // фильтр kit
      $('#pc-filter-kit').innerHTML = `<option value="">Kit: любой</option>` + (kits||[]).map(k=>`<option value="${k.id}">${esc(k.name)}</option>`).join('');
    }catch(_){ /* ignore */ }
  }
  function fillRealmFilter(){
    const uniq = Array.from(new Set(rows.map(r=>r.realm||''))).sort((a,b)=>String(a).localeCompare(String(b)));
    els.filterRealm.innerHTML = `<option value="">Realm: все</option>` + uniq.map(v=>`<option value="${esc(v)}">${v || 'all'}</option>`).join('');
  }

  // ---------- table render ----------
  function filterRows(){
    const q = (els.search.value||'').trim().toLowerCase();
    const st = els.filterStatus.value;
    const rl = els.filterRealm.value;
    const kit = els.filterKit.value;
    return rows.filter(x=>{
      if (q && !String(x.code).toLowerCase().includes(q)) return false;
      if (st!=='' && String(+!!x.enabled)!==st) return false;
      if (rl!=='' && String(x.realm||'')!==rl) return false;
      if (kit!=='' && String(x.kit_id||'')!==kit) return false;
      return true;
    });
  }
  function render(){
    let list = filterRows();
    list.sort((a,b)=>{
      const A=a[sortBy], B=b[sortBy];
      if(['id','amount','uses_left','uses_total'].includes(sortBy)) return (Number(A)||0)-(Number(B)||0);
      return String(A??'').localeCompare(String(B??''));
    });
    if (sortDir==='desc') list.reverse();

    els.cnt.textContent = list.length ? `${list.length} шт.` : '';

    if (!list.length){
      els.list.innerHTML = `<tr><td colspan="9" class="text-secondary small">Ничего не найдено</td></tr>`;
      return;
    }

    const now = Date.now();
    const q = (els.search.value||'').trim();

    els.list.innerHTML = list.map(x=>{
      const used = (x.uses_total!=null && x.uses_left!=null) ? (x.uses_total - x.uses_left) : '—';
      const st = (+x.enabled ? `<span class="badge badge-active">active</span>` : `<span class="badge badge-off">off</span>`);
      const lim = (x.uses_total!=null) ? `${x.uses_left}/${x.uses_total}` : '∞';
      const expTs = x.expires_at ? Date.parse(String(x.expires_at).replace(' ','T')) : null;
      const expStr = fmtDate(x.expires_at);
      const expHtml = expTs && expTs < now ? `<span class="text-expired" title="истёк">${expStr}</span>` : expStr;

      return `
      <tr data-id="${x.id}">
        <td><span class="pc-code" title="Скопировать код"><i class="bi bi-qr-code"></i><span class="code">${hl(x.code, q)}</span></span></td>
        <td>${st}</td>
        <td>${fmtMoney(x.amount, x.currency_key)}</td>
        <td>${x.realm ? esc(x.realm) : '<span class="text-dim">all</span>'}</td>
        <td>${lim}</td>
        <td>${expHtml}</td>
        <td>${x.kit_name? `<span class="badge badge-soft">${esc(x.kit_name)}</span>`: ''}</td>
        <td class="text-end">${used}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-light act-edit">Изм.</button>
            <button class="btn btn-outline-secondary act-copy" title="Скопировать"><i class="bi bi-clipboard"></i></button>
            <button class="btn btn-outline-danger act-del">Удалить</button>
          </div>
        </td>
      </tr>`;
    }).join('');

    // actions
    $$('.pc-code', els.list).forEach(el=>el.addEventListener('click', (e)=>{
      const tr = e.target.closest('tr'); const r = rows.find(x=>x.id==tr.dataset.id);
      if(!r) return;
      navigator.clipboard?.writeText(r.code).then(()=>{ el.classList.add('copied'); toast('Код скопирован'); setTimeout(()=>el.classList.remove('copied'), 700); });
    }));
    $$('.act-copy', els.list).forEach(b=>b.addEventListener('click', (e)=>{
      const tr=e.target.closest('tr'); const r=rows.find(x=>x.id==tr.dataset.id); if(r){ navigator.clipboard?.writeText(r.code); toast('Код скопирован'); }
    }));
    $$('.act-edit', els.list).forEach(b=>b.addEventListener('click', openEdit));
    $$('.act-del', els.list).forEach(b=>b.addEventListener('click', delOne));

    // делегат на один раз (клик по первой ячейке = копировать)
    if(!bodyDelegBound){
      bodyDelegBound = true;
      els.list.addEventListener('click', (e)=>{
        const td = e.target.closest('td'); const tr = e.target.closest('tr');
        if(!td || !tr) return;
        if(td.cellIndex===0){ const r=rows.find(x=>x.id==tr.dataset.id); if(r) { navigator.clipboard?.writeText(r.code); toast('Код скопирован'); } }
      });
    }
  }

  async function loadList(){
    skeletonRows();
    try{
      rows = await json(API+'/promo/list');
      fillRealmFilter();
      render();
    }catch(e){
      els.list.innerHTML = `<tr><td colspan="9" class="text-danger">${esc(e.message||String(e))}</td></tr>`;
    }
  }

  // ---------- modal: fill & open ----------
  function fillModal(row){
    els.mId.value      = row?.id ?? '';
    els.mTitle.textContent = row ? `#${row.id}` : '(новый)';
    els.mCode.value    = row?.code ?? '';
    els.mEnabled.value = (row?.enabled ?? 1) ? '1':'0';
    els.mRealm.value   = row?.realm ?? '';
    els.mExp.value     = row?.expires_at ?? '';
    els.mAmount.value  = row?.amount ?? '';
    els.mCurr.value    = row?.currency_key ?? 'rubs';
    els.mTotal.value   = row?.uses_total ?? '';
    els.mPer.value     = row?.per_player_uses ?? '';
    els.mCd.value      = row?.cooldown_seconds ?? '';
    els.mLeft.value    = row?.uses_left ?? '';
    els.mKit.value     = row?.kit_id ?? '';
    loadGroups(row?.id);
    loadReds(row?.id);
  }
  async function openEdit(e){
    const tr=e.target.closest('tr');
    const id=Number(tr.dataset.id);
    const row = rows.find(x=>x.id===id);
    await loadKits();
    fillModal(row);
    Modal.show();
  }
  async function delOne(e){
    const tr=e.target.closest('tr');
    const id=Number(tr.dataset.id);
    const row = rows.find(x=>x.id===id);
    if(!confirm(`Удалить промокод ${row?.code || ('#'+id)}?`)) return;
    try{
      await json(API+'/promo/delete',{method:'POST', body:JSON.stringify({id})});
      await loadList();
      toast('Удалено');
    }catch(err){ alert('Ошибка: '+(err.message||err)); }
  }

  // ---------- save (create/update) ----------
  function buildBodyFromModal(){
    const id = els.mId.value ? Number(els.mId.value) : null;
    return {
      id,
      code: (els.mCode.value||'').trim().toUpperCase(),
      enabled: Number(els.mEnabled.value||1),
      realm: (els.mRealm.value||'').trim() || null,
      expires_at: (els.mExp.value||'').trim() || null,
      amount: (els.mAmount.value!==''? Number(els.mAmount.value): null),
      currency_key: (els.mCurr.value||'').trim() || null,
      uses_total: (els.mTotal.value!==''? Number(els.mTotal.value): null),
      per_player_uses: (els.mPer.value!==''? Number(els.mPer.value): null),
      cooldown_seconds: (els.mCd.value!==''? Number(els.mCd.value): null),
      kit_id: (els.mKit.value? Number(els.mKit.value) : null)
    };
  }
  async function saveCurrent(){
    const body = buildBodyFromModal();
    try{
      if(!body.id){
        const created = await json(API+'/promo/create', {method:'POST', body: JSON.stringify({
          code: body.code || undefined,
          amount: body.amount || 0,
          currency_key: body.currency_key || 'rubs',
          realm: body.realm,
          kit_id: body.kit_id,
          uses: body.uses_total || 1,
          expires_at: body.expires_at
        })});
        await loadList();
        const row = rows.find(x=>x.id===created.id) || rows.find(x=>x.code===created.code);
        if(row) fillModal(row);
      }else{
        await json(API+'/promo/update', {method:'POST', body: JSON.stringify(body)});
        await loadList();
        const row = rows.find(x=>x.id===body.id);
        if(row) fillModal(row);
      }
      toast('Сохранено');
    }catch(err){ alert('Ошибка: '+(err.message||err)); }
  }

  // ---------- кодоген ----------
  function genCode(){
    const alph='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let out=''; const len=10+Math.floor(Math.random()*3);
    for(let i=0;i<len;i++) out+=alph[Math.floor(Math.random()*alph.length)];
    els.mCode.value = out;
  }

  // ---------- groups (LP) ----------
  function rowGroupTpl(i,g){
    return `<tr>
      <td class="text-secondary">${i+1}</td>
      <td><input class="form-control form-control-sm g-name" value="${esc(g.group_name||'')}"></td>
      <td style="width:150px"><input type="number" class="form-control form-control-sm g-temp" value="${g.temp_seconds??''}"></td>
      <td><input class="form-control form-control-sm g-srv" value="${esc(g.context_server||'')}"></td>
      <td><input class="form-control form-control-sm g-wld" value="${esc(g.context_world||'')}"></td>
      <td style="width:110px"><input type="number" class="form-control form-control-sm g-pr" value="${g.priority??(i+1)}"></td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger g-del">&times;</button></td>
    </tr>`;
  }
  function groupsFromUI(){
    const out=[];
    $$('#pc-groups-body tr').forEach((tr,i)=>{
      const g={
        group_name: $('.g-name',tr).value.trim(),
        temp_seconds: $('.g-temp',tr).value ? Number($('.g-temp',tr).value) : null,
        context_server: ($('.g-srv',tr).value||'').trim()||null,
        context_world: ($('.g-wld',tr).value||'').trim()||null,
        priority: $('.g-pr',tr).value ? Number($('.g-pr',tr).value) : (i+1)
      };
      if(g.group_name) out.push(g);
    });
    return out;
  }
  function bindGroupRowEvents(){
    $$('.g-del', els.gBody).forEach(b=>b.addEventListener('click', e=>e.target.closest('tr').remove()));
  }
  async function loadGroups(codeId){
    els.gBody.innerHTML='';
    if(!codeId) return;
    try{
      const data = await json(API+'/promo/groups/list?code_id='+codeId);
      els.gBody.innerHTML = (data||[]).map((g,i)=>rowGroupTpl(i,g)).join('') || '<tr><td colspan="7" class="text-secondary small">Нет групп</td></tr>';
      bindGroupRowEvents();
    }catch(_){
      els.gBody.innerHTML = '<tr><td colspan="7" class="text-secondary small">Endpoint /promo/groups/* не реализован</td></tr>';
    }
  }
  async function saveGroups(){
    const id = Number(els.mId.value||0);
    if(!id) return alert('Сначала сохраните промокод');
    try{
      await json(API+'/promo/groups/save',{method:'POST', body: JSON.stringify({code_id:id, groups: groupsFromUI()})});
      toast('Группы сохранены');
      await loadGroups(id);
    }catch(err){ alert('Ошибка: '+(err.message||err)); }
  }

  // ---------- redemptions ----------
  async function loadReds(codeId){
    els.rBody.innerHTML=''; els.rCnt.textContent='';
    if(!codeId) return;
    try{
      const q=(els.rQ.value||'').trim();
      const data = await json(API+`/promo/redemptions?code_id=${codeId}` + (q?`&q=${encodeURIComponent(q)}`:''));
      els.rBody.innerHTML = (data||[]).map(r=>`
        <tr>
          <td>${fmtDate(r.created_at)}</td>
          <td>${esc(r.username||'—')}</td>
          <td class="text-secondary small">${esc(r.uuid)}</td>
          <td>${r.granted_amount!=null? (+r.granted_amount).toFixed(2) : '—'}</td>
          <td>${rows.find(x=>x.id===r.code_id)?.currency_key || ''}</td>
          <td class="text-secondary">${esc(r.ip||'')}</td>
        </tr>
      `).join('') || `<tr><td colspan="6" class="text-secondary small">Пусто</td></tr>`;
      els.rCnt.textContent = (data||[]).length ? `${data.length} активаций` : '';
    }catch(_){
      els.rBody.innerHTML = `<tr><td colspan="6" class="text-secondary small">Ошибка загрузки</td></tr>`;
    }
  }

  // ---------- bind ----------
  function bind(){
    // сорт
    $$('th[data-sort]', els.table).forEach(th=>{
      th.addEventListener('click', ()=>{
        const k = th.getAttribute('data-sort');
        if(sortBy===k) sortDir = (sortDir==='asc'?'desc':'asc'); else { sortBy=k; sortDir='asc'; }
        $$('th[data-sort]', els.table).forEach(x=>x.classList.remove('desc'));
        if(sortDir==='desc') th.classList.add('desc');
        render();
      });
    });

    on(els.search,'input', render);
    on(els.filterStatus,'change', render);
    on(els.filterRealm,'change', render);
    on(els.filterKit,'change', render);

    on(els.ref,'click', loadList);
    on(els.create,'mousemove', (e)=>setNeonPointer(els.create, e));
    on(els.create,'click', async ()=>{ await loadKits(); fillModal(null); Modal.show(); });

    on(els.mSave,'click', saveCurrent);
    on(els.mDel,'click', async ()=>{
      const id = els.mId.value ? Number(els.mId.value) : null;
      if(!id){ alert('Промокод ещё не сохранён'); return; }
      if(!confirm('Удалить промокод?')) return;
      try{
        await json(API+'/promo/delete',{method:'POST', body:JSON.stringify({id})});
        Modal.hide(); await loadList(); toast('Удалено');
      }catch(err){ alert('Ошибка: '+(err.message||err)); }
    });

    on(els.gAdd,'click', ()=>{ const i=$$('#pc-groups-body tr').length; els.gBody.insertAdjacentHTML('beforeend', rowGroupTpl(i, {})); bindGroupRowEvents(); });
    on(els.gSave,'click', saveGroups);

    on(els.rBtn,'click', ()=>loadReds(Number(els.mId.value||0)));
    on(els.rQ,'keydown', (e)=>{ if(e.key==='Enter') loadReds(Number(els.mId.value||0)); });

    on(els.mGen,'click', (e)=>{ e.preventDefault(); genCode(); });
  }

  // ---------- init ----------
  (async function init(){
    Modal.init();
    API = await chooseBase();
    bind();
    await loadKits();
    await loadList();
  })();

})();
</script>
