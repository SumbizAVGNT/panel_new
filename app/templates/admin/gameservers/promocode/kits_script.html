<script>
/* Kits module */
(function(){
  'use strict';

  // ====== НАСТРОЙКИ ======
  const SLOT_COUNT = 27;        // <- поменяйте на 54, если нужен «двойной сундук»
  const SLOTS_PER_ROW = 9;      // визуально 9 в ряд — как в инвентаре
  const VERSIONS = [
    {
      id: '1.20.6',
      label: 'Vanilla 1.20.6',
      itemsUrl: '/static/data/vanilla-items-1.20.6.json',
      imgUrl: (id) => `/static/mc/1.20.6/items/${id}.png`
    }
    // При желании можно добавить ItemsAdder:
    // ,{ id:'ia', label:'ItemsAdder', itemsUrl:'/static/data/itemsadder-items.json', imgUrl: id => `/static/mc/itemsadder/${id}.png` }
  ];

  // ====== СОСТОЯНИЕ ======
  const state = {
    inited: false,
    items: [],                 // [{id,name}]
    version: VERSIONS[0],
    slots: Array(SLOT_COUNT).fill(null), // [{id,name,qty,display,extra}]
    active: -1,
    dirty: false
  };

  // ====== DOM ======
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  let root, grid, itemsWrap, itemsEmpty, verSelect,
      nameInput, descInput,
      slotEditor, slotNo, slotQty, slotDName, slotExtra,
      slotClearBtn, statsPill, kitsToasts;

  function grabElements(){
    root        = document.getElementById('kits-root');
    if(!root) return false;
    grid        = $('#slot-grid', root);
    itemsWrap   = $('#items-wrap', root);
    itemsEmpty  = $('#items-empty', root);
    verSelect   = $('#ver-select', root);
    nameInput   = $('#kit-name', root);
    descInput   = $('#kit-desc', root);

    slotEditor  = $('#slot-editor', root);
    slotNo      = $('#slot-no', root);
    slotQty     = $('#slot-qty', root);
    slotDName   = $('#slot-dname', root);
    slotExtra   = $('#slot-extra', root);
    slotClearBtn= $('#slot-clear', root);

    statsPill   = $('#kit-stats', root);
    kitsToasts  = $('#kits-toasts', root);

    return true;
  }

  // ====== UI: тост ======
  function toast(msg, ok=true){
    if(!kitsToasts) return;
    const el = document.createElement('div');
    el.className = 'toastx ' + (ok?'ok':'err');
    el.innerHTML = `<div class="small">${msg}</div>`;
    kitsToasts.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(), 320); }, 2000);
  }

  // ====== СЛОТЫ ======
  function buildSlots(){
    grid.innerHTML = '';
    // 27 div'ов; визуально сетка уже задана CSS (9 в ряд)
    for (let i=0; i<SLOT_COUNT; i++){
      const s = document.createElement('div');
      s.className = 'slot';
      s.dataset.idx = String(i);
      s.innerHTML = `<div class="name dim">—</div><div class="qty" hidden>1</div>`;

      // выбор слота
      s.addEventListener('click', ()=>selectSlot(i));

      // dnd
      s.addEventListener('dragover', (e)=>{ e.preventDefault(); s.classList.add('drag-over'); });
      s.addEventListener('dragleave', ()=> s.classList.remove('drag-over'));
      s.addEventListener('drop', (e)=>{
        e.preventDefault();
        s.classList.remove('drag-over');
        try{
          const data = e.dataTransfer.getData('application/json') || e.dataTransfer.getData('text/json') || e.dataTransfer.getData('text/plain');
          const item = JSON.parse(data);
          putItemToSlot(i, item);
        }catch(_){}
      });

      grid.appendChild(s);
      renderSlot(i);
    }
    updateStats();
  }

  function renderSlot(i){
    const s = grid.children[i];
    if(!s) return;
    const info = state.slots[i];
    const nameEl = $('.name', s);
    const qtyEl  = $('.qty', s);

    if(!info){
      s.classList.remove('active');
      s.innerHTML = `<div class="name dim">—</div><div class="qty" hidden>1</div>`;
      return;
    }

    // иконка
    const imgSrc = state.version.imgUrl(info.id);
    s.innerHTML = `
      <img class="icon" src="${imgSrc}" alt="" onerror="this.style.visibility='hidden'">
      <div class="name">${info.display || info.name || info.id}</div>
      <div class="qty">${info.qty ?? 1}</div>
    `;
    if ((info.qty ?? 1) <= 1) $('.qty', s).setAttribute('hidden','');
    else $('.qty', s).removeAttribute('hidden');

    if (state.active === i) s.classList.add('active'); else s.classList.remove('active');
  }

  function selectSlot(i){
    state.active = i;
    $$('.slot', grid).forEach(el => el.classList.toggle('active', Number(el.dataset.idx)===i));
    const data = state.slots[i];

    slotEditor.hidden = false;
    slotNo.textContent = String(i+1);

    slotQty.value   = data?.qty ?? 1;
    slotDName.value = data?.display ?? '';
    slotExtra.value = data?.extra ?? '';
    slotClearBtn.disabled = !data;
  }

  function putItemToSlot(i, item){
    // item: {id, name}
    state.slots[i] = { id: item.id, name: item.name, qty: 1 };
    state.dirty = true;
    renderSlot(i);
    selectSlot(i);
    updateStats();
  }

  function clearActiveSlot(){
    if (state.active < 0) return;
    state.slots[state.active] = null;
    state.dirty = true;
    renderSlot(state.active);
    selectSlot(state.active);
    updateStats();
  }

  function updateStats(){
    const count = state.slots.filter(Boolean).length;
    if(statsPill) statsPill.textContent = `${count} item${count===1?'':'s'}`;
  }

  // ====== КАТАЛОГ ПРЕДМЕТОВ ======
  async function loadItemsFor(version){
    state.version = version;
    try{
      const r = await fetch(version.itemsUrl, {cache:'no-store'});
      const j = await r.json();

      // Поддержка двух форматов:
      // 1) массив: [{id,name}, ...]
      // 2) объект { items: [...] }
      let arr = [];
      if (Array.isArray(j)) arr = j;
      else if (Array.isArray(j.items)) arr = j.items;
      else {
        // иногда приходит словарь {id: name}
        arr = Object.keys(j||{}).map(k=>({id:k, name: j[k]}));
      }

      // лёгкая валидация
      state.items = arr
        .filter(x => x && typeof x.id==='string')
        .map(x => ({ id: x.id, name: x.name || x.id.replaceAll('_',' ') }));

      renderItems();
    }catch(e){
      state.items = [];
      renderItems();
      toast('Не удалось загрузить список предметов', false);
      console.error(e);
    }
  }

  function renderItems(filter=''){
    const q = filter.trim().toLowerCase();
    const list = !q ? state.items
                    : state.items.filter(x =>
                        x.id.toLowerCase().includes(q) ||
                        (x.name||'').toLowerCase().includes(q)
                      );

    itemsWrap.innerHTML = '';
    itemsEmpty.hidden = list.length>0;

    for (const it of list){
      const div = document.createElement('div');
      div.className = 'item';
      div.draggable = true;
      div.title = `${it.name}\n${it.id}`;
      div.innerHTML = `
        <img class="icon" src="${state.version.imgUrl(it.id)}" alt="" onerror="this.style.visibility='hidden'">
        <div class="n">${it.name}</div>
      `;
      // drag payload
      div.addEventListener('dragstart', (e)=>{
        const payload = JSON.stringify({id: it.id, name: it.name});
        e.dataTransfer.setData('application/json', payload);
        e.dataTransfer.setData('text/json', payload);
        e.dataTransfer.setData('text/plain', payload);
      });
      // клик — положить в активный слот
      div.addEventListener('click', ()=>{
        const idx = state.active >= 0 ? state.active : 0;
        putItemToSlot(idx, it);
      });

      itemsWrap.appendChild(div);
    }
  }

  // ====== BINDINGS ======
  function bindCommon(){
    // версия
    verSelect.innerHTML = VERSIONS.map(v => `<option value="${v.id}">${v.label}</option>`).join('');
    verSelect.value = state.version.id;
    verSelect.addEventListener('change', ()=>{
      const v = VERSIONS.find(x => x.id === verSelect.value) || VERSIONS[0];
      loadItemsFor(v);
    });

    // поиск
    $('#item-search', root).addEventListener('input', (e)=> renderItems(e.target.value));
    $('#item-refresh', root).addEventListener('click', ()=> loadItemsFor(state.version));

    // редактор слота
    slotClearBtn.addEventListener('click', clearActiveSlot);

    // qty +/- кнопки
    $$('#slot-editor [data-qty]', root).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        let v = Number(slotQty.value||1) + (btn.dataset.qty === '+1' ? 1 : -1);
        v = Math.max(1, Math.min(64, v));
        slotQty.value = String(v);
        applySlotEditor();
      });
    });

    slotQty.addEventListener('input', applySlotEditor);
    slotDName.addEventListener('input', applySlotEditor);
    slotExtra.addEventListener('input', applySlotEditor);
  }

  function applySlotEditor(){
    if (state.active < 0) return;
    const s = state.slots[state.active] || (state.slots[state.active]={});
    s.qty     = Math.max(1, Math.min(64, Number(slotQty.value||1)));
    s.display = slotDName.value.trim() || '';
    s.extra   = slotExtra.value.trim() || '';
    state.dirty = true;
    renderSlot(state.active);
    updateStats();
  }

  // ====== ПУБЛИЧНЫЙ ИНИТ ======
  window.kitsInit = function kitsInit(){
    if(state.inited) return;
    if(!grabElements()) return;      // секция ещё не в DOM (вкладка не открыта)
    state.inited = true;

    buildSlots();
    bindCommon();
    loadItemsFor(state.version);     // первая загрузка каталога
  };

  // Если вкладка «Kits» уже открыта — инициализируем сразу
  if (document.getElementById('tab-kits')?.classList.contains('active')) {
    window.kitsInit();
  }
})();
</script>
