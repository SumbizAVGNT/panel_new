<script>
/* Kits module + автокомплит через портал (с fallback) */
(function(){
  'use strict';

  const SLOT_COUNT = 27;

  const VERSIONS = [
    { id:'vanilla-1.20.6', label:'Vanilla 1.20.6',
      itemsUrl:'/static/data/vanilla-items-1.20.6.json',
      imgUrl:(id)=>`/static/mc/1.20.6/items/${id}.png` },
    { id:'itemsadder', label:'ItemsAdder',
      itemsUrl:'/static/data/itemsadder-items.json',
      imgUrl:(id)=>`/static/itemsadder/${id.replace(':','_')}.png` }
  ];

  const ENCH_FILE = '/static/data/enchantments-1.20.6.json';

  /* ---- Fallback на случай 404/пустого json ---- */
  const DEFAULT_ENCH = [
    {id:'minecraft:sharpness',max:5},{id:'minecraft:smite',max:5},
    {id:'minecraft:efficiency',max:5},{id:'minecraft:looting',max:3},
    {id:'minecraft:unbreaking',max:3},{id:'minecraft:mending',max:1}
  ];
  const DEFAULT_ATTR = [
    {id:'minecraft:generic.attack_damage',def:1,range:[-2048,2048]},
    {id:'minecraft:generic.max_health',def:1,range:[0,2048]},
    {id:'minecraft:generic.movement_speed',def:0.1,range:[-1024,1024]}
  ];

  const state = {
    inited:false,
    items:[],
    version: VERSIONS[0],
    slots: Array(SLOT_COUNT).fill(null),
    active:-1,
    ench: { list:[], attrs:[] },
    dd:{ open:false, idx:-1, data:[] }
  };

  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  let root, grid, itemsWrap, itemsEmpty, verSelect, nameInput, descInput;
  let slotEditor, slotNo, slotQty, slotDName, dnameClear, slotExtra, slotClearBtn, statsPill, kitsToasts;
  let enchInput, enchWrap, enchClearBtn;
  let ddPortal;

  function grab(){
    root = document.getElementById('kits-root');
    if(!root) return false;
    grid       = $('#slot-grid', root);
    itemsWrap  = $('#items-wrap', root);
    itemsEmpty = $('#items-empty', root);
    verSelect  = $('#ver-select', root);
    nameInput  = $('#kit-name', root);
    descInput  = $('#kit-desc', root);
    slotEditor   = $('#slot-editor', root);
    slotNo       = $('#slot-no', root);
    slotQty      = $('#slot-qty', root);
    slotDName    = $('#slot-dname', root);
    dnameClear   = $('#dname-clear', root);
    slotExtra    = $('#slot-extra', root);
    slotClearBtn = $('#slot-clear', root);
    statsPill    = $('#kit-stats', root);
    kitsToasts   = $('#kits-toasts', root);
    enchInput    = $('#ench-input', root);
    enchWrap     = $('#slot-enchants', root);
    enchClearBtn = $('#ench-clear', root);

    if(!ddPortal){
      ddPortal = document.createElement('div');
      ddPortal.className = 'kits-dd-popover d-none';
      document.body.appendChild(ddPortal);
    }
    return true;
  }

  function toast(msg, ok=true){
    if(!kitsToasts) return;
    const el=document.createElement('div');
    el.className='toastx '+(ok?'ok':'err');
    el.innerHTML=`<div class="small">${msg}</div>`;
    kitsToasts.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(), 320); }, 2000);
  }

  /* ========== ITEMS ========== */
  async function loadItemsFor(version){
    state.version = version;
    try{
      const r=await fetch(version.itemsUrl,{cache:'no-store'});
      const j=await r.json();
      let arr=[];
      if(Array.isArray(j)) arr=j;
      else if(Array.isArray(j.items)) arr=j.items;
      else arr=Object.keys(j||{}).map(k=>({id:k,name:j[k]}));

      const map=new Map();
      for(const it of arr){
        if(!it||!it.id) continue;
        const id=String(it.id);
        const name = it.name || id.replaceAll('_',' ');
        if(!map.has(id)) map.set(id,{id,name});
      }
      state.items = Array.from(map.values());
      renderItems();
    }catch(e){
      console.error('Items load error', e);
      state.items=[]; renderItems();
      toast('Не удалось загрузить список предметов', false);
    }
  }

  function renderItems(filter=''){
    const q=filter.trim().toLowerCase();
    const list = !q ? state.items : state.items.filter(x =>
      x.id.toLowerCase().includes(q) || (x.name||'').toLowerCase().includes(q));
    itemsWrap.innerHTML=''; itemsEmpty.hidden = list.length>0;
    for(const it of list){
      const col=document.createElement('div'); col.className='col';
      col.innerHTML = `
        <div class="item" draggable="true" title="${it.name}\n${it.id}">
          <img class="icon" src="${state.version.imgUrl(it.id)}" alt="" onerror="this.style.visibility='hidden'">
          <div class="n">${it.name}</div>
        </div>`;
      const div = col.firstElementChild;
      div.addEventListener('dragstart', (e)=>{
        const payload=JSON.stringify({id:it.id,name:it.name});
        e.dataTransfer.setData('application/json', payload);
        e.dataTransfer.setData('text/plain', payload);
      });
      div.addEventListener('click', ()=>{ const idx = state.active>=0 ? state.active : 0; putItemToSlot(idx, it); });
      itemsWrap.appendChild(col);
    }
  }

  /* ========== SLOTS ========== */
  function updateStats(){ const c = state.slots.filter(Boolean).length; statsPill.textContent=`${c} item${c===1?'':'s'}`; }

  function buildSlots(){
    grid.innerHTML='';
    for(let i=0;i<SLOT_COUNT;i++){
      const s=document.createElement('div');
      s.className='slot'; s.dataset.idx=String(i);
      s.innerHTML=`<div class="name dim">—</div><div class="qty" hidden>1</div>`;
      s.addEventListener('click', ()=>selectSlot(i));
      s.addEventListener('dragover', e=>{e.preventDefault(); s.classList.add('drag-over');});
      s.addEventListener('dragleave', ()=>s.classList.remove('drag-over'));
      s.addEventListener('drop', e=>{
        e.preventDefault(); s.classList.remove('drag-over');
        try{
          const data = e.dataTransfer.getData('application/json') || e.dataTransfer.getData('text/plain');
          const item = JSON.parse(data); putItemToSlot(i, item);
        }catch(_){}
      });
      grid.appendChild(s);
      renderSlot(i);
    }
    updateStats();
  }

  function renderSlot(i){
    const s=grid.children[i]; if(!s) return;
    const info=state.slots[i];
    if(!info){ s.classList.remove('active'); s.innerHTML=`<div class="name dim">—</div><div class="qty" hidden>1</div>`; return; }
    const img=state.version.imgUrl(info.id);
    const qty=info.qty ?? 1;
    s.innerHTML = `
      <img class="icon" src="${img}" alt="" onerror="this.style.visibility='hidden'">
      <div class="name">${info.display || info.name || info.id}</div>
      <div class="qty"${qty>1?'':" hidden"}>${qty}</div>`;
    s.classList.toggle('active', state.active===i);
  }

  function putItemToSlot(i,item){
    state.slots[i] = { id:item.id, name:item.name, qty:1, extra:{ench:[], attr:[]} };
    renderSlot(i); selectSlot(i); updateStats();
  }

  function selectSlot(i){
    state.active=i;
    $$('.slot',grid).forEach(el=>el.classList.toggle('active', Number(el.dataset.idx)===i));
    const data = state.slots[i];
    slotEditor.hidden=false; slotNo.textContent=String(i+1);
    slotQty.value = data?.qty ?? 1;
    slotDName.value = data?.display ?? '';
    slotClearBtn.disabled = !data;

    enchWrap.innerHTML='';
    const extra = data?.extra || {ench:[],attr:[]};
    (extra.ench||[]).forEach(addEnchChip);
    (extra.attr||[]).forEach(addAttrChip);
    serializeExtra();
  }

  function clearActiveSlot(){
    if(state.active<0) return;
    state.slots[state.active]=null;
    renderSlot(state.active); selectSlot(state.active); updateStats();
  }

  function applySlotEditor(){
    if(state.active<0) return;
    const s = state.slots[state.active] || (state.slots[state.active]={});
    s.qty = Math.max(1, Math.min(64, Number(slotQty.value||1)));
    s.display = slotDName.value.trim() || '';
    s.extra = parseExtraFromChips();
    serializeExtra();
    renderSlot(state.active); updateStats();
  }

  /* ========== ENCHANTS/ATTR ========== */
  async function loadEnchData(){
    try{
      const r=await fetch(ENCH_FILE,{cache:'no-store'});
      const j=await r.json();
      const list  = (j.enchantments||[]).map(e=>({ id:e.id, t:'ench', alias:(e.alias||[]), max:Number(e.max||1), desc:e.desc||'' }));
      const attrs = (j.attributes||[]).map(a=>({ id:a.id, t:'attr', alias:(a.alias||[]), range:a.range||[-2048,2048], def:a.default ?? 1 }));
      state.ench.list  = list.length ? list : DEFAULT_ENCH.map(x=>({id:x.id,t:'ench',alias:[],max:x.max}));
      state.ench.attrs = attrs.length ? attrs : DEFAULT_ATTR.map(x=>({id:x.id,t:'attr',alias:[],range:x.range,def:x.def}));
    }catch(e){
      console.error('Enchant file load error', e);
      state.ench.list  = DEFAULT_ENCH.map(x=>({id:x.id,t:'ench',alias:[],max:x.max}));
      state.ench.attrs = DEFAULT_ATTR.map(x=>({id:x.id,t:'attr',alias:[],range:x.range,def:x.def}));
      toast('Файл чар не найден — использую встроенный список', false);
    }
  }

  function findSuggestions(q){
    const s=(q||'').toLowerCase();
    const pool=[...state.ench.list, ...state.ench.attrs];
    if(!pool.length) return [];             // теоретически не случится из-за fallback
    if(!s) return pool.slice(0,12);
    return pool.filter(x => x.id.includes(s) || (x.alias||[]).some(a=>a.includes(s))).slice(0,12);
  }

  function addEnchChip(e){
    const chip=document.createElement('span'); chip.className='chip'; chip.dataset.type='ench'; chip.dataset.id=e.id;
    const max = (state.ench.list.find(x=>x.id===e.id)?.max) || 5;
    const lvl = Math.max(1, Math.min(max, Number(e.lvl||1)));
    chip.innerHTML = `<span>${e.id}</span> <span class="lvl" data-lvl="${lvl}">${lvl}</span> <button class="x" title="Удалить" aria-label="Удалить">&times;</button>`;
    enchWrap.appendChild(chip);
  }

  function addAttrChip(a){
    const chip=document.createElement('span'); chip.className='chip'; chip.dataset.type='attr'; chip.dataset.id=a.id;
    let val = (a.val==null) ? (state.ench.attrs.find(x=>x.id===a.id)?.def ?? 1) : Number(a.val);
    if(isNaN(val)) val=1;
    chip.innerHTML = `<span>${a.id}</span> <span class="lvl" data-val="${val}">${val}</span> <button class="x" title="Удалить" aria-label="Удалить">&times;</button>`;
    enchWrap.appendChild(chip);
  }

  function parseExtraFromChips(){
    const ench=[], attr=[];
    $$('.chip',enchWrap).forEach(ch=>{
      const id=ch.dataset.id, t=ch.dataset.type;
      if(t==='ench'){ ench.push({id, lvl:Number(ch.querySelector('.lvl').dataset.lvl||1)}); }
      else{ attr.push({id, val:Number(ch.querySelector('.lvl').dataset.val||1)}); }
    });
    return {ench, attr};
  }
  function serializeExtra(){
    if(state.active<0) return;
    const s = state.slots[state.active] || {};
    s.extra = parseExtraFromChips();
    slotExtra.value = JSON.stringify(s.extra);
    state.slots[state.active] = s;
  }

  /* ========== DROPDOWN-PORTAL ========== */
  function placeDD(){
    if(!state.dd.open) return;
    const r = enchInput.getBoundingClientRect();
    ddPortal.style.top   = Math.round(r.bottom + 6 + window.scrollY)+'px';
    ddPortal.style.left  = Math.round(r.left   + window.scrollX)+'px';
    ddPortal.style.width = Math.round(r.width)+'px';
  }
  function openDD(list){
    if(!list || list.length===0){ closeDD(); return; }
    ddPortal.innerHTML = list.map((x,i)=>`
      <div class="kits-dd-item${i===state.dd.idx?' act':''}" data-i="${i}">
        <span>${x.id}</span><small>${x.t==='ench' ? ('max '+(x.max??1)) : 'attr'}</small>
      </div>`).join('');
    ddPortal.classList.remove('d-none');
    state.dd.open = true;
    placeDD();
  }
  function closeDD(){
    if(!state.dd.open) return;
    ddPortal.classList.add('d-none'); ddPortal.innerHTML='';
    state.dd.open=false; state.dd.idx=-1; state.dd.data=[];
  }

  /* ========== BINDINGS ========== */
  function bind(){
    verSelect.innerHTML = VERSIONS.map(v=>`<option value="${v.id}">${v.label}</option>`).join('');
    verSelect.value = state.version.id;
    verSelect.addEventListener('change', ()=>{ const v = VERSIONS.find(x=>x.id===verSelect.value) || VERSIONS[0]; loadItemsFor(v); });
    $('#item-search',root).addEventListener('input', (e)=>renderItems(e.target.value));
    $('#item-refresh',root).addEventListener('click', ()=>loadItemsFor(state.version));

    slotClearBtn.addEventListener('click', clearActiveSlot);
    dnameClear.addEventListener('click', ()=>{ slotDName.value=''; applySlotEditor(); });
    $$('#slot-editor [data-qty]', root).forEach(btn=>{
      btn.addEventListener('click', ()=>{ let v=Number(slotQty.value||1) + (btn.dataset.qty==='+1'?1:-1); v=Math.max(1, Math.min(64, v)); slotQty.value=String(v); applySlotEditor(); });
    });
    slotQty.addEventListener('input', applySlotEditor);
    slotDName.addEventListener('input', applySlotEditor);

    enchWrap.addEventListener('click', (e)=>{
      const x = e.target.closest('.x'); if(x){ x.parentElement.remove(); serializeExtra(); enchInput.focus(); }
    });
    enchInput.addEventListener('keydown', (e)=>{
      if(e.key==='Backspace' && !enchInput.value){
        const chips = $$('.chip',enchWrap); const last = chips[chips.length-1];
        if(last){ last.remove(); serializeExtra(); e.preventDefault(); }
      }
    });
    enchClearBtn.addEventListener('click', ()=>{ enchWrap.innerHTML=''; serializeExtra(); enchInput.value=''; enchInput.focus(); });

    // Показ подсказок при фокусе И при вводе
    function showDD(){ const list = findSuggestions(enchInput.value); state.dd.idx=0; state.dd.data=list; openDD(list); }
    enchInput.addEventListener('focus', showDD);
    enchInput.addEventListener('input', showDD);

    enchInput.addEventListener('keydown', (e)=>{
      if(!state.dd.open) return;
      if(e.key==='ArrowDown'){ e.preventDefault(); state.dd.idx=Math.min(state.dd.data.length-1, state.dd.idx+1); openDD(state.dd.data); }
      if(e.key==='ArrowUp'){   e.preventDefault(); state.dd.idx=Math.max(0, state.dd.idx-1); openDD(state.dd.data); }
      if(e.key==='Escape'){ closeDD(); }
      if(e.key==='Enter'){
        e.preventDefault();
        const it=state.dd.data[state.dd.idx]; if(!it) return;
        if(it.t==='ench') addEnchChip({id:it.id, lvl:1}); else addAttrChip({id:it.id, val:it.def ?? 1});
        enchInput.value=''; closeDD(); serializeExtra(); // сразу закрываем
      }
    });

    ddPortal.addEventListener('mousedown', (e)=>e.preventDefault());
    ddPortal.addEventListener('click', (e)=>{
      const row = e.target.closest('.kits-dd-item'); if(!row) return;
      const i = Number(row.dataset.i||-1); const it = state.dd.data[i]; if(!it) return;
      if(it.t==='ench') addEnchChip({id:it.id, lvl:1}); else addAttrChip({id:it.id, val:it.def ?? 1});
      enchInput.value=''; closeDD(); serializeExtra(); enchInput.focus();
    });

    document.addEventListener('click', (e)=>{ if(e.target!==enchInput && !ddPortal.contains(e.target)) closeDD(); });
    window.addEventListener('resize', placeDD);
    window.addEventListener('scroll', placeDD, true);
  }

  /* ========== INIT ========== */
  window.kitsInit = function kitsInit(){
    if(!grab() || state.inited) return;
    state.inited=true;
    buildSlots();
    bind();
    loadItemsFor(state.version);
    loadEnchData();
  };
  if(document.getElementById('tab-kits')?.classList.contains('active')) window.kitsInit();
})();
</script>
