<script>
/* === KITS: список/открытие/сохранение/удаление (подключено к /admin/promocode/api/kits/*) === */
(function(){
  'use strict';

  // ---- селекторы под твою вёрстку (поправь при необходимости) ----
  const Q = {
    savedList:   '#kits-saved',
    btnNew:      '#kit-new',
    btnDup:      '#kit-dup',
    btnSave:     '#kit-save',
    btnDelete:   '#kit-del',

    // уже существующие элементы редактора:
    root:        '#kits-root',
    grid:        '#slot-grid',
    nameInput:   '#kit-name',
    descInput:   '#kit-desc',
    statsPill:   '#kit-stats',
    enchWrap:    '#slot-enchants',
    enchInput:   '#ench-input'
  };

  // ---- состояние модуля (добавка к твоему state) ----
  const model = {
    currentId: null,
    kits: [],
    dirty: false,
    // ссылка на «старый» state редактора слотов/предметов
    stateRef: null
  };

  // ---- хелперы (общие) ----
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  function toast(msg, ok=true){
    const host = $('#kits-toasts') || $('#toasts') || document.body;
    const el   = document.createElement('div');
    el.className='toastx '+(ok?'ok':'err');
    el.style.cssText = 'position:fixed;right:16px;bottom:16px;background:#0b1220;border:1px solid rgba(148,163,184,.25);padding:.5rem .75rem;border-radius:.75rem;color:#e5e7eb;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:5000;transition:opacity .25s ease';
    el.innerHTML=`<div class="small">${msg}</div>`;
    host.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(), 280); }, 2000);
  }

  // ---- доступ к уже существующему редактору (твой скрипт его создаёт) ----
  function grabEditorState(){
    // твой модуль вешает window.kitsInit и держит состояние в замыкании.
    // Мы берём минимально необходимое API через window.__kitsEditor,
    // либо мягко «хватаем» ключевые узлы и читаем state из window.
    // Чтобы было детерминированно — экспортни в своём редакторе ниже:
    //   window.__kitsEditor = { state, selectSlot, putItemToSlot, renderSlot, buildSlots }
    return window.__kitsEditor || {};
  }

  // ---- граб UI правой колонки/кнопок ----
  let ui = {};
  function grabSavedUi(){
    ui.saved   = $(Q.savedList);
    ui.btnNew  = $(Q.btnNew);
    ui.btnDup  = $(Q.btnDup);
    ui.btnSave = $(Q.btnSave);
    ui.btnDel  = $(Q.btnDelete);

    ui.name    = $(Q.nameInput);
    ui.desc    = $(Q.descInput);
    ui.grid    = $(Q.grid);
    ui.root    = $(Q.root);

    if(!ui.saved || !ui.btnSave || !ui.btnDel || !ui.btnNew){
      // ничего не ломаем, просто выходим — возможно, это не та страница
      return false;
    }
    return true;
  }

  // ---- утилиты для (де)сериализации предметов между UI и API ----
  function slotToApiItem(slotData, slotIdx){
    // slotData: { id, name, qty, display, extra:{ench:[{id,lvl}], attr:[{id,val}] } }
    if(!slotData || !slotData.id) return null;
    const raw = String(slotData.id);
    const [ns, iid] = raw.includes(':') ? raw.split(':',2) : ['minecraft', raw];
    return {
      ns,
      id: iid,
      amount: Number(slotData.qty||1),
      display_name: slotData.display || null,
      enchants: (slotData.extra?.ench||[]),
      nbt: (slotData.extra?.attr||[]),       // атрибуты кладём в nbt_json
      slot: slotIdx
    };
  }

  function apiItemToSlot(it){
    // it: { namespace, item_id, amount, display_name, enchants_json, nbt_json, slot }
    const ns  = it.namespace || it.ns || 'minecraft';
    const iid = it.item_id || it.id || '';
    const fullId = ns==='minecraft' ? iid : `${ns}:${iid}`;
    const ench = it.enchants || it.enchants_json || [];
    const nbt  = it.nbt || it.nbt_json || [];
    return {
      id: fullId,
      name: iid.replaceAll('_',' '),
      qty: Number(it.amount||1),
      display: it.display_name || '',
      extra: { ench: Array.isArray(ench)?ench:[], attr: Array.isArray(nbt)?nbt:[] }
    };
  }

  function collectItemsFromGrid(){
    const state = model.stateRef?.state || {};
    const slots = state.slots || [];
    const out = [];
    for(let i=0;i<slots.length;i++){
      const api = slotToApiItem(slots[i], i);
      if(api) out.push(api);
    }
    return out;
  }

  // ---- отрисовка списка сохранённых китов ----
  function renderSaved(){
    if(!ui.saved) return;
    ui.saved.innerHTML = '';
    if(!Array.isArray(model.kits) || !model.kits.length){
      ui.saved.innerHTML = `<div class="dim small" style="padding:.5rem .75rem">нет сохранённых</div>`;
      return;
    }
    for(const k of model.kits){
      const row = document.createElement('button');
      row.type='button';
      row.className='row';
      row.style.cssText='display:block;width:100%;text-align:left;padding:.55rem .7rem;border-radius:.5rem;border:1px solid rgba(148,163,184,.15);background:transparent;color:#e5e7eb;margin:.25rem 0;cursor:pointer';
      row.dataset.id = k.id;
      const created = k.created_at ? new Date(k.created_at.replace(' ','T')).toLocaleString() : '';
      row.innerHTML = `<div style="display:flex;justify-content:space-between;gap:.6rem;">
        <span>${escapeHTML(k.name||('kit #'+k.id))}</span>
        <small class="dim">${created}</small>
      </div>`;
      row.addEventListener('mouseenter', ()=>row.style.background='rgba(96,165,250,.10)');
      row.addEventListener('mouseleave', ()=>row.style.background='transparent');
      row.addEventListener('click', ()=>openKit(k.id));
      ui.saved.appendChild(row);
    }
  }

  function escapeHTML(s){ return String(s).replace(/[&<>'"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // ---- загрузка списка ----
  async function loadSaved(){
    try{
      const r = await fetch('/admin/promocode/api/kits/list',{cache:'no-store'});
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'load failed');
      model.kits = j.data || [];
      renderSaved();
    }catch(e){
      console.error(e);
      toast('Не удалось загрузить киты', false);
    }
  }

  // ---- открыть кит в редакторе ----
  async function openKit(id){
    const k = model.kits.find(x => Number(x.id)===Number(id));
    if(!k){ toast('Кит не найден', false); return; }
    // загружаем чисто из списка (там уже items), если нет — подстрахуемся GET info
    const items = Array.isArray(k.items) ? k.items : [];
    // очистить сетку и заполнить
    const ed = model.stateRef;
    if(ed?.buildSlots) ed.buildSlots();   // пересобрать пустые слоты
    // установить имя/описание
    ui.name.value = k.name || '';
    ui.desc.value = k.description || '';

    const state = ed?.state || {};
    const slots = state.slots || [];
    // сброс
    for(let i=0;i<slots.length;i++){ slots[i]=null; if(ed?.renderSlot) ed.renderSlot(i); }
    // проставим предметы по слоту или по порядку
    let pos = 0;
    for(const it of items){
      const slotIdx = (it.slot!=null) ? Number(it.slot) : pos++;
      const slotData = apiItemToSlot(it);
      if(slotIdx>=0 && slotIdx<slots.length){
        slots[slotIdx]=slotData;
        if(ed?.renderSlot) ed.renderSlot(slotIdx);
      }
    }
    // обновим счётчик
    if($(Q.statsPill)) {
      const c = (state.slots||[]).filter(Boolean).length;
      $(Q.statsPill).textContent = `${c} item${c===1?'':'s'}`;
    }
    model.currentId = Number(k.id);
    markDirty(false);
  }

  // ---- кнопка: Новый ----
  function newKit(){
    const ed = model.stateRef;
    if(ed?.buildSlots) ed.buildSlots();
    ui.name.value = '';
    ui.desc.value = '';
    model.currentId = null;
    markDirty(false);
  }

  // ---- кнопка: Дублировать ----
  function duplicateKit(){
    if(!ui.name) return;
    // просто снимаем id и добавляем хвост к имени
    model.currentId = null;
    ui.name.value = (ui.name.value || 'kit') + ' ' + new Date().toLocaleString();
    markDirty(true);
  }

  // ---- кнопка: Сохранить ----
  async function saveKit(){
    if(!ui.name || !ui.name.value.trim()){
      toast('Укажите название кита', false);
      ui.name?.focus();
      return;
    }
    const payload = {
      id: model.currentId || undefined,
      name: ui.name.value.trim(),
      description: (ui.desc?.value||'').trim(),
      items: collectItemsFromGrid().map(x => ({
        namespace: x.ns, id: undefined, // на бэке — item_id; здесь приведём к ожидаемым ключам
        item_id: x.id,
        amount: x.amount,
        display_name: x.display_name || null,
        enchants: x.enchants || [],
        nbt: x.nbt || [],
        slot: (typeof x.slot==='number') ? x.slot : undefined
      }))
    };
    try{
      const r = await fetch('/admin/promocode/api/kits/save', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'save failed');
      model.currentId = j.data?.id ?? model.currentId;
      toast('Кит сохранён');
      markDirty(false);
      await loadSaved();
    }catch(e){
      console.error(e);
      toast('Ошибка при сохранении кита', false);
    }
  }

  // ---- кнопка: Удалить ----
  async function deleteKit(){
    if(!model.currentId){ toast('Выберите кит', false); return; }
    if(!confirm('Удалить этот кит?')) return;
    try{
      const r = await fetch('/admin/promocode/api/kits/delete', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: model.currentId })
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'delete failed');
      toast('Кит удалён');
      newKit();           // очистим форму
      await loadSaved();  // обновим список
    }catch(e){
      console.error(e);
      toast('Ошибка при удалении', false);
    }
  }

  // ---- dirty/изменения ----
  function markDirty(v=true){
    model.dirty = !!v;
    if(ui.btnSave){
      ui.btnSave.disabled = !model.dirty;
      ui.btnSave.style.opacity = model.dirty ? '1' : '.65';
      ui.btnSave.style.cursor  = model.dirty ? 'pointer' : 'default';
    }
  }

  function bindDirtyWatchers(){
    if(ui.name) ui.name.addEventListener('input', ()=>markDirty(true));
    if(ui.desc) ui.desc.addEventListener('input', ()=>markDirty(true));
    // «засекать» изменения по кликам в сетке (у тебя уже есть applySlotEditor/clearActiveSlot)
    if(ui.grid) ui.grid.addEventListener('click', ()=>markDirty(true));
    // если в твоём редакторе есть публичные колбэки — можно дернуть markDirty(true) из них.
  }

  // ---- бинды кнопок ----
  function bindButtons(){
    ui.btnNew?.addEventListener('click', newKit);
    ui.btnDup?.addEventListener('click', duplicateKit);
    ui.btnSave?.addEventListener('click', saveKit);
    ui.btnDel?.addEventListener('click', deleteKit);
  }

  // ---- инициализация модуля saved-китов ----
  function initSaved(){
    if(!grabSavedUi()) return;            // нет нужных узлов — тихо выходим
    model.stateRef = grabEditorState();   // доступ к API редактора слотов
    bindButtons();
    bindDirtyWatchers();
    loadSaved();
  }

  // запускаем, когда твой основной редактор проинициализировался
  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(initSaved, 0);
  }else{
    document.addEventListener('DOMContentLoaded', initSaved);
  }
})();
</script>
