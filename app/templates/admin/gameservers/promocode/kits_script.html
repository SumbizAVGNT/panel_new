<script>
/* Kits: список из БД + редактирование/удаление + автокомплит чаров */
(function(){
  'use strict';

  /* ===== API ===== */
  const API = {
    itemsVanilla: '/admin/promocode/api/items/vanilla',
    itemsCustom:  '/admin/promocode/api/items/custom',
    kitsList:     '/admin/promocode/api/kits/list',
    kitsSave:     '/admin/promocode/api/kits/save',
    kitsDelete:   '/admin/promocode/api/kits/delete',
  };

  /* ===== CONSTS ===== */
  const SLOT_COUNT = 27;

  const VERSIONS = [
    { id:'vanilla-1.20.6', label:'Vanilla 1.20.6',
      itemsUrl: API.itemsVanilla,
      imgUrl:(id)=>`/static/mc/1.20.6/items/${String(id).includes(':')?String(id).split(':',2)[1]:id}.png` },
    { id:'itemsadder', label:'ItemsAdder',
      itemsUrl: API.itemsCustom,
      // важно: для IA нужен полный id с namespace, а в пути — точка:
      imgUrl:(id)=>`/static/mc/itemsadder/${String(id).replace(':','.')}.png` }
  ];

  const ENCH_FILE = '/static/data/enchantments-1.20.6.json';

  const DEFAULT_ENCH = [
    {id:'minecraft:sharpness',max:5},{id:'minecraft:smite',max:5},
    {id:'minecraft:efficiency',max:5},{id:'minecraft:looting',max:3},
    {id:'minecraft:unbreaking',max:3},{id:'minecraft:mending',max:1}
  ];
  const DEFAULT_ATTR = [
    {id:'minecraft:generic.attack_damage',def:1,range:[-2048,2048]},
    {id:'minecraft:generic.max_health',def:1,range:[0,2048]},
    {id:'minecraft:generic.movement_speed',def:0.1,range:[-1024,1024]}
  ];

  /* ===== STATE ===== */
  const state = {
    inited:false,
    items:[],
    version: VERSIONS[0],
    slots: Array(SLOT_COUNT).fill(null),
    active:-1,
    ench: { list:[], attrs:[] },
    dd:{ open:false, idx:-1, data:[] },
    kit:{ id:null, name:'', description:'' },
    dirty:false,
    kitsCache:[]
  };

  /* ===== MINI DOM ===== */
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  let root, grid, itemsWrap, itemsEmpty, verSelect, nameInput, descInput;
  let slotEditor, slotNo, slotQty, slotDName, dnameClear, slotExtra, slotClearBtn, statsPill, kitsToasts;
  let enchInput, enchWrap, enchClearBtn;
  let ddPortal;
  // управление и список
  let btnNew, btnDup, btnSave, btnDel, listWrap, btnRefresh;

  /* ===== HELPERS ===== */
  async function GET(url){
    const r=await fetch(url,{cache:'no-store'});
    let j=null; try{ j=await r.json(); }catch(_){}
    return (j && j.ok) ? j.data : j;
  }
  async function POST(url, body){
    const r=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body||{}) });
    const j=await r.json().catch(()=>({ok:false,error:'bad json'}));
    if(!j.ok) throw new Error(j.error||'Request failed');
    return j.data;
  }
  function toast(msg, ok=true){
    if(!kitsToasts) return;
    const el=document.createElement('div');
    el.className='toastx '+(ok?'ok':'err');
    el.innerHTML=`<div class="small">${msg}</div>`;
    kitsToasts.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(), 320); }, 2000);
  }
  function markDirty(v=true){
    state.dirty = !!v;
    if(btnSave) btnSave.disabled = !state.dirty;
  }
  window.addEventListener('beforeunload', (e)=>{ if(state.dirty){ e.preventDefault(); e.returnValue=''; } });

  /* ===== GRAB ===== */
  function grab(){
    root = document.getElementById('kits-root');
    if(!root) return false;

    grid       = $('#slot-grid', root);
    itemsWrap  = $('#items-wrap', root);
    itemsEmpty = $('#items-empty', root);
    verSelect  = $('#ver-select', root);
    nameInput  = $('#kit-name', root);
    descInput  = $('#kit-desc', root);

    slotEditor   = $('#slot-editor', root);
    slotNo       = $('#slot-no', root);
    slotQty      = $('#slot-qty', root);
    slotDName    = $('#slot-dname', root);
    dnameClear   = $('#dname-clear', root);
    slotExtra    = $('#slot-extra', root);
    slotClearBtn = $('#slot-clear', root);
    statsPill    = $('#kit-stats', root);
    kitsToasts   = $('#kits-toasts', root);

    enchInput    = $('#ench-input', root);
    enchWrap     = $('#slot-enchants', root);
    enchClearBtn = $('#ench-clear', root);

    btnNew    = $('#kit-new', root);
    btnDup    = $('#kit-dup', root);
    btnSave   = $('#kit-save', root);
    btnDel    = $('#kit-del', root);
    listWrap  = $('#kits-list', root);
    btnRefresh= $('#kits-refresh', root);

    if(!ddPortal){
      ddPortal = document.createElement('div');
      ddPortal.className = 'kits-dd-popover';
      Object.assign(ddPortal.style, {
        position:'absolute', zIndex:'4000', left:'0px', top:'0px',
        minWidth:'240px', background:'#0b1220',
        border:'1px solid rgba(148,163,184,.25)', borderRadius:'10px',
        boxShadow:'0 10px 24px rgba(0,0,0,.35)', maxHeight:'260px',
        overflow:'auto', padding:'4px 0', display:'none'
      });
      document.body.appendChild(ddPortal);
    }
    return true;
  }

  /* ===== ITEMS ===== */
  async function loadItemsFor(version){
    state.version = version;
    try{
      const data = await GET(version.itemsUrl);
      const arr = Array.isArray(data) ? data : [];
      const map=new Map();
      for(const it of arr){
        if(!it||!it.id) continue;
        // сохраняем full id для кастомных предметов (IA)
        const fullId = it.full || (it.ns && `${it.ns}:${it.id}`) || String(it.id);
        const name   = it.name || String(it.id).replaceAll('_',' ');
        map.set(fullId,{id:fullId,name,icon:it.icon,ns:it.ns||'minecraft'});
      }
      state.items = Array.from(map.values());
      renderItems();
    }catch(e){
      console.error('Items load error', e);
      state.items=[]; renderItems();
      toast('Не удалось загрузить список предметов', false);
    }
  }

  function renderItems(filter=''){
    const q=filter.trim().toLowerCase();
    const list = !q ? state.items : state.items.filter(x =>
      x.id.toLowerCase().includes(q) || (x.name||'').toLowerCase().includes(q));
    itemsWrap.innerHTML=''; itemsEmpty.hidden = list.length>0;
    for(const it of list){
      const col=document.createElement('div'); col.className='col';
      const icon = it.icon || state.version.imgUrl(it.id);
      col.innerHTML = `
        <div class="item" draggable="true" title="${it.name}\n${it.id}">
          <img class="icon" src="${icon}" alt="" onerror="this.style.visibility='hidden'">
          <div class="n">${it.name}</div>
        </div>`;
      const div = col.firstElementChild;
      div.addEventListener('dragstart', (e)=>{
        const payload=JSON.stringify({id:it.id,name:it.name,ns:it.ns});
        e.dataTransfer.setData('application/json', payload);
        e.dataTransfer.setData('text/plain', payload);
      });
      div.addEventListener('click', ()=>{ const idx = state.active>=0 ? state.active : 0; putItemToSlot(idx, it); });
      itemsWrap.appendChild(col);
    }
  }

  /* ===== SLOTS ===== */
  function updateStats(){ const c = state.slots.filter(Boolean).length; if(statsPill) statsPill.textContent=`${c} item${c===1?'':'s'}`; }

  function buildSlots(){
    grid.innerHTML='';
    for(let i=0;i<SLOT_COUNT;i++){
      const s=document.createElement('div');
      s.className='slot'; s.dataset.idx=String(i);
      s.innerHTML=`<div class="name dim">—</div><div class="qty" hidden>1</div>`;
      s.addEventListener('click', ()=>selectSlot(i));
      s.addEventListener('dragover', e=>{e.preventDefault(); s.classList.add('drag-over');});
      s.addEventListener('dragleave', ()=>s.classList.remove('drag-over'));
      s.addEventListener('drop', e=>{
        e.preventDefault(); s.classList.remove('drag-over');
        try{
          const data = e.dataTransfer.getData('application/json') || e.dataTransfer.getData('text/plain');
          const item = JSON.parse(data); putItemToSlot(i, item);
        }catch(_){}
      });
      grid.appendChild(s);
      renderSlot(i);
    }
    updateStats();
  }

  function renderSlot(i){
    const s=grid.children[i]; if(!s) return;
    const info=state.slots[i];
    if(!info){
      s.classList.remove('active');
      s.innerHTML=`<div class="name dim">—</div><div class="qty" hidden>1</div>`;
      return;
    }
    // ВАЖНО: используем ПОЛНЫЙ id (ns:id) — это чинит иконки ItemsAdder.
    const img=state.version.imgUrl(info.id);
    const qty=info.qty ?? 1;
    s.innerHTML = `
      <img class="icon" src="${img}" alt="" onerror="this.style.visibility='hidden'">
      <div class="name">${info.display || info.name || (info.id.includes(':')?info.id.split(':',2)[1]:info.id)}</div>
      <div class="qty"${qty>1?'':" hidden"}>${qty}</div>`;
    s.classList.toggle('active', state.active===i);
  }

  function putItemToSlot(i,item){
    const fullId = item.id || (item.ns && item.iid ? `${item.ns}:${item.iid}` : String(item));
    const ns = fullId.includes(':') ? fullId.split(':',2)[0] : (item.ns || 'minecraft');
    state.slots[i] = { id:fullId, ns, name:item.name, qty:1, extra:{ench:[], attr:[]} };
    renderSlot(i); selectSlot(i); updateStats(); markDirty(true);
  }

  function selectSlot(i){
    state.active=i;
    $$('.slot',grid).forEach(el=>el.classList.toggle('active', Number(el.dataset.idx)===i));
    const data = state.slots[i];
    slotEditor.hidden=false; slotNo.textContent=String(i+1);
    slotQty.value = data?.qty ?? 1;
    slotDName.value = data?.display ?? '';
    slotClearBtn.disabled = !data;

    enchWrap.innerHTML='';
    const extra = data?.extra || {ench:[],attr:[]};
    (extra.ench||[]).forEach(addEnchChip);
    (extra.attr||[]).forEach(addAttrChip);
    serializeExtra();
  }

  function clearActiveSlot(){
    if(state.active<0) return;
    state.slots[state.active]=null;
    renderSlot(state.active); selectSlot(state.active); updateStats(); markDirty(true);
  }

  function applySlotEditor(){
    if(state.active<0) return;
    const s = state.slots[state.active] || (state.slots[state.active]={});
    s.qty = Math.max(1, Math.min(64, Number(slotQty.value||1)));
    s.display = slotDName.value.trim() || '';
    s.extra = parseExtraFromChips();
    serializeExtra();
    renderSlot(state.active); updateStats(); markDirty(true);
  }

  /* ===== ENCHANTS / ATTR ===== */
  async function loadEnchData(){
    try{
      const r=await fetch(ENCH_FILE,{cache:'no-store'});
      const j=await r.json();
      const list  = (j.enchantments||[]).map(e=>({ id:e.id, t:'ench', alias:(e.alias||[]), max:Number(e.max||1), desc:e.desc||'' }));
      const attrs = (j.attributes||[]).map(a=>({ id:a.id, t:'attr', alias:(a.alias||[]), range:a.range||[-2048,2048], def:a.default ?? 1 }));
      state.ench.list  = list.length ? list : DEFAULT_ENCH.map(x=>({id:x.id,t:'ench',alias:[],max:x.max}));
      state.ench.attrs = attrs.length ? attrs : DEFAULT_ATTR.map(x=>({id:x.id,t:'attr',alias:[],range:x.range,def:x.def}));
    }catch(e){
      console.error('Enchant file load error', e);
      state.ench.list  = DEFAULT_ENCH.map(x=>({id:x.id,t:'ench',alias:[],max:x.max}));
      state.ench.attrs = DEFAULT_ATTR.map(x=>({id:x.id,t:'attr',alias:[],range:x.range,def:x.def}));
      toast('Файл чар не найден — использую встроенный список', false);
    }
  }
  function findSuggestions(q){
    const s=(q||'').toLowerCase();
    const pool=[...state.ench.list, ...state.ench.attrs];
    if(!pool.length) return [];
    if(!s) return pool.slice(0,12);
    return pool.filter(x => x.id.includes(s) || (x.alias||[]).some(a=>a.includes(s))).slice(0,12);
  }
  function addEnchChip(e){
    const chip=document.createElement('span'); chip.className='chip'; chip.dataset.type='ench'; chip.dataset.id=e.id;
    const max = (state.ench.list.find(x=>x.id===e.id)?.max) || 5;
    const lvl = Math.max(1, Math.min(max, Number(e.lvl||1)));
    chip.innerHTML = `<span>${e.id}</span> <span class="lvl" data-lvl="${lvl}">${lvl}</span> <button class="x" title="Удалить" aria-label="Удалить">&times;</button>`;
    enchWrap.appendChild(chip);
  }
  function addAttrChip(a){
    const chip=document.createElement('span'); chip.className='chip'; chip.dataset.type='attr'; chip.dataset.id=a.id;
    let val = (a.val==null) ? (state.ench.attrs.find(x=>x.id===a.id)?.def ?? 1) : Number(a.val);
    if(isNaN(val)) val=1;
    chip.innerHTML = `<span>${a.id}</span> <span class="lvl" data-val="${val}">${val}</span> <button class="x" title="Удалить" aria-label="Удалить">&times;</button>`;
    enchWrap.appendChild(chip);
  }
  function parseExtraFromChips(){
    const ench=[], attr=[];
    $$('.chip',enchWrap).forEach(ch=>{
      const id=ch.dataset.id, t=ch.dataset.type;
      if(t==='ench'){ ench.push({id, lvl:Number(ch.querySelector('.lvl').dataset.lvl||1)}); }
      else{ attr.push({id, val:Number(ch.querySelector('.lvl').dataset.val||1)}); }
    });
    return {ench, attr};
  }
  function serializeExtra(){
    if(state.active<0) return;
    const s = state.slots[state.active] || {};
    s.extra = parseExtraFromChips();
    slotExtra.value = JSON.stringify(s.extra);
    state.slots[state.active] = s;
  }

  /* ===== DROPDOWN ===== */
  function placeDD(){
    if(!state.dd.open) return;
    const r = enchInput.getBoundingClientRect();
    const margin = 6;
    const top = Math.round(r.bottom + margin + window.scrollY);
    const left= Math.round(r.left + window.scrollX);
    const width = Math.round(r.width);
    Object.assign(ddPortal.style,{ top:top+'px', left:left+'px', width:width+'px' });
  }
  function openDD(list){
    if(!list || list.length===0){ closeDD(); return; }
    ddPortal.innerHTML = list.map((x,i)=>(
      `<div class="kits-dd-item${i===state.dd.idx?' act':''}" data-i="${i}" style="padding:.45rem .6rem;display:flex;justify-content:space-between;gap:.6rem;cursor:pointer;">` +
        `<span style="color:#e5e7eb">${x.id}</span>` +
        `<small style="color:#94a3b8">${x.t==='ench' ? ('max '+(x.max??1)) : 'attr'}</small>` +
      `</div>`
    )).join('');
    ddPortal.querySelectorAll('.kits-dd-item').forEach(el=>{
      el.addEventListener('mouseenter',()=>el.style.background='rgba(96,165,250,.12)');
      el.addEventListener('mouseleave',()=>el.style.background='transparent');
    });
    ddPortal.style.display = 'block';
    state.dd.open = true;
    placeDD();
  }
  function closeDD(){ if(!state.dd.open) return; ddPortal.style.display='none'; ddPortal.innerHTML=''; state.dd.open=false; state.dd.idx=-1; state.dd.data=[]; }

  /* ===== KITS <-> DB ===== */
  function kitSerializeItems(){
    const items=[];
    for(let i=0;i<SLOT_COUNT;i++){
      const s = state.slots[i];
      if(!s) continue;
      const hasNs = String(s.id).includes(':');
      const ns  = hasNs ? s.id.split(':',2)[0] : (s.ns || 'minecraft');
      const iid = hasNs ? s.id.split(':',2)[1] : String(s.id);
      items.push({
        ns, id:iid,
        amount: Number(s.qty||1),
        display_name: s.display||'',
        enchants: (s.extra?.ench)||[],
        nbt: (s.extra?.attr)||[],    // сохраняем «атрибуты» в нашем поле nbt
        slot: i
      });
    }
    return items;
  }

  function kitLoadToUI(kit){
    // очистка
    state.slots = Array(SLOT_COUNT).fill(null);
    buildSlots();

    nameInput.value = kit.name||'';
    descInput.value = kit.description||'';
    state.kit.id = kit.id||null;
    state.kit.name = nameInput.value;
    state.kit.description = descInput.value;

    const items = Array.isArray(kit.items)? kit.items : [];
    for(const it of items){
      const idx = (it.slot!=null) ? Number(it.slot) : -1;
      if(idx<0 || idx>=SLOT_COUNT) continue;
      const ns  = it.namespace || it.ns || 'minecraft';
      const iid = it.item_id   || it.id;
      if(!iid) continue;
      const fullId = (ns && ns!=='minecraft') ? `${ns}:${iid}` : String(iid);
      const ench = Array.isArray(it.enchants) ? it.enchants : [];
      const nbt  = Array.isArray(it.nbt) ? it.nbt : [];
      state.slots[idx] = {
        id: fullId, ns, name: it.display_name || iid, qty: Number(it.amount||1),
        display: it.display_name || '',
        extra:{ ench, attr: nbt }
      };
      renderSlot(idx);
    }
    updateStats();
    markDirty(false);
    // визуально отметить выбранный ряд
    $$('.kit-row', listWrap).forEach(el=>el.classList.toggle('sel', Number(el.dataset.id)===state.kit.id));
  }

  function renderKitsList(){
    if(!listWrap) return;
    listWrap.innerHTML = (state.kitsCache||[]).map(k => `
      <div class="kit-row" data-id="${k.id}" title="${(k.description||'').replace(/"/g,'&quot;')}">
        <div class="ttl">${k.name}</div>
        <div class="sub">${(k.created_at||'').toString().replace('T',' ').slice(0,19)}</div>
      </div>
    `).join('');
    $$('.kit-row', listWrap).forEach(el=>{
      el.addEventListener('click', ()=>{
        const id = Number(el.dataset.id);
        const k = state.kitsCache.find(x=>x.id===id);
        if(!k) return;
        kitLoadToUI(k);
      });
    });
  }

  async function loadKitsList(){
    try{
      const data = await GET(API.kitsList);
      state.kitsCache = Array.isArray(data)? data : [];
      renderKitsList();
      if(state.kit.id==null && state.kitsCache.length){
        kitLoadToUI(state.kitsCache[0]);
      }else{
        // обновить выделение
        $$('.kit-row', listWrap).forEach(el=>el.classList.toggle('sel', Number(el.dataset.id)===state.kit.id));
      }
    }catch(e){
      console.error('kits list error', e);
      toast('Не удалось загрузить киты', false);
    }
  }

  async function saveKit(){
    const payload = {
      id: state.kit.id,
      name: (nameInput.value||'').trim(),
      description: (descInput.value||'').trim(),
      items: kitSerializeItems()
    };
    if(!payload.name){ toast('Введите название кита', false); return; }
    try{
      const data = await POST(API.kitsSave, payload);
      if(data && data.id!=null) state.kit.id = data.id;
      toast('Кит сохранён');
      markDirty(false);
      await loadKitsList();
    }catch(e){
      console.error(e);
      toast('Ошибка при сохранении кита', false);
    }
  }

  async function deleteKit(){
    if(!state.kit.id){ toast('Кит ещё не сохранён', false); return; }
    if(!confirm('Удалить этот кит?')) return;
    try{
      await POST(API.kitsDelete, {id: state.kit.id});
      toast('Кит удалён');
      state.kit = {id:null,name:'',description:''};
      nameInput.value=''; descInput.value='';
      state.slots = Array(SLOT_COUNT).fill(null); buildSlots(); updateStats();
      markDirty(false);
      await loadKitsList();
    }catch(e){
      console.error(e);
      toast('Не удалось удалить кит', false);
    }
  }

  function newKit(){
    state.kit = {id:null,name:'',description:''};
    nameInput.value=''; descInput.value='';
    state.slots = Array(SLOT_COUNT).fill(null); buildSlots(); updateStats();
    markDirty(false);
    $$('.kit-row', listWrap).forEach(el=>el.classList.remove('sel'));
  }

  function duplicateKit(){
    const base = (nameInput.value||'').trim() || 'Kit';
    nameInput.value = base + ' (copy)';
    state.kit.id = null;
    markDirty(true);
    $$('.kit-row', listWrap).forEach(el=>el.classList.remove('sel'));
  }

  /* ===== BINDINGS ===== */
  function bind(){
    // версии/поиск/обновить items
    verSelect.innerHTML = VERSIONS.map(v=>`<option value="${v.id}">${v.label}</option>`).join('');
    verSelect.value = state.version.id;
    verSelect.addEventListener('change', ()=>{ const v = VERSIONS.find(x=>x.id===verSelect.value) || VERSIONS[0]; loadItemsFor(v); });
    $('#item-search',root)?.addEventListener('input', (e)=>renderItems(e.target.value));
    $('#item-refresh',root)?.addEventListener('click', ()=>loadItemsFor(state.version));

    // слоты/редактор
    slotClearBtn?.addEventListener('click', clearActiveSlot);
    dnameClear?.addEventListener('click', ()=>{ slotDName.value=''; applySlotEditor(); });
    $$('#slot-editor [data-qty]', root).forEach(btn=>{
      btn.addEventListener('click', ()=>{ let v=Number(slotQty.value||1) + (btn.dataset.qty==='+1'?1:-1); v=Math.max(1, Math.min(64, v)); slotQty.value=String(v); applySlotEditor(); });
    });
    slotQty?.addEventListener('input', applySlotEditor);
    slotDName?.addEventListener('input', applySlotEditor);

    // энчанты/атрибуты
    enchWrap?.addEventListener('click', (e)=>{
      const x = e.target.closest('.x'); if(x){ x.parentElement.remove(); serializeExtra(); enchInput.focus(); markDirty(true); }
    });
    enchInput?.addEventListener('keydown', (e)=>{
      if(e.key==='Backspace' && !enchInput.value){
        const chips = $$('.chip',enchWrap); const last = chips[chips.length-1];
        if(last){ last.remove(); serializeExtra(); e.preventDefault(); markDirty(true); }
      }
    });
    enchClearBtn?.addEventListener('click', ()=>{ enchWrap.innerHTML=''; serializeExtra(); enchInput.value=''; enchInput.focus(); markDirty(true); });

    function showDD(){ const list = findSuggestions(enchInput.value); state.dd.idx=0; state.dd.data=list; openDD(list); }
    enchInput?.addEventListener('focus', showDD);
    enchInput?.addEventListener('input', showDD);

    enchInput?.addEventListener('keydown', (e)=>{
      if(!state.dd.open) return;
      if(e.key==='ArrowDown'){ e.preventDefault(); state.dd.idx=Math.min(state.dd.data.length-1, state.dd.idx+1); openDD(state.dd.data); }
      if(e.key==='ArrowUp'){   e.preventDefault(); state.dd.idx=Math.max(0, state.dd.idx-1); openDD(state.dd.data); }
      if(e.key==='Escape'){ closeDD(); }
      if(e.key==='Enter'){
        e.preventDefault();
        const it=state.dd.data[state.dd.idx]; if(!it) return;
        if(it.t==='ench') addEnchChip({id:it.id, lvl:1}); else addAttrChip({id:it.id, val:it.def ?? 1});
        enchInput.value=''; closeDD(); serializeExtra(); enchInput.focus(); markDirty(true);
      }
    });

    ddPortal.addEventListener('mousedown', (e)=>e.preventDefault());
    ddPortal.addEventListener('click', (e)=>{
      const row = e.target.closest('.kits-dd-item'); if(!row) return;
      const i = Number(row.dataset.i||-1); const it = state.dd.data[i]; if(!it) return;
      if(it.t==='ench') addEnchChip({id:it.id, lvl:1}); else addAttrChip({id:it.id, val:it.def ?? 1});
      enchInput.value=''; closeDD(); serializeExtra(); enchInput.focus(); markDirty(true);
    });

    document.addEventListener('click', (e)=>{ if(e.target!==enchInput && !ddPortal.contains(e.target)) closeDD(); });
    window.addEventListener('resize', placeDD);
    window.addEventListener('scroll', placeDD, true);

    // поля кита + кнопки
    nameInput?.addEventListener('input', ()=>markDirty(true));
    descInput?.addEventListener('input', ()=>markDirty(true));
    btnSave?.addEventListener('click', saveKit);
    btnDel?.addEventListener('click', deleteKit);
    btnNew?.addEventListener('click', newKit);
    btnDup?.addEventListener('click', duplicateKit);
    btnRefresh?.addEventListener('click', loadKitsList);
  }

  /* ===== INIT ===== */
  function init(){
    if(!grab() || state.inited) return;
    state.inited=true;
    buildSlots();
    bind();
    loadItemsFor(state.version);
    loadEnchData();
    loadKitsList();     // подключение к БД: тянем список китов
    markDirty(false);
  }

  window.kitsInit = init;
  if(document.getElementById('tab-kits')?.classList.contains('active')) init();
})();
</script>
