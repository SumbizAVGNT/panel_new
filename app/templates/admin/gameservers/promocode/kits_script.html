<script>
(() => {
  if (window.kitsInit) return; // не дублируем инициализацию между табами

  /* ===== Config / endpoints ===== */
  const API = {
    versions: '/admin/gameservers/api/kits/versions',   // GET -> {ok, versions:[{id,name}]}
    items:    '/admin/gameservers/api/kits/items',      // GET ?version=&q=  -> {ok, items:[{id,name,icon}]}
    list:     '/admin/gameservers/api/kits/list',       // GET -> {ok, kits:[{id,name,desc,slots:[...]}]}
    get:      (id)=> `/admin/gameservers/api/kits/${encodeURIComponent(id)}`, // GET -> {ok, kit}
    save:     '/admin/gameservers/api/kits/save',       // POST {kit} -> {ok, id}
    delete:   (id)=> `/admin/gameservers/api/kits/${encodeURIComponent(id)}`  // DELETE -> {ok}
  };

  /* ===== State ===== */
  const S = {
    currentId: null,
    dirty: false,
    slots: Array.from({length:9},()=>null), // {id,name,icon,qty,dname,extra}
    versions: [],
    items: [],
  };

  /* ===== DOM ===== */
  const R = {
    root: document.getElementById('kits-root'),
    name: document.getElementById('kit-name'),
    desc: document.getElementById('kit-desc'),
    stats: document.getElementById('kit-stats'),
    hint: document.getElementById('kit-hint'),
    btnNew: document.getElementById('kit-new'),
    btnDup: document.getElementById('kit-dup'),
    btnSave: document.getElementById('kit-save'),
    btnDel: document.getElementById('kit-del'),
    grid: document.getElementById('slot-grid'),
    slotEditor: document.getElementById('slot-editor'),
    slotNo: document.getElementById('slot-no'),
    slotQty: document.getElementById('slot-qty'),
    slotDname: document.getElementById('slot-dname'),
    slotExtra: document.getElementById('slot-extra'),
    slotClear: document.getElementById('slot-clear'),
    verSel: document.getElementById('ver-select'),
    search: document.getElementById('item-search'),
    iWrap: document.getElementById('items-wrap'),
    iEmpty: document.getElementById('items-empty'),
    iRefresh: document.getElementById('item-refresh'),
    kList: document.getElementById('kits-list'),
    kCount: document.getElementById('kits-count'),
    toasts: document.getElementById('kits-toasts'),
  };

  /* ===== Utils ===== */
  const toast = (msg, ok=true) => {
    const el = document.createElement('div');
    el.className = `toast align-items-center text-bg-${ok?'dark':'danger'} border-0 show`;
    el.role = 'alert';
    el.style = 'min-width:280px;border:1px solid rgba(148,163,184,.28);background:#0b1220';
    el.innerHTML = `
      <div class="d-flex">
        <div class="toast-body small">${msg}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
    R.toasts.appendChild(el);
    setTimeout(()=> el.remove(), 2600);
  };

  const setDirty = (v=true) => {
    S.dirty = v;
    R.btnSave.disabled = !S.dirty;
    R.btnDup.disabled  = (S.currentId==null);
    R.btnDel.disabled  = (S.currentId==null);
    updateStats();
  };

  const updateStats = () => {
    const total = S.slots.reduce((a,s)=>a+(s?.qty||0),0);
    R.stats.textContent = `${total} items`;
  };

  const renderSlots = (active = null) => {
    R.grid.innerHTML = "";
    S.slots.forEach((s, i) => {
      const el = document.createElement('div');
      el.className = 'slot';
      el.dataset.idx = String(i);
      if (active === i) el.classList.add('active');

      // content
      if (s && s.id) {
        el.innerHTML = `
          ${s.icon ? `<img class="icon" src="${s.icon}" alt="">` : `<div class="icon"></div>`}
          <div class="name">${s.name||s.id}</div>
          <div class="qty">${s.qty||1}</div>
        `;
      } else {
        el.innerHTML = `<div class="dim">слот ${i+1}</div>`;
      }

      // click -> select
      el.addEventListener('click', () => {
        selectSlot(i);
      });

      // DnD
      el.addEventListener('dragover', (ev)=>{ev.preventDefault(); el.classList.add('drag-over');});
      el.addEventListener('dragleave', ()=> el.classList.remove('drag-over'));
      el.addEventListener('drop', (ev)=>{
        ev.preventDefault(); el.classList.remove('drag-over');
        const payload = ev.dataTransfer.getData('application/json');
        try{
          const item = JSON.parse(payload);
          putItem(i, item);
        }catch(_){}
      });

      R.grid.appendChild(el);
    });
  };

  const selectSlot = (idx) => {
    S.active = idx;
    renderSlots(idx);
    const s = S.slots[idx] || {qty:1};
    R.slotNo.textContent = String(idx+1);
    R.slotQty.value   = s.qty || 1;
    R.slotDname.value = s.dname || '';
    R.slotExtra.value = s.extra || '';
    R.slotEditor.hidden = false;
    R.slotClear.disabled = !(S.slots[idx] && S.slots[idx].id);
  };

  const putItem = (idx, item) => {
    const curr = S.slots[idx] || {};
    S.slots[idx] = { ...curr, id:item.id, name:item.name||item.id, icon:item.icon||'', qty:curr.qty||1 };
    setDirty(true);
    renderSlots(idx);
    selectSlot(idx);
  };

  const clearSlot = (idx) => {
    S.slots[idx] = null;
    setDirty(true);
    renderSlots(idx);
    selectSlot(idx);
  };

  /* ===== Catalog ===== */
  const renderItems = (items) => {
    R.iWrap.innerHTML = "";
    if (!items || !items.length) {
      R.iEmpty.hidden = false; return;
    }
    R.iEmpty.hidden = true;
    for (const it of items) {
      const el = document.createElement('div');
      el.className = 'item';
      el.draggable = true;
      el.innerHTML = `
        <img class="icon" src="${it.icon||''}" onerror="this.style.visibility='hidden'">
        <div class="n">${it.name || it.id}</div>
      `;
      el.addEventListener('dragstart', (ev)=>{
        ev.dataTransfer.setData('application/json', JSON.stringify({id:it.id, name:it.name, icon:it.icon||''}));
      });
      el.addEventListener('click', ()=>{
        if (typeof S.active === 'number') {
          putItem(S.active, it);
        }
      });
      R.iWrap.appendChild(el);
    }
  };

  async function fetchJSON(url){
    const r = await fetch(url, {cache:'no-store'});
    return r.json();
  }

  async function loadVersions(){
    try{
      const j = await fetchJSON(API.versions);
      if (!j.ok) throw new Error(j.error || 'versions error');
      S.versions = j.versions || [];
    }catch(_){
      // fallback
      S.versions = [{id:'vanilla-1.20.6', name:'Vanilla 1.20.6'}];
    }
    R.verSel.innerHTML = S.versions.map(v=>`<option value="${v.id}">${v.name||v.id}</option>`).join('');
  }

  async function loadItems(){
    const ver = R.verSel.value || (S.versions[0] && S.versions[0].id) || '';
    const q = R.search.value.trim();
    R.iWrap.innerHTML = `<div class="skeleton" style="grid-column:1/-1;min-height:52px"></div>`;
    try{
      const url = new URL(API.items, location.origin);
      url.searchParams.set('version', ver);
      if (q) url.searchParams.set('q', q);
      const j = await fetchJSON(url);
      if (!j.ok) throw new Error(j.error || 'items error');
      S.items = j.items || [];
      renderItems(S.items);
    }catch(_){
      // fallback examples
      S.items = [
        {id:'minecraft:stone', name:'Stone'},
        {id:'minecraft:oak_log', name:'Oak Log'},
        {id:'minecraft:iron_sword', name:'Iron Sword'},
        {id:'minecraft:bread', name:'Bread'},
      ];
      renderItems(S.items);
    }
  }

  /* ===== Saved kits ===== */
  function renderKitsList(kits){
    R.kList.innerHTML = "";
    if (!kits || !kits.length){
      R.kList.innerHTML = `<div class="dim">Китов нет</div>`;
      R.kCount.textContent = '0';
      return;
    }
    R.kCount.textContent = String(kits.length);
    for (const k of kits){
      const row = document.createElement('div');
      row.className = 'kit-row';
      row.innerHTML = `
        <div class="flex-grow-1">
          <div class="name">${k.name||k.id}</div>
          <div class="dim">${k.desc||''}</div>
        </div>
        <button class="btn btn-sm btn-outline-light">Открыть</button>
      `;
      row.querySelector('button').addEventListener('click', ()=> openKit(k.id));
      R.kList.appendChild(row);
    }
  }

  async function loadKits(){
    R.kList.innerHTML = `<div class="skeleton"></div><div class="skeleton"></div>`;
    try{
      const j = await fetchJSON(API.list);
      if (!j.ok) throw new Error(j.error||'list error');
      renderKitsList(j.kits||[]);
    }catch(_){
      renderKitsList([]);
    }
  }

  async function openKit(id){
    try{
      const j = await fetchJSON(API.get(id));
      if (!j.ok) throw new Error(j.error||'get error');
      const kit = j.kit || {};
      S.currentId = kit.id || id;
      S.slots = Array.from({length:9},(_,i)=> kit.slots?.[i] || null);
      R.name.value = kit.name||'';
      R.desc.value = kit.desc||'';
      renderSlots();
      selectSlot(0);
      setDirty(false);
      R.hint.textContent = `редактирование кита ${kit.name || kit.id}`;
      toast('Кит загружен');
    }catch(e){
      toast('Не удалось открыть кит', false);
    }
  }

  async function saveKit(){
    const payload = {
      id: S.currentId || undefined,
      name: R.name.value.trim(),
      desc: R.desc.value.trim(),
      slots: S.slots.map(s => s ? {id:s.id, name:s.name, icon:s.icon||'', qty:s.qty||1, dname:s.dname||'', extra:s.extra||''} : null),
    };
    if (!payload.name){
      toast('Укажите название кита', false); return;
    }
    try{
      const r = await fetch(API.save, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      const j = await r.json();
      if (!j.ok) throw new Error(j.error||'save error');
      S.currentId = j.id || S.currentId || payload.name;
      setDirty(false);
      loadKits();
      toast('Сохранено');
    }catch(e){
      toast('Ошибка сохранения', false);
    }
  }

  async function deleteKit(){
    if (!S.currentId) return;
    if (!confirm('Удалить кит?')) return;
    try{
      const r = await fetch(API.delete(S.currentId), {method:'DELETE'});
      const j = await r.json();
      if (!j.ok) throw new Error(j.error||'delete error');
      // reset
      newKit();
      loadKits();
      toast('Кит удалён');
    }catch(e){
      toast('Не удалось удалить', false);
    }
  }

  /* ===== Actions ===== */
  function newKit(){
    S.currentId = null;
    S.slots = Array.from({length:9},()=>null);
    R.name.value = '';
    R.desc.value = '';
    renderSlots();
    selectSlot(0);
    setDirty(true);
    R.hint.textContent = 'новый кит';
  }

  function duplicateKit(){
    if (!S.currentId) return;
    S.currentId = null;
    R.name.value = (R.name.value || 'kit') + ' copy';
    setDirty(true);
    R.hint.textContent = 'дубликат (новый)';
  }

  /* ===== Binds ===== */
  renderSlots();
  selectSlot(0);

  R.name.addEventListener('input', ()=> setDirty(true));
  R.desc.addEventListener('input', ()=> setDirty(true));
  R.slotQty.addEventListener('input', ()=>{
    const n = Math.max(1, Math.min(64, parseInt(R.slotQty.value,10)||1));
    R.slotQty.value = n;
    if (typeof S.active === 'number'){
      S.slots[S.active] = S.slots[S.active] || {qty:1};
      S.slots[S.active].qty = n;
      renderSlots(S.active);
      setDirty(true);
    }
  });
  R.slotDname.addEventListener('input', ()=>{
    if (typeof S.active === 'number'){
      S.slots[S.active] = S.slots[S.active] || {qty:1};
      S.slots[S.active].dname = R.slotDname.value.trim();
      setDirty(true);
    }
  });
  R.slotExtra.addEventListener('input', ()=>{
    if (typeof S.active === 'number'){
      S.slots[S.active] = S.slots[S.active] || {qty:1};
      S.slots[S.active].extra = R.slotExtra.value.trim();
      setDirty(true);
    }
  });
  R.slotClear.addEventListener('click', ()=>{
    if (typeof S.active === 'number') clearSlot(S.active);
  });
  R.slotEditor.querySelectorAll('[data-qty]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = parseInt(btn.dataset.qty.replace('+',''),10);
      R.slotQty.value = Math.max(1, Math.min(64, (parseInt(R.slotQty.value,10)||1) + d));
      R.slotQty.dispatchEvent(new Event('input'));
    });
  });

  R.verSel.addEventListener('change', loadItems);
  R.search.addEventListener('input', ()=> { clearTimeout(R._t); R._t = setTimeout(loadItems, 220); });
  R.iRefresh.addEventListener('click', loadItems);

  R.btnNew.addEventListener('click', newKit);
  R.btnDup.addEventListener('click', duplicateKit);
  R.btnSave.addEventListener('click', saveKit);
  R.btnDel.addEventListener('click', deleteKit);

  // expose init for lazy tab
  window.kitsInit = async function kitsInit(){
    if (!R.verSel.dataset._inited){
      await loadVersions();
      await loadItems();
      await loadKits();
      R.verSel.dataset._inited = '1';
    }
  };
})();
</script>
