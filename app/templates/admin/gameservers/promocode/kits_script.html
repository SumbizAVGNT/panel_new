{# Визуальная логика инвентаря. Используем HTML5 DnD + Bootstrap тултипы. #}
<script>
(function KitsUI(){
  const $ = (id)=>document.getElementById(id);
  const grid = $('inv-grid'), catGrid = $('cat-grid'), countLbl = $('kit-count'), slotLbl = $('edit-slot');

  // bootstrap tooltips (для каталога)
  function initTooltips(root=document){
    [...root.querySelectorAll('[data-bs-toggle="tooltip"]')]
      .forEach(el=> new bootstrap.Tooltip(el));
  }

  const iconFor = (ns,id)=> ns==='minecraft'
    ? `/static/mc/1.20.6/items/${id}.png`
    : `/static/mc/itemsadder/${ns}.${id}.png`;

  let current = { id:null, name:'', description:'', items: Array(54).fill(null) };
  let selectedSlot = null;
  let catalog = [];

  // ---------- helpers ----------
  function updateTitle(){ $('kit-title-lbl').textContent = ($('kit-name').value || '—'); }
  function itemCount(){ return current.items.filter(Boolean).length; }
  function setCount(){ countLbl.textContent = `${itemCount()} предметов`; }

  function renderSlot(i){
    const slot = grid.querySelector(`.slot[data-slot="${i}"]`);
    slot.innerHTML = '';
    const it = current.items[i];
    if(it){
      const d = document.createElement('div'); d.className='item'; d.draggable=true; d.dataset.slot = i;
      d.innerHTML = `<img alt="" src="${iconFor(it.ns||'minecraft',it.id)}"><span class="qty">${it.amount||1}</span>`;
      // drag start
      d.addEventListener('dragstart', (ev)=>{
        ev.dataTransfer.setData('text/slot', String(i));
        ev.dataTransfer.effectAllowed = 'move';
      });
      slot.appendChild(d);
    }
  }
  function renderAll(){ for(let i=0;i<54;i++) renderSlot(i); setCount(); updateTitle(); }

  function selectSlot(i){
    grid.querySelectorAll('.slot').forEach(s=> s.classList.remove('selected'));
    const slot = grid.querySelector(`.slot[data-slot="${i}"]`);
    if(!slot) return;
    slot.classList.add('selected'); selectedSlot = i; slotLbl.textContent = i;
    const it = current.items[i] || {display_name:'', amount:1, enchants:[]};
    $('edit-name').value = it.display_name || '';
    $('edit-amount').value = it.amount || 1;
    renderEnchants(it.enchants||[]);
  }

  function renderEnchants(list){
    const box = $('enchips');
    if(!list || !list.length){ box.innerHTML = `<span class="small text-secondary">Зачарований нет</span>`; return; }
    box.innerHTML = list.map((e,ix)=>`<span class="chip">${e.id}@${e.lvl} <a href="#" data-ix="${ix}" class="ms-1">×</a></span>`).join('');
    box.querySelectorAll('a[data-ix]').forEach(a=>{
      a.addEventListener('click',(ev)=>{
        ev.preventDefault();
        if(selectedSlot==null) return;
        current.items[selectedSlot].enchants.splice(+a.dataset.ix,1);
        renderEnchants(current.items[selectedSlot].enchants);
      });
    });
  }

  function putIntoSlot(i, item){
    current.items[i] = {...item};
    renderSlot(i); setCount();
  }
  function clearSlot(i){ current.items[i] = null; renderSlot(i); setCount(); }

  // ---------- catalog ----------
  function renderCatalog(items){
    if(!items || !items.length){ catGrid.innerHTML = `<div class="text-secondary small">Нет предметов</div>`; return; }
    catGrid.innerHTML = '';
    items.forEach(it=>{
      const el = document.createElement('div');
      el.className = 'cat-item'; el.draggable = true;
      el.setAttribute('data-bs-toggle','tooltip');
      el.setAttribute('data-bs-title', `${it.name || it.id} • ${(it.ns||'minecraft')}:${it.id}`);
      el.innerHTML = `<img alt=""><span class="hint">↘</span>`;
      el.querySelector('img').src = it.icon;

      // drag from catalog
      el.addEventListener('dragstart', (ev)=>{
        const payload = JSON.stringify({ns: it.ns || 'minecraft', id: it.id, display_name: '', amount:1, enchants:[]});
        ev.dataTransfer.setData('application/x-item', payload);
        ev.dataTransfer.effectAllowed = 'copy';
      });
      // click to quick put
      el.addEventListener('click', ()=>{
        const item = {ns: it.ns || 'minecraft', id: it.id, display_name:'', amount:1, enchants:[]};
        const slotIndex = (selectedSlot!=null) ? selectedSlot : current.items.findIndex(s=>!s);
        if(slotIndex>=0) { putIntoSlot(slotIndex, item); selectSlot(slotIndex); }
      });

      catGrid.appendChild(el);
    });
    initTooltips(catGrid);
  }
  async function loadCatalog(src){
    catGrid.innerHTML = `<div class="text-secondary small">Загрузка…</div>`;
    try{
      const url = src==='custom' ? '/admin/promocode/api/items/custom' : '/admin/promocode/api/items/vanilla';
      const r = await fetch(url, {cache:'no-store'}); const j = await r.json(); if(!j.ok) throw new Error(j.error||'catalog');
      catalog = j.data || [];
      applySearch();
    }catch(e){
      catGrid.innerHTML = `<div class="text-danger small">${e.message||e}</div>`;
    }
  }
  function applySearch(){
    const q = ($('cat-q').value||'').trim().toLowerCase();
    const filtered = !q ? catalog : catalog.filter(it=>{
      const hay = `${it.id} ${(it.name||'')} ${(it.ns||'minecraft')}`.toLowerCase();
      return hay.includes(q);
    });
    renderCatalog(filtered);
  }

  // ---------- grid events ----------
  grid.querySelectorAll('.slot').forEach(slot=>{
    const i = +slot.dataset.slot;

    slot.addEventListener('click', ()=> selectSlot(i));

    // right-click clear
    slot.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); clearSlot(i); });

    // drag over (from catalog or from another slot)
    slot.addEventListener('dragover', (ev)=>{
      if(ev.dataTransfer.types.includes('application/x-item') || ev.dataTransfer.types.includes('text/slot')){
        ev.preventDefault(); slot.classList.add('drag-over');
      }
    });
    slot.addEventListener('dragleave', ()=> slot.classList.remove('drag-over'));

    slot.addEventListener('drop', (ev)=>{
      ev.preventDefault(); slot.classList.remove('drag-over');
      // from catalog
      if(ev.dataTransfer.types.includes('application/x-item')){
        const data = JSON.parse(ev.dataTransfer.getData('application/x-item')||'{}');
        putIntoSlot(i, {...data});
        selectSlot(i);
        return;
      }
      // from another slot (swap)
      if(ev.dataTransfer.types.includes('text/slot')){
        const from = parseInt(ev.dataTransfer.getData('text/slot')||'-1',10);
        if(from>=0 && from!==i){
          const a = current.items[from], b = current.items[i];
          current.items[i] = a; current.items[from] = b;
          renderSlot(from); renderSlot(i);
          if(selectedSlot===from) selectSlot(i);
        }
      }
    });
  });

  // ---------- controls ----------
  $('kit-new').addEventListener('click', ()=>{
    current = { id:null, name:'', description:'', items:Array(54).fill(null) };
    $('kit-name').value=''; $('kit-desc').value='';
    $('kit-delete').classList.add('d-none');
    $('kit-save').disabled=false;
    selectedSlot = null; slotLbl.textContent = '—';
    renderAll();
    exposeToPromos();
  });
  $('kit-name').addEventListener('input', ()=>{ current.name = $('kit-name').value; updateTitle(); });
  $('kit-desc').addEventListener('input', ()=>{ current.description = $('kit-desc').value; });

  $('inv-clear').addEventListener('click', ()=>{
    if(!confirm('Очистить все 54 слота?')) return;
    current.items = Array(54).fill(null); renderAll();
  });
  $('inv-fill').addEventListener('click', ()=>{
    grid.querySelectorAll('.slot').forEach(s=> s.classList.remove('selected'));
    selectedSlot = null; slotLbl.textContent = '—';
  });

  $('slot-clear').addEventListener('click', ()=>{ if(selectedSlot!=null) clearSlot(selectedSlot); });

  // edit panel
  $('edit-name').addEventListener('input', ()=>{
    if(selectedSlot==null) return;
    current.items[selectedSlot] = current.items[selectedSlot] || {ns:'minecraft',id:''};
    current.items[selectedSlot].display_name = $('edit-name').value;
  });
  $('edit-amount').addEventListener('input', ()=>{
    if(selectedSlot==null) return;
    const v = Math.max(1, Math.min(64, parseInt($('edit-amount').value||'1',10)||1)); // лимит стека 64
    current.items[selectedSlot] = current.items[selectedSlot] || {ns:'minecraft',id:''};
    current.items[selectedSlot].amount = v; renderSlot(selectedSlot);
  });
  $('edit-ench-add').addEventListener('click', ()=>{
    if(selectedSlot==null) return;
    const id = ($('edit-ench-id').value||'').trim(); const lvl = Math.max(1, parseInt($('edit-ench-lvl').value||'1',10)||1);
    if(!id) return;
    const it = current.items[selectedSlot] = current.items[selectedSlot] || {ns:'minecraft',id:''};
    it.enchants = it.enchants || []; it.enchants.push({id, lvl});
    $('edit-ench-id').value=''; $('edit-ench-lvl').value='1';
    renderEnchants(it.enchants);
  });

  // save / delete
  $('kit-save').addEventListener('click', async ()=>{
    const body = {
      id: current.id, name: ($('kit-name').value||'').trim(),
      description: ($('kit-desc').value||'').trim(),
      items: current.items
        .map((it,slot)=> it ? ({...it, slot}) : null)
        .filter(Boolean)
    };
    if(!body.name){ alert('Название кита обязательно'); return; }
    try{
      const r = await fetch('/admin/promocode/api/kits/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const j = await r.json(); if(!j.ok) throw new Error(j.error||'save failed');
      current.id = j.data.id; $('kit-delete').classList.remove('d-none');
      exposeToPromos();
      alert('Сохранено');
    }catch(e){ alert('Ошибка: '+(e.message||e)); }
  });

  $('kit-delete').addEventListener('click', async ()=>{
    if(!current.id) return;
    if(!confirm('Удалить кит целиком?')) return;
    try{
      const r = await fetch('/admin/promocode/api/kits/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id: current.id})});
      const j = await r.json(); if(!j.ok) throw new Error(j.error||'delete failed');
      $('kit-new').click();
      exposeToPromos();
    }catch(e){ alert('Ошибка: '+(e.message||e)); }
  });

  // catalog events
  $('cat-src').addEventListener('change', ()=> loadCatalog($('cat-src').value));
  $('cat-refresh').addEventListener('click', ()=> loadCatalog($('cat-src').value));
  $('cat-q').addEventListener('input', applySearch);

  // ---------- expose kits to promocode select ----------
  async function exposeToPromos(){
    try{
      const r = await fetch('/admin/promocode/api/kits/list',{cache:'no-store'});
      const j = await r.json(); if(!j.ok) return;
      const sel = document.getElementById('pc-kit'); if(!sel) return;
      const cur = sel.value;
      sel.innerHTML = `<option value="">— без кита —</option>` + (j.data||[]).map(k=>`<option value="${k.id}">${k.name}</option>`).join('');
      if(current.id) sel.value = current.id;
      else if(cur) sel.value = cur;
    }catch(_){}
  }
  window.refreshKitsSelect = exposeToPromos;

  // ---------- init ----------
  loadCatalog('vanilla');
  renderAll();
})();
</script>
