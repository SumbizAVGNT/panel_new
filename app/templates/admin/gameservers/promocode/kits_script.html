<script>
/* Kits module + автокомплит + CRUD киты (расширено: корректное сохранение/открытие по id, счётчик items_count, иконки, D&D между слотами) */
(function(){
  'use strict';

  const API = {
    itemsVanilla: '/admin/promocode/api/items/vanilla',
    itemsCustom:  '/admin/promocode/api/items/custom',
    kitsList:     '/admin/promocode/api/kits/list',
    kitsSave:     '/admin/promocode/api/kits/save',
    kitsDelete:   '/admin/promocode/api/kits/delete',
  };

  const SLOT_COUNT = 27;

  const VERSIONS = [
    { id:'vanilla',   label:'Vanilla 1.20.6',
      itemsUrl: API.itemsVanilla,
      imgUrl:(id)=>`/static/mc/1.20.6/items/${id}.png` },
    { id:'custom',    label:'Custom (ItemsAdder)',
      itemsUrl: API.itemsCustom,
      imgUrl:(id)=>`/static/mc/itemsadder/${String(id).replace(':','.')}.png` },
    { id:'all',       label:'Все',
      itemsUrl: null,
      imgUrl:(id,ns)=> ns && ns!=='minecraft'
        ? `/static/mc/itemsadder/${ns}.${id}.png`
        : `/static/mc/1.20.6/items/${id}.png`
    }
  ];

  const ENCH_FILE = '/static/data/enchantments-1.20.6.json';
  const DEFAULT_ENCH = [
    {id:'minecraft:sharpness',max:5},{id:'minecraft:smite',max:5},
    {id:'minecraft:efficiency',max:5},{id:'minecraft:looting',max:3},
    {id:'minecraft:unbreaking',max:3},{id:'minecraft:mending',max:1}
  ];
  const DEFAULT_ATTR = [
    {id:'minecraft:generic.attack_damage',def:1,range:[-2048,2048]},
    {id:'minecraft:generic.max_health',def:1,range:[0,2048]},
    {id:'minecraft:generic.movement_speed',def:0.1,range:[-1024,1024]}
  ];

  const state = {
    inited:false,
    items:[],                 // [{id:'ns:id', ns, name, icon}]
    version: VERSIONS[0],
    slots: Array(SLOT_COUNT).fill(null),
    active:-1,
    ench: { list:[], attrs:[] },
    dd:{ open:false, idx:-1, data:[] },
    kit:{ id:null, name:'', description:'' },
    dirty:false,
    kitsCache:[]
  };

  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));

  let root, grid, itemsWrap, itemsEmpty, verSelect, nameInput, descInput;
  let slotEditor, slotNo, slotQty, slotDName, dnameClear, slotExtra, slotClearBtn, statsPill, kitsToasts;
  let enchInput, enchWrap, enchClearBtn;
  let ddPortal;
  let btnNew, btnDup, btnSave, btnDel, listWrap, btnRefresh, kitsCountLbl;
  let itemSearch, itemRefresh;

  async function GET(url){
    const r=await fetch(url,{cache:'no-store'});
    let j=null; try{ j=await r.json(); }catch(_){}
    return (j && j.ok) ? j.data : j;
  }
  async function POST(url, body){
    const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})});
    const j=await r.json().catch(()=>({ok:false,error:'bad json'}));
    if(!j.ok) throw new Error(j.error||'Request failed');
    return j.data;
  }

  function grab(){
    root = document.getElementById('kits-root');
    if(!root) return false;

    grid       = $('#slot-grid', root);
    itemsWrap  = $('#items-wrap', root);
    itemsEmpty = $('#items-empty', root);
    verSelect  = $('#ver-select', root);
    nameInput  = $('#kit-name', root);
    descInput  = $('#kit-desc', root);

    slotEditor   = $('#slot-editor', root);
    slotNo       = $('#slot-no', root);
    slotQty      = $('#slot-qty', root);
    slotDName    = $('#slot-dname', root);
    dnameClear   = $('#dname-clear', root);
    slotExtra    = $('#slot-extra', root);
    slotClearBtn = $('#slot-clear', root);
    statsPill    = $('#kit-stats', root);
    kitsToasts   = $('#kits-toasts', root);

    enchInput    = $('#ench-input', root);
    enchWrap     = $('#slot-enchants', root);
    enchClearBtn = $('#ench-clear', root);

    btnNew      = $('#kit-new', root);
    btnDup      = $('#kit-dup', root);
    btnSave     = $('#kit-save', root);
    btnDel      = $('#kit-del', root);
    btnRefresh  = $('#kits-refresh', root);
    listWrap    = $('#kits-list', root);
    kitsCountLbl= $('#kits-count', root);

    itemSearch  = $('#item-search', root);
    itemRefresh = $('#item-refresh', root);

    if(!ddPortal){
      ddPortal = document.createElement('div');
      Object.assign(ddPortal.style,{
        position:'absolute',zIndex:'4000',left:'0px',top:'0px',minWidth:'240px',
        background:'#0b1220',border:'1px solid rgba(148,163,184,.25)',borderRadius:'10px',
        boxShadow:'0 10px 24px rgba(0,0,0,.35)',maxHeight:'260px',overflow:'auto',padding:'4px 0',display:'none'
      });
      document.body.appendChild(ddPortal);
    }
    return true;
  }

  function toast(msg, ok=true){
    if(!kitsToasts) return;
    const el=document.createElement('div');
    el.className='toastx '+(ok?'ok':'err');
    el.innerHTML=`<div class="small">${msg}</div>`;
    kitsToasts.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(), 320); }, 2000);
  }

  function setButtons(){
    btnSave && (btnSave.disabled = !state.dirty || !(nameInput.value||'').trim());
    btnDel  && (btnDel.disabled  = !(state.kit.id));
    btnDup  && (btnDup.disabled  = !(state.kit.id));
  }
  function markDirty(v=true){
    state.dirty = !!v;
    setButtons();
  }
  window.addEventListener('beforeunload',(e)=>{ if(state.dirty){ e.preventDefault(); e.returnValue=''; } });

  /* ===== ITEMS ===== */
  async function fetchItems(url){
    const data = await GET(url);
    const arr = Array.isArray(data) ? data : [];
    const out = [];
    for(const it of arr){
      if(!it) continue;
      const idRaw = it.id || it.item_id || '';
      if(!idRaw) continue;
      const ns = it.ns || it.namespace || 'minecraft';
      const id = String(idRaw);
      const full = `${ns}:${id}`;
      out.push({
        key: full,
        id,
        ns,
        name: it.name || full.replaceAll('_',' '),
        icon: it.icon || (ns==='minecraft'
          ? `/static/mc/1.20.6/items/${id}.png`
          : `/static/mc/itemsadder/${ns}.${id}.png`)
      });
    }
    return out;
  }

  async function loadItemsFor(version){
    state.version = version;
    try{
      let items = [];
      if(version.id==='all'){
        const [van, cust] = await Promise.all([
          fetchItems(API.itemsVanilla),
          fetchItems(API.itemsCustom)
        ]);
        const map = new Map();
        for(const it of [...van, ...cust]) if(!map.has(it.key)) map.set(it.key, it);
        items = Array.from(map.values());
      }else{
        items = await fetchItems(version.itemsUrl);
      }
      state.items = items;
      renderItems();
    }catch(e){
      console.error('Items load error', e);
      state.items=[]; renderItems();
      toast('Не удалось загрузить список предметов', false);
    }
  }

  function renderItems(filter=''){
    const q=String(filter).trim().toLowerCase();
    const list = !q ? state.items : state.items.filter(x =>
      x.key.toLowerCase().includes(q) || (x.name||'').toLowerCase().includes(q));

    itemsWrap.innerHTML=''; itemsEmpty.hidden = list.length>0;

    for(const it of list){
      const el = document.createElement('div');
      el.className = 'item';
      el.setAttribute('draggable','true');
      el.dataset.ns = it.ns || 'minecraft';
      el.dataset.id = it.id;
      el.dataset.icon = it.icon;
      el.title = `${it.name}\n${it.key}`;
      el.innerHTML = `
        <img class="icon" src="${it.icon}" alt="" onerror="this.style.visibility='hidden'">
        <div class="n">${it.ns}:${it.id}</div>
      `;
      el.addEventListener('dragstart', (e)=>{
        const payload = JSON.stringify({type:'catalog', ns:el.dataset.ns, id:el.dataset.id, icon:it.icon, name:it.name});
        e.dataTransfer.setData('application/x-kits', payload);
        e.dataTransfer.setData('text/plain', payload);
      });
      el.addEventListener('dblclick', ()=>{
        const idx = state.active>=0 ? state.active : (state.slots.findIndex(x=>!x) >= 0 ? state.slots.findIndex(x=>!x) : 0);
        putItemToSlot(idx, {ns:el.dataset.ns, id:el.dataset.id, name:it.name, icon:it.icon});
      });
      itemsWrap.appendChild(el);
    }
  }

  /* ===== SLOTS ===== */
  function updateStats(){
    const c = state.slots.filter(Boolean).length;
    statsPill && (statsPill.textContent=`${c} item${c===1?'':'s'}`);
    btnDup && (btnDup.disabled = !(state.kit.id));
    btnDel && (btnDel.disabled = !(state.kit.id));
    btnSave && (btnSave.disabled = !state.dirty || !(nameInput.value||'').trim());
    slotClearBtn && (slotClearBtn.disabled = state.active<0 || !state.slots[state.active]);
  }

  function buildSlots(){
    grid.innerHTML='';
    for(let i=0;i<SLOT_COUNT;i++){
      const s=document.createElement('div');
      s.className='slot'; s.dataset.idx=String(i);
      s.innerHTML=`<div class="name dim">#${i+1}</div><div class="qty" hidden>1</div>`;
      s.addEventListener('click', (ev)=>{
        if(ev.altKey){ clearSlot(i); return; }
        selectSlot(i);
      });
      s.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); clearSlot(i); });

      s.addEventListener('dragover', e=>{e.preventDefault(); s.classList.add('drag-over');});
      s.addEventListener('dragleave', ()=>s.classList.remove('drag-over'));
      s.addEventListener('drop', e=>{
        e.preventDefault(); s.classList.remove('drag-over');
        let dataRaw = e.dataTransfer.getData('application/x-kits') || e.dataTransfer.getData('text/plain');
        if(!dataRaw) return;
        let data = {}; try{ data = JSON.parse(dataRaw); }catch(_){}
        if(data.type==='slot' && typeof data.from==='number'){
          const from = data.from, to = i;
          if(from===to) return;
          const A = state.slots[from];
          const B = state.slots[to];
          state.slots[to] = A ? {...A} : null;
          state.slots[from] = B ? {...B} : null;
          renderSlot(from); renderSlot(to);
          selectSlot(to); updateStats(); markDirty(true);
          return;
        }
        if(data.type==='catalog' && data.id){
          putItemToSlot(i, data);
        }
      });

      grid.appendChild(s);
      renderSlot(i);
    }
    updateStats();
  }

  function renderSlot(i){
    const s=grid.children[i]; if(!s) return;
    const info=state.slots[i];
    s.classList.remove('active');
    if(!info){
      s.innerHTML=`<div class="name dim">#${i+1}</div><div class="qty" hidden>1</div>`;
      s.removeAttribute('draggable');
      s.onmousedown = null;
      s.ondragstart = null;
      return;
    }
    const img = info.icon || (state.version.id==='all'
      ? VERSIONS[2].imgUrl(info.id, info.ns)
      : (info.ns==='minecraft'
          ? VERSIONS[0].imgUrl(info.id)
          : VERSIONS[1].imgUrl(`${info.ns}:${info.id}`)));
    const qty=info.qty ?? 1;
    s.innerHTML = `
      <img class="icon" src="${img}" alt="" onerror="this.style.visibility='hidden'">
      <div class="name">${info.display || `${info.ns}:${info.id}`}</div>
      <div class="qty"${qty>1?'':" hidden"}>${qty}</div>`;
    s.classList.toggle('active', state.active===i);

    s.setAttribute('draggable','true');
    s.addEventListener('dragstart', (e)=>{
      const payload = JSON.stringify({type:'slot', from:i});
      e.dataTransfer.setData('application/x-kits', payload);
      e.dataTransfer.setData('text/plain', payload);
    }, {once:true});
  }

  function putItemToSlot(i,item){
    const ns = item.ns || 'minecraft';
    const id = (item.id||'').includes(':') ? item.id.split(':',2)[1] : item.id;
    state.slots[i] = { ns, id, qty:1, name:item.name||id, display:'', icon:item.icon, extra:{ench:[], attr:[]} };
    renderSlot(i); selectSlot(i); updateStats(); markDirty(true);
  }

  function selectSlot(i){
    state.active=i;
    $$('.slot',grid).forEach(el=>el.classList.toggle('active', Number(el.dataset.idx)===i));
    const data = state.slots[i];
    slotEditor.hidden = !data;
    slotNo.textContent = String(i+1);
    slotQty.value   = data?.qty ?? 1;
    slotDName.value = data?.display ?? '';
    slotClearBtn.disabled = !data;

    enchWrap.innerHTML='';
    const extra = data?.extra || {ench:[],attr:[]};
    (extra.ench||[]).forEach(addEnchChip);
    (extra.attr||[]).forEach(addAttrChip);
    serializeExtra();
  }

  function clearSlot(i){
    if(i<0) return;
    if(!state.slots[i]) return;
    state.slots[i]=null;
    renderSlot(i);
    if(state.active===i){ selectSlot(i); }
    updateStats(); markDirty(true);
  }

  function clearActiveSlot(){
    if(state.active<0) return;
    clearSlot(state.active);
  }

  function applySlotEditor(){
    if(state.active<0) return;
    const s = state.slots[state.active] || (state.slots[state.active]={});
    s.qty = Math.max(1, Math.min(64, Number(slotQty.value||1)));
    s.display = slotDName.value.trim() || '';
    s.extra = parseExtraFromChips();
    serializeExtra();
    renderSlot(state.active); updateStats(); markDirty(true);
  }

  /* ===== ENCHANTS/ATTR ===== */
  async function loadEnchData(){
    try{
      const r=await fetch(ENCH_FILE,{cache:'no-store'});
      const j=await r.json();
      const list  = (j.enchantments||[]).map(e=>({ id:e.id, t:'ench', alias:(e.alias||[]), max:Number(e.max||1), desc:e.desc||'' }));
      const attrs = (j.attributes||[]).map(a=>({ id:a.id, t:'attr', alias:(a.alias||[]), range:a.range||[-2048,2048], def:a.default ?? 1 }));
      state.ench.list  = list.length ? list : DEFAULT_ENCH.map(x=>({id:x.id,t:'ench',alias:[],max:x.max}));
      state.ench.attrs = attrs.length ? attrs : DEFAULT_ATTR.map(x=>({id:x.id,t:'attr',alias:[],range:x.range,def:x.def}));
    }catch(e){
      console.error('Enchant file load error', e);
      state.ench.list  = DEFAULT_ENCH.map(x=>({id:x.id,t:'ench',alias:[],max:x.max}));
      state.ench.attrs = DEFAULT_ATTR.map(x=>({id:x.id,t:'attr',alias:[],range:x.range,def:x.def}));
      toast('Файл чар не найден — использую встроенный список', false);
    }
  }
  function findSuggestions(q){
    const s=(q||'').toLowerCase();
    const pool=[...state.ench.list, ...state.ench.attrs];
    if(!pool.length) return [];
    if(!s) return pool.slice(0,12);
    return pool.filter(x => x.id.toLowerCase().includes(s) || (x.alias||[]).some(a=>a.toLowerCase().includes(s))).slice(0,12);
  }
  function addEnchChip(e){
    const chip=document.createElement('span'); chip.className='chip'; chip.dataset.type='ench'; chip.dataset.id=e.id;
    const max = (state.ench.list.find(x=>x.id===e.id)?.max) || 5;
    const lvl = Math.max(1, Math.min(max, Number(e.lvl||1)));
    chip.innerHTML = `<span>${e.id}</span> <span class="lvl" data-lvl="${lvl}" title="Клик: +1, Shift: −1 (max ${max})">${lvl}</span> <button class="x" title="Удалить" aria-label="Удалить">&times;</button>`;
    enchWrap.appendChild(chip);
  }
  function addAttrChip(a){
    const chip=document.createElement('span'); chip.className='chip'; chip.dataset.type='attr'; chip.dataset.id=a.id;
    let val = (a.val==null) ? (state.ench.attrs.find(x=>x.id===a.id)?.def ?? 1) : Number(a.val);
    if(isNaN(val)) val=1;
    chip.innerHTML = `<span>${a.id}</span> <span class="lvl" data-val="${val}" title="Клик: +1, Shift: −1">${val}</span> <button class="x" title="Удалить" aria-label="Удалить">&times;</button>`;
    enchWrap.appendChild(chip);
  }
  function parseExtraFromChips(){
    const ench=[], attr=[];
    $$('.chip',enchWrap).forEach(ch=>{
      const id=ch.dataset.id, t=ch.dataset.type;
      if(t==='ench'){ ench.push({id, lvl:Number(ch.querySelector('.lvl').dataset.lvl||1)}); }
      else{ attr.push({id, val:Number(ch.querySelector('.lvl').dataset.val||1)}); }
    });
    return {ench, attr};
  }
  function serializeExtra(){
    if(state.active<0) return;
    const s = state.slots[state.active] || {};
    s.extra = parseExtraFromChips();
    slotExtra.value = JSON.stringify(s.extra);
    state.slots[state.active] = s;
  }

  /* ===== DROPDOWN (portal) ===== */
  function placeDD(){
    if(!state.dd.open) return;
    const r = enchInput.getBoundingClientRect();
    const margin = 6;
    ddPortal.style.top  = Math.round(r.bottom + margin + window.scrollY)+'px';
    ddPortal.style.left = Math.round(r.left + window.scrollX)+'px';
    ddPortal.style.width= Math.round(r.width)+'px';
  }
  function openDD(list){
    if(!list || list.length===0){ closeDD(); return; }
    ddPortal.innerHTML = list.map((x,i)=>(`
      <div class="kits-dd-item${i===state.dd.idx?' act':''}" data-i="${i}"
           style="padding:.45rem .6rem;display:flex;justify-content:space-between;gap:.6rem;cursor:pointer;">
        <span style="color:#e5e7eb">${x.id}</span>
        <small style="color:#94a3b8">${x.t==='ench' ? ('max '+(x.max??1)) : 'attr'}</small>
      </div>`)).join('');
    ddPortal.style.display = 'block';
    state.dd.open = true;
    placeDD();
  }
  function closeDD(){
    if(!state.dd.open) return;
    ddPortal.style.display='none'; ddPortal.innerHTML='';
    state.dd.open=false; state.dd.idx=-1; state.dd.data=[];
  }

  /* ===== KITS <-> DB ===== */
  function kitSerializeItems(){
    const items=[];
    for(let i=0;i<SLOT_COUNT;i++){
      const s = state.slots[i];
      if(!s) continue;
      items.push({
        namespace: s.ns || 'minecraft',
        item_id:   s.id,
        amount:    Number(s.qty||1),
        display_name: s.display || '',
        enchants:  (s.extra?.ench)||[],
        nbt:       (s.extra?.attr)||[],
        slot: i
      });
    }
    return items;
  }

  function highlightSelected(id){
    $$('.kit-row', listWrap).forEach(el=>el.classList.toggle('sel', Number(el.dataset.id)===Number(id)));
  }

  function kitLoadToUI(kit){
    state.slots = Array(SLOT_COUNT).fill(null);
    buildSlots();

    nameInput.value = kit.name||'';
    descInput.value = kit.description||'';
    state.kit.id = kit.id||null;
    state.kit.name = nameInput.value;
    state.kit.description = descInput.value;

    const items = Array.isArray(kit.items)? kit.items : [];
    for(const it of items){
      const idx = (it.slot!=null) ? Number(it.slot) : -1;
      if(idx<0 || idx>=SLOT_COUNT) continue;
      const ns = it.namespace || it.ns || 'minecraft';
      const iid = it.item_id || it.id;
      if(!iid) continue;
      const ench = it.enchants || it.enchants_json || [];
      const nbt  = it.nbt || it.nbt_json || [];
      state.slots[idx] = {
        ns, id:iid, qty: Number(it.amount||1),
        display: it.display_name || '',
        icon: (ns==='minecraft'
          ? `/static/mc/1.20.6/items/${iid}.png`
          : `/static/mc/itemsadder/${ns}.${iid}.png`),
        extra:{ ench:Array.isArray(ench)?ench:[], attr:Array.isArray(nbt)?nbt:[] }
      };
      renderSlot(idx);
    }
    updateStats();
    markDirty(false);
    highlightSelected(state.kit.id);
  }

  function renderKitsList(){
    if(!listWrap) return;
    const list = Array.isArray(state.kitsCache)? state.kitsCache : [];
    kitsCountLbl && (kitsCountLbl.textContent = list.length ? `${list.length}` : '—');
    listWrap.innerHTML = list.map(k => `
      <div class="kit-row${state.kit.id===k.id?' sel':''}" data-id="${k.id}" title="${(k.description||'').replaceAll('"','&quot;')}">
        <div class="ttl">${k.name}</div>
        <div class="sub">${(k.items_count!=null?k.items_count:(k.items||[]).length)} items</div>
      </div>
    `).join('');
    $$('.kit-row', listWrap).forEach(el=>{
      el.addEventListener('click', ()=>{
        const id = Number(el.dataset.id);
        if(state.dirty && !confirm('Есть несохранённые изменения. Переключить без сохранения?')) return;
        const k = state.kitsCache.find(x=>Number(x.id)===id);
        if(!k) return;
        kitLoadToUI(k);
      });
    });
  }

  async function loadKitsList(){
    try{
      const data = await GET(API.kitsList);
      state.kitsCache = Array.isArray(data)? data : [];
      renderKitsList();
      if(state.kit.id==null && state.kitsCache.length){
        kitLoadToUI(state.kitsCache[0]);
      }else{
        highlightSelected(state.kit.id);
      }
    }catch(e){
      console.error('kits list error', e);
      toast('Не удалось загрузить киты', false);
    }
  }

  async function saveKit(){
    const payload = {
      id: state.kit.id,
      name: (nameInput.value||'').trim(),
      description: (descInput.value||'').trim(),
      items: kitSerializeItems()
    };
    if(!payload.name){ toast('Введите название кита', false); return; }
    try{
      const data = await POST(API.kitsSave, payload);
      if(data && data.id!=null) state.kit.id = data.id;
      toast('Кит сохранён');
      markDirty(false);
      await loadKitsList();
      highlightSelected(state.kit.id);
      const fresh = state.kitsCache.find(k=>Number(k.id)===Number(state.kit.id));
      if(fresh) kitLoadToUI(fresh);
    }catch(e){
      console.error(e);
      toast('Ошибка при сохранении кита', false);
    }
  }

  async function deleteKit(){
    if(!state.kit.id){ toast('Кит ещё не сохранён', false); return; }
    if(!confirm('Удалить этот кит?')) return;
    try{
      await POST(API.kitsDelete, {id: state.kit.id});
      toast('Кит удалён');
      state.kit = {id:null,name:'',description:''};
      nameInput.value=''; descInput.value='';
      state.slots = Array(SLOT_COUNT).fill(null); buildSlots(); updateStats();
      markDirty(false);
      await loadKitsList();
      highlightSelected(null);
    }catch(e){
      console.error(e);
      toast('Не удалось удалить кит', false);
    }
  }

  function newKit(){
    if(state.dirty && !confirm('Есть несохранённые изменения. Очистить форму?')) return;
    state.kit = {id:null,name:'',description:''};
    nameInput.value=''; descInput.value='';
    state.slots = Array(SLOT_COUNT).fill(null); buildSlots(); updateStats();
    markDirty(false);
    highlightSelected(null);
  }
  function duplicateKit(){
    const base = (nameInput.value||'').trim() || 'Kit';
    nameInput.value = base + ' (copy)';
    state.kit.id = null;
    markDirty(true);
    highlightSelected(null);
  }

  /* ===== BINDINGS ===== */
  function bind(){
    verSelect.innerHTML = VERSIONS.map(v=>`<option value="${v.id}">${v.label}</option>`).join('');
    verSelect.value = state.version.id;
    verSelect.addEventListener('change', ()=>{
      const v = VERSIONS.find(x=>x.id===verSelect.value) || VERSIONS[0];
      loadItemsFor(v);
    });
    itemSearch?.addEventListener('input', (e)=>renderItems(e.target.value));
    itemRefresh?.addEventListener('click', ()=>loadItemsFor(state.version));

    slotClearBtn?.addEventListener('click', clearActiveSlot);
    dnameClear?.addEventListener('click', ()=>{ slotDName.value=''; applySlotEditor(); });
    $$('#slot-editor [data-qty]', root).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        let v=Number(slotQty.value||1) + (btn.dataset.qty==='+1'?1:-1);
        v=Math.max(1, Math.min(64, v));
        slotQty.value=String(v); applySlotEditor();
      });
    });
    slotQty?.addEventListener('input', applySlotEditor);
    slotDName?.addEventListener('input', applySlotEditor);

    enchWrap?.addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip');
      if(!chip) return;
      if(e.target.classList.contains('x')){
        chip.remove(); serializeExtra(); enchInput.focus(); markDirty(true);
        return;
      }
      if(e.target.classList.contains('lvl')){
        if(chip.dataset.type==='ench'){
          const id = chip.dataset.id;
          const max = (state.ench.list.find(x=>x.id===id)?.max) || 5;
          let lvl = Number(e.target.dataset.lvl||1);
          lvl += (e.shiftKey?-1:1);
          lvl = Math.max(1, Math.min(max, lvl));
          e.target.dataset.lvl = String(lvl);
          e.target.textContent = String(lvl);
        }else{
          let val = Number(e.target.dataset.val||1);
          val += (e.shiftKey?-1:1);
          e.target.dataset.val = String(val);
          e.target.textContent = String(val);
        }
        serializeExtra(); markDirty(true);
      }
    });

    enchInput?.addEventListener('keydown', (e)=>{
      if(e.key==='Backspace' && !enchInput.value){
        const chips = $$('.chip',enchWrap); const last = chips[chips.length-1];
        if(last){ last.remove(); serializeExtra(); e.preventDefault(); markDirty(true); }
      }
    });
    enchClearBtn?.addEventListener('click', ()=>{ enchWrap.innerHTML=''; serializeExtra(); enchInput.value=''; enchInput.focus(); markDirty(true); });

    const showDD = ()=>{ const list = findSuggestions(enchInput.value); state.dd.idx=0; state.dd.data=list; openDD(list); };
    enchInput?.addEventListener('focus', showDD);
    enchInput?.addEventListener('input', showDD);
    enchInput?.addEventListener('keydown', (e)=>{
      if(!state.dd.open) return;
      if(e.key==='ArrowDown'){ e.preventDefault(); state.dd.idx=Math.min(state.dd.data.length-1, state.dd.idx+1); openDD(state.dd.data); }
      if(e.key==='ArrowUp'){   e.preventDefault(); state.dd.idx=Math.max(0, state.dd.idx-1); openDD(state.dd.data); }
      if(e.key==='Escape'){ closeDD(); }
      if(e.key==='Enter'){
        e.preventDefault();
        const it=state.dd.data[state.dd.idx]; if(!it) return;
        if(it.t==='ench') addEnchChip({id:it.id, lvl:1}); else addAttrChip({id:it.id, val:it.def ?? 1});
        enchInput.value=''; closeDD(); serializeExtra(); enchInput.focus(); markDirty(true);
      }
    });

    ddPortal.addEventListener('mousedown', (e)=>e.preventDefault());
    ddPortal.addEventListener('click', (e)=>{
      const row = e.target.closest('.kits-dd-item'); if(!row) return;
      const i = Number(row.dataset.i||-1); const it = state.dd.data[i]; if(!it) return;
      if(it.t==='ench') addEnchChip({id:it.id, lvl:1}); else addAttrChip({id:it.id, val:it.def ?? 1});
      enchInput.value=''; closeDD(); serializeExtra(); enchInput.focus(); markDirty(true);
    });

    document.addEventListener('click', (e)=>{ if(e.target!==enchInput && !ddPortal.contains(e.target)) closeDD(); });
    window.addEventListener('resize', placeDD);
    window.addEventListener('scroll', placeDD, true);

    nameInput?.addEventListener('input', ()=>markDirty(true));
    descInput?.addEventListener('input', ()=>markDirty(true));
    btnSave?.addEventListener('click', saveKit);
    btnDel?.addEventListener('click', deleteKit);
    btnNew?.addEventListener('click', newKit);
    btnDup?.addEventListener('click', duplicateKit);
    btnRefresh?.addEventListener('click', loadKitsList);
  }

  /* ===== INIT ===== */
  function init(){
    if(!grab() || state.inited) return;
    state.inited=true;

    verSelect && (verSelect.innerHTML = VERSIONS.map(v=>`<option value="${v.id}">${v.label}</option>`).join(''));

    buildSlots();
    bind();
    loadItemsFor(state.version);
    loadEnchData();
    loadKitsList();
    markDirty(false);
    setButtons();
  }

  window.kitsInit = init;
  if(document.getElementById('tab-kits')?.classList.contains('active')) init();
})();
</script>
