<script>
);
drawCatalogChunked(filtered);
}, 120);
});
$('cat-src').addEventListener('change', ()=> loadCatalog($('cat-src').value));
$('cat-refresh').addEventListener('click', ()=> loadCatalog(lastCatalogSrc));


// ---------- inventory: interactions ----------
els('.slot', grid).forEach(slot=>{
const idx = +slot.dataset.slot;
slot.addEventListener('click', ()=> setSelected(idx));
slot.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); clearSlot(idx); if(selectedSlot===idx) fillEditorsFromSlot(); markDirty(); });
slot.addEventListener('dragover', (ev)=>{ ev.preventDefault(); slot.classList.add('drag-over'); ev.dataTransfer.dropEffect='copy'; });
slot.addEventListener('dragleave', ()=> slot.classList.remove('drag-over'));
slot.addEventListener('drop', (ev)=>{
ev.preventDefault(); slot.classList.remove('drag-over');
let data=null; try{ data = JSON.parse(ev.dataTransfer.getData('application/json')||'null'); }catch(_){ }
if(!data || !data.id) return;
placeItem(idx, { ns: data.ns || 'minecraft', id: data.id, amount: 1, display_name: null, enchants: [], icon: data.icon || iconFor(data), orig_name: data.name || data.id });
setSelected(idx); markDirty();
});
});


function placeItem(idx, it){ current.inventory[idx] = it; renderInventory(); }
function clearSlot(idx){ current.inventory[idx] = null; renderInventory(); }


// top actions
$('inv-clear').addEventListener('click', ()=>{
if(!confirm('Очистить все 54 слота?')) return;
current.inventory = Array.from({length:SLOTS_TOTAL}, ()=>null);
renderInventory(); fillEditorsFromSlot(); markDirty();
});
$('inv-fill').addEventListener('click', ()=> setSelected(null));
$('slot-clear').addEventListener('click', ()=>{ if(selectedSlot==null) return; clearSlot(selectedSlot); markDirty(); });


// editor change handlers
$('edit-name').addEventListener('input', ()=>{ updateSelectedFromEditors(); markDirty(); });
$('edit-amount').addEventListener('input', ()=>{ updateSelectedFromEditors(); markDirty(); });
$('edit-ench-add').addEventListener('click', ()=>{
if(selectedSlot==null) return; const it = current.inventory[selectedSlot]; if(!it) return;
const id = ($('edit-ench-id').value||'').trim(); let lvl = parseInt($('edit-ench-lvl').value||'1', 10); if(!Number.isFinite(lvl) || lvl<1) lvl=1;
if(!id) return; it.enchants = it.enchants || []; it.enchants.push({id, lvl}); $('edit-ench-id').value=''; $('edit-ench-lvl').value='1';
renderInventory(); fillEditorsFromSlot(); markDirty();
});


// ---------- Kit header / CRUD ----------
function markDirty(){ $('kit-save').disabled = false; lblTitle.textContent = (current.name || '—'); }
$('kit-name').addEventListener('input', ()=>{ current.name = $('kit-name').value.trim(); markDirty(); });
$('kit-desc').addEventListener('input', ()=>{ current.description = $('kit-desc').value.trim(); markDirty(); });


$('kit-new').addEventListener('click', ()=>{
if(!confirm('Создать новый кит? Текущие изменения будут потеряны.')) return;
current = { id:null, name:'', description:'', inventory: Array.from({length:SLOTS_TOTAL}, ()=>null) };
selectedSlot = null; $('kit-name').value=''; $('kit-desc').value=''; $('kit-delete').classList.add('d-none'); $('kit-save').disabled=false; lblTitle.textContent='—'; renderInventory(); fillEditorsFromSlot();
});


$('kit-save').addEventListener('click', async ()=>{
const payload = kitPayload(); if(!payload.name){ alert('Название кита обязательно'); return; }
try{
const r = await fetch('/admin/promocode/api/kits/save',{
method:'POST', headers:xheaders({'Content-Type':'application/json'}), body: JSON.stringify(payload)
});
const j = await r.json(); if(!j.ok) throw new Error(j.error||'save failed');
current.id = j.data.id; $('kit-delete').classList.remove('d-none'); $('kit-save').disabled = true; alert('Сохранено');
if(window.refreshKitsSelect) window.refreshKitsSelect();
}catch(e){ alert('Ошибка: '+(e.message||e)); }
});


$('kit-delete').addEventListener('click', async ()=>{
if(!current.id) return; if(!confirm('Удалить этот кит?')) return;
try{
const r = await fetch('/admin/promocode/api/kits/delete',{
method:'POST', headers:xheaders({'Content-Type':'application/json'}), body: JSON.stringify({id: current.id})
});
const j = await r.json(); if(!j.ok) throw new Error(j.error||'delete failed');
$('kit-new').click(); if(window.refreshKitsSelect) window.refreshKitsSelect();
}catch(e){ alert('Ошибка: '+(e.message||e)); }
});


function kitPayload(){
const items = [];
current.inventory.forEach((it, idx)=>{ if(!it) return; items.push({ ns: it.ns || 'minecraft', id: it.id, amount: Math.max(1, it.amount|0), display_name: (it.display_name || '').trim() || null, enchants: (it.enchants||[]).map(e=>({id: e.id, lvl: Math.max(1, e.lvl|0)})), slot: idx }); });
return { id: current.id, name: (current.name||'').trim(), description: (current.description||'').trim(), items };
}
window.kitGetPayload = kitPayload;


// ---------- boot ----------
async function boot(){ renderInventory(); fillEditorsFromSlot(); await loadCatalog('vanilla'); }
boot();
})();
</script>