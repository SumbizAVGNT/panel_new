{% extends "layout/base.html" %}
{% block title %}{{ realm }} — Game Server{% endblock %}

{% block content %}
<style>
.container-xxl.gs-scope{
  background:
    radial-gradient(700px 360px at 50% -12%, rgba(148,163,184,.10), transparent 70%),
    linear-gradient(180deg, rgba(13,17,23,.55), rgba(13,17,23,.42));
  border:1px solid rgba(148,163,184,.14);
  border-radius:18px;
}
.gs-layout{display:grid;grid-template-columns:300px 1fr;gap:16px}
@media (max-width:992px){.gs-layout{grid-template-columns:1fr}}
.card.glass{background:rgba(13,17,23,.55);border:1px solid rgba(148,163,184,.18);backdrop-filter:blur(8px)}
.table>:not(caption)>*>*{background:transparent}

/* side */
.gs-side{position:sticky;top:76px;align-self:start}
.gs-side .nav-link{border:1px solid rgba(148,163,184,.18);border-radius:12px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.gs-side .nav-link .dot{width:6px;height:6px;border-radius:999px;background:rgba(148,163,184,.5)}
.gs-side .nav-link.active{background:#0f172a;box-shadow:inset 0 0 0 1px rgba(148,163,184,.28)}
.gs-side .nav-link.active .dot{background:#22c55e}

/* tiles */
.tile{position:relative;isolation:isolate;display:flex;flex-direction:column;gap:6px;padding:16px;border-radius:14px;border:1px solid rgba(148,163,184,.18);background:rgba(13,17,23,.55)}
.tile[data-click]{cursor:pointer}
.tile:before{content:"";position:absolute;inset:-1px;border-radius:14px;z-index:-1;background:
  radial-gradient(260px 140px at 0% 0%, rgba(56,189,248,.20), transparent 70%),
  radial-gradient(260px 140px at 100% 100%, rgba(34,197,94,.12), transparent 70%);opacity:.28;transition:.2s}
.tile:hover:before{opacity:.5}
.tcap{font-size:.78rem;color:#94a3b8;text-transform:uppercase;letter-spacing:.04em}
.kpi .value{font-size:1.25rem}
.badge-cap{padding:.35rem .6rem;border-radius:999px}
.sub{font-size:.8rem;color:#94a3b8}

/* bars & gauges */
.meter{height:8px;border-radius:6px;background:rgba(148,163,184,.18);overflow:hidden}
.meter>span{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#34d399)}

/* maintenance */
.maint{display:grid;grid-template-columns:1fr;gap:12px}
.maint .head{display:flex;align-items:center;justify-content:space-between;gap:12px}
.stat-dot{display:inline-flex;align-items:center;gap:6px;font-size:.86rem}
.stat-dot .d{width:8px;height:8px;border-radius:999px;background:#475569}
.stat-dot.m .d{background:#f59e0b}
.stat-dot.o .d{background:#22c55e}
.mrow{display:flex;flex-wrap:wrap;gap:10px}
.switch-big{display:flex;align-items:center;gap:10px;background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.2);border-radius:12px;padding:8px 10px}
.switch-big input{transform:scale(1.25)}
.maint .msg{flex:1;min-width:220px}
.maint .msg input{width:100%;border:1px solid rgba(148,163,184,.25);background:rgba(15,23,42,.55);color:#e5e7eb;border-radius:10px;padding:8px 10px;outline:0}
.pills{display:flex;flex-wrap:wrap;gap:8px}
.pills .btn{border:1px dashed rgba(148,163,184,.35)}
.caption{font-size:.8rem;color:#94a3b8}

/* console */
.console-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.switchx{display:flex;align-items:center;gap:6px;font-size:.9rem}
pre.console{max-height:320px;overflow:auto;background:rgba(15,23,42,.44);border-radius:10px;padding:10px;border:1px solid rgba(148,163,184,.18);white-space:pre-wrap}

/* players */
.player-head{width:32px;height:32px;border-radius:6px;border:1px solid rgba(148,163,184,.25);background:rgba(15,23,42,.5);image-rendering:pixelated}
.player-row{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:8px}
.player-row:hover{background:rgba(148,163,184,.06)}

/* skeletons + toasts */
.skel{position:relative;overflow:hidden;background:rgba(148,163,184,.12);border-radius:8px}
.skel:after{content:"";position:absolute;inset:0;background:linear-gradient(90deg, transparent, rgba(255,255,255,.07), transparent);transform:translateX(-100%);animation:shimmer 1.2s infinite}
@keyframes shimmer{100%{transform:translateX(100%)}}
#toasts{position:fixed;right:16px;bottom:16px;z-index:1080;display:flex;flex-direction:column;gap:8px}
.toastx{background:rgba(13,17,23,.96);border:1px solid rgba(148,163,184,.28);color:#e2e8f0;padding:10px 12px;border-radius:12px}
.toastx.ok{border-color:rgba(34,197,94,.6)}
.toastx.err{border-color:rgba(239,68,68,.6)}

/* grid helpers */
.g-tiles{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
@media(max-width:1200px){.g-tiles{grid-template-columns:repeat(8,1fr)}}
@media(max-width:768px){.g-tiles{grid-template-columns:repeat(4,1fr)}}
.span-3{grid-column:span 3}
.span-4{grid-column:span 4}
.span-6{grid-column:span 6}
.span-8{grid-column:span 8}
</style>

<div class="container-xxl gs-scope py-4" data-realm="{{ realm }}">
  <!-- header -->
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <div class="d-flex align-items-center gap-3">
      <div class="rounded-circle" style="width:42px;height:42px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.25);background:rgba(15,23,42,.6)">
        <i class="bi bi-hdd-network text-info"></i>
      </div>
      <div>
        <h2 class="m-0">{{ realm|capitalize }}</h2>
        <div class="text-secondary small">Minecraft (Paper) · realm: <code class="text-light">{{ realm }}</code></div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="status-badge" class="badge badge-cap bg-secondary"><i class="bi bi-activity me-1"></i>unknown</span>
      <div class="form-check form-switch ms-2">
        <input class="form-check-input" type="checkbox" id="autorefresh">
        <label class="form-check-label small" for="autorefresh">Авто-обновление</label>
      </div>
      <div class="d-flex align-items-center gap-2">
        <label class="small text-secondary">интервал</label>
        <input id="refresh-interval" type="range" min="2" max="15" step="1" value="3">
        <span id="refresh-interval-label" class="small text-secondary">3s</span>
      </div>
      <button id="refresh" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-repeat me-1"></i>Обновить</button>
      <a href="{{ url_for('admin.gameservers_index') }}" class="btn btn-sm btn-outline-light"><i class="bi bi-arrow-left"></i> Назад</a>
    </div>
  </div>

  <div class="gs-layout">
    <!-- sidebar -->
    <aside class="gs-side">
      <div class="card glass p-2">
        {% set sections = [
          ('overview','Overview'),
          ('maintenance','Maintenance'),
          ('players','Players'),
          ('worlds','Worlds'),
          ('console','Console')
        ] %}
        {% for key, title in sections %}
          <a class="nav-link px-3 py-2" href="#{{ key }}"><span class="dot"></span>{{ title }}</a>
        {% endfor %}
        <a class="nav-link px-3 py-2" href="{{ url_for('admin.accounts.index') }}">
          <span class="dot"></span>Accounts
        </a>
      </div>
    </aside>

    <!-- main -->
    <main class="gs-main">

      <!-- overview -->
      <section id="overview" class="card glass mb-3">
        <div class="card-body">
          <!-- KPI tiles -->
          <div class="g-tiles">
            <button class="tile span-3 text-start" type="button" data-click data-metric="mspt" title="История MSPT (по БД)">
              <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-speedometer2"></i> MSPT</div>
              <div class="kpi d-flex align-items-baseline gap-2">
                <div id="t-mspt" class="value skel" style="height:20px;width:64px"></div>
                <div class="text-secondary small">ms</div>
              </div>
              <div class="caption">Среднее время тика</div>
            </button>

            <button class="tile span-3 text-start" type="button" data-click data-metric="tps" title="История TPS (по БД)">
              <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-graph-up-arrow"></i> TPS (avg)</div>
              <div id="t-tps" class="value skel" style="height:20px;width:64px"></div>
              <div class="caption">Среднее 1m/5m/15m</div>
            </button>

            <button id="players-tile" class="tile span-3 text-start" type="button" data-click data-metric="players">
              <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-people"></i> Players</div>
              <div id="t-players" class="value skel text-light" style="height:20px;width:80%"></div>
              <div class="small text-secondary">open list ⟶</div>
            </button>

            <button class="tile span-3 text-start" type="button" data-click data-metric="online" title="История онлайн (по БД)">
              <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-person-check"></i> Online</div>
              <div id="t-online" class="value skel" style="height:20px;width:64px"></div>
              <div class="caption">Онлайн игроков</div>
            </button>

            <button class="tile span-4 text-start" type="button" data-click data-metric="cpu" title="История загрузки CPU (по БД)">
              <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-cpu"></i> CPU</div>
              <div class="d-flex justify-content-between sub"><span>system</span><span id="cpu-system-lbl">—</span></div>
              <div class="meter mb-2"><span id="cpu-system" style="width:0%"></span></div>
              <div class="d-flex justify-content-between sub"><span>process</span><span id="cpu-proc-lbl">—</span></div>
              <div class="meter"><span id="cpu-proc" style="width:0%"></span></div>
            </button>

            <button class="tile span-4 text-start" type="button" data-click data-metric="heap" title="История памяти (по БД)">
              <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-memory"></i> Heap</div>
              <div class="d-flex justify-content-between sub"><span id="heap-used-lbl">—</span><span id="heap-max-lbl">—</span></div>
              <div class="meter"><span id="heap-bar" style="width:0%"></span></div>
              <div class="sub mt-1">Non-heap: <span id="nonheap-lbl">—</span></div>
            </button>

            <button class="tile span-4 text-start" type="button" data-click data-metric="disk" title="История диска (по БД)">
              <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-hdd"></i> Disk</div>
              <div class="sub">Root free: <span id="fs-free">—</span></div>
              <div class="sub">Root total: <span id="fs-total">—</span></div>
              <div class="tcap mt-2 d-flex align-items-center gap-1"><i class="bi bi-clock-history"></i> Uptime</div>
              <div class="sub"><span id="uptime">—</span></div>
            </button>

            <button class="tile span-6 text-start" type="button" data-click data-metric="tps1m" title="Открыть график TPS (1m) по БД">
              <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-activity"></i> TPS (1m) Sparkline</div>
              <canvas id="tpsChart" height="92"></canvas>
              <div class="form-text">Последние значения TPS (1m)</div>
            </button>

            <button class="tile span-6 text-start" type="button" data-click data-metric="entities" title="Топ сущностей (последний снимок)">
              <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-diagram-3"></i> Top Entities</div>
              <canvas id="entChart" height="120"></canvas>
              <div class="sub">Топ типов сущностей за снимок</div>
            </button>
          </div>
        </div>
      </section>

      <!-- maintenance -->
      <section id="maintenance" class="card glass mb-3">
        <div class="card-body maint">
          <div class="head">
            <h5 class="m-0 d-flex align-items-center gap-2">
              <i class="bi bi-cone-striped text-warning"></i> Maintenance
            </h5>
            <div id="maint-state" class="stat-dot o"><span class="d"></span><span>state: online</span></div>
          </div>

          <div class="mrow">
            <div class="switch-big">
              <input class="form-check-input" type="checkbox" id="maint-toggle">
              <label for="maint-toggle" class="form-check-label">Технические работы</label>
            </div>
            <div class="msg" title="Сообщение кика (необязательно)">
              <input id="maint-msg" placeholder="Kick message (optional)">
            </div>
            <div class="pills">
              <button class="btn btn-sm btn-outline-warning" data-maint-preset="15">15m</button>
              <button class="btn btn-sm btn-outline-warning" data-maint-preset="30">30m</button>
              <button class="btn btn-sm btn-outline-warning" data-maint-preset="60">1h</button>
              <button class="btn btn-sm btn-outline-warning" data-maint-preset="120">2h</button>
              <span class="caption">Авто-выключение через: <span id="maint-countdown">—</span></span>
            </div>
          </div>

          <div class="mrow">
            <div class="input-group" style="max-width:480px">
              <span class="input-group-text"><i class="bi bi-shield-check"></i> Whitelist</span>
              <input id="wl-player" class="form-control" placeholder="Player">
              <button id="wl-add" class="btn btn-outline-light"><i class="bi bi-plus-lg"></i></button>
              <button id="wl-remove" class="btn btn-outline-danger"><i class="bi bi-dash-lg"></i></button>
            </div>
            <div class="caption">Whitelist работает только в режиме техработ</div>
          </div>
        </div>
      </section>

      <!-- players -->
      <section id="players" class="card glass mb-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="mb-3">Игроки</h5>
            <input class="form-control form-control-sm" style="max-width:260px" id="players-filter" placeholder="Поиск по нику/UUID">
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead><tr><th>Ник</th><th>UUID</th><th>Мир</th><th class="text-end">Пинг</th><th>Группа</th></tr></thead>
              <tbody id="tbl-players"><tr><td colspan="5" class="text-secondary">нет данных</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- worlds -->
      <section id="worlds" class="card glass mb-3">
        <div class="card-body">
          <h5 class="mb-3">Миры</h5>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Мир</th><th>Тип</th><th>TPS</th><th>Игроки</th><th>Чанки</th><th>Сущности</th>
                  <th>View</th><th>Sim</th><th>Spawn</th>
                </tr>
              </thead>
              <tbody id="tbl-worlds"><tr><td colspan="9" class="text-secondary">нет данных</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- console -->
      <section id="console" class="card glass">
        <div class="card-body">
          <h5 class="mb-3">Консоль</h5>

          <div class="console-toolbar">
            <div class="switchx">
              <input class="form-check-input" type="checkbox" id="live-toggle" checked>
              <label for="live-toggle" class="form-check-label">Live log</label>
            </div>
            <div class="switchx">
              <input class="form-check-input" type="checkbox" id="auto-scroll" checked>
              <label for="auto-scroll" class="form-check-label">Autoscroll</label>
            </div>
            <button id="clear-log" class="btn btn-sm btn-outline-light"><i class="bi bi-eraser"></i> Clear</button>
          </div>

          <pre class="console" id="console-log">// connecting…</pre>

          <div class="input-group mt-2">
            <input id="cmd" class="form-control" placeholder="say Hello from MoonRein">
            <button id="send" class="btn btn-primary"><i class="bi bi-send"></i> Отправить</button>
          </div>
          <div id="console-status" class="small text-muted mt-1"></div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- players modal -->
<div class="modal fade" id="playersModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content glass">
      <div class="modal-header">
        <h5 class="modal-title">Players · <code>{{ realm }}</code></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="players-list" class="vstack gap-1">
          <div class="text-secondary">Loading…</div>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-secondary">Скины: Mojang (textures.minecraft.net) / Crafatar</small>
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- metrics modal (универсальный для кликабельных плиток) -->
<div class="modal fade" id="metricsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-xl">
    <div class="modal-content glass">
      <div class="modal-header">
        <h5 class="modal-title" id="metricsTitle">Metrics</h5>
        <div class="d-flex align-items-center gap-2">
          <select id="m-range" class="form-select form-select-sm">
            <option value="60">1h</option>
            <option value="180" selected>3h</option>
            <option value="720">12h</option>
            <option value="1440">24h</option>
            <option value="4320">3d</option>
          </select>
          <select id="m-step" class="form-select form-select-sm">
            <option value="30">30s</option>
            <option value="60" selected>60s</option>
            <option value="120">2m</option>
            <option value="300">5m</option>
          </select>
        </div>
        <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="metricsChart" height="280" style="width:100%"></canvas>
        <div class="small text-secondary mt-2">Данные берутся из БД (/api/stats/series). Если сервер офлайн — можно смотреть историю.</div>
        <div id="metricsLegend" class="small mt-2"></div>
      </div>
      <div class="modal-footer">
        <button id="exportCsv" type="button" class="btn btn-outline-info btn-sm"><i class="bi bi-download"></i> CSV</button>
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
const realm = document.querySelector("[data-realm]").dataset.realm;
const LS_AUTO_KEY = `gs_auto_${realm}`;
const LS_INT_KEY = `gs_auto_int_${realm}`;
let tpsSeries = [], entSeries = [], timer = null, lastStats = null;
let maintTimer = null, maintUntil = 0;

/* ---------- client meta ---------- */
function clientMeta(){
  const tz = (Intl.DateTimeFormat().resolvedOptions().timeZone || "");
  const tzOffsetMin = -new Date().getTimezoneOffset(); // east-positive
  const lang = (navigator.language || "");
  const dpr = (window.devicePixelRatio || 1);
  const vp = `${window.innerWidth}x${window.innerHeight}@${dpr}`;
  const sc = (screen && `${screen.width}x${screen.height}`) || "";
  const vis = (document.visibilityState || "");
  return { tz, tzOffsetMin, lang, vp, sc, vis,
    ua: navigator.userAgent || "", ref: document.referrer || "",
    page: location.pathname + location.search, ts: Date.now()
  };
}
function clientHeaders(c){
  return {
    "Content-Type":"application/json",
    "X-Client-TZ": c.tz || "",
    "X-Client-Of": String(c.tzOffsetMin ?? ""),
    "X-Client-Lang": c.lang || ""
  };
}

/* toasts */
function toast(msg, ok=true){
  const wrap = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = 'toastx ' + (ok?'ok':'err');
  el.innerHTML = `<div class="small">${msg}</div>`;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(), 320); }, 2200);
}

/* status */
function setStatusBadge(state){
  const el = document.getElementById("status-badge");
  el.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary");
  if(state==="online") el.classList.add("bg-success");
  else if(state==="maintenance") el.classList.add("bg-warning");
  else if(state==="offline") el.classList.add("bg-danger");
  else el.classList.add("bg-secondary");
  el.innerHTML = `<i class="bi bi-activity me-1"></i>${state || "unknown"}`;

  const ms = document.getElementById("maint-state");
  ms.classList.remove("o","m");
  ms.classList.add(state==="maintenance" ? "m" : "o");
  ms.querySelector("span:last-child").textContent = `state: ${state}`;
}

/* sparkline */
function drawSparkline(canvas, values){
  const ctx = canvas.getContext("2d");
  const w = canvas.width = canvas.clientWidth, h = canvas.height = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  if(!values.length) return;
  const min = Math.min(...values), max = Math.max(...values), pad = 6;
  const xi = i => pad + (w-2*pad) * (i/((values.length-1)||1));
  const yi = v => h - pad - (h-2*pad) * ((v-min)/((max-min)||1));
  ctx.lineWidth = 2;
  ctx.strokeStyle = "rgba(148,163,184,.9)";
  ctx.beginPath();
  values.forEach((v,i)=>{ const x=xi(i), y=yi(v); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();
}

/* tiny bar chart (entities) */
function drawBars(canvas, items){
  const ctx = canvas.getContext("2d");
  const w = canvas.width = canvas.clientWidth, h = canvas.height = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  if(!items.length) return;
  const pad = 18, gap = 6, n = items.length;
  const maxVal = Math.max(...items.map(i=>i.value));
  const bw = (w - pad*2 - gap*(n-1)) / n;
  ctx.fillStyle = "rgba(148,163,184,.85)";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.textAlign = "center"; ctx.textBaseline = "top";
  items.forEach((it,idx)=>{
    const x = pad + idx*(bw+gap);
    const hNorm = maxVal? Math.max(2, (h-36) * (it.value/maxVal)) : 2;
    const y = h-18 - hNorm;
    ctx.fillRect(x, y, bw, hNorm);
    const label = (it.name||"").slice(0,10);
    ctx.fillText(label, x + bw/2, h-16);
  });
}

/* multi-line chart for modal */
function drawLines(canvas, seriesMap, opts={}){
  const ctx = canvas.getContext("2d");
  const w = canvas.width = canvas.clientWidth, h = canvas.height = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);

  const labels = Object.keys(seriesMap);
  const all = [];
  labels.forEach(k=>{ all.push(...seriesMap[k].map(p=>p.y).filter(v=>v!=null && !isNaN(v))); });
  if(!all.length){ ctx.fillStyle="#94a3b8"; ctx.fillText("Нет данных", 12, 16); return; }

  const min = Math.min(...all), max = Math.max(...all);
  const padL = 42, padR = 10, padT = 14, padB = 24;

  const xs = seriesMap[labels[0]].map(p=>p.x);
  const x0 = xs[0], x1 = xs[xs.length-1] || (x0+1);

  function X(ts){ return padL + (w-padL-padR) * ((ts - x0)/((x1-x0)||1)); }
  function Y(val){
    const v = (opts.y01? Math.max(0, Math.min(1, val)) : val);
    const mi = opts.y01 ? 0 : min;
    const ma = opts.y01 ? 1 : Math.max(max, min+1e-9);
    return h - padB - (h-padT-padB) * ((v - mi)/((ma - mi)||1));
  }

  // grid + axes labels
  ctx.font="12px system-ui,-apple-system,Segoe UI,Roboto";
  ctx.fillStyle="#94a3b8";
  for(let i=0;i<=4;i++){
    const yy = padT + (h-padT-padB)*i/4;
    ctx.save();
    ctx.strokeStyle="rgba(148,163,184,.22)";
    ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(padL,yy); ctx.lineTo(w-padR,yy); ctx.stroke();
    ctx.restore();
    const val = (opts.y01 ? (1 - i/4) : (max - (max-min)*i/4));
    const lbl = opts.y01 ? Math.round(val*100)+"%" : (Math.abs(val)>=1000 ? Math.round(val) : val.toFixed(2));
    ctx.fillText(lbl, 6, yy+4);
  }
  const fmt = ts => new Date(ts*1000).toLocaleTimeString();
  ctx.fillText(fmt(x0), padL, h-6);
  ctx.textAlign="right"; ctx.fillText(fmt(x1), w-10, h-6); ctx.textAlign="left";

  // palette
  const palette = ["#60a5fa","#34d399","#f59e0b","#f472b6","#a78bfa","#22d3ee","#f87171"];

  // draw lines
  labels.forEach((label, idx)=>{
    const pts = seriesMap[label];
    ctx.beginPath();
    pts.forEach((p,i)=>{ const x=X(p.x), y=Y(p.y); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
    ctx.lineWidth = 2;
    ctx.strokeStyle = palette[idx % palette.length];
    ctx.stroke();
  });
}

/* export CSV */
function toCSV(rows){
  if(!rows.length) return "";
  const keys = Object.keys(rows[0]);
  const esc=v=> `"${String(v??"").replace(/"/g,'""')}"`;
  return [keys.join(","), ...rows.map(r=>keys.map(k=>esc(r[k])).join(","))].join("\n");
}

/* unskeleton */
function unskeleton(){
  for(const id of ["t-mspt","t-tps","t-players","t-online"]){
    const el = document.getElementById(id);
    el.classList.remove('skel'); el.style.removeProperty('width'); el.style.removeProperty('height');
  }
}

/* helpers */
function avgTps(tps){
  if(!tps) return null;
  const arr = [tps["1m"], tps["5m"], tps["15m"]].filter(v=>typeof v==="number");
  if(!arr.length) return null;
  return arr.reduce((a,b)=>a+b,0) / arr.length;
}
function bytesFmt(v){
  if(v==null||v<0) return "—";
  const u = ["B","KB","MB","GB","TB"]; let i=0; let x=v;
  while(x>=1024 && i<u.length-1){ x/=1024; i++; }
  return `${x.toFixed(1)} ${u[i]}`;
}
function percentFmt(x){ if(x==null||x<0) return "—"; return `${Math.round(x*100)}%`; }
function humanMs(ms){
  if(!ms||ms<0) return "—";
  let s = Math.floor(ms/1000);
  const d = Math.floor(s/86400); s%=86400;
  const h = Math.floor(s/3600); s%=3600;
  const m = Math.floor(s/60); s%=60;
  const parts=[]; if(d) parts.push(d+"d"); if(h) parts.push(h+"h"); if(m) parts.push(m+"m"); if(s) parts.push(s+"s");
  return parts.join(" ")||"0s";
}

/* ---------- robust normalize ---------- */
function normalize(raw){
  const p = raw && typeof raw === 'object'
    ? (raw.data && typeof raw.data === 'object' ? raw.data
      : raw.payload && typeof raw.payload === 'object' ? raw.payload
      : raw)
    : {};

  const tps = p.tps && typeof p.tps === 'object'
    ? { "1m":p.tps["1m"] ?? p.tps_1m, "5m":p.tps["5m"] ?? p.tps_5m, "15m":p.tps["15m"] ?? p.tps_15m, "mspt": p.tps.mspt ?? p.mspt }
    : { "1m":p.tps_1m, "5m":p.tps_5m, "15m":p.tps_15m, "mspt": p.mspt };

  const players = p.players && typeof p.players === 'object'
    ? { max:p.players.max ?? p.players_max, online:p.players.online ?? p.players_online }
    : { max:p.players_max, online:p.players_online };

  const players_list =
    (Array.isArray(p.players_list) && p.players_list) ||
    (p.players && Array.isArray(p.players.list) && p.players.list) ||
    (Array.isArray(p.playersList) && p.playersList) ||
    [];

  let worlds = [];
  if (Array.isArray(p.worlds)) {
    worlds = p.worlds;
  } else if (p.worlds && typeof p.worlds === 'object') {
    worlds = Object.keys(p.worlds).map(name => {
      const w = p.worlds[name] || {};
      return {
        name,
        type: w.type || "",
        tps: w.tps || [],
        players: w.players ?? w.players_count ?? "",
        loadedChunks: w.chunks_loaded ?? w.loadedChunks ?? "",
        entities: w.entities ?? "",
        view_distance: w.view_distance ?? "",
        simulation_distance: w.simulation_distance ?? "",
        spawn: w.spawn || null
      };
    });
  }

  const heap = p.heap || {};
  const nonheap = p.nonheap || {};
  const os = p.os || {};
  const jvm = p.jvm || {};
  const fs = p.fs || {};
  const entities_top = p.entities_top_types || {};

  return {
    realm: p.realm || raw.realm || "{{ realm }}",
    tps, mspt: tps.mspt ?? p.mspt ?? null, players, players_list, worlds,
    heap, nonheap, os, jvm, fs, entities_top
  };
}

/* render stats */
function render(payload){
  const p = normalize(payload);
  lastStats = p;

  // status
  const tps1m = p?.tps?.["1m"];
  const online = (p?.players?.online ?? null);
  const status = (typeof online === "number" && online>0) || (typeof tps1m === "number" && tps1m>0) ? "online" : "offline";
  setStatusBadge(status);

  // KPIs
  const mspt = p.mspt ?? null;
  const tpsAvg = avgTps(p.tps);
  document.getElementById("t-mspt").textContent = (typeof mspt==="number") ? mspt.toFixed(2) : "—";
  document.getElementById("t-tps").textContent  = (typeof tpsAvg==="number") ? tpsAvg.toFixed(2) : "—";
  document.getElementById("t-online").textContent = (typeof online==="number") ? online : "—";

  // players tile
  const playersArr = p.players_list || [];
  document.getElementById("t-players").textContent = playersArr.map(x=>x.name).join(", ") || "—";
  unskeleton();

  // charts (inline)
  if(typeof tps1m==="number"){ tpsSeries.push(tps1m); if(tpsSeries.length>60) tpsSeries.shift(); }
  drawSparkline(document.getElementById("tpsChart"), tpsSeries);

  const entPairs = Object.entries(p.entities_top||{}).map(([name,value])=>({name,value}));
  entPairs.sort((a,b)=>b.value-a.value);
  drawBars(document.getElementById("entChart"), entPairs.slice(0,12));

  // CPU
  const sys = p.os?.cpu_load?.system ?? null;
  const proc = p.os?.cpu_load?.process ?? null;
  document.getElementById("cpu-system").style.width = (sys!=null? (sys*100).toFixed(0):0)+"%";
  document.getElementById("cpu-system-lbl").textContent = percentFmt(sys);
  document.getElementById("cpu-proc").style.width = (proc!=null? (proc*100).toFixed(0):0)+"%";
  document.getElementById("cpu-proc-lbl").textContent = percentFmt(proc);

  // Heap/Non-heap
  const hu = p.heap?.used ?? null, hm = p.heap?.max ?? null;
  const nhu = p.nonheap?.used ?? null;
  const perc = (hu!=null && hm>0) ? Math.min(100, Math.round(hu/hm*100)) : 0;
  document.getElementById("heap-used-lbl").textContent = `used ${bytesFmt(hu)}`;
  document.getElementById("heap-max-lbl").textContent = `max ${bytesFmt(hm)}`;
  document.getElementById("heap-bar").style.width = perc + "%";
  document.getElementById("nonheap-lbl").textContent = bytesFmt(nhu);

  // FS
  const rf = p.fs?.root_free ?? p.fs?.free;
  const rt = p.fs?.root_total ?? p.fs?.total;
  document.getElementById("fs-free").textContent  = bytesFmt(rf);
  document.getElementById("fs-total").textContent = bytesFmt(rt);

  // Uptime
  document.getElementById("uptime").textContent = humanMs(p.jvm?.uptime_ms);

  // Таблица игроков (с фильтром)
  const filter = (document.getElementById("players-filter").value || "").toLowerCase().trim();
  const filtered = !filter ? playersArr : playersArr.filter(x =>
    (x.name||"").toLowerCase().includes(filter) || (x.uuid||"").toLowerCase().includes(filter)
  );
  const pt = document.getElementById("tbl-players");
  pt.innerHTML = filtered.length ? filtered.map(pl=>`
    <tr>
      <td>${pl.name}</td>
      <td class="small">${pl.uuid||""}</td>
      <td>${pl.world||""}</td>
      <td class="text-end">${(pl.ping??"")}</td>
      <td>${pl.lp_primary||""}</td>
    </tr>
  `).join("") : `<tr><td colspan="5" class="text-secondary">нет данных</td></tr>`;

  // Таблица миров
  const wt = document.getElementById("tbl-worlds");
  const worlds = p.worlds||[];
  wt.innerHTML = worlds.length ? worlds.map(w=>`
    <tr>
      <td>${w.name}</td>
      <td>${w.type||""}</td>
      <td>${(w.tps||[]).join(", ")}</td>
      <td>${w.players??""}</td>
      <td>${w.loadedChunks??w.chunks_loaded??""}</td>
      <td>${w.entities??""}</td>
      <td>${w.view_distance??""}</td>
      <td>${w.simulation_distance??""}</td>
      <td>${w.spawn?`${w.spawn.x},${w.spawn.y},${w.spawn.z}`:""}</td>
    </tr>
  `).join("") : `<tr><td colspan="9" class="text-secondary">нет данных</td></tr>`;
}

/* polling stats */
async function fetchStats(){
  try{
    const r = await fetch(`/admin/gameservers/api/stats?realm=${encodeURIComponent(realm)}`, {cache:"no-store"});
    const j = await r.json();
    if(!j.ok){ setStatusBadge("offline"); return; }
    render(j.data||{});
  }catch(e){ setStatusBadge("offline"); }
}

/* players modal */
function openPlayersModal(){
  const list = document.getElementById("players-list");
  list.innerHTML = "";
  const players = (lastStats?.players_list)||[];
  if(players.length===0){
    list.innerHTML = `<div class="text-secondary">Игроков нет.</div>`;
  } else {
    for(const p of players){
      const row = document.createElement("div");
      row.className = "player-row";
      const uuid = (p.uuid||"").replace(/-/g,"");
      const headSrc = `/admin/gameservers/api/player-head?name=${encodeURIComponent(p.name)}&uuid=${encodeURIComponent(uuid)}`;
      row.innerHTML = `
        <img class="player-head" width="32" height="32" src="${headSrc}" alt="">
        <div class="flex-grow-1">
          <div class="text-light">${p.name}</div>
          <div class="small text-secondary">${uuid}${p.world? " · "+p.world : ""}</div>
        </div>`;
      list.appendChild(row);
    }
  }
  bootstrap.Modal.getOrCreateInstance(document.getElementById('playersModal')).show();
}

/* ---------- DB Series: modal loader (рисуем ПОСЛЕ показа модалки) ---------- */
async function fetchSeries({minutes=180, step=60, fields=[]}){
  const params = new URLSearchParams({
    realm, minutes:String(minutes), step:String(step),
    ...(fields.length? {fields: fields.join(",")} : {})
  });
  const r = await fetch(`/admin/gameservers/api/stats/series?`+params.toString(), {cache:"no-store"});
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||"db error");
  return j.data||[];
}

// состояние последнего графика (для перерисовки)
let _metricsLast = { seriesMap: null, opts: null, kind: null, rows: [] };

function renderMetricsChart(){
  const canvas = document.getElementById("metricsChart");
  if (!canvas || !_metricsLast.seriesMap) {
    if (canvas) { canvas.width = canvas.clientWidth; canvas.height = 280; }
    return;
  }
  canvas.width  = canvas.clientWidth;
  canvas.height = 280;
  drawLines(canvas, _metricsLast.seriesMap, _metricsLast.opts || {});
}

window.addEventListener('resize', ()=> requestAnimationFrame(renderMetricsChart));

async function openMetric(kind){
  const modalEl = document.getElementById('metricsModal');
  const modal   = bootstrap.Modal.getOrCreateInstance(modalEl);
  const title   = document.getElementById("metricsTitle");
  const legend  = document.getElementById("metricsLegend");
  const canvas  = document.getElementById("metricsChart");

  let fields = [], titleText = "", y01=false;

  switch(kind){
    case "mspt":    fields = ["mspt"]; titleText = "MSPT (tick duration, ms)"; break;
    case "tps":     fields = ["tps_1m","tps_5m","tps_15m"]; titleText = "TPS (1m / 5m / 15m)"; break;
    case "tps1m":   fields = ["tps_1m"]; titleText = "TPS (1m)"; break;
    case "online":
    case "players": fields = ["players_online"]; titleText = "Онлайн игроков"; break;
    case "cpu":     fields = ["cpu_system_load","cpu_process_load"]; titleText = "CPU load (system / process)"; y01=true; break;
    case "heap":    fields = ["heap_used","heap_max","nonheap_used"]; titleText = "Память Heap / Non-heap (байты)"; break;
    case "disk":    fields = ["fs_root_free","fs_root_total"]; titleText = "Диск (root free / total, байты)"; break;
    case "entities":
      title.textContent = "Top entities (последний снимок) · " + realm;
      legend.textContent = "";
      modal.show();
      modalEl.addEventListener('shown.bs.modal', function once(){
        modalEl.removeEventListener('shown.bs.modal', once);
        canvas.width = canvas.clientWidth; canvas.height = 280;
        const data = lastStats?.entities_top || {};
        const items = Object.entries(data).map(([name,val])=>({name,value:val}))
                       .sort((a,b)=>b.value-a.value).slice(0,16);
        const ctx = canvas.getContext("2d"); ctx.clearRect(0,0,canvas.width,canvas.height);
        drawBars(canvas, items);
      });
      return;
    default:
      fields = []; titleText = "Metrics";
  }

  title.textContent = `${titleText} · ${realm}`;
  legend.textContent = "Загрузка…";
  modal.show(); // показать, чтобы canvas имел реальную ширину

  const minutes = parseInt(document.getElementById("m-range").value,10)||180;
  const step    = parseInt(document.getElementById("m-step").value,10)||60;

  try{
    const rows = await fetchSeries({minutes, step, fields});
    if(!rows.length){
      _metricsLast = { seriesMap:null, opts:null, kind, rows:[] };
      legend.textContent = "Нет данных за выбранный период";
    }else{
      const seriesMap = {}; fields.forEach(f=> seriesMap[f]=[]);
      rows.forEach(r=>{
        const ts = r.ts || r.time || r.timestamp || r.t || Math.floor(Date.now()/1000);
        fields.forEach(f=>{
          let v = r[f];
          if(v==null) return;
          if (y01 && typeof v === "number") v = Math.max(0, Math.min(1, v));
          seriesMap[f].push({x: ts, y: v});
        });
      });
      Object.keys(seriesMap).forEach(k=>{ if(!seriesMap[k].length) delete seriesMap[k]; });
      _metricsLast = { seriesMap, opts:{y01}, kind, rows };

      const doDraw = ()=>{ renderMetricsChart(); };
      if (modalEl.classList.contains('show')) { doDraw(); }
      else {
        modalEl.addEventListener('shown.bs.modal', function once(){
          modalEl.removeEventListener('shown.bs.modal', once);
          doDraw();
        });
      }

      const names = {
        mspt: "MSPT",
        tps_1m: "TPS 1m", tps_5m:"TPS 5m", tps_15m:"TPS 15m",
        players_online:"Players online",
        cpu_system_load:"CPU system", cpu_process_load:"CPU process",
        heap_used:"Heap used", heap_max:"Heap max", nonheap_used:"Non-heap used",
        fs_root_free:"Root free", fs_root_total:"Root total"
      };
      const span = txt => `<span class="badge bg-secondary me-1">${txt}</span>`;
      legend.innerHTML = Object.keys(seriesMap).map(k=>span(names[k]||k)).join("") +
        `<div class="mt-2 text-secondary small">Точек: ${rows.length}, шаг: ${step}s, период: ${minutes}m</div>`;

      document.getElementById("exportCsv").onclick = ()=>{
        const csv = toCSV(rows);
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${realm}_${kind}_${minutes}m_${step}s.csv`;
        a.click();
        URL.revokeObjectURL(a.href);
      };
    }
  }catch(e){
    _metricsLast = { seriesMap:null, opts:null, kind, rows:[] };
    legend.innerHTML = `<span class="text-danger">${e.message||e}</span>`;
  }
}

/* ---------- SSE: live console with meta in query ---------- */
let es=null;
function sseQuery(){
  const c = clientMeta();
  const sp = new URLSearchParams({
    realm,
    tz: c.tz || "",
    of: String(c.tzOffsetMin ?? ""),
    lang: c.lang || "",
    vp: c.vp || "",
    sc: c.sc || "",
    vis: c.vis || ""
  });
  return sp.toString();
}
function appendLine(line){
  const pre = document.getElementById('console-log');
  pre.textContent += (pre.textContent?'\n':'') + line;
  if(document.getElementById('auto-scroll').checked){
    pre.scrollTop = pre.scrollHeight;
  }
}
function fmtLine(p){
  const t  = new Date().toLocaleTimeString();
  const lv = p.level ? `[${p.level}] ` : '';
  const sc = p.source ? `${p.source}: ` : '';
  const msg = p.line || p.message || JSON.stringify(p);
  return `[${t}] ${lv}${sc}${msg}`;
}
function startLive(){
  if(es) return;
  const url = `/admin/gameservers/api/console/stream?` + sseQuery();
  es = new EventSource(url);
  es.onmessage = (ev)=>{ try{ appendLine(fmtLine(JSON.parse(ev.data||'{}')));}catch{} };
  es.addEventListener('err', (ev)=>{ appendLine(`[stream] ${ev.data}`); });
  es.onerror = ()=>{}; // авто-reconnect
}
function stopLive(){ try{es?.close();}catch{} es=null; }

/* ---------- POST helpers that attach client meta ---------- */
async function postJSON(url, obj){
  const c = clientMeta();
  const r = await fetch(url, {
    method:"POST",
    headers: clientHeaders(c),
    body: JSON.stringify({...obj, client: c})
  });
  return r.json();
}

/* console: send command */
async function sendCmd(){
  const cmd = document.getElementById("cmd").value.trim();
  if(!cmd) return;
  const btn = document.getElementById("send"), st = document.getElementById("console-status");
  btn.disabled = true; st.textContent = "Отправка...";
  try{
    const j = await postJSON("/admin/gameservers/api/console", {realm, cmd});
    st.textContent = j.ok ? "OK" : (j.error||"error");
    toast(j.ok ? "Команда отправлена" : (j.error||"Ошибка"), j.ok);
    if(j.ok){ document.getElementById("cmd").value=""; }
  }catch(e){ st.textContent = e.message||"network error"; toast(st.textContent, false); }
  finally{ btn.disabled = false; }
}

/* -------------- Maintenance: toggle + presets + auto-off -------------- */
async function setMaintenance(enabled){
  const msg = document.getElementById("maint-msg").value.trim();
  const j = await postJSON("/admin/gameservers/api/maintenance", {realm, enabled, kickMessage: msg, message: msg});
  if (j.ok && enabled) setStatusBadge("maintenance");
  if (j.ok && !enabled) setStatusBadge("online");
  toast(j.ok ? (enabled?"Техработы включены":"Техработы отключены") : (j.error||"Ошибка"), j.ok);
  return j.ok;
}
function maintUpdateCountdown(){
  if(!maintUntil){ document.getElementById("maint-countdown").textContent = "—"; return; }
  const left = Math.max(0, maintUntil - Date.now());
  document.getElementById("maint-countdown").textContent = humanMs(left);
  if(left<=0){ maintUntil = 0; document.getElementById("maint-toggle").checked = false; }
}
async function maintToggleHandler(e){
  const on = e.target.checked;
  const ok = await setMaintenance(on);
  if(!ok){ e.target.checked = !on; return; }
  if(!on){ clearInterval(maintTimer); maintUntil = 0; maintUpdateCountdown(); }
}
async function maintPreset(minutes){
  const ok = await setMaintenance(true);
  if(!ok) return;
  maintUntil = Date.now() + minutes*60*1000;
  clearInterval(maintTimer);
  maintTimer = setInterval(async ()=>{
    const left = maintUntil - Date.now();
    maintUpdateCountdown();
    if(left<=0){
      clearInterval(maintTimer);
      maintUntil = 0;
      await setMaintenance(false);
      document.getElementById("maint-toggle").checked = false;
    }
  }, 1000);
  maintUpdateCountdown();
}

/* whitelist */
async function wlChange(op){
  const player = document.getElementById("wl-player").value.trim();
  if(!player) return;
  const j = await postJSON("/admin/gameservers/api/maintenance/whitelist", {realm, op, player});
  toast(j.ok ? `Whitelist: ${op} ${player}` : (j.error||"Ошибка"), j.ok);
  if (j.ok && op === "add") document.getElementById("wl-player").value = "";
}

/* sidebar actives */
const links = Array.from(document.querySelectorAll('.gs-side .nav-link[href^="#"]'));
const ids = links.map(a => a.getAttribute('href')).filter(Boolean).map(h => h.replace('#',''));
const obs = new IntersectionObserver((entries)=>{
  entries.forEach(e=>{
    const id = e.target.id;
    const link = links.find(a => a.getAttribute('href') === '#' + id);
    if(link){ e.isIntersecting ? link.classList.add('active') : link.classList.remove('active'); }
  });
},{rootMargin:'-40% 0px -50% 0px', threshold:0.01});
ids.forEach(id => { const el = document.getElementById(id); if(el) obs.observe(el); });

/* binds + persistence */
document.getElementById("send").addEventListener("click", sendCmd);
document.getElementById("cmd").addEventListener("keydown", e=>{ if(e.key==="Enter") sendCmd(); });
document.getElementById("refresh").addEventListener("click", fetchStats);
document.getElementById("players-tile")?.addEventListener("click", openPlayersModal);
document.getElementById("players-filter").addEventListener("input", ()=>{ if(lastStats) render(lastStats); });

document.getElementById("live-toggle").addEventListener("change", e=>{ e.target.checked ? startLive() : stopLive(); });
document.getElementById("clear-log").addEventListener("click", ()=>{ document.getElementById('console-log').textContent=""; });

document.getElementById("wl-add").addEventListener("click", ()=>wlChange("add"));
document.getElementById("wl-remove").addEventListener("click", ()=>wlChange("remove"));

/* maintenance ui binds */
document.getElementById("maint-toggle").addEventListener("change", maintToggleHandler);
document.querySelectorAll("[data-maint-preset]").forEach(btn=>{
  btn.addEventListener("click", ()=>maintPreset(parseInt(btn.dataset.maintPreset,10)));
});

/* make ALL tiles with data-metric open modal */
document.querySelectorAll('.tile[data-metric]').forEach(el=>{
  el.addEventListener('click', ()=>{
    const kind = el.getAttribute('data-metric');
    if(kind === 'players'){ openPlayersModal(); } else { openMetric(kind); }
  });
});

/* react to range/step changes in modal */
document.getElementById("m-range").addEventListener("change", ()=>{
  if (_metricsLast.kind) openMetric(_metricsLast.kind);
});
document.getElementById("m-step").addEventListener("change", ()=>{
  if (_metricsLast.kind) openMetric(_metricsLast.kind);
});

/* init */
fetchStats();
function applyTimer(){
  clearInterval(timer);
  if(document.getElementById("autorefresh").checked){
    const sec = Math.max(2, parseInt(document.getElementById("refresh-interval").value,10)||3);
    timer = setInterval(fetchStats, sec*1000);
  }
}
const autoEl = document.getElementById("autorefresh");
const intEl  = document.getElementById("refresh-interval");
const intLbl = document.getElementById("refresh-interval-label");
autoEl.checked = (localStorage.getItem(LS_AUTO_KEY) ?? "1") !== "0";
intEl.value    = localStorage.getItem(LS_INT_KEY) || "3";
intLbl.textContent = intEl.value + "s";
autoEl.addEventListener("change", e=>{
  localStorage.setItem(LS_AUTO_KEY, e.target.checked ? "1" : "0");
  applyTimer();
});
intEl.addEventListener("input", e=>{
  intLbl.textContent = e.target.value + "s";
  localStorage.setItem(LS_INT_KEY, e.target.value);
  applyTimer();
});
applyTimer();
startLive();
</script>
{% endblock %}
