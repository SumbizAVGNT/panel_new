{% extends "layout/base.html" %}
{% block title %}{{ realm }} — Game Server{% endblock %}

{% block content %}
<style>
/* ——— (тот же стиль, как в предыдущей версии; укоротил, но функционально без изменений) ——— */
:root{--bg:#0b1220;--card:rgba(13,17,23,.55);--border:rgba(148,163,184,.18);--border-strong:rgba(148,163,184,.28);--muted:#94a3b8;--text:#e5e7eb;--text-dim:#cbd5e1;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444}
.container-xxl.gs-scope{background:radial-gradient(700px 360px at 50% -12%, rgba(148,163,184,.10), transparent 70%),linear-gradient(180deg, rgba(13,17,23,.55), rgba(13,17,23,.42));border:1px solid var(--border);border-radius:18px}
.gs-layout{display:grid;grid-template-columns:300px 1fr;gap:16px}@media (max-width:992px){.gs-layout{grid-template-columns:1fr}}
.card.glass{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(8px)}
.table>:not(caption)>*>*{background:transparent;color:var(--text)}
.gs-side{position:sticky;top:76px;align-self:start}
.gs-side .nav-link{border:1px solid var(--border);border-radius:12px;margin-bottom:8px;display:flex;align-items:center;gap:8px;color:var(--text)}
.gs-side .nav-link .dot{width:6px;height:6px;border-radius:999px;background:rgba(148,163,184,.5)}
.gs-side .nav-link.active{background:#0f172a;box-shadow:inset 0 0 0 1px var(--border-strong)}
.gs-side .nav-link.active .dot{background:var(--ok)}
.tile{position:relative;isolation:isolate;display:flex;flex-direction:column;gap:6px;padding:16px;border-radius:14px;border:1px solid var(--border);background:var(--card)}
.tile[data-click]{cursor:pointer}.tile:before{content:"";position:absolute;inset:-1px;border-radius:14px;z-index:-1;background:radial-gradient(260px 140px at 0% 0%, rgba(56,189,248,.20), transparent 70%),radial-gradient(260px 140px at 100% 100%, rgba(34,197,94,.12), transparent 70%);opacity:.28;transition:.2s}.tile:hover:before{opacity:.5}
.tcap{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}.kpi .value{font-size:1.25rem}.badge-cap{padding:.35rem .6rem;border-radius:999px}
.maint-card .head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
.stat-dot{display:inline-flex;align-items:center;gap:6px;font-size:.86rem;color:var(--text-dim)}
.stat-dot .d{width:8px;height:8px;border-radius:999px;background:#475569}.stat-dot.m .d{background:var(--warn)}.stat-dot.o .d{background:var(--ok)}
.ctrlbar{display:flex;flex-wrap:wrap;gap:10px}.ctrl{display:flex;align-items:center;background:rgba(15,23,42,.55);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.ctrl .label{display:flex;align-items:center;gap:6px;padding:0 10px;color:var(--text-dim);border-right:1px solid var(--border)}
.ctrl input{border:0;background:transparent;color:var(--text);outline:0;width:280px;min-width:160px}.ctrl .btn{border:0}
.ctrl .btn-start{background:var(--warn);color:#111827}.ctrl .btn-stop{background:transparent;border-left:1px solid var(--border);color:var(--text)}
.ctrl .btn:hover{filter:brightness(1.05)}.ctrl .btn:active{transform:translateY(1px)}
.ctrl .btn,.ctrl .label,.ctrl input{height:36px}.ctrl.wl input{width:200px}
.console-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:8px}.switchx{display:flex;align-items:center;gap:6px;font-size:.9rem}
pre.console{max-height:360px;overflow:auto;background:rgba(15,23,42,.44);border-radius:10px;padding:10px;border:1px solid var(--border);white-space:pre-wrap;color:#d1d5db}
.player-head{width:32px;height:32px;border-radius:6px;border:1px solid rgba(148,163,184,.25);background:rgba(15,23,42,.5);image-rendering:pixelated}
.player-row{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:8px}.player-row:hover{background:rgba(148,163,184,.06)}
.skel{position:relative;overflow:hidden;background:rgba(148,163,184,.12);border-radius:8px}
.skel:after{content:"";position:absolute;inset:0;background:linear-gradient(90deg, transparent, rgba(255,255,255,.07), transparent);transform:translateX(-100%);animation:shimmer 1.2s infinite}
@keyframes shimmer{100%{transform:translateX(100%)}}
#toasts{position:fixed;right:16px;bottom:16px;z-index:1080;display:flex;flex-direction:column;gap:8px}
.toastx{background:rgba(13,17,23,.96);border:1px solid var(--border-strong);color:#e2e8f0;padding:10px 12px;border-radius:12px}
.toastx.ok{border-color:rgba(34,197,94,.6)}.toastx.err{border-color:rgba(239,68,68,.6)}
.badge-online{background:var(--ok)}.badge-maint{background:var(--warn)}.badge-off{background:var(--err)}.badge-unknown{background:#64748b}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.form-text{color:var(--muted)}.code-chip{padding:.2rem .4rem;border:1px solid var(--border);border-radius:6px;background:rgba(15,23,42,.55);font-family:ui-monospace,Menlo,Consolas,monospace}
</style>

<div class="container-xxl gs-scope py-4" data-realm="{{ realm }}">
  <!-- header -->
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <div class="d-flex align-items-center gap-3">
      <div class="rounded-circle" style="width:42px;height:42px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);background:rgba(15,23,42,.6)">
        <i class="bi bi-hdd-network text-info" aria-hidden="true"></i>
      </div>
      <div>
        <h2 class="m-0">{{ realm|capitalize }}</h2>
        <div class="text-secondary small">
          Minecraft (Paper) · realm:
          <button id="copy-realm" class="code-chip btn btn-sm btn-ghost p-1" title="Copy realm" aria-label="Copy realm">
            <code class="text-light">{{ realm }}</code>
            <i class="bi bi-clipboard ms-1"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="status-badge" class="badge badge-cap badge-unknown"><i class="bi bi-activity me-1"></i>unknown</span>
      <small id="latency" class="text-secondary ms-1">ping: —</small>
      <div class="form-check form-switch ms-2">
        <input class="form-check-input" type="checkbox" id="autorefresh">
        <label class="form-check-label small" for="autorefresh">Авто-обновление</label>
      </div>
      <button id="refresh" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-repeat me-1"></i>Обновить</button>
      <a href="{{ url_for('admin.gameservers_index') }}" class="btn btn-sm btn-outline-light"><i class="bi bi-arrow-left"></i> Назад</a>
    </div>
  </div>

  <div class="gs-layout">
    <!-- sidebar -->
    <aside class="gs-side" aria-label="Навигация по разделам">
      <div class="card glass p-2">
        {% set sections = [('overview','Overview'),('maintenance','Maintenance'),('players','Players'),('worlds','Worlds'),('console','Console')] %}
        {% for key, title in sections %}
          <a class="nav-link px-3 py-2" href="#{{ key }}"><span class="dot"></span>{{ title }}</a>
        {% endfor %}
        <a class="nav-link px-3 py-2" href="{{ url_for('admin.accounts.index') }}">
          <span class="dot"></span>Accounts
        </a>
      </div>
    </aside>

    <!-- main -->
    <main class="gs-main">

      <!-- overview -->
      <section id="overview" class="card glass mb-3" aria-labelledby="ov-title">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <h5 id="ov-title" class="m-0">Overview</h5>
            <small id="conn-state" class="text-secondary">SSE: <span data-sse="state">connecting…</span></small>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-6 col-md-3">
              <div class="tile">
                <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-speedometer2"></i> MSPT</div>
                <div class="kpi d-flex align-items-baseline gap-2">
                  <div id="t-mspt" class="value skel" style="height:20px;width:64px"></div>
                  <div class="text-secondary small">ms</div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="tile">
                <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-graph-up-arrow"></i> TPS (avg)</div>
                <div id="t-tps" class="value skel" style="height:20px;width:64px"></div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <button id="players-tile" class="tile w-100 text-start" type="button" data-click>
                <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-people"></i> Players</div>
                <div id="t-players" class="value skel text-light" style="height:20px;width:80%"></div>
                <div class="small text-secondary">open list ⟶</div>
              </button>
            </div>
            <div class="col-6 col-md-3">
              <div class="tile">
                <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-person-check"></i> Online</div>
                <div id="t-online" class="value skel" style="height:20px;width:64px"></div>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <canvas id="tpsChart" height="92" role="img" aria-label="Последние значения TPS"></canvas>
            <div class="form-text">Мини-график последних значений TPS (1m). Авто-масштаб.</div>
          </div>
        </div>
      </section>

      <!-- maintenance -->
      <section id="maintenance" class="card glass mb-3 maint-card" aria-labelledby="m-title">
        <div class="card-body">
          <div class="head">
            <h5 id="m-title" class="m-0 d-flex align-items-center gap-2">
              <i class="bi bi-cone-striped text-warning"></i> Maintenance
            </h5>
            <div id="maint-state" class="stat-dot o"><span class="d"></span><span>state: online</span></div>
          </div>

          <div class="ctrlbar">
            <div class="ctrl" role="group" aria-label="Maintenance toggle">
              <div class="label"><i class="bi bi-tools"></i> Technical work</div>
              <input id="maint-msg" placeholder="Kick message (optional)" aria-label="Kick message">
              <button id="maint-on"  class="btn btn-start"><i class="bi bi-play-fill me-1"></i>Start</button>
              <button id="maint-off" class="btn btn-stop"><i class="bi bi-stop-fill me-1"></i>Stop</button>
            </div>
            <div class="ctrl wl" role="group" aria-label="Whitelist">
              <div class="label"><i class="bi bi-shield-check"></i> Whitelist</div>
              <input id="wl-player" placeholder="Player" aria-label="Player name">
              <button id="wl-add"    class="btn btn-stop"><i class="bi bi-plus-lg me-1"></i>Add</button>
              <button id="wl-remove" class="btn btn-stop" style="color:#fca5a5"><i class="bi bi-dash-lg me-1"></i>Remove</button>
            </div>
          </div>
        </div>
      </section>

      <!-- players -->
      <section id="players" class="card glass mb-3" aria-labelledby="p-title">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h5 id="p-title" class="m-0">Игроки</h5>
            <input id="players-filter" class="form-control form-control-sm" style="max-width:220px" placeholder="Поиск по нику/UUID" aria-label="Поиск игроков">
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead><tr><th>Ник</th><th>UUID</th><th>Мир</th><th>Пинг</th><th>Группа</th></tr></thead>
              <tbody id="tbl-players"><tr><td colspan="5" class="text-secondary">нет данных</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- worlds -->
      <section id="worlds" class="card glass mb-3" aria-labelledby="w-title">
        <div class="card-body">
          <h5 id="w-title" class="mb-3">Миры</h5>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Мир</th><th>Тип</th><th>TPS</th>
                  <th>Игроки</th><th>Чанки</th><th>Сущности</th>
                  <th>View</th><th>Sim</th><th>Spawn</th>
                </tr>
              </thead>
              <tbody id="tbl-worlds"><tr><td colspan="9" class="text-secondary">нет данных</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- console -->
      <section id="console" class="card glass" aria-labelledby="c-title">
        <div class="card-body">
          <h5 id="c-title" class="mb-3">Консоль</h5>

          <div class="console-toolbar">
            <div class="switchx">
              <input class="form-check-input" type="checkbox" id="live-toggle" checked>
              <label for="live-toggle" class="form-check-label">Live log</label>
            </div>
            <div class="switchx">
              <input class="form-check-input" type="checkbox" id="auto-scroll" checked>
              <label for="auto-scroll" class="form-check-label">Autoscroll</label>
            </div>
            <button id="clear-log" class="btn btn-sm btn-outline-light"><i class="bi bi-eraser"></i> Clear</button>
            <small class="text-secondary ms-auto">Шорткаты: <span class="code-chip">/</span> фокус · <span class="code-chip">↑/↓</span> история · <span class="code-chip">Ctrl/⌘+Enter</span> отправить</small>
          </div>

          <pre class="console" id="console-log" aria-live="polite">// connecting…</pre>

          <div class="input-group mt-2">
            <input id="cmd" class="form-control" placeholder="say Hello from MoonRein" aria-label="Команда для консоли">
            <button id="send" class="btn btn-primary"><i class="bi bi-send"></i> Отправить</button>
          </div>
          <div id="console-status" class="small text-muted mt-1"></div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- players modal -->
<div class="modal fade" id="playersModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content glass">
      <div class="modal-header">
        <h5 class="modal-title">Players · <code>{{ realm }}</code></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="players-list" class="vstack gap-1">
          <div class="text-secondary">Loading…</div>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-secondary">Скины: Mojang (textures.minecraft.net) / Crafatar</small>
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
const realm = document.querySelector("[data-realm]").dataset.realm;
const LS_AUTO_KEY = `gs_auto_${realm}`;
let tpsSeries = [], timer = null, lastStats = null;
let es=null, esStateEl=null, fetchAbort=null;
let cmdHistory=[], cmdIdx=-1;

/* ---------- meta + headers ---------- */
function clientMeta(){
  const tz = (Intl.DateTimeFormat().resolvedOptions().timeZone || "");
  const tzOffsetMin = -new Date().getTimezoneOffset();
  const lang = (navigator.language || "");
  const dpr = (window.devicePixelRatio || 1);
  const vp = `${window.innerWidth}x${window.innerHeight}@${dpr}`;
  const sc = (screen && `${screen.width}x${screen.height}`) || "";
  const vis = (document.visibilityState || "");
  return {tz, tzOffsetMin, lang, vp, sc, vis, ua:navigator.userAgent||"", ref:document.referrer||"", page:location.pathname+location.search, ts:Date.now()};
}
function clientHeaders(c){ return {"Content-Type":"application/json","X-Client-TZ":c.tz||"","X-Client-Of":String(c.tzOffsetMin??""),"X-Client-Lang":c.lang||""}; }

/* ---------- UI helpers ---------- */
function toast(msg, ok=true){
  const wrap = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = 'toastx ' + (ok?'ok':'err');
  el.innerHTML = `<div class="small">${msg}</div>`;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(), 320); }, 2200);
}
function setStatusBadge(state){
  const el = document.getElementById("status-badge");
  el.classList.remove("badge-online","badge-maint","badge-off","badge-unknown");
  if(state==="online") el.classList.add("badge-online");
  else if(state==="maintenance") el.classList.add("badge-maint");
  else if(state==="offline") el.classList.add("badge-off");
  else el.classList.add("badge-unknown");
  el.innerHTML = `<i class="bi bi-activity me-1"></i>${state || "unknown"}`;

  const ms = document.getElementById("maint-state");
  ms.classList.remove("o","m");
  ms.classList.add(state==="maintenance" ? "m" : "o");
  ms.querySelector("span:last-child").textContent = `state: ${state}`;
}
function setLatency(ms){ document.getElementById("latency").textContent = `ping: ${ms===null?'—':ms+' ms'}`; }

/* ---------- chart ---------- */
function drawSparkline(canvas, values){
  const ctx = canvas.getContext("2d");
  const w = canvas.width = canvas.clientWidth, h = canvas.height = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  if(!values.length) return;
  const min = Math.min(...values), max = Math.max(...values), pad = 6;
  const xi = i => pad + (w-2*pad) * (i/((values.length-1)||1));
  const yi = v => h - pad - (h-2*pad) * ((v-min)/((max-min)||1));
  ctx.lineWidth = 2; ctx.beginPath();
  values.forEach((v,i)=>{ const x=xi(i), y=yi(v); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();
}
new ResizeObserver(()=> drawSparkline(document.getElementById("tpsChart"), tpsSeries))
  .observe(document.getElementById("tpsChart"));

function unskeleton(){
  for(const id of ["t-mspt","t-tps","t-players","t-online"]){
    const el = document.getElementById(id);
    el.classList.remove('skel'); el.style.removeProperty('width'); el.style.removeProperty('height');
  }
}

/* ---------- NORMALIZATION of bridge payloads ---------- */
function normalize(raw){
  // 1) если кадр обёрнут в {type:'server.stats', data:{...}}
  const p = raw && raw.data && typeof raw.data === 'object' ? raw.data : raw;

  // 2) Сведём TPS/MSPT к единому виду
  const tps = p.tps && typeof p.tps === 'object'
    ? { "1m":p.tps["1m"] ?? p.tps_1m, "5m":p.tps["5m"] ?? p.tps_5m, "15m":p.tps["15m"] ?? p.tps_15m, "mspt": p.tps.mspt ?? p.mspt }
    : { "1m":p.tps_1m, "5m":p.tps_5m, "15m":p.tps_15m, "mspt": p.mspt };

  // 3) Игроки
  const players = p.players && typeof p.players === 'object'
    ? { max:p.players.max ?? p.players_max, online:p.players.online ?? p.players_online }
    : { max:p.players_max, online:p.players_online };

  const players_list = Array.isArray(p.players_list) ? p.players_list : [];

  // 4) Миры: словарь -> массив
  let worlds = [];
  if (Array.isArray(p.worlds)) {
    worlds = p.worlds;
  } else if (p.worlds && typeof p.worlds === 'object') {
    worlds = Object.keys(p.worlds).map(name => {
      const w = p.worlds[name] || {};
      return {
        name,
        type: w.type || "",
        tps: w.tps || [],
        players: w.players ?? w.players_count ?? "",
        loadedChunks: w.chunks_loaded ?? w.loadedChunks ?? "",
        entities: w.entities ?? "",
        view_distance: w.view_distance ?? "",
        simulation_distance: w.simulation_distance ?? "",
        spawn: w.spawn || null
      };
    });
  }

  return {
    realm: p.realm || raw.realm || "{{ realm }}",
    tps, mspt: tps.mspt ?? p.mspt ?? null,
    players, players_list, worlds
  };
}

/* ---------- derived helpers ---------- */
function avgTps(tps){
  if(!tps) return null;
  const arr = [tps["1m"], tps["5m"], tps["15m"]].filter(v=>typeof v==="number");
  return arr.length ? arr.reduce((a,b)=>a+b,0) / arr.length : null;
}

/* ---------- RENDER ---------- */
function renderRaw(raw){
  const p = normalize(raw);
  lastStats = p;

  const mspt = p.mspt ?? null;
  const tpsAvg = avgTps(p.tps);
  const tps1m = p?.tps?.["1m"];
  const online = (p?.players?.online ?? null);

  const status = (typeof online === "number" && online>0) || (typeof tps1m === "number" && tps1m>0) ? "online" : "offline";
  setStatusBadge(status);

  document.getElementById("t-mspt").textContent = (typeof mspt==="number") ? mspt.toFixed(2) : "—";
  document.getElementById("t-tps").textContent  = (typeof tpsAvg==="number") ? tpsAvg.toFixed(2) : "—";
  document.getElementById("t-online").textContent = (typeof online==="number") ? online : "—";

  const playersArr = p.players_list || [];
  document.getElementById("t-players").textContent = playersArr.map(x=>x.name).join(", ") || "—";
  unskeleton();

  if(typeof tps1m==="number"){ tpsSeries.push(tps1m); if(tpsSeries.length>60) tpsSeries.shift(); }
  drawSparkline(document.getElementById("tpsChart"), tpsSeries);

  // Игроки
  applyPlayersTable(playersArr);

  // Миры
  const wt = document.getElementById("tbl-worlds");
  const worlds = p.worlds||[];
  wt.innerHTML = worlds.length ? worlds.map(w=>`
    <tr>
      <td>${w.name}</td>
      <td>${w.type||""}</td>
      <td>${Array.isArray(w.tps)? w.tps.join(", ") : ""}</td>
      <td>${w.players ?? ""}</td>
      <td>${w.loadedChunks ?? ""}</td>
      <td>${w.entities ?? ""}</td>
      <td>${w.view_distance ?? ""}</td>
      <td>${w.simulation_distance ?? ""}</td>
      <td>${w.spawn?`${w.spawn.x??""},${w.spawn.y??""},${w.spawn.z??""}`:""}</td>
    </tr>
  `).join("") : `<tr><td colspan="9" class="text-secondary">нет данных</td></tr>`;
}

/* фильтр игроков */
function applyPlayersTable(playersArr){
  const q = document.getElementById("players-filter").value.trim().toLowerCase();
  const filtered = !q ? playersArr : playersArr.filter(p =>
    (p.name||"").toLowerCase().includes(q) || (p.uuid||"").toLowerCase().includes(q)
  );
  const pt = document.getElementById("tbl-players");
  pt.innerHTML = filtered.length ? filtered.map(pl=>`
    <tr>
      <td>${pl.name}</td>
      <td class="small">${pl.uuid||""}</td>
      <td>${pl.world||""}</td>
      <td>${pl.ping ?? ""}</td>
      <td>${pl.lp_primary ?? ""}</td>
    </tr>
  `).join("") : `<tr><td colspan="5" class="text-secondary">нет данных</td></tr>`;
}

/* ---------- polling (race-safe) ---------- */
async function fetchStats(){
  try{ fetchAbort?.abort(); }catch{}
  fetchAbort = new AbortController();
  const t0 = performance.now();
  try{
    const r = await fetch(`/admin/gameservers/api/stats?realm=${encodeURIComponent(realm)}`, {cache:"no-store", signal:fetchAbort.signal});
    const j = await r.json();
    if(!j.ok){ setStatusBadge("offline"); return; }
    renderRaw(j.data||{});
    setLatency(Math.max(0, Math.round(performance.now()-t0)));
  }catch(e){ if(e.name!=='AbortError'){ setStatusBadge("offline"); } }
}

/* ---------- players modal ---------- */
function openPlayersModal(){
  const list = document.getElementById("players-list");
  list.innerHTML = "";
  const players = (lastStats?.players_list)||[];
  if(players.length===0){
    list.innerHTML = `<div class="text-secondary">Игроков нет.</div>`;
  } else {
    for(const p of players){
      const row = document.createElement("div");
      row.className = "player-row";
      const uuid = (p.uuid||"").replace(/-/g,"");
      const headSrc = `/admin/gameservers/api/player-head?name=${encodeURIComponent(p.name)}&uuid=${encodeURIComponent(uuid)}`;
      row.innerHTML = `
        <img class="player-head" width="32" height="32" src="${headSrc}" alt="">
        <div class="flex-grow-1">
          <div class="text-light">${p.name}</div>
          <div class="small text-secondary">${uuid}${p.world? " · "+p.world : ""}${typeof p.ping==="number" ? " · "+p.ping+"ms":""}${p.lp_primary? " · "+p.lp_primary:""}</div>
        </div>`;
      list.appendChild(row);
    }
  }
  bootstrap.Modal.getOrCreateInstance(document.getElementById('playersModal')).show();
}

/* ---------- SSE console (query meta) ---------- */
function sseQuery(){
  const c = clientMeta();
  const sp = new URLSearchParams({ realm, tz:c.tz||"", of:String(c.tzOffsetMin??""), lang:c.lang||"", vp:c.vp||"", sc:c.sc||"", vis:c.vis||"" });
  return sp.toString();
}
function appendLine(line){
  const pre = document.getElementById('console-log');
  pre.textContent += (pre.textContent?'\n':'') + line;
  if(document.getElementById('auto-scroll').checked){ pre.scrollTop = pre.scrollHeight; }
}
function fmtLine(p){
  const t  = new Date().toLocaleTimeString();
  const lv = p.level ? `[${p.level}] ` : '';
  const sc = p.source ? `${p.source}: ` : '';
  const msg = p.line || p.message || JSON.stringify(p);
  return `[${t}] ${lv}${sc}${msg}`;
}
function startLive(){
  if(es) return;
  const st = document.querySelector('[data-sse="state"]');
  const url = `/admin/gameservers/api/console/stream?` + sseQuery();
  es = new EventSource(url);
  st.textContent = 'connecting…';
  es.onopen = ()=>{ st.textContent = 'connected'; };
  es.onmessage = (ev)=>{ try{ appendLine(fmtLine(JSON.parse(ev.data||'{}')));}catch{} };
  es.addEventListener('err', (ev)=>{ appendLine(`[stream] ${ev.data}`); });
  es.onerror = ()=>{ st.textContent = 'disconnected'; };
}
function stopLive(){ try{es?.close();}catch{} es=null; document.querySelector('[data-sse="state"]').textContent='stopped'; }

/* ---------- POST helper (with meta) ---------- */
async function postJSON(url, obj){
  const c = clientMeta();
  const r = await fetch(url, { method:"POST", headers:clientHeaders(c), body: JSON.stringify({...obj, client:c}) });
  return r.json();
}

/* ---------- console send + history ---------- */
function pushHistory(cmd){
  if(!cmd) return;
  const key = `gs_history_${realm}`;
  try{
    const arr = JSON.parse(localStorage.getItem(key) || "[]");
    if(arr[0] !== cmd){ arr.unshift(cmd); }
    localStorage.setItem(key, JSON.stringify(arr.slice(0,50)));
  }catch{}
}
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(`gs_history_${realm}`) || "[]"); }catch{ return []; } }
async function sendCmd(){
  const input = document.getElementById("cmd");
  const cmd = input.value.trim();
  if(!cmd) return;
  const btn = document.getElementById("send"), st = document.getElementById("console-status");
  btn.disabled = true; st.textContent = "Отправка...";
  try{
    const j = await postJSON("/admin/gameservers/api/console", {realm, cmd});
    st.textContent = j.ok ? "OK" : (j.error||"error");
    toast(j.ok ? "Команда отправлена" : (j.error||"Ошибка"), j.ok);
    if(j.ok){ pushHistory(cmd); cmdHistory = loadHistory(); cmdIdx = -1; input.value=""; }
  }catch(e){ st.textContent = e.message||"network error"; toast(st.textContent, false); }
  finally{ btn.disabled = false; input.focus(); }
}
function navigateHistory(dir){
  if(!cmdHistory.length) return;
  if(dir<0){ cmdIdx = Math.min(cmdHistory.length-1, cmdIdx+1); }
  else{ cmdIdx = Math.max(-1, cmdIdx-1); }
  document.getElementById("cmd").value = cmdIdx>=0 ? cmdHistory[cmdIdx] : "";
}

/* ---------- binds ---------- */
document.getElementById("send").addEventListener("click", sendCmd);
document.getElementById("cmd").addEventListener("keydown", e=>{
  if((e.ctrlKey||e.metaKey) && e.key==="Enter") return sendCmd();
  if(e.key==="ArrowUp") return (e.preventDefault(), navigateHistory(-1));
  if(e.key==="ArrowDown") return (e.preventDefault(), navigateHistory(1));
});
document.addEventListener("keydown", e=>{
  if(e.key === "/" && document.activeElement !== document.getElementById("cmd")){
    e.preventDefault(); document.getElementById("cmd").focus();
  }
});
document.getElementById("refresh").addEventListener("click", fetchStats);
document.getElementById("players-tile")?.addEventListener("click", openPlayersModal);
document.getElementById("players-filter").addEventListener("input", ()=> applyPlayersTable(lastStats?.players_list||[]));

document.getElementById("maint-on").addEventListener("click", ()=>maintToggle(true));
document.getElementById("maint-off").addEventListener("click", ()=>maintToggle(false));
document.getElementById("wl-add").addEventListener("click", ()=>wlChange("add"));
document.getElementById("wl-remove").addEventListener("click", ()=>wlChange("remove"));

document.getElementById("live-toggle").addEventListener("change", e=>{ e.target.checked ? startLive() : stopLive(); });
document.getElementById("clear-log").addEventListener("click", ()=>{ document.getElementById('console-log').textContent=""; });
document.getElementById("copy-realm").addEventListener("click", async ()=>{ try{ await navigator.clipboard.writeText(realm); toast("Realm скопирован"); }catch{ toast("Не удалось скопировать", false); }});

const autoEl = document.getElementById("autorefresh");
autoEl.checked = (localStorage.getItem(LS_AUTO_KEY) ?? "1") !== "0";
autoEl.addEventListener("change", e=>{
  clearInterval(timer);
  localStorage.setItem(LS_AUTO_KEY, e.target.checked ? "1" : "0");
  if(e.target.checked) timer = setInterval(fetchStats, 3000);
});

/* ---------- maintenance API ---------- */
async function maintToggle(enabled){
  const msg = document.getElementById("maint-msg").value.trim();
  const j = await postJSON("/admin/gameservers/api/maintenance", {realm, enabled, kickMessage: msg, message: msg});
  if (j.ok && enabled) setStatusBadge("maintenance");
  if (j.ok && !enabled) setStatusBadge("online");
  toast(j.ok ? (enabled?"Техработы включены":"Техработы отключены") : (j.error||"Ошибка"), j.ok);
}
async function wlChange(op){
  const player = document.getElementById("wl-player").value.trim();
  if(!player) return;
  const j = await postJSON("/admin/gameservers/api/maintenance/whitelist", {realm, op, player});
  toast(j.ok ? `Whitelist: ${op} ${player}` : (j.error||"Ошибка"), j.ok);
  if (j.ok && op === "add") document.getElementById("wl-player").value = "";
}

/* ---------- init ---------- */
cmdHistory = loadHistory();
fetchStats();
if(autoEl.checked) timer = setInterval(fetchStats, 3000);
startLive();
</script>
{% endblock %}
