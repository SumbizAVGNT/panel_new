{% extends "layout/base.html" %}
{% block title %}{{ realm }} — Game Server{% endblock %}

{% block content %}
<style>
/* базовый стилизатор (как у тебя) + новые блоки */
.container-xxl.gs-scope{
  background:
    radial-gradient(700px 360px at 50% -12%, rgba(148,163,184,.10), transparent 70%),
    linear-gradient(180deg, rgba(13,17,23,.55), rgba(13,17,23,.42));
  border:1px solid rgba(148,163,184,.14);
  border-radius:18px;
}
.gs-layout{display:grid;grid-template-columns:300px 1fr;gap:16px}
@media (max-width:992px){.gs-layout{grid-template-columns:1fr}}
.card.glass{background:rgba(13,17,23,.55);border:1px solid rgba(148,163,184,.18);backdrop-filter:blur(8px)}
.table>:not(caption)>*>*{background:transparent}

/* side */
.gs-side{position:sticky;top:76px;align-self:start}
.gs-side .nav-link{border:1px solid rgba(148,163,184,.18);border-radius:12px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.gs-side .nav-link .dot{width:6px;height:6px;border-radius:999px;background:rgba(148,163,184,.5)}
.gs-side .nav-link.active{background:#0f172a;box-shadow:inset 0 0 0 1px rgba(148,163,184,.28)}
.gs-side .nav-link.active .dot{background:#22c55e}

/* tiles */
.tile{position:relative;isolation:isolate;display:flex;flex-direction:column;gap:6px;padding:16px;border-radius:14px;border:1px solid rgba(148,163,184,.18);background:rgba(13,17,23,.55)}
.tile[data-click]{cursor:pointer}
.tile:before{content:"";position:absolute;inset:-1px;border-radius:14px;z-index:-1;background:
  radial-gradient(260px 140px at 0% 0%, rgba(56,189,248,.20), transparent 70%),
  radial-gradient(260px 140px at 100% 100%, rgba(34,197,94,.12), transparent 70%);opacity:.28;transition:.2s}
.tile:hover:before{opacity:.5}
.tcap{font-size:.78rem;color:#94a3b8;text-transform:uppercase;letter-spacing:.04em}
.kpi .value{font-size:1.25rem}
.badge-cap{padding:.35rem .6rem;border-radius:999px}

/* maintenance card */
.maint-card .head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
.stat-dot{display:inline-flex;align-items:center;gap:6px;font-size:.86rem}
.stat-dot .d{width:8px;height:8px;border-radius:999px;background:#475569}
.stat-dot.m .d{background:#f59e0b}
.stat-dot.o .d{background:#22c55e}
.ctrlbar{display:flex;flex-wrap:wrap;gap:10px}
.ctrl{display:flex;align-items:center;background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.20);border-radius:12px;overflow:hidden}
.ctrl .label{display:flex;align-items:center;gap:6px;padding:0 10px;color:#cbd5e1;border-right:1px solid rgba(148,163,184,.18)}
.ctrl input{border:0;background:transparent;color:#e5e7eb;outline:0;width:280px;min-width:160px}
.ctrl .btn{border:0}
.ctrl .btn-start{background:#f59e0b;color:#111827}
.ctrl .btn-stop{background:transparent;border-left:1px solid rgba(148,163,184,.18);color:#e5e7eb}
.ctrl .btn:hover{filter:brightness(1.05)}
.ctrl .btn:active{transform:translateY(1px)}
.ctrl .btn, .ctrl .label, .ctrl input{height:36px}
.ctrl.wl input{width:200px}

/* console */
.console-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.switchx{display:flex;align-items:center;gap:6px;font-size:.9rem}
pre.console{max-height:320px;overflow:auto;background:rgba(15,23,42,.44);border-radius:10px;padding:10px;border:1px solid rgba(148,163,184,.18);white-space:pre-wrap}

/* players */
.player-head{width:32px;height:32px;border-radius:6px;border:1px solid rgba(148,163,184,.25);background:rgba(15,23,42,.5);image-rendering:pixelated}
.player-row{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:8px}
.player-row:hover{background:rgba(148,163,184,.06)}

/* plugins grid */
.plugins-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.plugin-pill{border:1px solid rgba(148,163,184,.28);border-radius:10px;padding:8px 10px;background:rgba(13,17,23,.55)}

/* skeletons + toasts */
.skel{position:relative;overflow:hidden;background:rgba(148,163,184,.12);border-radius:8px}
.skel:after{content:"";position:absolute;inset:0;background:linear-gradient(90deg, transparent, rgba(255,255,255,.07), transparent);transform:translateX(-100%);animation:shimmer 1.2s infinite}
@keyframes shimmer{100%{transform:translateX(100%)}}
#toasts{position:fixed;right:16px;bottom:16px;z-index:1080;display:flex;flex-direction:column;gap:8px}
.toastx{background:rgba(13,17,23,.96);border:1px solid rgba(148,163,184,.28);color:#e2e8f0;padding:10px 12px;border-radius:12px}
.toastx.ok{border-color:rgba(34,197,94,.6)}
.toastx.err{border-color:rgba(239,68,68,.6)}
</style>

<div class="container-xxl gs-scope py-4" data-realm="{{ realm }}">
  <!-- header -->
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <div class="d-flex align-items-center gap-3">
      <div class="rounded-circle" style="width:42px;height:42px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.25);background:rgba(15,23,42,.6)">
        <i class="bi bi-hdd-network text-info"></i>
      </div>
      <div>
        <h2 class="m-0">{{ realm|capitalize }}</h2>
        <div class="text-secondary small">Minecraft (Paper) · realm: <code class="text-light">{{ realm }}</code></div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="status-badge" class="badge badge-cap bg-secondary"><i class="bi bi-activity me-1"></i>unknown</span>
      <div class="form-check form-switch ms-2">
        <input class="form-check-input" type="checkbox" id="autorefresh">
        <label class="form-check-label small" for="autorefresh">Авто-обновление</label>
      </div>
      <button id="refresh" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-repeat me-1"></i>Обновить</button>
      <a href="{{ url_for('admin.gameservers_index') }}" class="btn btn-sm btn-outline-light"><i class="bi bi-arrow-left"></i> Назад</a>
    </div>
  </div>

  <div class="gs-layout">
    <!-- sidebar -->
    <aside class="gs-side">
      <div class="card glass p-2">
        {% set sections = [
          ('overview','Overview'),
          ('maintenance','Maintenance'),
          ('players','Players'),
          ('worlds','Worlds'),
          ('system','System'),
          ('jvm','JVM & Memory'),
          ('plugins','Plugins'),
          ('raw','Raw JSON'),
          ('console','Console')
        ] %}
        {% for key, title in sections %}
          <a class="nav-link px-3 py-2" href="#{{ key }}"><span class="dot"></span>{{ title }}</a>
        {% endfor %}
        <a class="nav-link px-3 py-2" href="{{ url_for('admin.accounts') }}">
          <span class="dot"></span>Accounts
        </a>
      </div>
    </aside>

    <!-- main -->
    <main class="gs-main">

      <!-- overview -->
      <section id="overview" class="card glass mb-3">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6 col-md-3">
              <div class="tile">
                <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-speedometer2"></i> MSPT</div>
                <div class="kpi d-flex align-items-baseline gap-2">
                  <div id="t-mspt" class="value skel" style="height:20px;width:64px"></div>
                  <div class="text-secondary small">ms</div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="tile">
                <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-graph-up-arrow"></i> TPS (avg)</div>
                <div id="t-tps" class="value skel" style="height:20px;width:64px"></div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <button id="players-tile" class="tile w-100 text-start" type="button" data-click>
                <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-people"></i> Players</div>
                <div id="t-players" class="value skel text-light" style="height:20px;width:80%"></div>
                <div class="small text-secondary">open list ⟶</div>
              </button>
            </div>
            <div class="col-6 col-md-3">
              <div class="tile">
                <div class="tcap d-flex align-items-center gap-1"><i class="bi bi-person-check"></i> Online</div>
                <div id="t-online" class="value skel" style="height:20px;width:64px"></div>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <canvas id="tpsChart" height="92"></canvas>
            <div class="form-text">Мини-график последних значений TPS (1m).</div>
          </div>
        </div>
      </section>

      <!-- maintenance -->
      <section id="maintenance" class="card glass mb-3 maint-card">
        <div class="card-body">
          <div class="head">
            <h5 class="m-0 d-flex align-items-center gap-2">
              <i class="bi bi-cone-striped text-warning"></i> Maintenance
            </h5>
            <div id="maint-state" class="stat-dot o"><span class="d"></span><span>state: online</span></div>
          </div>

          <div class="ctrlbar">
            <div class="ctrl">
              <div class="label"><i class="bi bi-tools"></i> Technical work</div>
              <input id="maint-msg" placeholder="Kick message (optional)">
              <button id="maint-on"  class="btn btn-start"><i class="bi bi-play-fill me-1"></i>Start</button>
              <button id="maint-off" class="btn btn-stop"><i class="bi bi-stop-fill me-1"></i>Stop</button>
            </div>
            <div class="ctrl wl">
              <div class="label"><i class="bi bi-shield-check"></i> Whitelist</div>
              <input id="wl-player" placeholder="Player">
              <button id="wl-add"    class="btn btn-stop"><i class="bi bi-plus-lg me-1"></i>Add</button>
              <button id="wl-remove" class="btn btn-stop" style="color:#fca5a5"><i class="bi bi-dash-lg me-1"></i>Remove</button>
            </div>
          </div>
        </div>
      </section>

      <!-- players -->
      <section id="players" class="card glass mb-3">
        <div class="card-body">
          <h5 class="mb-3">Игроки</h5>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead><tr><th>Ник</th><th>UUID</th><th>Мир</th></tr></thead>
              <tbody id="tbl-players"><tr><td colspan="3" class="text-secondary">нет данных</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- worlds -->
      <section id="worlds" class="card glass mb-3">
        <div class="card-body">
          <h5 class="mb-3">Миры</h5>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead><tr><th>Мир</th><th>Тип</th><th>TPS</th><th>Игроки</th><th>Чанки</th><th>Spawn</th></tr></thead>
              <tbody id="tbl-worlds"><tr><td colspan="6" class="text-secondary">нет данных</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- system -->
      <section id="system" class="card glass mb-3">
        <div class="card-body">
          <h5 class="mb-3">System</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="tile">
                <div class="tcap">OS</div>
                <div class="small" id="sys-os">—</div>
                <div class="small text-secondary">Cores: <span id="sys-cores">—</span></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="tile">
                <div class="tcap">CPU load</div>
                <div class="small">System: <span id="cpu-sys">—</span></div>
                <div class="small">Process: <span id="cpu-proc">—</span></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- jvm -->
      <section id="jvm" class="card glass mb-3">
        <div class="card-body">
          <h5 class="mb-3">JVM & Memory</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="tile">
                <div class="tcap">Heap</div>
                <div class="small">Used: <span id="heap-used">—</span></div>
                <div class="small">Max: <span id="heap-max">—</span></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="tile">
                <div class="tcap">Non-Heap</div>
                <div class="small">Used: <span id="nheap-used">—</span></div>
                <div class="small">Max: <span id="nheap-max">—</span></div>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-6">
              <div class="tile">
                <div class="tcap">Classes</div>
                <div class="small">Loaded: <span id="cls-loaded">—</span></div>
                <div class="small">Total loaded: <span id="cls-total">—</span></div>
                <div class="small">Unloaded: <span id="cls-unloaded">—</span></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="tile">
                <div class="tcap">Threads</div>
                <div class="small">Live: <span id="thr-live">—</span></div>
                <div class="small">Peak: <span id="thr-peak">—</span></div>
                <div class="small">Daemon: <span id="thr-daemon">—</span></div>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <h6 class="mb-2">Garbage Collectors</h6>
            <div id="gc-list" class="small text-secondary">нет данных</div>
          </div>

          <div class="mt-3">
            <h6 class="mb-2">Memory Pools</h6>
            <div id="mem-pools" class="small text-secondary">нет данных</div>
          </div>
        </div>
      </section>

      <!-- plugins -->
      <section id="plugins" class="card glass mb-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h5 class="m-0">Plugins</h5>
            <input id="pl-search" class="form-control form-control-sm" placeholder="Search…"
                   style="max-width:220px">
          </div>
          <div id="plugins-wrap" class="plugins-grid">
            <div class="text-secondary">нет данных</div>
          </div>
        </div>
      </section>

      <!-- raw json -->
      <section id="raw" class="card glass mb-3">
        <div class="card-body">
          <h5 class="mb-2">Raw JSON</h5>
          <pre id="raw-json" class="console" style="max-height:260px"></pre>
        </div>
      </section>

      <!-- console -->
      <section id="console" class="card glass">
        <div class="card-body">
          <h5 class="mb-3">Консоль</h5>

          <div class="console-toolbar">
            <div class="switchx">
              <input class="form-check-input" type="checkbox" id="live-toggle" checked>
              <label for="live-toggle" class="form-check-label">Live log</label>
            </div>
            <div class="switchx">
              <input class="form-check-input" type="checkbox" id="auto-scroll" checked>
              <label for="auto-scroll" class="form-check-label">Autoscroll</label>
            </div>
            <button id="clear-log" class="btn btn-sm btn-outline-light"><i class="bi bi-eraser"></i> Clear</button>
          </div>

          <pre class="console" id="console-log">// connecting…</pre>

          <div class="input-group mt-2">
            <input id="cmd" class="form-control" placeholder="say Hello from MoonRein">
            <button id="send" class="btn btn-primary"><i class="bi bi-send"></i> Отправить</button>
          </div>
          <div id="console-status" class="small text-muted mt-1"></div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- players modal -->
<div class="modal fade" id="playersModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content glass">
      <div class="modal-header">
        <h5 class="modal-title">Players · <code>{{ realm }}</code></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="players-list" class="vstack gap-1">
          <div class="text-secondary">Loading…</div>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-secondary">Скины: Mojang (textures.minecraft.net) / Crafatar</small>
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
const realm = document.querySelector("[data-realm]").dataset.realm;
const LS_AUTO_KEY = `gs_auto_${realm}`;
let tpsSeries = [], timer = null, lastStats = null;

/* toasts */
function toast(msg, ok=true){
  const wrap = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = 'toastx ' + (ok?'ok':'err');
  el.innerHTML = `<div class="small">${msg}</div>`;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(), 320); }, 2200);
}

/* status */
function setStatusBadge(state){
  const el = document.getElementById("status-badge");
  el.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary");
  if(state==="online") el.classList.add("bg-success");
  else if(state==="maintenance") el.classList.add("bg-warning");
  else if(state==="offline") el.classList.add("bg-danger");
  else el.classList.add("bg-secondary");
  el.innerHTML = `<i class="bi bi-activity me-1"></i>${state || "unknown"}`;

  const ms = document.getElementById("maint-state");
  ms.classList.remove("o","m");
  ms.classList.add(state==="maintenance" ? "m" : "o");
  ms.querySelector("span:last-child").textContent = `state: ${state}`;
}

/* sparkline */
function drawSparkline(canvas, values){
  const ctx = canvas.getContext("2d");
  const w = canvas.width = canvas.clientWidth, h = canvas.height = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  if(!values.length) return;
  const min = Math.min(...values), max = Math.max(...values), pad = 6;
  const xi = i => pad + (w-2*pad) * (i/((values.length-1)||1));
  const yi = v => h - pad - (h-2*pad) * ((v-min)/((max-min)||1));
  ctx.lineWidth = 2; ctx.beginPath();
  values.forEach((v,i)=>{ const x=xi(i), y=yi(v); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();
}
function unskeleton(){
  for(const id of ["t-mspt","t-tps","t-players","t-online"]){
    const el = document.getElementById(id);
    el.classList.remove('skel'); el.style.removeProperty('width'); el.style.removeProperty('height');
  }
}

/* helpers */
function avgTps(tps){
  if(!tps) return null;
  const arr = [tps["1m"], tps["5m"], tps["15m"]].filter(v=>typeof v==="number");
  if(!arr.length) return null;
  return arr.reduce((a,b)=>a+b,0) / arr.length;
}
function humanBytes(n){
  if(typeof n!=="number"||!isFinite(n)) return "—";
  const u=["B","KB","MB","GB","TB"]; let i=0; while(n>=1024&&i<u.length-1){n/=1024;i++;}
  return n.toFixed(2)+" "+u[i];
}
function pct(a,b){ if(typeof a!=="number"||typeof b!=="number"||b<=0) return "—"; return ((a/b)*100).toFixed(1)+"%"; }

/* render stats */
function render(data){
  // поддерживаем и "server.stats", и "stats.report"
  const p = data?.payload || data;
  lastStats = p;

  const mspt  = p.mspt ?? p?.tps?.mspt ?? null;
  const tps1m = p?.tps?.["1m"];
  const tpsAvg = avgTps(p.tps);
  const online = (p?.players_online ?? p?.players?.online ?? null);

  const status = (typeof online === "number" && online>0) || (typeof tps1m === "number" && tps1m>0) ? "online" : "offline";
  setStatusBadge(status);

  document.getElementById("t-mspt").textContent = (typeof mspt==="number") ? mspt.toFixed(2) : "—";
  document.getElementById("t-tps").textContent  = (typeof tpsAvg==="number") ? tpsAvg.toFixed(2) : "—";
  document.getElementById("t-online").textContent = (typeof online==="number") ? online : "—";

  const playersArr = p.players_list || [];
  document.getElementById("t-players").textContent = playersArr.map(x=>x.name).join(", ") || "—";
  unskeleton();

  if(typeof tps1m==="number"){ tpsSeries.push(tps1m); if(tpsSeries.length>60) tpsSeries.shift(); }
  drawSparkline(document.getElementById("tpsChart"), tpsSeries);

  // players table
  const pt = document.getElementById("tbl-players");
  pt.innerHTML = playersArr.length ? playersArr.map(pl=>`
    <tr><td>${pl.name}</td><td class="small">${pl.uuid||""}</td><td>${pl.world||""}</td></tr>
  `).join("") : `<tr><td colspan="3" class="text-secondary">нет данных</td></tr>`;

  // worlds table
  const wt = document.getElementById("tbl-worlds");
  const worlds = p.worlds||[];
  wt.innerHTML = worlds.length ? worlds.map(w=>`
    <tr>
      <td>${w.name}</td>
      <td>${w.type||""}</td>
      <td>${(w.tps||[]).join(", ")}</td>
      <td>${w.players??""}</td>
      <td>${w.loadedChunks??""}</td>
      <td>${w.spawn?`${w.spawn.x},${w.spawn.y},${w.spawn.z}`:""}</td>
    </tr>
  `).join("") : `<tr><td colspan="6" class="text-secondary">нет данных</td></tr>`;

  // system
  document.getElementById("sys-os").textContent = `${p.os_name||"?"} ${p.os_arch?"("+p.os_arch+")":""}`;
  document.getElementById("sys-cores").textContent = p.os_cores ?? "—";
  document.getElementById("cpu-sys").textContent = (typeof p.cpu_system_load==="number") ? (p.cpu_system_load*100).toFixed(1)+"%" : "—";
  document.getElementById("cpu-proc").textContent = (typeof p.cpu_process_load==="number") ? (p.cpu_process_load*100).toFixed(1)+"%" : "—";

  // jvm/heap
  const hu=p.heap_used, hm=p.heap_max, nhu=p.nonheap_used, nhm=p.nonheap_max;
  document.getElementById("heap-used").textContent  = `${humanBytes(hu)}${hm?` · ${pct(hu,hm)}`:""}`;
  document.getElementById("heap-max").textContent   = humanBytes(hm);
  document.getElementById("nheap-used").textContent = `${humanBytes(nhu)}${nhm&&nhm>0?` · ${pct(nhu,nhm)}`:""}`;
  document.getElementById("nheap-max").textContent  = nhm && nhm>0 ? humanBytes(nhm) : "—";

  document.getElementById("cls-loaded").textContent   = p.classes_loaded ?? "—";
  document.getElementById("cls-total").textContent    = p.classes_total_loaded ?? "—";
  document.getElementById("cls-unloaded").textContent = p.classes_unloaded ?? "—";
  document.getElementById("thr-live").textContent     = p.threads_live ?? "—";
  document.getElementById("thr-peak").textContent     = p.threads_peak ?? "—";
  document.getElementById("thr-daemon").textContent   = p.threads_daemon ?? "—";

  // GC list
  const gc = p.gc || {};
  const gcHtml = Object.keys(gc).length
    ? `<div class="row row-cols-1 row-cols-md-2 g-2">` + Object.entries(gc).map(([k,v])=>{
        const c=v?.count??0, tm=v?.time_ms??0;
        return `<div class="col"><div class="plugin-pill d-flex justify-content-between">
                  <span>${k}</span><span class="text-secondary small">${c} × · ${tm} ms</span>
                </div></div>`;
      }).join("") + `</div>`
    : "нет данных";
  document.getElementById("gc-list").innerHTML = gcHtml;

  // Memory pools
  const pools = p.mem_pools || {};
  const mpHtml = Object.keys(pools).length
    ? `<div class="table-responsive"><table class="table table-sm mb-0">
        <thead><tr><th>Pool</th><th>Used</th><th>Max</th><th>Committed</th></tr></thead>
        <tbody>
        ${Object.entries(pools).map(([name,st])=>`
          <tr>
            <td>${name}</td>
            <td>${humanBytes(st?.used)}</td>
            <td>${st?.max && st.max>0 ? humanBytes(st.max) : "—"}</td>
            <td>${humanBytes(st?.committed)}</td>
          </tr>
        `).join("")}
        </tbody>
      </table></div>`
    : "нет данных";
  document.getElementById("mem-pools").innerHTML = mpHtml;

  // Plugins
  const plugins = p.plugins || {};
  const entries = Object.entries(plugins).map(([name,ver])=>({name, ver:String(ver)}))
    .sort((a,b)=>a.name.localeCompare(b.name));
  const wrap = document.getElementById("plugins-wrap");
  wrap.innerHTML = entries.length
    ? entries.map(pl=>`<div class="plugin-pill d-flex justify-content-between"><span>${pl.name}</span><span class="text-secondary">${pl.ver}</span></div>`).join("")
    : `<div class="text-secondary">нет данных</div>`;
  const input = document.getElementById("pl-search");
  input.oninput = () => {
    const q = input.value.trim().toLowerCase();
    Array.from(wrap.children).forEach(node=>{
      if(!node.classList.contains('plugin-pill')) return;
      const txt = node.textContent.toLowerCase();
      node.style.display = txt.includes(q) ? "" : "none";
    });
  };

  // Raw JSON
  document.getElementById("raw-json").textContent = JSON.stringify(p, null, 2);
}

/* polling stats */
async function fetchStats(){
  try{
    const r = await fetch(`/admin/gameservers/api/stats?realm=${encodeURIComponent(realm)}`, {cache:"no-store"});
    const j = await r.json();
    if(!j.ok){ setStatusBadge("offline"); return; }
    render(j.data||{});
  }catch(e){ setStatusBadge("offline"); }
}

/* players modal */
function openPlayersModal(){
  const list = document.getElementById("players-list");
  list.innerHTML = "";
  const players = (lastStats?.players_list)||[];
  if(players.length===0){
    list.innerHTML = `<div class="text-secondary">Игроков нет.</div>`;
  } else {
    for(const p of players){
      const row = document.createElement("div");
      row.className = "player-row";
      const uuid = (p.uuid||"").replace(/-/g,"");
      const headSrc = `/admin/gameservers/api/player-head?name=${encodeURIComponent(p.name)}&uuid=${encodeURIComponent(uuid)}`;
      row.innerHTML = `
        <img class="player-head" width="32" height="32" src="${headSrc}" alt="">
        <div class="flex-grow-1">
          <div class="text-light">${p.name}</div>
          <div class="small text-secondary">${uuid}${p.world? " · "+p.world : ""}</div>
        </div>`;
      list.appendChild(row);
    }
  }
  bootstrap.Modal.getOrCreateInstance(document.getElementById('playersModal')).show();
}

/* console: live via SSE */
let es=null;
function appendLine(line){
  const pre = document.getElementById('console-log');
  pre.textContent += (pre.textContent?'\n':'') + line;
  if(document.getElementById('auto-scroll').checked){
    pre.scrollTop = pre.scrollHeight;
  }
}
function fmtLine(p){
  const t  = new Date().toLocaleTimeString();
  const lv = p.level ? `[${p.level}] ` : '';
  const sc = p.source ? `${p.source}: ` : '';
  const msg = p.line || p.message || JSON.stringify(p);
  return `[${t}] ${lv}${sc}${msg}`;
}
function startLive(){
  if(es) return;
  const url = `/admin/gameservers/api/console/stream?realm=${encodeURIComponent(realm)}`;
  es = new EventSource(url);
  es.onmessage = (ev)=>{ try{ appendLine(fmtLine(JSON.parse(ev.data||'{}')));}catch{} };
  es.addEventListener('err', (ev)=>{ appendLine(`[stream] ${ev.data}`); });
  es.onerror = ()=>{}; // авто-reconnect
}
function stopLive(){ try{es?.close();}catch{} es=null; }

/* console: send command */
async function sendCmd(){
  const cmd = document.getElementById("cmd").value.trim();
  if(!cmd) return;
  const btn = document.getElementById("send"), st = document.getElementById("console-status");
  btn.disabled = true; st.textContent = "Отправка...";
  try{
    const r = await fetch("/admin/gameservers/api/console", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({realm, cmd})});
    const j = await r.json();
    st.textContent = j.ok ? "OK" : (j.error||"error");
    toast(j.ok ? "Команда отправлена" : (j.error||"Ошибка"), j.ok);
    if(j.ok){ document.getElementById("cmd").value=""; }
  }catch(e){ st.textContent = e.message||"network error"; toast(st.textContent, false); }
  finally{ btn.disabled = false; }
}

/* maintenance API */
async function maintToggle(enabled){
  const msg = document.getElementById("maint-msg").value.trim();
  const r = await fetch("/admin/gameservers/api/maintenance", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({realm, enabled, kickMessage: msg, message: msg})});
  const j = await r.json();
  if (j.ok && enabled) setStatusBadge("maintenance");
  if (j.ok && !enabled) setStatusBadge("online");
  toast(j.ok ? (enabled?"Техработы включены":"Техработы отключены") : (j.error||"Ошибка"), j.ok);
}
async function wlChange(op){
  const player = document.getElementById("wl-player").value.trim();
  if(!player) return;
  const r = await fetch("/admin/gameservers/api/maintenance/whitelist", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({realm, op, player})});
  const j = await r.json();
  toast(j.ok ? `Whitelist: ${op} ${player}` : (j.error||"Ошибка"), j.ok);
  if (j.ok && op === "add") document.getElementById("wl-player").value = "";
}

/* sidebar actives */
const links = Array.from(document.querySelectorAll('.gs-side .nav-link[href^="#"]'));
const ids = links.map(a => a.getAttribute('href')).filter(Boolean).map(h => h.replace('#',''));
const obs = new IntersectionObserver((entries)=>{
  entries.forEach(e=>{
    const id = e.target.id;
    const link = links.find(a => a.getAttribute('href') === '#' + id);
    if(link){ e.isIntersecting ? link.classList.add('active') : link.classList.remove('active'); }
  });
},{rootMargin:'-40% 0px -50% 0px', threshold:0.01});
ids.forEach(id => { const el = document.getElementById(id); if(el) obs.observe(el); });

/* binds + persistence */
document.getElementById("send").addEventListener("click", sendCmd);
document.getElementById("cmd").addEventListener("keydown", e=>{ if(e.key==="Enter") sendCmd(); });
document.getElementById("refresh").addEventListener("click", fetchStats);
document.getElementById("players-tile")?.addEventListener("click", openPlayersModal);

document.getElementById("maint-on").addEventListener("click", ()=>maintToggle(true));
document.getElementById("maint-off").addEventListener("click", ()=>maintToggle(false));
document.getElementById("wl-add").addEventListener("click", ()=>wlChange("add"));
document.getElementById("wl-remove").addEventListener("click", ()=>wlChange("remove"));

document.getElementById("live-toggle").addEventListener("change", e=>{ e.target.checked ? startLive() : stopLive(); });
document.getElementById("clear-log").addEventListener("click", ()=>{ document.getElementById('console-log').textContent=""; });

const autoEl = document.getElementById("autorefresh");
autoEl.checked = (localStorage.getItem(LS_AUTO_KEY) ?? "1") !== "0";
autoEl.addEventListener("change", e=>{
  clearInterval(timer);
  localStorage.setItem(LS_AUTO_KEY, e.target.checked ? "1" : "0");
  if(e.target.checked) timer = setInterval(fetchStats, 3000);
});

/* init */
fetchStats();
if(autoEl.checked) timer = setInterval(fetchStats, 3000);
startLive();
</script>
{% endblock %}
