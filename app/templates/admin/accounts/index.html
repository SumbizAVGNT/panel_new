{% extends "layout/base.html" %}
{% block title %}Accounts{% endblock %}

{% block content %}
<style>
.card.glass{background:rgba(13,17,23,.55);border:1px solid rgba(148,163,184,.18);backdrop-filter:blur(8px)}
.table>:not(caption)>*>*{background:transparent}
.searchbar{display:flex;gap:.5rem;align-items:center}
.searchbar .form-control{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.20);color:#e5e7eb}
.badge-role{background:#0b1220;border:1px solid rgba(148,163,184,.24);padding:.25rem .5rem;border-radius:999px}
.player-head{width:22px;height:22px;border-radius:4px;border:1px solid rgba(148,163,184,.25);image-rendering:pixelated;background:#0b1220}
.hint{color:#9aa4b2;font-size:.9rem}
.cursor-pointer{cursor:pointer}
.status-dot{display:inline-block;width:10px;height:10px;border-radius:50%}
.status-online{background:#22c55e;box-shadow:0 0 10px #22c55e80}
.status-offline{background:#ef4444}
.status-unknown{background:#9aa4b2}
.sticky-th th{position:sticky;top:0;background:rgba(13,17,23,.9);backdrop-filter:blur(4px)}
.skeleton{background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(255,255,255,.12),rgba(255,255,255,.06));background-size:200% 100%;animation:s 1.2s infinite}
@keyframes s{0%{background-position:200% 0}100%{background-position:-200% 0}}
.small-muted{color:#9aa4b2;font-size:.85rem}
.kv{display:flex;gap:.5rem;align-items:center}
.kv .k{color:#9aa4b2}
.table-xs td,.table-xs th{padding:.35rem .5rem;font-size:.9rem}
.nav-link{cursor:pointer}
.modal .form-control{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.20);color:#e5e7eb}
</style>

<div class="container-xxl py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">Accounts</h3>
    <div class="d-flex align-items-center gap-2">
      <span id="count" class="text-secondary small">—</span>
      <a href="/admin/gameservers" class="btn btn-sm btn-outline-light">Game Servers</a>
    </div>
  </div>

  <div class="card glass mb-3">
    <div class="card-body">
      <div class="searchbar">
        <div class="input-group">
          <span class="input-group-text bg-transparent text-secondary"><i class="bi bi-search"></i></span>
          <input id="q" class="form-control" placeholder="Ник / UUID / email / ip (prefix)">
        </div>
        <button id="btnSearch" class="btn btn-primary">Поиск</button>
      </div>
    </div>
  </div>

  <div class="card glass">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0">
          <thead class="sticky-th">
          <tr>
            <th style="width:26%">Ник</th>
            <th style="width:12%">Роль</th>
            <th style="width:28%">UUID</th>
            <th style="width:12%">Email</th>
            <th style="width:10%">IP</th>
            <th style="width:12%">Reg</th>
            <th style="width:12%">Last</th>
            <th style="width:10%">Premium</th>
          </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="8" class="text-secondary">Введите ник и нажмите «Поиск»</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="mt-2 hint">Клик по строке — подробная карточка (баланс, донаты, наказания). Поиск поддерживает ник, uuid (с/без дефисов), email и ip.</div>
</div>

<!-- Modal -->
<div class="modal fade" id="accountModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content card glass">
      <div class="modal-header">
        <h5 class="modal-title" id="mTitle">Профиль</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div id="mLoading" class="skeleton rounded p-3 mb-3" style="display:none">Загрузка…</div>
        <div id="mAlert" class="alert alert-danger d-none"></div>

        <!-- Header -->
        <div class="d-flex align-items-center gap-3 mb-3">
          <img id="mHead" class="player-head" src="" alt="">
          <div class="d-flex flex-column gap-1">
            <div class="kv"><span class="k">Ник:</span><strong id="mName">—</strong> <span id="mOnline" class="ms-2"><span class="status-dot status-unknown me-1"></span><span class="align-middle">unknown</span></span></div>
            <div class="kv"><span class="k">UUID:</span><span id="mUuid" class="small">—</span></div>
            <div class="kv"><span class="k">IP:</span><span id="mIp" class="small">—</span></div>
            <div class="kv"><span class="k">Роль:</span><span id="mRole" class="badge-role">default</span></div>
          </div>
          <div class="ms-auto text-end small-muted">
            <div>Регистрация: <span id="mReg">—</span></div>
            <div>Последний вход: <span id="mLast">—</span></div>
          </div>
        </div>

        <!-- Points + Ban row -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <div class="card glass h-100">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="fw-bold">Донатная валюта <span id="mKeyWrap" class="text-secondary"></span></div>
                  <span class="small-muted">Текущий баланс: <span id="mPointsCurr">0.00</span></span>
                </div>
                <div class="input-group">
                  <input id="mPoints" type="number" min="0" step="0.01" class="form-control" placeholder="0.00">
                  <button id="btnSavePoints" class="btn btn-success" disabled>Сохранить</button>
                </div>
                <div id="pointsNote" class="small-muted mt-1"></div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card glass h-100">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="fw-bold">Блокировка (LiteBans)</div>
                  <span class="badge" id="banStatus">—</span>
                </div>

                <div id="banActiveBox" class="small d-none"></div>

                <div class="row g-2 mt-2">
                  <div class="col-md-8">
                    <input id="banReason" class="form-control" placeholder="Причина (по умолчанию — Banned by an operator)">
                  </div>
                  <div class="col-md-4">
                    <div class="input-group">
                      <input id="banDuration" type="number" min="0" step="1" class="form-control" placeholder="Секунды (0 = навсегда)">
                      <button id="btnBan" class="btn btn-outline-danger">Забанить</button>
                      <button id="btnUnban" class="btn btn-outline-warning d-none">Разбанить</button>
                    </div>
                  </div>
                </div>
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="banSilent">
                  <label class="form-check-label" for="banSilent">Silent</label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-pills mb-3" id="mTabs">
          <li class="nav-item"><a class="nav-link active" data-tab="donations">Донаты</a></li>
          <li class="nav-item"><a class="nav-link" data-tab="punishments">Наказания</a></li>
        </ul>

        <!-- Donations -->
        <div id="tab-donations">
          <div class="table-responsive">
            <table class="table table-dark table-hover table-xs">
              <thead>
                <tr>
                  <th>#Платёж</th><th>#Покупка</th><th>Продукт</th><th>Кол-во</th><th>Стоимость</th><th>Создано</th>
                </tr>
              </thead>
              <tbody id="donationRows">
                <tr><td colspan="6" class="text-secondary">Нет данных</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Punishments -->
        <div id="tab-punishments" class="d-none">
          <div id="punishSpinner" class="small-muted mb-2">Загрузка...</div>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card glass">
                <div class="card-body">
                  <div class="fw-bold mb-2">Баны</div>
                  <div class="table-responsive">
                    <table class="table table-dark table-xs">
                      <thead><tr><th>ID</th><th>Причина</th><th>От</th><th>С</th><th>До</th><th>Активен</th></tr></thead>
                      <tbody id="banRows"><tr><td colspan="6" class="text-secondary">—</td></tr></tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="card glass mt-3">
                <div class="card-body">
                  <div class="fw-bold mb-2">Варны</div>
                  <div class="table-responsive">
                    <table class="table table-dark table-xs">
                      <thead><tr><th>ID</th><th>Причина</th><th>От</th><th>С</th><th>До</th><th>Активен</th></tr></thead>
                      <tbody id="warnRows"><tr><td colspan="6" class="text-secondary">—</td></tr></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card glass">
                <div class="card-body">
                  <div class="fw-bold mb-2">Муты</div>
                  <div class="table-responsive">
                    <table class="table table-dark table-xs">
                      <thead><tr><th>ID</th><th>Причина</th><th>От</th><th>С</th><th>До</th><th>Активен</th></tr></thead>
                      <tbody id="muteRows"><tr><td colspan="6" class="text-secondary">—</td></tr></tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="card glass mt-3">
                <div class="card-body">
                  <div class="fw-bold mb-2">История заходов</div>
                  <div class="table-responsive">
                    <table class="table table-dark table-xs">
                      <thead><tr><th>ID</th><th>Дата</th><th>Ник</th><th>IP</th></tr></thead>
                      <tbody id="histRows"><tr><td colspan="4" class="text-secondary">—</td></tr></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- /row -->
        </div>

      </div><!--/modal-body-->

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert">
    <div class="d-flex">
      <div id="toastBody" class="toast-body">done</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script>
const rows = document.getElementById('rows');
const countEl = document.getElementById('count') || null;
const el = id => document.getElementById(id);

/* Bootstrap fallback */
const BS = (()=> {
  const has = !!(window.bootstrap && window.bootstrap.Modal && window.bootstrap.Toast);
  if (has) return window.bootstrap;
  class Modal {
    constructor(root){ this.root = root; this._backdrop = null; }
    show(){
      this.root.classList.add('show'); this.root.style.display='block'; this.root.removeAttribute('aria-hidden');
      document.body.classList.add('modal-open');
      this._backdrop = document.createElement('div'); this._backdrop.className='modal-backdrop fade show'; document.body.appendChild(this._backdrop);
    }
    hide(){
      this.root.classList.remove('show'); this.root.style.display='none'; this.root.setAttribute('aria-hidden','true');
      document.body.classList.remove('modal-open');
      if (this._backdrop){ this._backdrop.remove(); this._backdrop = null; }
    }
  }
  class Toast {
    constructor(root){ this.root = root; }
    show(){ this.root.classList.add('show'); this.root.style.display='block'; setTimeout(()=>this.hide(), 2500); }
    hide(){ this.root.classList.remove('show'); this.root.style.display='none'; }
  }
  return { Modal, Toast };
})();

const toast = new BS.Toast(el('toast'));
function toastMsg(msg){ el('toastBody').textContent = msg; toast.show(); }

const fmtTime = ms => {
  if (ms == null) return "—";
  try{
    const d = new Date(Number(ms));
    if (isNaN(d.getTime())) return "—";
    const z = n => String(n).padStart(2,'0');
    return `${z(d.getDate())}.${z(d.getMonth()+1)}.${d.getFullYear()}, ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
  }catch{ return "—"; }
};

const skin = (name, uuid) => {
  const u = (uuid||'').replaceAll('-', '');
  const qs = u ? `uuid=${u}` : `name=${encodeURIComponent(name||'')}`;
  return `/admin/gameservers/api/player-head?${qs}`;
};

function setCount(n){ if (!countEl) return; countEl.textContent = Number.isFinite(n) ? `${n} результатов` : '—'; }

function render(list){
  setCount(Array.isArray(list) ? list.length : 0);
  if(!list || !list.length){
    rows.innerHTML = `<tr><td colspan="8" class="text-secondary">ничего не найдено</td></tr>`;
    return;
  }
  rows.innerHTML = list.map(r=>{
    const nm  = r.name || r.player_name || '—';
    const uid = r.uuid || r.unique_id || '';
    const em  = r.email ?? '—';
    const ip  = r.ip || r.lastip || '—';
    const reg = fmtTime(r.regdate);
    const last= fmtTime(r.lastlogin);
    const prem= (r.premium===1 || r.premium===true) ? "yes" : "—";
    const role= r.role || 'default';
    return `
    <tr class="cursor-pointer" data-uuid="${uid}" data-name="${nm}">
      <td><img class="player-head me-2" src="${skin(nm, uid)}" alt=""> <a href="#" class="link-light text-decoration-none fw-semibold">${nm}</a></td>
      <td><span class="badge-role">${role}</span></td>
      <td class="small">${uid || '—'}</td>
      <td>${em}</td>
      <td>${ip}</td>
      <td>${reg}</td>
      <td>${last}</td>
      <td>${prem}</td>
    </tr>`;
  }).join('');
  rows.querySelectorAll('tr').forEach(tr=>{
    tr.addEventListener('click', (e)=>{
      e.preventDefault();
      openModal({uuid: tr.dataset.uuid, name: tr.dataset.name});
    });
  });
}

async function fetchData(q=""){
  const url = new URL("/admin/accounts/api/search", location.origin);
  if(q) url.searchParams.set("q", q);
  rows.innerHTML = `<tr><td colspan="8"><div class="skeleton rounded p-3">Загрузка…</div></td></tr>`;
  try{
    const res = await fetch(url, {cache:"no-store"});
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || "error");
    render(j.data || []);
  }catch(e){
    rows.innerHTML = `<tr><td colspan="8" class="text-danger">${e.message}</td></tr>`;
    setCount(0);
  }
}

const onInputDebounce = (fn, ms=400)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };

el('btnSearch').addEventListener('click', ()=> fetchData(el('q').value.trim()));
el('q').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') el('btnSearch').click(); });
el('q').addEventListener('input', onInputDebounce(()=>el('btnSearch').click(), 450));

/* Modal refs */
const m = {
  root: el('accountModal'), head: el('mHead'), name: el('mName'), uuid: el('mUuid'),
  email: el('mEmail'), ip: el('mIp'), reg: el('mReg'), last: el('mLast'),
  role: el('mRole'), loading: el('mLoading'), online: el('mOnline'),
  keyWrap: el('mKeyWrap'), points: el('mPoints'), save: el('btnSavePoints'),
  curr: el('mPointsCurr'), alert: el('mAlert'), title: el('mTitle'),
  // ban
  banStatus: el('banStatus'), banBox: el('banActiveBox'),
  banReason: el('banReason'), banDuration: el('banDuration'),
  btnBan: el('btnBan'), btnUnban: el('btnUnban'), banSilent: el('banSilent'),
  // tabs
  tabDon: document.getElementById('tab-donations'),
  tabPun: document.getElementById('tab-punishments'),
  tabs: document.getElementById('mTabs'),
  donationRows: document.getElementById('donationRows'),
  banRows: document.getElementById('banRows'),
  muteRows: document.getElementById('muteRows'),
  warnRows: document.getElementById('warnRows'),
  histRows: document.getElementById('histRows'),
  punishSpinner: document.getElementById('punishSpinner'),
  pointsNote: el('pointsNote'),
};
const modal = new BS.Modal(m.root);

// ensure close in fallback
document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(btn=>{
  btn.addEventListener('click', ()=> modal.hide());
});
document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') modal.hide(); });

function setOnline(o){
  const dot = m.online.querySelector('.status-dot');
  const text = m.online.querySelector('span.align-middle');
  dot.className = 'status-dot ' + (o===true?'status-online':o===false?'status-offline':'status-unknown');
  text.textContent = o===true ? 'online' : o===false ? 'offline' : 'unknown';
}

function setPointsValue(v){
  const num = Number.isFinite(v) ? Number(v) : 0;
  m.points.value = num.toFixed(2);
  if (m.curr) m.curr.textContent = num.toFixed(2);
}

let current = { uuid: '', name: '' };
let punishLoaded = false;

async function openModal({uuid, name}){
  current = {uuid: uuid||'', name: name||''};

  // reset UI
  m.loading.style.display = '';
  m.alert.classList.add('d-none'); m.alert.textContent='';
  m.title.textContent = 'Профиль';
  m.head.src = skin(name, uuid);
  m.name.textContent = name || '—';
  m.uuid.textContent = uuid || '—';
  m.email.textContent = '—'; m.ip.textContent = '—';
  m.reg.textContent = '—'; m.last.textContent = '—';
  m.role.textContent = 'default'; setOnline(null);
  setPointsValue(0); m.save.disabled = true; m.pointsNote.textContent = '';
  m.keyWrap.textContent = '';

  // ban ui reset
  setBadge(m.banStatus, '—', false);
  m.banBox.classList.add('d-none'); m.banBox.innerHTML = '';
  m.btnBan.disabled = true; m.btnUnban.classList.add('d-none');
  punishLoaded = false; showTab('donations');

  modal.show();

  try{
    const u = new URL("/admin/accounts/api/details", location.origin);
    if(uuid) u.searchParams.set('uuid', uuid);
    if(name) u.searchParams.set('name', name);
    const res = await fetch(u, {cache:'no-store'});
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || 'error');
    const d = j.data || {};

    // header
    m.head.src = skin(d.name, d.uuid);
    m.title.textContent = d.name || 'Профиль';
    m.name.textContent = d.name || name || '—';
    m.uuid.textContent = d.uuid || uuid || '—';
    m.email.textContent = d.email || '—';
    m.ip.textContent = d.ip || '—';
    m.reg.textContent = fmtTime(d.regdate);
    m.last.textContent = fmtTime(d.lastlogin);
    m.role.textContent = d.role || 'default';
    setOnline(d.online);

    // points
    const key = (d.points_key || 'rubs').trim();
    m.keyWrap.textContent = key ? `(${key})` : '';
    setPointsValue(typeof d.points === 'number' ? d.points : 0);
    m.save.disabled = !d.can_edit_points;
    m.pointsNote.textContent = d.can_edit_points ? '' : 'У вас нет прав изменять баланс.';

    // donations included in details
    renderDonations(d.donations || []);

    // ban status
    const ban = d.ban || {};
    setBadge(m.banStatus, ban.is_banned ? 'Забанен' : 'Не забанен', !!ban.is_banned);
    m.btnBan.disabled = !d.can_ban || !!ban.is_banned;
    m.btnUnban.classList.toggle('d-none', !d.can_ban || !ban.is_banned);
    if (ban.active) {
      m.banBox.classList.remove('d-none');
      m.banBox.innerHTML = `
        <div><span class="k">Причина:</span> ${ban.active.reason || '—'}</div>
        <div><span class="k">От:</span> ${ban.active.actor_name || ban.active.banned_by_name || '—'}</div>
        <div><span class="k">С:</span> ${fmtTime(ban.active.time_ms)}</div>
        <div><span class="k">До:</span> ${ban.active.until_ms ? fmtTime(ban.active.until_ms) : 'навсегда'}</div>
      `;
    }
  }catch(e){
    showError(e.message);
  }finally{
    m.loading.style.display = 'none';
  }
}

function showError(msg){
  m.alert.textContent = msg || 'Ошибка';
  m.alert.classList.remove('d-none');
}

function setBadge(node, text, ok){
  node.textContent = text;
  node.className = 'badge ' + (ok ? 'bg-danger' : 'bg-secondary');
}

/* Tabs */
function showTab(name){
  document.querySelectorAll('#mTabs .nav-link').forEach(a=>{
    a.classList.toggle('active', a.dataset.tab === name);
  });
  m.tabDon.classList.toggle('d-none', name !== 'donations');
  m.tabPun.classList.toggle('d-none', name !== 'punishments');
  if (name === 'punishments' && !punishLoaded) {
    loadPunishments(current.uuid);
  }
}
m.tabs.querySelectorAll('.nav-link').forEach(a=>{
  a.addEventListener('click', ()=> showTab(a.dataset.tab));
});

/* Donations render */
function renderDonations(list){
  if(!list || !list.length){
    m.donationRows.innerHTML = `<tr><td colspan="6" class="text-secondary">Нет данных</td></tr>`;
    return;
  }
  m.donationRows.innerHTML = list.map(r=>{
    const payId = r.payment_id ?? '—';
    const purId = r.purchase_id ?? '—';
    const prod  = r.product_name ?? '—';
    const amt   = r.amount ?? '—';
    const cost  = (r.cost != null) ? r.cost : '—';
    const created = r.payment_created_at || r.purchase_created_at || '—';
    return `<tr>
      <td>${payId}</td>
      <td>${purId}</td>
      <td>${prod}</td>
      <td>${amt}</td>
      <td>${cost}</td>
      <td>${created}</td>
    </tr>`;
  }).join('');
}

/* Punishments */
async function loadPunishments(uuid){
  if(!uuid) return;
  m.punishSpinner.style.display='';
  try{
    const u = new URL('/admin/accounts/api/punishments', location.origin);
    u.searchParams.set('uuid', uuid);
    const res = await fetch(u, {cache:'no-store'});
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || 'error');
    const d = j.data || {};
    fillPunTable(m.banRows, d.bans, true);
    fillPunTable(m.muteRows, d.mutes, true);
    fillPunTable(m.warnRows, d.warnings, true);
    fillHistTable(m.histRows, d.history);
    punishLoaded = true;
  }catch(e){
    showError('Не удалось загрузить наказания: ' + e.message);
  }finally{
    m.punishSpinner.style.display='none';
  }
}
function fillPunTable(tbody, list, withActive){
  if(!list || !list.length){
    tbody.innerHTML = `<tr><td colspan="6" class="text-secondary">—</td></tr>`;
    return;
  }
  tbody.innerHTML = list.map(x=>{
    return `<tr>
      <td>${x.id ?? '—'}</td>
      <td>${x.reason || '—'}</td>
      <td>${x.banned_by_name || x.actor_name || '—'}</td>
      <td>${fmtTime(x.time_ms)}</td>
      <td>${x.until_ms ? fmtTime(x.until_ms) : '—'}</td>
      <td>${withActive ? (x.active ? 'yes' : 'no') : '—'}</td>
    </tr>`;
  }).join('');
}
function fillHistTable(tbody, list){
  if(!list || !list.length){
    tbody.innerHTML = `<tr><td colspan="4" class="text-secondary">—</td></tr>`;
    return;
  }
  tbody.innerHTML = list.map(x=>{
    return `<tr>
      <td>${x.id ?? '—'}</td>
      <td>${x.date || '—'}</td>
      <td>${x.name || '—'}</td>
      <td>${x.ip || '—'}</td>
    </tr>`;
  }).join('');
}

/* Save points */
m.save.addEventListener('click', async ()=>{
  const uuid = (m.uuid.textContent || '').trim();
  const key = (m.keyWrap.textContent || '(rubs)').replace(/[()]/g,'').trim() || 'rubs';
  const points = parseFloat(m.points.value);
  if(!uuid || Number.isNaN(points)) return;
  m.save.disabled = true;
  try{
    const res = await fetch('/admin/accounts/api/points', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ uuid, key, points })
    });
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || 'error');
    const newVal = j.data?.points ?? points;
    setPointsValue(newVal);
    toastMsg('Баланс сохранён');
  }catch(e){
    toastMsg('Ошибка: ' + e.message);
  }finally{
    m.save.disabled = false;
  }
});

/* Ban / Unban */
m.btnBan.addEventListener('click', async ()=>{
  const body = {
    uuid: current.uuid,
    reason: m.banReason.value || undefined,
    duration_seconds: parseInt(m.banDuration.value || '0', 10) || 0,
    silent: !!m.banSilent.checked,
    ipban: false
  };
  try{
    const r = await fetch('/admin/accounts/api/ban', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'ban failed');
    toastMsg('Пользователь забанен');
    openModal(current);
  }catch(e){ showError(e.message); }
});

m.btnUnban.addEventListener('click', async ()=>{
  try{
    const r = await fetch('/admin/accounts/api/unban', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({uuid: current.uuid})});
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'unban failed');
    toastMsg('Бан снят');
    openModal(current);
  }catch(e){ showError(e.message); }
});

/* helpers */
function setBadgeText(id, text, ok){
  const b = el(id);
  b.textContent = text;
  b.className = 'badge ' + (ok ? 'bg-success' : 'bg-secondary');
}

/* авто-подгрузка «последних» при входе */
fetchData();
</script>
{% endblock %}
