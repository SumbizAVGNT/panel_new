{# ===== DISCORD OAUTH2 + общие настройки (табы) ===== #}
<div class="card glass p-3 p-md-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div class="d-flex align-items-center gap-2">
      <img
        src="data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 199'><path fill='%23ffffff' d='M216.856 16.597A208.502 208.502 0 0 0 170.976.46a144.225 144.225 0 0 0-6.814 14.083 201.303 201.303 0 0 0-59.044 0A144.28 144.28 0 0 0 98.304.461 208.67 208.67 0 0 0 52.42 16.598C18.192 66.058 9.111 114.288 13.23 162.074a209.79 209.79 0 0 0 63.425 32.222 152.742 152.742 0 0 0 13.6-21.998 134.638 134.638 0 0 1-21.46-10.235c1.797-1.321 3.542-2.703 5.225-4.143a148.59 148.59 0 0 0 132.26 0c1.684 1.44 3.43 2.822 5.226 4.143a134.2 134.2 0 0 1-21.513 10.273 152.16 152.16 0 0 0 13.6 21.958 209.72 209.72 0 0 0 63.424-32.222c5.19-58.78-9.9-106.86-36.12-145.477zM85.474 128.109c-12.324 0-22.36-11.51-22.36-25.676 0-14.165 9.98-25.675 22.36-25.675 12.378 0 22.413 11.51 22.36 25.675 0 14.166-9.982 25.676-22.36 25.676z'/></svg>"
        alt="Discord" style="width:26px;height:26px" class="img-fluid rounded-2">
      <h1 class="h4 m-0">Discord OAuth2</h1>
    </div>

    <button type="button"
            class="btn btn-outline-warning btn-sm"
            data-bs-toggle="tooltip"
            data-bs-placement="left"
            title="How to configure Discord&#10;Open Discord Developer Portal → Applications → Your App.&#10;Go to OAuth2 → General and copy Client ID & Secret.&#10;Add redirect: http://127.0.0.1:5000/discord/callback.&#10;Scopes: identify, grant type: Authorization Code.">
      <i class="bi bi-exclamation-circle-fill me-1"></i> Help
    </button>
  </div>

  <ul class="nav nav-pills gap-2 pillbar mb-3" id="settingsTabs" role="tablist">
    <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-general"  type="button" role="tab">General</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link"        data-bs-toggle="pill" data-bs-target="#tab-oauth"    type="button" role="tab">OAuth2</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link"        data-bs-toggle="pill" data-bs-target="#tab-security" type="button" role="tab">Security</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link"        data-bs-toggle="pill" data-bs-target="#tab-appearance" type="button" role="tab">Appearance</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link"        data-bs-toggle="pill" data-bs-target="#tab-logs"     type="button" role="tab">Logs</button></li>
  </ul>

  <form method="post" class="tab-content">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    {# GENERAL #}
    <div class="tab-pane fade show active" id="tab-general" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <label class="form-label">Site title</label>
          <input class="form-control" type="text" name="SITE_TITLE" value="{{ site_title or 'MoonRein' }}">
        </div>
        <div class="col-12 col-lg-6">
          <label class="form-label">Default Redirect URI</label>
          <input class="form-control" type="url" name="DISCORD_REDIRECT_URI" value="{{ redirect_uri or 'http://127.0.0.1:5000/discord/callback' }}">
          <div class="form-text">Используется также в Discord OAuth2.</div>
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" type="submit">Save all</button>
      </div>
    </div>

    {# OAUTH #}
    <div class="tab-pane fade" id="tab-oauth" role="tabpanel">
      {% set configured = client_id and has_secret and redirect_uri %}
      {% if configured %}
        {% set badge_cls = 'bg-success' if oauth_ok else 'bg-danger' %}
        {% set badge_text = 'Connected' if oauth_ok else 'Misconfigured' %}
      {% else %}
        {% set badge_cls = 'bg-warning' %}
        {% set badge_text = 'Not configured' %}
      {% endif %}

      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <div class="d-flex align-items-center gap-2">
          <input class="form-check-input me-2" type="checkbox" checked disabled>
          <strong>Discord OAuth2</strong>
          <span class="badge rounded-pill {{ badge_cls }}">{{ badge_text }}</span>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-light" href="{{ url_for('auth.discord_login') }}">Test</a>
          <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#oauthEdit">Edit</button>
          <button type="submit" class="btn btn-outline-danger"
                  formmethod="post" formaction="{{ url_for('admin.oauth_disconnect') }}"
                  formnovalidate onclick="return confirm('Disconnect OAuth2?');">Disconnect</button>
        </div>
      </div>

      <div class="row g-3 mb-2">
        <div class="col-12 col-lg-6">
          <label class="form-label">Client ID</label>
          <input class="form-control" type="text" value="{{ client_id[:4] ~ '•••' if client_id else '' }}" readonly>
        </div>
        <div class="col-12 col-lg-6">
          <label class="form-label">Redirect URI</label>
          <input class="form-control" type="text" value="{{ redirect_uri or '' }}" readonly>
        </div>
      </div>

      <div id="oauthEdit" class="collapse {% if not configured %}show{% endif %}">
        <hr class="text-secondary">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <label class="form-label">Discord Client ID</label>
            <input class="form-control" type="text" name="DISCORD_CLIENT_ID" value="{{ client_id }}">
          </div>
          <div class="col-12 col-lg-6">
            <label class="form-label">Discord Client Secret</label>
            <input class="form-control" type="password" name="DISCORD_CLIENT_SECRET" placeholder="{{ '•••••••• (set)' if has_secret else 'paste secret' }}">
          </div>
        </div>
      </div>
    </div>

    {# SECURITY #}
    <div class="tab-pane fade" id="tab-security" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <label class="form-label">Require login for dashboard</label>
          <select class="form-select" name="REQUIRE_LOGIN">
            <option value="1" {{ 'selected' if require_login else '' }}>Yes</option>
            <option value="0" {{ '' if require_login else 'selected' }}>No</option>
          </select>
        </div>
        <div class="col-12 col-lg-6">
          <label class="form-label">Session lifetime (hours)</label>
          <input class="form-control" type="number" min="1" max="168" name="SESSION_HOURS" value="{{ session_hours or 12 }}">
        </div>
      </div>
    </div>

    {# APPEARANCE #}
    <div class="tab-pane fade" id="tab-appearance" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <label class="form-label">Theme</label>
          <select class="form-select" name="THEME">
            <option value="dark"  {{ 'selected' if theme=='dark'  else '' }}>Dark</option>
            <option value="light" {{ 'selected' if theme=='light' else '' }}>Light</option>
            <option value="auto"  {{ 'selected' if theme=='auto'  else '' }}>Auto</option>
          </select>
        </div>
        <div class="col-12 col-lg-6">
          <label class="form-label">Primary accent (hex)</label>
          <input class="form-control" type="text" name="ACCENT" value="{{ accent or '#5865F2' }}">
        </div>
      </div>
    </div>

    {# LOGS #}
    <div class="tab-pane fade" id="tab-logs" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <label class="form-label">Log retention (days)</label>
          <input class="form-control" type="number" min="1" max="365" name="LOG_RETENTION_DAYS" value="{{ log_days or 14 }}">
        </div>
        <div class="col-12 col-lg-6">
          <label class="form-label">Verbosity</label>
          <select class="form-select" name="LOG_LEVEL">
            {% for lvl in ['INFO','WARNING','ERROR','DEBUG'] %}
              <option value="{{ lvl }}" {{ 'selected' if log_level==lvl else '' }}>{{ lvl }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </form>
</div>
