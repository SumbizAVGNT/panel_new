{# ===== SUPPORT (CHATWOOT) ===== #}
<div class="card glass p-3 p-md-4 mt-3">
  {% set cw_token_set = chatwoot_token %}
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-life-preserver"></i>
      <h2 class="h5 m-0">Support (Chatwoot)</h2>
      {% set sup_badge = 'bg-success' if support_ok else ('bg-warning' if chatwoot_base and cw_token_set else 'bg-secondary') %}
      <span class="badge rounded-pill {{ sup_badge }}">
        {{ 'Connected' if support_ok else ('Configured' if chatwoot_base and cw_token_set else 'Not configured') }}
      </span>
    </div>
    <div class="d-flex gap-2">
      <form method="post" action="{{ url_for('admin.support_test') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button class="btn btn-outline-light btn-sm" type="submit">Test</button>
      </form>
      <form method="post" action="{{ url_for('admin.support_disconnect') }}" onsubmit="return confirm('Disconnect Chatwoot?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button class="btn btn-outline-danger btn-sm" type="submit">Disconnect</button>
      </form>
    </div>
  </div>

  <form method="post" class="row g-3 align-items-end">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <div class="col-12 col-lg-6">
      <label class="form-label">Base URL</label>
      <input class="form-control" type="url" name="CHATWOOT_BASE_URL" placeholder="https://chatwoot.example.com" value="{{ chatwoot_base }}">
      <div class="form-text">Напр. https://chatwoot.example.com</div>
    </div>
    <div class="col-12 col-lg-6">
      <label class="form-label">Access Token</label>
      <input class="form-control" type="password" name="CHATWOOT_ACCESS_TOKEN" placeholder="{{ '•••••••• (set)' if cw_token_set else 'paste access token' }}">
      <div class="form-text">Личный API-токен из Chatwoot (Settings → Profile → Access token).</div>
    </div>
    <div class="col-12 col-lg-6">
      <label class="form-label">Client (optional)</label>
      <input class="form-control" type="text" name="CHATWOOT_CLIENT" value="{{ chatwoot_client or '' }}" placeholder="client id / app id (optional)">
    </div>
    <div class="col-12 col-lg-6">
      <label class="form-label">UID (optional)</label>
      <input class="form-control" type="text" name="CHATWOOT_UID" value="{{ chatwoot_uid or '' }}" placeholder="uid (optional)">
    </div>
    <div class="col-12">
      <button class="btn btn-primary" type="submit">Save</button>
      {% if support_reason and (chatwoot_base or cw_token_set) and not support_ok %}
        <span class="ms-2 text-warning small">Last check: {{ support_reason }}</span>
      {% endif %}
    </div>
  </form>
</div>
