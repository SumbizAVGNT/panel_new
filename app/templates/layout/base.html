<!--app/templates/layout/base.html-->
<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>{% block title %}MoonRein{% endblock %}</title>
  <meta name="csrf-token" content="{{ csrf_token }}" />

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Ваши стили (если есть) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --mr-surface: rgba(13,17,23,.55);
      --mr-border : rgba(148,163,184,.18);
      --mr-glow   : 0 10px 30px rgba(0,0,0,.35);
    }

    /* Фон */
    body.bg-space{background:#070b12;color:#e5e7eb;min-height:100dvh}
    .stars-canvas{position:fixed;inset:0;z-index:-1;opacity:.35}

    /* ===== Topbar ===== */
    .topbar{
      position:sticky;top:0;z-index:1040;
      border-bottom:1px solid var(--mr-border);
      background:linear-gradient(180deg,rgba(6,10,18,.75),rgba(6,10,18,.55));
      backdrop-filter:blur(10px)
    }
    .topbar .brand{font-weight:800;letter-spacing:.2px;text-decoration:none;color:#e5e7eb}
    .topbar .nav-center .nav-link{
      border:1px solid var(--mr-border);border-radius:12px;
      padding:.45rem .9rem;background:rgba(13,17,23,.65);color:#e5e7eb
    }
    .topbar .nav-center .nav-link:hover{border-color:#3b4453}
    .topbar .nav-center .nav-link.active{background:#0f172a;border-color:#3b4453}

    .user-menu .user-btn{
      display:flex;align-items:center;gap:.6rem;padding:.35rem .6rem;border-radius:14px;
      border:1px solid var(--mr-border);background:rgba(13,17,23,.65);color:#e5e7eb
    }
    .user-menu .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover}
    .user-menu .dropdown-menu{border:1px solid var(--mr-border);background:#0b1220}

    /* ===== Layout ===== */
    .page-wrap{max-width:1200px;margin:0 auto;padding:22px 16px 40px;}
    .page-wrap--tight{padding-top:8px !important;}

    .glass{
      background:var(--mr-surface);
      backdrop-filter:blur(10px);
      border:1px solid var(--mr-border);
      border-radius:16px;
      box-shadow:var(--mr-glow)
    }

    /* Flash */
    .flash-stack{position:fixed;top:76px;right:16px;z-index:1080;display:grid;gap:.5rem}
    .flash{padding:.6rem .9rem;border-radius:12px}
    .flash-success{background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.25)}
    .flash-error{background:rgba(248,113,113,.15);border:1px solid rgba(248,113,113,.25)}
    .flash-warning{background:rgba(251,191,36,.15);border:1px solid rgba(251,191,36,.25)}
    .flash-info{background:rgba(96,165,250,.15);border:1px solid rgba(96,165,250,.25)}

    /* === GLOBAL TOP-TIGHTEN FIX === */
    .page-wrap > *:first-child { margin-top: 8px !important; }
    .page-wrap > .container,
    .page-wrap > .container-fluid,
    .page-wrap > .container-xxl,
    .page-wrap > .container-xl,
    .page-wrap > .container-lg,
    .page-wrap > .container-md,
    .page-wrap > .container-sm {
      margin-top: 8px !important;
      padding-top: 8px;
    }
    .page-wrap h1:first-child,
    .page-wrap .h1:first-child,
    .page-wrap h2:first-child,
    .page-wrap .h2:first-child { margin-top: 0 !important; }
    .page-wrap > .card:first-child,
    .page-wrap > .glass:first-child { margin-top: 8px !important; }
    .page-wrap > section:first-child { margin-top: 8px !important; }
  </style>
</head>
<body class="bg-space">
  <!-- фон со «звёздами» -->
  <canvas id="stars-canvas" class="stars-canvas"></canvas>

  {% set ep   = request.endpoint or '' %}
  {% set role = session.get('role') %}

  {% if session.get('user_id') and not ep.startswith('auth.') %}
  <header class="topbar py-2">
    <div class="container-xxl d-flex align-items-center gap-3">
      <!-- Лого -->
      <a class="brand me-1" href="{{ url_for('dashboard.dashboard') }}">MoonRein</a>

      <!-- Центр-меню -->
      <nav class="nav-center d-flex gap-2 flex-grow-1 justify-content-center">
        <a class="nav-link {{ 'active' if 'dashboard.dashboard' in ep else '' }}"
           href="{{ url_for('dashboard.dashboard') }}">Overview</a>

        <a class="nav-link {{ 'active' if ep.startswith('news.') else '' }}"
           href="{{ url_for('news.index') }}">News</a>

        {% if role in ['admin','superadmin'] %}
          <a class="nav-link {{ 'active' if 'admin.admin_users' in ep else '' }}"
             href="{{ url_for('admin.admin_users') }}">Users</a>
          <a class="nav-link {{ 'active' if ep.startswith('logs.') else '' }}" href="#">Logs</a>
        {% endif %}

        {% if role == 'superadmin' %}
          <a class="nav-link {{ 'active' if 'admin.settings' in ep else '' }}"
             href="{{ url_for('admin.settings') }}">Settings</a>
        {% endif %}
      </nav>

      <!-- Пользователь -->
      {% set user = current_user or {'username':'user','discord_id':None} %}
      {% if user.discord_id %}
        {% set avatar_url = (
          'https://cdn.discordapp.com/avatars/%s/%s.png?size=64' % (user.discord_id, user.discord_avatar)
          if user.discord_avatar else 'https://cdn.discordapp.com/embed/avatars/0.png'
        ) %}
      {% else %}
        {% set avatar_url = 'https://api.dicebear.com/7.x/initials/svg?radius=50&seed=' ~ (user.username|e) %}
      {% endif %}

      <div class="user-menu dropdown ms-auto">
        <button class="user-btn dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          <img class="avatar" src="{{ avatar_url }}" alt="" referrerpolicy="no-referrer">
          <div class="d-none d-sm-block lh-sm">
            <div class="fw-semibold small">{{ user.username }}</div>
            <div class="text-secondary small">{{ role }}</div>
          </div>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow">
          <li><a class="dropdown-item" href="#">Profile</a></li>
          {% if role in ['admin','superadmin'] %}
          <li><a class="dropdown-item" href="{{ url_for('admin.admin_users') }}">Manage Users</a></li>
          {% endif %}
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">Logout</a></li>
        </ul>
      </div>
    </div>
  </header>
  {% endif %}

  <!-- Контент -->
  <main class="page-wrap">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-stack">
          {% for category, message in messages %}
            <div class="flash flash-{{ category|lower }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Ваши скрипты -->
  <script src="{{ url_for('static', filename='js/script.js') }}"></script>

  <!-- Рисуем «звёзды» -->
  <script>
    (function(){
      const c = document.getElementById('stars-canvas');
      if(!c) return;
      const ctx = c.getContext('2d');
      function resize(){ c.width = innerWidth; c.height = innerHeight; draw(); }
      addEventListener('resize', resize, {passive:true}); resize();
      function draw(){
        ctx.clearRect(0,0,c.width,c.height);
        for(let i=0;i<120;i++){
          const x=Math.random()*c.width, y=Math.random()*c.height, r=Math.random()*1.2;
          ctx.fillStyle = `rgba(255,255,255,${.15+Math.random()*.35})`;
          ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
        }
      }
    })();
  </script>

  {% block body_extra %}{% endblock %}
</body>
</html>
